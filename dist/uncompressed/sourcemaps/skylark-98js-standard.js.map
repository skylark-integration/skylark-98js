{"version":3,"sources":["skylark-98js-standard.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"../skylark-98js-standard.js","sourcesContent":["define('skylark-98js/win98',[\r\n\t\"skylark-langx-ns\",\r\n\t\"skylark-jquery\"\r\n],function(skylark,$){\r\n\twindow.$ = $;\r\n\treturn skylark.attach(\"intg.win98js\");\r\n});\ndefine('skylark-98js/helpers',[\n\t\"skylark-jquery\",\n\t\"./win98\"\n],function($,win98js){\n\tvar TAU =     //////|//////\n\t          /////     |     /////\n\t       ///         tau         ///\n\t     ///     ...--> | <--...     ///\n\t   ///     -'   one | turn  '-     ///\n\t  //     .'         |         '.     //\n\t //     /           |           \\     //\n\t//     |            | <-..       |     //\n\t//    |          .->|     \\       |    //\n\t//    |         /   |      |      |    //\n\t- - - - - - Math.PI + Math.PI - - - - - 0\n\t//    |         \\   |      |      |    //\n\t//    |          '->|     /       |    //\n\t//     |            | <-''       |     //\n\t //     \\           |           /     //\n\t  //     '.         |         .'     //\n\t   ///     -.       |       .-     ///\n\t     ///     '''----|----'''     ///\n\t       ///          |          ///\n\t         //////     |     /////\n\t              //////|//////          C/r;\n\n\tvar $G = $(window);\n\n\tfunction Cursor(cursor_def) {\n\t\treturn \"url(images/cursors/\" + cursor_def[0] + \".png) \" +\n\t\t\tcursor_def[1].join(\" \") +\n\t\t\t\", \" + cursor_def[2]\n\t}\n\n\tfunction E(t) {\n\t\treturn document.createElement(t);\n\t}\n\n\tvar DESKTOP_ICON_SIZE = 32;\n\tvar TASKBAR_ICON_SIZE = 16;\n\tvar TITLEBAR_ICON_SIZE = 16;\n\n\t// For Wayback Machine, match URLs like https://web.archive.org/web/20191213113214/https://98.js.org/\n\t// (also match URLs like https://98.js.org/ because why not)\n\tconst web_server_root_for_icons =\n\t\tlocation.href.match(/98.js.org/) ?\n\t\t\tlocation.href.match(/.*98.js.org/)[0] + \"/\" :\n\t\t\t\"/\";\n\n\tfunction getIconPath(iconID, size) {\n\t\treturn web_server_root_for_icons + \"images/icons/\" + iconID + \"-\" + size + \"x\" + size + \".png\";\n\t}\n\n\tfunction Canvas(width, height) {\n\t\tvar new_canvas = E(\"canvas\");\n\t\tvar new_ctx = new_canvas.getContext(\"2d\");\n\t\tnew_ctx.imageSmoothingEnabled = false;\n\t\tnew_ctx.mozImageSmoothingEnabled = false;\n\t\tnew_ctx.webkitImageSmoothingEnabled = false;\n\t\tif (width && height) {\n\t\t\t// new Canvas(width, height)\n\t\t\tnew_canvas.width = width;\n\t\t\tnew_canvas.height = height;\n\t\t} else {\n\t\t\t// new Canvas(image)\n\t\t\tvar copy_of = width;\n\t\t\tif (copy_of) {\n\t\t\t\tnew_canvas.width = copy_of.width;\n\t\t\t\tnew_canvas.height = copy_of.height;\n\t\t\t\tnew_ctx.drawImage(copy_of, 0, 0);\n\t\t\t}\n\t\t}\n\t\tnew_canvas.ctx = new_ctx;\n\t\treturn new_canvas;\n\t}\n\n\tfunction mustHaveMethods(obj, methodNames) {\n\t\tfor (const methodName of methodNames) {\n\t\t\tif (typeof obj[methodName] != 'function') {\n\t\t\t\tconsole.error(\"Missing method\", methodName, \"on object\", obj);\n\t\t\t\tthrow new TypeError(\"missing method \" + methodName);\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\tconst windowInterfaceMethods = [\n\t\t\"close\",\n\t\t\"minimize\",\n\t\t\"unminimize\",\n\t\t// \"maximize\",\n\t\t// \"unmaximize\",\n\t\t\"bringToFront\", // TODO: maybe setZIndex instead\n\t\t\"getTitle\",\n\t\t// \"getIconName\",\n\t\t\"getIconAtSize\",\n\t\t\"focus\",\n\t\t\"blur\",\n\t\t\"onFocus\",\n\t\t\"onBlur\",\n\t\t\"onClosed\",\n\t];\n\n\n\tfunction file_name_from_path(file_path) {\n\t\treturn file_path.split(\"\\\\\").pop().split(\"/\").pop();\n\t}\n\n\tfunction file_extension_from_path(file_path) {\n\t\treturn (file_path.match(/\\.(\\w+)$/) || [, \"\"])[1];\n\t}\n\treturn {\n\t\tCursor,\n\t\tDESKTOP_ICON_SIZE,\n\t\tTASKBAR_ICON_SIZE,\n\t\tTITLEBAR_ICON_SIZE,\n\t\tgetIconPath,\n\t\tCanvas,\n\t\tmustHaveMethods,\n\t\twindowInterfaceMethods,\n\t\tfile_name_from_path,\n\n\t\tfile_extension_from_path\n\t}\n});\ndefine('skylark-98js/FolderViewItem',[\n\t\"skylark-jquery\",\n\t\"./win98\",\n\t\"./helpers\"\n],function($,win98js,helpers){\n    \"use strict\";\n\n\tfunction FolderViewItem(options) {\n\t\t// TODO: rename options to be consistent,\n\t\t// like is_folder, is_shortcut, etc.\n\t\t// TODO: rename CSS class to folder-view-item, or find a better name\n\t\tvar $container = $(\"<div class='desktop-icon' draggable='true' tabindex=-1/>\");\n\t\tvar $icon_wrapper = $(\"<div class='icon-wrapper'/>\").appendTo($container);\n\t\tvar $selection_effect = $(\"<div class='selection-effect'/>\").appendTo($icon_wrapper);\n\t\tvar $title = $(\"<div class='title'/>\").text(options.title);\n\t\tvar $icon;\n\t\t$container.append($icon_wrapper, $title);\n\n\t\t// TODO: handle the loading state display in some intentional way\n\n\t\t// TODO: or if set to \"web\" mode, single click\n\t\t// also Enter is currently implemented by triggering dblclick which is awkward\n\t\tlet single_click_timeout;\n\t\t$container.on(\"dblclick\", (event) => {\n\t\t\tif (event.ctrlKey || event.metaKey || event.shiftKey || event.altKey) {\n\t\t\t\treturn; // Not true to Windows 98. But in Windows 98 it doesn't do two things, it just does the double click action.\n\t\t\t\t// At any rate, it feels nice to make Ctrl+click do only one thing (toggling the selection state).\n\t\t\t}\n\t\t\toptions.open();\n\t\t\tclearTimeout(single_click_timeout);\n\t\t});\n\t\t// TODO: allow dragging files out from this folder view to the system file browser, with dataTransfer.setData(\"DownloadURL\", ...)\n\t\t// sadly will only work for a single file (unless it secretly supports text/uri-list (either as a separate type or for DownloadURL))\n\t\t// also it won't work if I want to do custom drag-and-drop (e.g. repositioning icons)\n\t\t// so I have to choose one feature or the other (right?), probably custom drag-and-drop\n\n\t\t$title.on(\"click\", () => {\n\t\t\tif (!$container[0]._was_selected_at_pointerdown) {\n\t\t\t\treturn; // this click is for selecting the item\n\t\t\t}\n\t\t\t// @TODO: if the folder view wasn't focused at pointerdown,\n\t\t\t// don't start rename\n\t\t\tsingle_click_timeout = setTimeout(() => {\n\t\t\t\tif ($container.hasClass(\"selected\")) {\n\t\t\t\t\tthis.start_rename();\n\t\t\t\t}\n\t\t\t}, 500);\n\t\t});\n\n\t\tif (options.shortcut) {\n\t\t\t$container.addClass(\"shortcut\");\n\t\t}\n\t\t$container[0].dataset.filePath = options.file_path;\n\n\t\tthis.element = $container[0];\n\n\t\tthis.icons = options.icons;\n\t\tthis.iconSize = options.iconSize || helpers.DESKTOP_ICON_SIZE;\n\n\t\tthis.file_path = options.file_path;\n\t\tthis.is_system_folder = options.is_system_folder;\n\n\t\tthis._update_icon = () => {\n\t\t\tif (this.icons) {\n\t\t\t\tconst $old_icon = $icon;\n\t\t\t\tconst src = this.icons[this.iconSize];\n\t\t\t\t$icon = $(\"<img class='icon'/>\");\n\t\t\t\t$icon.attr({\n\t\t\t\t\tdraggable: false,\n\t\t\t\t\tsrc,\n\t\t\t\t\twidth: this.iconSize,\n\t\t\t\t\theight: this.iconSize,\n\t\t\t\t});\n\t\t\t\t$selection_effect[0].style.setProperty(\"--icon-image\", `url(\"${src}\")`);\n\t\t\t\tif ($old_icon) {\n\t\t\t\t\t$old_icon.replaceWith($icon);\n\t\t\t\t} else {\n\t\t\t\t\t$icon_wrapper.prepend($icon);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$icon && $icon.remove();\n\t\t\t\t$icon = null;\n\t\t\t\t$selection_effect[0].style.setProperty(\"--icon-image\", \"none\");\n\t\t\t}\n\t\t\t$icon_wrapper[0].style.setProperty(\"--icon-size\", this.iconSize + \"px\");\n\t\t\t$icon_wrapper[0].style.setProperty(\"--shortcut-icon\", `url(\"${helpers.getIconPath(\"shortcut\", this.iconSize)}\")`);\n\t\t};\n\t\tthis.setIcons = (new_icons) => {\n\t\t\tthis.icons = new_icons;\n\t\t\tthis._update_icon();\n\t\t};\n\t\tthis.setIconSize = (new_size) => {\n\t\t\tif (this.iconSize === new_size) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.iconSize = new_size;\n\t\t\tthis._update_icon();\n\t\t};\n\t\tthis._update_icon();\n\n\t\tthis.start_rename = () => {\n\t\t\tif (!options.rename) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($container.hasClass(\"renaming\")) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t$container.addClass(\"renaming\");\n\t\t\t$container.attr(\"draggable\", false);\n\t\t\tconst old_title = $title.text();\n\t\t\t// @TODO: auto-size the input box,\n\t\t\t// and wrap to multiple lines\n\t\t\tconst $input = $(\"<input type='text'/>\");\n\t\t\t$input.val(old_title);\n\t\t\t$input.on(\"keydown\", (e) => {\n\t\t\t\t// relying on blur event to trigger the rename,\n\t\t\t\t// or to reset the input to the old title\n\t\t\t\tif (e.key === \"Enter\") {\n\t\t\t\t\t$container.focus();\n\t\t\t\t\te.preventDefault();\n\t\t\t\t} else if (e.key === \"Escape\") {\n\t\t\t\t\t$input.val(old_title);\n\t\t\t\t\t$container.focus();\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t\t$input.on(\"blur\", () => {\n\t\t\t\tconst new_title = $input.val();\n\t\t\t\tif (new_title.trim() === \"\") {\n\t\t\t\t\tshowMessageBox({\n\t\t\t\t\t\ttitle: \"Rename\",\n\t\t\t\t\t\tmessage: \"You must type a filename.\",\n\t\t\t\t\t\ticonID: \"error\",\n\t\t\t\t\t}).then(() => {\n\t\t\t\t\t\t$input.focus(); // @TODO: why is this needed? it's supposed to refocus the last focused element\n\t\t\t\t\t\t// well I guess it doesn't work for the desktop, just windows\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t$input.remove(); // technically not necessary\n\t\t\t\t$title.text(new_title);\n\t\t\t\t$container.removeClass(\"renaming\");\n\t\t\t\t$container.attr(\"draggable\", true);\n\t\t\t\tif (new_title !== old_title) {\n\t\t\t\t\t// console.log(\"renaming\", this.file_path, \"to\", new_title);\n\t\t\t\t\toptions.rename(new_title)\n\t\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\t\t$title.text(old_title);\n\t\t\t\t\t\t\talert(\"Failed to rename:\\n\\n\" + error);\n\t\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\t$title.empty().append($input);\n\t\t\t$input[0].focus();\n\t\t\t$input[0].select();\n\t\t};\n\t}\n\n\treturn FolderViewItem;\n});\ndefine('skylark-98js/filesystem-setup',[\n\t\"skylark-jquery\",\n\t\"skylark-browserfs\",\n\t\"./win98\"\n],function($,BrowserFS, win98js){\n\n\tvar __fs_initialized;\n\tvar __fs_errored;\n\tvar __fs_timed_out;\n\tvar __fs_waiting_callbacks = [];\n\n\n\t// For Wayback Machine, match URLs like https://web.archive.org/web/20191213113214/https://98.js.org/\n\t// (also match URLs like https://98.js.org/ because why not)\n\tconst web_server_root_for_browserfs =\n\t\tlocation.href.match(/98.js.org/) ?\n\t\t\tlocation.href.match(/.*98.js.org/)[0] + \"/\" :\n\t\t\t\"/\";\n\n\tBrowserFS.configure({\n\t\tfs: \"OverlayFS\",\n\t\toptions: {\n\t\t\twritable: {\n\t\t\t\tfs: \"IndexedDB\",\n\t\t\t\toptions: {\n\t\t\t\t\tstoreName: \"C:\"\n\t\t\t\t}\n\t\t\t},\n\t\t\treadable: {\n\t\t\t\tfs: \"XmlHttpRequest\",\n\t\t\t\toptions: {\n\t\t\t\t\tindex: web_server_root_for_browserfs + \"filesystem-index.json\",\n\t\t\t\t\tbaseUrl: web_server_root_for_browserfs\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// TODO: mount the repo contents at something like C:\\98\\\n\t\t// but other OS stuff from a subfolder of the repo as root (C? HD? hard-drive? disk? OS?)\n\t\t// the desktop at something like.. well I guess C:\\98\\desktop\n\t\t// and I could have the default desktop setup in source control there\n\t}, function (error) {\n\t\tif (error) {\n\t\t\t__fs_errored = true;\n\t\t\tif (__fs_waiting_callbacks.length) {\n\t\t\t\t// TODO: DRY (can probably simplify this logic significantly)\n\t\t\t\talert(\"The filesystem is not available. It failed to initialize.\");\n\t\t\t}\n\t\t\t__fs_waiting_callbacks = [];\n\t\t\t// TODO: message box; offer to reset the filesystem\n\t\t\tthrow error;\n\t\t}\n\t\t__fs_initialized = true;\n\t\tfor (var i = 0; i < __fs_waiting_callbacks.length; i++) {\n\t\t\t__fs_waiting_callbacks[i]();\n\t\t}\n\t\t__fs_waiting_callbacks = [];\n\t});\n\n\tsetTimeout(function () {\n\t\t__fs_timed_out = true;\n\t\tif (__fs_waiting_callbacks.length) {\n\t\t\t// TODO: DRY (can probably simplify this logic significantly)\n\t\t\talert(\"The filesystem is not working.\");\n\t\t}\n\t\t__fs_waiting_callbacks = [];\n\t}, 5000);\n\n\tfunction withFilesystem(callback) {\n\t\tif (__fs_initialized) {\n\t\t\tcallback();\n\t\t} else if (__fs_errored) {\n\t\t\talert(\"The filesystem is not available. It failed to initialize.\");\n\t\t} else if (__fs_timed_out) {\n\t\t\talert(\"The filesystem is not working.\");\n\t\t} else {\n\t\t\t// wait within a global period of time while it should be configuring (and not show a message box)\n\t\t\t// TODO: hm, maybe a global timeout isn't what we want\n\t\t\t// The desktop should load, regardless of how long it takes.\n\t\t\t// Other operations could fail in a second or more. Depending on the operation.\n\t\t\t__fs_waiting_callbacks.push(callback);\n\t\t}\n\t}\n\t// TODO: never use alert(); use thematic, non-blocking dialog windows, preferably with warning and error icons\n\t// I have a show_error_message in jspaint, but with no warning or error icons - as of writing; see https://github.com/1j01/jspaint/issues/84\n\n\n\treturn {\n\t\twithFilesystem\n\t}\n\n});\ndefine('skylark-98js/FolderView',[\n\t\"skylark-jquery\",\n\t\"skylark-browserfs\",\n\t\"./win98\",\n\t\"./FolderViewItem\",\n\t\"./filesystem-setup\",\n\t\"./helpers\"\n],function($,BrowserFS, win98js,FolderViewItem,FilesystemSetup,helpers){\n\tconst grid_size_x_for_large_icons = 75;\n\tconst grid_size_y_for_large_icons = 75;\n\t// @TODO: this is supposed to be dynamic based on length of names\n\tconst grid_size_x_for_small_icons = 150;\n\tconst grid_size_y_for_small_icons = 17;\n\n\twindow.resetAllFolderCustomizations = () => {\n\t\tfor (let i = 0; i < localStorage.length; i++) {\n\t\t\tif (localStorage.key(i).startsWith(\"folder-config:\")) {\n\t\t\t\tlocalStorage.removeItem(localStorage.key(i));\n\t\t\t}\n\t\t}\n\t};\n\n\tconst icon_size_by_view_mode = {\n\t\tLARGE_ICONS: 32,\n\t\tSMALL_ICONS: 16,\n\t\tDETAILS: 16,\n\t\tLIST: 16,\n\t\tDESKTOP: 32,\n\t};\n\n\tFolderView.VIEW_MODES = {\n\t\tTHUMBNAILS: \"THUMBNAILS\", // hidden until you right click in a folder, go to Properties, and enable thumbnails\n\t\tLARGE_ICONS: \"LARGE_ICONS\", // left to right, then top to bottom\n\t\tSMALL_ICONS: \"SMALL_ICONS\", // left to right, then top to bottom\n\t\tDETAILS: \"DETAILS\", // table view\n\t\tLIST: \"LIST\", // top to bottom, then left to right\n\t\tDESKTOP: \"DESKTOP\", // like Large Icons, but arranged top to bottom before left to right; does not apply to the Desktop folder, only the Desktop itself\n\t};\n\n\tFolderView.SORT_MODES = {\n\t\tNAME: \"NAME\",\n\t\tTYPE: \"TYPE\",\n\t\tSIZE: \"SIZE\",\n\t\tDATE: \"DATE\",\n\t\t// there are many other attributes, some for specific types of files/objects\n\t};\n\n\t// TODO: what's the \"right\" way to do file type / program associations for icons?\n\n\t// TODO: get more icons; can extract from shell32.dll, moricons.dll, and other files from a VM\n\t// also get more file extensions; can find a mime types listing data dump\n\t// https://github.com/1j01/retrores\n\t// Note: extensions must be lowercase here. This is used to implement case-insensitive matching.\n\tvar file_extension_icons = {\n\t\ttxt: \"notepad-file\",\n\t\tmd: \"notepad-file\",\n\t\tjson: \"notepad-file\",\n\t\tjs: \"notepad-file\",\n\t\tcss: \"notepad-file\",\n\t\thtml: \"notepad-file\",\n\t\tgitattributes: \"notepad-file\",\n\t\tgitignore: \"notepad-file\",\n\t\tpng: \"image-gif\", // \"image-png\"? nope... (but should it be image-gif or image-wmf?)\n\t\tjpg: \"image-jpeg\",\n\t\tjpeg: \"image-jpeg\",\n\t\tgif: \"image-gif\",\n\t\twebp: \"image-other\",\n\t\tbmp: \"paint-file\",\n\t\ttif: \"kodak-imaging-file\",\n\t\ttiff: \"kodak-imaging-file\",\n\t\t// wmf: \"image-wmf\"? nope (https://en.wikipedia.org/wiki/Windows_Metafile)\n\t\t// emf: \"image-wmf\"? nope\n\t\t// wmz: \"image-wmf\"? nope\n\t\t// emz: \"image-wmf\"? nope\n\t\twav: \"sound\",\n\t\tmp3: \"sound\", // TODO: show blue video icon, as it's a container format that can contain video\n\t\togg: \"sound\", // TODO: probably ditto\n\t\twma: \"sound\",\n\t\t// \"doc\": \"doc\"?\n\t\t\"exe\": \"task\",\n\t\thtm: \"html\",\n\t\thtml: \"html\",\n\t\turl: \"html\",\n\t\ttheme: \"themes\",\n\t\tthemepack: \"themes\",\n\t};\n\n\t// @TODO: maintain less fake naming abstraction\n\t// base it more on the actual filesystem\n\t// @TODO: bring system folders, icons, and file associations into one place\n\tconst system_folder_path_to_name = {\n\t\t\"/\": \"(C:)\", //\"My Computer\",\n\t\t\"/my-pictures/\": \"My Pictures\",\n\t\t\"/my-documents/\": \"My Documents\",\n\t\t\"/network-neighborhood/\": \"Network Neighborhood\",\n\t\t\"/desktop/\": \"Desktop\",\n\t\t\"/programs/\": \"Program Files\",\n\t\t\"/recycle-bin/\": \"Recycle Bin\",\n\t};\n\tconst system_folder_name_to_path = Object.fromEntries(\n\t\tObject.entries(system_folder_path_to_name).map(([key, value]) => [value, key])\n\t);\n\tconst system_folder_lowercase_name_to_path = Object.fromEntries(\n\t\tObject.entries(system_folder_name_to_path).map(([key, value]) => [key.toLowerCase(), value])\n\t);\n\n\n\tconst set_dragging_file_paths = (dragging_file_paths) => {\n\t\twindow.dragging_file_paths = dragging_file_paths;\n\t\tlet frame = window;\n\t\twhile (frame !== frame.parent) {\n\t\t\tframe = frame.parent;\n\t\t\tframe.dragging_file_paths = dragging_file_paths;\n\t\t}\n\t};\n\n\tfunction FolderView(folder_path, { asDesktop = false, onStatus, openFolder, openFileOrFolder, onConfigure } = {}) {\n\t\tconst self = this;\n\t\t// TODO: ensure a trailing slash / use path.join where appropriate\n\n\t\tvar $folder_view = $(`<div class=\"folder-view\" tabindex=\"0\">`);\n\n\t\tthis.element = $folder_view[0];\n\n\t\tthis.items = [];\n\n\t\tthis.add_item = (folder_view_item) => {\n\t\t\t$folder_view.append(folder_view_item.element);\n\t\t\tthis.items.push(folder_view_item);\n\t\t\t// if (this.items.length === 1) {\n\t\t\t// \t// this.items[0].element.focus();\n\t\t\t// \tthis.items[0].element.classList.add(\"focused\");\n\t\t\t// }\n\t\t};\n\n\t\t// config:\n\t\t// - [x] view_mode\n\t\t// - [x] sort_mode\n\t\t// - [ ] auto_arrange\n\t\t// - [ ] icon_positions\n\t\t// - [x] view_as_web_page\n\n\t\tthis.config = {};\n\t\tvar storage_key = `folder-config:${asDesktop ? \"desktop\" : folder_path}`;\n\t\ttry {\n\t\t\tconst config_json = localStorage.getItem(storage_key);\n\t\t\tconst config = JSON.parse(config_json);\n\t\t\tif (config) {\n\t\t\t\tObject.assign(this.config, config);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to read folder config:\", e);\n\t\t}\n\t\t// Handling defaults and invalid values at the same time\n\t\tif (!FolderView.VIEW_MODES[this.config.view_mode]) {\n\t\t\tthis.config.view_mode = asDesktop ?\n\t\t\t\tFolderView.VIEW_MODES.DESKTOP :\n\t\t\t\tFolderView.VIEW_MODES.LARGE_ICONS;\n\t\t}\n\t\tif (!FolderView.SORT_MODES[this.config.sort_mode]) {\n\t\t\tthis.config.sort_mode = FolderView.SORT_MODES.NAME;\n\t\t}\n\t\t///this.config.view_as_web_page ??= folder_path !== \"/desktop/\";\n\t\tif (!this.config.view_as_web_page) {\n\t\t\tthis.config.view_as_web_page = folder_path !== \"/desktop/\";\n\t\t}\n\n\t\tthis.element.dataset.viewMode = this.config.view_mode;\n\t\tthis.configure = (config_props) => {\n\t\t\tObject.assign(this.config, config_props);\n\t\t\tif (config_props.view_mode) {\n\t\t\t\tthis.element.dataset.viewMode = config_props.view_mode;\n\t\t\t}\n\t\t\tthis.arrange_icons();\n\t\t\ttry {\n\t\t\t\tlocalStorage.setItem(storage_key, JSON.stringify(this.config));\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\"Can't write to localStorage:\", e);\n\t\t\t}\n\t\t\t///onConfigure?.(config_props);\n\t\t\tif (onConfigure) {\n\t\t\t\tonConfigure(config_props);\n\t\t\t}\n\t\t};\n\n\t\tthis.cycle_view_mode = () => {\n\t\t\t// const view_modes = Object.values(FolderView.VIEW_MODES);\n\t\t\tconst view_modes = [\n\t\t\t\t// FolderView.VIEW_MODES.THUMBNAILS, conditionally?\n\t\t\t\tFolderView.VIEW_MODES.LARGE_ICONS,\n\t\t\t\tFolderView.VIEW_MODES.SMALL_ICONS,\n\t\t\t\tFolderView.VIEW_MODES.LIST,\n\t\t\t\t// FolderView.VIEW_MODES.DETAILS, // same as list for now\n\t\t\t];\n\t\t\tconst current_view_mode_index = view_modes.indexOf(this.config.view_mode);\n\t\t\tconst next_view_mode_index = (current_view_mode_index + 1) % view_modes.length;\n\t\t\tthis.configure({ view_mode: view_modes[next_view_mode_index] });\n\t\t};\n\n\t\tlet waiting_on_stats = false;\n\t\tthis.arrange_icons = () => {\n\t\t\tif (waiting_on_stats) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!self.element.isConnected) { // checking parentElement doesn't work if under a shadowRoot\n\t\t\t\t// console.trace(\"not in DOM\");\n\t\t\t\treturn; // prevent errors computing layout if folder view removed before stats resolve\n\t\t\t}\n\t\t\tconst pending_promises = this.items.map((item) => item.pendingStatPromise).filter(Boolean);\n\t\t\tconst any_pending = pending_promises.length > 0;\n\t\t\tif (any_pending) {\n\t\t\t\tif (!waiting_on_stats) {\n\t\t\t\t\t// should I choose a batch size? or is waiting on all stats fine?\n\t\t\t\t\t// batches mean that it would update multiple times, which could be jarring.\n\t\t\t\t\tPromise.allSettled(pending_promises).then(() => {\n\t\t\t\t\t\twaiting_on_stats = false;\n\t\t\t\t\t\tself.arrange_icons();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\twaiting_on_stats = true;\n\t\t\t}\n\t\t\tconst horizontal_first =\n\t\t\t\tthis.config.view_mode === FolderView.VIEW_MODES.LARGE_ICONS ||\n\t\t\t\tthis.config.view_mode === FolderView.VIEW_MODES.SMALL_ICONS;\n\t\t\tconst large_icons =\n\t\t\t\tthis.config.view_mode === FolderView.VIEW_MODES.LARGE_ICONS ||\n\t\t\t\tthis.config.view_mode === FolderView.VIEW_MODES.DESKTOP;\n\t\t\tconst icon_size = icon_size_by_view_mode[this.config.view_mode] || 32;\n\n\t\t\tconst grid_size_x = large_icons ? grid_size_x_for_large_icons : grid_size_x_for_small_icons;\n\t\t\tconst grid_size_y = large_icons ? grid_size_y_for_large_icons : grid_size_y_for_small_icons;\n\t\t\tvar x = 0;\n\t\t\tvar y = 0;\n\t\t\tconst dir_ness = (item) =>\n\t\t\t\t// system folders always go first\n\t\t\t\t// not all system folder shortcuts on the desktop have real paths (currently)\n\t\t\t\t// so we can't check system_folder_path_to_name, need a separate attribute.\n\t\t\t\t// system_folder_path_to_name[item.file_path] ? 2 :\n\t\t\t\titem.is_system_folder ? 2 :\n\t\t\t\t\t// then folders, then everything else\n\t\t\t\t\t///item.resolvedStats?.isDirectory() ? 1 : 0;\n\t\t\t\t\titem.resolvedStats && item.resolvedStats.isDirectory() ? 1 : 0;\n\t\t\tconst get_ext = (item) => (item.file_path ||/*??*/ \"\").split(\".\").pop();\n\t\t\tif (this.config.sort_mode === FolderView.SORT_MODES.NAME) {\n\t\t\t\tthis.items.sort((a, b) =>\n\t\t\t\t\tdir_ness(b) - dir_ness(a) ||\n\t\t\t\t\t(a.title ||/*??*/ \"\").localeCompare(b.title ||/*??*/ \"\")\n\t\t\t\t);\n\t\t\t} else if (this.config.sort_mode === FolderView.SORT_MODES.TYPE) {\n\t\t\t\tthis.items.sort((a, b) =>\n\t\t\t\t\tdir_ness(b) - dir_ness(a) ||\n\t\t\t\t\t(get_ext(a) ||/*??*/ \"\").localeCompare(get_ext(b) ||/*??*/ \"\")\n\t\t\t\t);\n\t\t\t} else if (this.config.sort_mode === FolderView.SORT_MODES.SIZE) {\n\t\t\t\tthis.items.sort((a, b) =>\n\t\t\t\t\tdir_ness(b) - dir_ness(a) ||\n\t\t\t\t\t(a.resolvedStats.size ||/*??*/ 0) - (b.resolvedStats && b.resolvedStats.size ||/*??*/ 0)\n\t\t\t\t);\n\t\t\t} else if (this.config.sort_mode === FolderView.SORT_MODES.DATE) {\n\t\t\t\tthis.items.sort((a, b) =>\n\t\t\t\t\tdir_ness(b) - dir_ness(a) ||\n\t\t\t\t\t(a.resolvedStats && a.resolvedStats.mtime ||/*??*/ 0) - (b.resolvedStats && b.resolvedStats.mtime ||/*??*/ 0)\n\t\t\t\t);\n\t\t\t}\n\t\t\tfor (const item of this.items) {\n\t\t\t\t$(item.element).css({\n\t\t\t\t\tleft: x,\n\t\t\t\t\ttop: y,\n\t\t\t\t});\n\t\t\t\tif (horizontal_first) {\n\t\t\t\t\tx += grid_size_x;\n\t\t\t\t\tif (x + grid_size_x > $folder_view[0].clientWidth) {\n\t\t\t\t\t\ty += grid_size_y;\n\t\t\t\t\t\tx = 0;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\ty += grid_size_y;\n\t\t\t\t\tif (y + grid_size_y > $folder_view[0].clientHeight) {\n\t\t\t\t\t\tx += grid_size_x;\n\t\t\t\t\t\ty = 0;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\titem.setIconSize(icon_size);\n\n\t\t\t\t// apply sort - well, I'm positioning things absolutely, so I don't need to do this (AS LONG AS I DON'T ASSUME THE DOM ORDER, and use self.items instead)\n\t\t\t\t// and this is very slow for large folders.\n\t\t\t\t// this.element.appendChild(item.element);\n\t\t\t}\n\n\t\t\tif (!any_pending) {\n\t\t\t\t// this.items[0].element.classList.add(\"focused\");\n\t\t\t\tthis.items.forEach((item, index) => {\n\t\t\t\t\titem.element.classList.toggle(\"focused\", index === 0);\n\t\t\t\t});\n\t\t\t\t// console.log(\"this.element.ownerDocument.activeElement\", this.element.ownerDocument.activeElement);\n\t\t\t\t// if (this.element.ownerDocument.activeElement === this.element) {\n\t\t\t\tthis.items[0] && this.items[0].element.focus();\n\t\t\t\t// }\n\t\t\t\tupdateStatus();\n\t\t\t}\n\t\t};\n\n\t\tfunction updateStatus() {\n\t\t\tonStatus && onStatus({\n\t\t\t\titems: self.items,\n\t\t\t\tselectedItems: self.items.filter((item) => item.element.classList.contains(\"selected\")),\n\t\t\t});\n\t\t}\n\n\t\tfunction deleteRecursiveSync(fs, itemPath) {\n\t\t\tif (fs.statSync(itemPath).isDirectory()) {\n\t\t\t\tfor (const childItemName of fs.readdirSync(itemPath)) {\n\t\t\t\t\tdeleteRecursiveSync(itemPath + \"/\" + childItemName);\n\t\t\t\t}\n\t\t\t\tfs.rmdirSync(itemPath);\n\t\t\t} else {\n\t\t\t\tfs.unlinkSync(itemPath);\n\t\t\t}\n\t\t}\n\n\t\tself.focus = function () {\n\t\t\tif ($folder_view.is(\":focus-within\")) {\n\t\t\t\treturn; // don't mess with renaming inputs, for instance, if you click on the input\n\t\t\t}\n\t\t\t$folder_view.focus();\n\t\t\t// This doesn't do much if it's yet to be populated:\n\t\t\tif ($folder_view.find(\".desktop-icon.focused\").length === 0) {\n\t\t\t\tthis.items[0] && this.items[0].element.focus();\n\t\t\t}\n\t\t\t// Initial focus is handled in arrange_icons currently.\n\t\t};\n\n\t\tself.select_all = function () {\n\t\t\t$folder_view.find(\".desktop-icon\").addClass(\"selected\");\n\t\t\tupdateStatus();\n\t\t};\n\n\t\tself.select_inverse = function () {\n\t\t\t$folder_view.find(\".desktop-icon\").each(function () {\n\t\t\t\t$(this).toggleClass(\"selected\");\n\t\t\t});\n\t\t\tupdateStatus();\n\t\t};\n\n\t\tself.delete_selected = function () {\n\t\t\tconst selected_file_paths = $folder_view.find(\".desktop-icon.selected\")\n\t\t\t\t.toArray().map((icon_el) => icon_el.dataset.filePath)\n\t\t\t\t.filter((file_path) => system_folder_path_to_name[file_path] === undefined);\n\n\t\t\tif (selected_file_paths.length === 0) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// @NOTE: if system setting for displaying file extensions was implemented, this should be changed...\n\t\t\tconst name_of_first = $folder_view.find(\".desktop-icon.selected .title\").text().replace(/\\.([^.]+)$/, \"\");\n\t\t\tshowMessageBox({\n\t\t\t\ttitle: selected_file_paths.length === 1 ? \"Confirm File Delete\" : \"Confirm Multiple File Delete\",\n\t\t\t\tmessage: selected_file_paths.length === 1 ?\n\t\t\t\t\t`Are you sure you want to delete '${name_of_first}'?` :\n\t\t\t\t\t`Are you sure you want to delete these ${selected_file_paths.length} items?`,\n\t\t\t\tbuttons: [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: \"Yes\",\n\t\t\t\t\t\tvalue: \"yes\",\n\t\t\t\t\t\tdefault: true,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: \"No\",\n\t\t\t\t\t\tvalue: \"no\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\ticonID: \"nuke\",\n\t\t\t}).then((result) => {\n\t\t\t\tif (result !== \"yes\") {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tFilesystemSetup.withFilesystem(function () {\n\t\t\t\t\tconst fs = BrowserFS.BFSRequire('fs');\n\t\t\t\t\tlet num_deleted = 0;\n\t\t\t\t\tfor (const file_path of selected_file_paths) {\n\t\t\t\t\t\tlet single_delete_success = false;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tdeleteRecursiveSync(fs, file_path);\n\t\t\t\t\t\t\tsingle_delete_success = true;\n\t\t\t\t\t\t\tnum_deleted += 1;\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tconsole.log(\"failed to delete\", file_path, error);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (single_delete_success) {\n\t\t\t\t\t\t\tself.items.forEach((item) => {\n\t\t\t\t\t\t\t\tif (item.element.dataset.filePath === file_path) {\n\t\t\t\t\t\t\t\t\titem.element.remove();\n\t\t\t\t\t\t\t\t\tupdateStatus();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// TODO: pluralization, and be more specific about folders vs files vs selected items, and total\n\t\t\t\t\tif (num_deleted < selected_file_paths.length) {\n\t\t\t\t\t\talert(`Failed to delete ${selected_file_paths.length - num_deleted} items.`);\n\t\t\t\t\t}\n\t\t\t\t\t// self.refresh();\n\t\t\t\t});\n\t\t\t});\n\t\t};\n\n\t\tself.start_rename = () => {\n\t\t\tfor (const item of self.items) {\n\t\t\t\tif (item.element.classList.contains(\"focused\")) {\n\t\t\t\t\titem.start_rename();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\t// Read the folder and create icon items\n\t\tFilesystemSetup.withFilesystem(function () {\n\t\t\tvar fs = BrowserFS.BFSRequire('fs');\n\t\t\tfs.readdir(folder_path, function (error, contents) {\n\t\t\t\tif (error) {\n\t\t\t\t\talert(\"Failed to read contents of the directory \" + folder_path);\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\n\t\t\t\tfor (var i = 0; i < contents.length; i++) {\n\t\t\t\t\tvar fname = contents[i];\n\t\t\t\t\tadd_fs_item(fname, -1000, -1000);\n\t\t\t\t}\n\t\t\t\tself.arrange_icons();\n\t\t\t});\n\t\t});\n\n\t\t// NOTE: in Windows, icons by default only get moved if they go offscreen (by maybe half the grid size)\n\t\t// we're handling it as if Auto Arrange is on (@TODO: support Auto Arrange off)\n\t\tconst resizeObserver = new ResizeObserver(entries => {\n\t\t\tself.arrange_icons();\n\t\t});\n\t\tresizeObserver.observe(self.element);\n\n\t\t// Handle selecting icons\n\t\t(function () {\n\t\t\tvar $marquee = $(\"<div class='marquee'/>\").appendTo($folder_view).hide();\n\t\t\tvar start = { x: 0, y: 0 };\n\t\t\tvar current = { x: 0, y: 0 };\n\t\t\tvar dragging = false;\n\t\t\tvar drag_update = function () {\n\t\t\t\tvar min_x = Math.min(start.x, current.x);\n\t\t\t\tvar min_y = Math.min(start.y, current.y);\n\t\t\t\tvar max_x = Math.max(start.x, current.x);\n\t\t\t\tvar max_y = Math.max(start.y, current.y);\n\t\t\t\t$marquee.show().css({\n\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\tleft: min_x,\n\t\t\t\t\ttop: min_y,\n\t\t\t\t\twidth: max_x - min_x,\n\t\t\t\t\theight: max_y - min_y,\n\t\t\t\t});\n\t\t\t\t$folder_view.find(\".desktop-icon\").each(function (i, folder_view_icon) {\n\t\t\t\t\t// Note: this is apparently considerably more complex in Windows 98\n\t\t\t\t\t// like things are not considered the same heights and/or positions based on the size of their names\n\t\t\t\t\tvar icon_offset = $(folder_view_icon).offset();\n\t\t\t\t\tvar icon_left = parseFloat($(folder_view_icon).css(\"left\"));\n\t\t\t\t\tvar icon_top = parseFloat($(folder_view_icon).css(\"top\"));\n\t\t\t\t\tvar icon_width = $(folder_view_icon).width();\n\t\t\t\t\tvar icon_height = $(folder_view_icon).height();\n\t\t\t\t\tfolder_view_icon.classList.toggle(\"selected\",\n\t\t\t\t\t\ticon_left < max_x &&\n\t\t\t\t\t\ticon_top < max_y &&\n\t\t\t\t\t\ticon_left + icon_width > min_x &&\n\t\t\t\t\t\ticon_top + icon_height > min_y\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t\tupdateStatus();\n\t\t\t};\n\t\t\t$folder_view.on(\"pointerdown\", \".desktop-icon\", function (e) {\n\t\t\t\tconst item_el = e.currentTarget;\n\t\t\t\titem_el._was_selected_at_pointerdown = item_el.classList.contains(\"selected\");\n\t\t\t\tselect_item(item_el, e, true);\n\t\t\t});\n\t\t\t$folder_view.on(\"pointerdown\", function (e) {\n\t\t\t\t// TODO: allow a margin of mouse movement before starting selecting\n\t\t\t\tvar view_was_focused = $folder_view.is(\":focus-within\");\n\t\t\t\tself.focus();\n\t\t\t\tvar $icon = $(e.target).closest(\".desktop-icon\");\n\t\t\t\t$marquee.hide();\n\t\t\t\t// var folder_view_offset = $folder_view.offset();\n\t\t\t\tvar folder_view_offset = self.element.getBoundingClientRect();\n\t\t\t\tstart = { x: e.pageX - folder_view_offset.left + $folder_view[0].scrollLeft, y: e.pageY - folder_view_offset.top + $folder_view[0].scrollTop };\n\t\t\t\tcurrent = { x: e.pageX - folder_view_offset.left + $folder_view[0].scrollLeft, y: e.pageY - folder_view_offset.top + $folder_view[0].scrollTop };\n\t\t\t\tif ($icon.length > 0) {\n\t\t\t\t\t$marquee.hide();\n\t\t\t\t\tset_dragging_file_paths($(\".desktop-icon.selected\").get().map((icon) =>\n\t\t\t\t\t\ticon.dataset.filePath\n\t\t\t\t\t).filter((file_path) => file_path));\n\t\t\t\t} else {\n\t\t\t\t\tset_dragging_file_paths([]);\n\t\t\t\t\t// start dragging marquee unless over scrollbar\n\t\t\t\t\tlet scrollbar_width = $folder_view[0].offsetWidth - $folder_view[0].clientWidth;\n\t\t\t\t\tlet scrollbar_height = $folder_view[0].offsetHeight - $folder_view[0].clientHeight;\n\t\t\t\t\tscrollbar_width += 2; // for marquee border (@TODO: make marquee unable to cause scrollbar, by putting it in an overflow: hidden container)\n\t\t\t\t\tscrollbar_height += 2; // for marquee border\n\t\t\t\t\tconst rect = $folder_view[0].getBoundingClientRect();\n\t\t\t\t\tconst over_scrollbar = e.clientX > rect.right - scrollbar_width || e.clientY > rect.bottom - scrollbar_height;\n\t\t\t\t\t// console.log(`over_scrollbar: ${over_scrollbar}, e.clientX: ${e.clientX}, rect.right - scrollbar_width: ${rect.right - scrollbar_width}`);\n\t\t\t\t\tdragging = !over_scrollbar;\n\t\t\t\t\t// don't deselect right away unless the \n\t\t\t\t\t// TODO: deselect on pointerUP, if the desktop was focused\n\t\t\t\t\t// or when starting selecting (re: TODO: allow a margin of movement before starting selecting)\n\t\t\t\t\tif (dragging && view_was_focused) {\n\t\t\t\t\t\tdrag_update();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$($folder_view[0].ownerDocument).on(\"pointermove\", handle_pointermove);\n\t\t\t\t$($folder_view[0].ownerDocument).on(\"pointerup blur\", handle_pointerup_blur);\n\t\t\t});\n\t\t\tfunction handle_pointermove (e) {\n\t\t\t\t// var folder_view_offset = $folder_view.offset();\n\t\t\t\tvar folder_view_offset = self.element.getBoundingClientRect();\n\t\t\t\tcurrent = { x: e.pageX - folder_view_offset.left + $folder_view[0].scrollLeft, y: e.pageY - folder_view_offset.top + $folder_view[0].scrollTop };\n\t\t\t\t// clamp coordinates to within folder view\n\t\t\t\t// This accomplishes three things:\n\t\t\t\t// 1. it improves the visual coherence of the marquee as an object\n\t\t\t\t// 2. it makes the marquee not cause a scrollbar\n\t\t\t\t// 3. it prevents selecting things you can't see\n\t\t\t\tconst scrollbar_width = $folder_view.width() - $folder_view[0].clientWidth;\n\t\t\t\tconst scrollbar_height = $folder_view.height() - $folder_view[0].clientHeight;\n\t\t\t\tconst clamp_left = $folder_view[0].scrollLeft;\n\t\t\t\tconst clamp_top = $folder_view[0].scrollTop;\n\t\t\t\tconst clamp_right = $folder_view.width() + $folder_view[0].scrollLeft - scrollbar_width;\n\t\t\t\tconst clamp_bottom = $folder_view.height() + $folder_view[0].scrollTop - scrollbar_height;\n\t\t\t\tcurrent.x = Math.max(clamp_left, Math.min(clamp_right, current.x));\n\t\t\t\tcurrent.y = Math.max(clamp_top, Math.min(clamp_bottom, current.y));\n\t\t\t\tif (dragging) {\n\t\t\t\t\tdrag_update();\n\t\t\t\t\t// scroll the view by dragging the mouse at/past the edge\n\t\t\t\t\tconst scroll_speed = 10;\n\t\t\t\t\tif (current.x === clamp_left) {\n\t\t\t\t\t\t$folder_view[0].scrollLeft -= scroll_speed;\n\t\t\t\t\t} else if (current.x === clamp_right) {\n\t\t\t\t\t\t$folder_view[0].scrollLeft += scroll_speed;\n\t\t\t\t\t}\n\t\t\t\t\tif (current.y === clamp_top) {\n\t\t\t\t\t\t$folder_view[0].scrollTop -= scroll_speed;\n\t\t\t\t\t} else if (current.y === clamp_bottom) {\n\t\t\t\t\t\t$folder_view[0].scrollTop += scroll_speed;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\tfunction handle_pointerup_blur() {\n\t\t\t\t$marquee.hide();\n\t\t\t\tdragging = false;\n\t\t\t\tset_dragging_file_paths([]);\n\t\t\t\t$($folder_view[0].ownerDocument).off(\"pointermove\", handle_pointermove);\n\t\t\t\t$($folder_view[0].ownerDocument).off(\"pointerup blur\", handle_pointerup_blur);\n\t\t\t};\n\t\t})();\n\n\t\tlet search_string = \"\";\n\t\tlet search_timeout;\n\n\t\t$folder_view.on(\"keydown\", function (e) {\n\t\t\t// console.log(\"keydown\", e.isDefaultPrevented());\n\n\t\t\tif (e.target.tagName === \"INPUT\" || e.target.tagName === \"TEXTAREA\") {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (e.key == \"Enter\") {\n\t\t\t\t$folder_view.find(\".desktop-icon.selected\").trigger(\"dblclick\");\n\t\t\t} else if (e.ctrlKey && e.key == \"a\") {\n\t\t\t\tfolder_view.select_all();\n\t\t\t\te.preventDefault();\n\t\t\t} else if (e.key == \"Delete\") {\n\t\t\t\tself.delete_selected();\n\t\t\t\te.preventDefault();\n\t\t\t} else if (\n\t\t\t\te.key == \"ArrowLeft\" ||\n\t\t\t\te.key == \"ArrowRight\" ||\n\t\t\t\te.key == \"ArrowUp\" ||\n\t\t\t\te.key == \"ArrowDown\"\n\t\t\t) {\n\t\t\t\te.preventDefault();\n\t\t\t\tconst move_x = e.key == \"ArrowLeft\" ? -1 : e.key == \"ArrowRight\" ? 1 : 0;\n\t\t\t\tconst move_y = e.key == \"ArrowUp\" ? -1 : e.key == \"ArrowDown\" ? 1 : 0;\n\t\t\t\tnavigate_grid(move_x, move_y, e);\n\t\t\t\t// @TODO: wrap around columns in list view\n\t\t\t} else if (\n\t\t\t\te.key == \"PageUp\" ||\n\t\t\t\te.key == \"PageDown\"\n\t\t\t) {\n\t\t\t\te.preventDefault();\n\t\t\t\tif (self.config.view_mode === FolderView.VIEW_MODES.LIST) {\n\t\t\t\t\tconst x_dir = e.key == \"PageUp\" ? -1 : 1;\n\t\t\t\t\tconst full_page_size = $folder_view.width();\n\t\t\t\t\tconst item_width = $folder_view.find(\".desktop-icon\").outerWidth();\n\t\t\t\t\tconst page_increment = full_page_size - item_width;\n\t\t\t\t\tfor (let increment = page_increment; increment > 0; increment -= item_width) {\n\t\t\t\t\t\tif (navigate_grid(x_dir * increment / item_width, 0, e)) { // grid units\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconst y_dir = e.key == \"PageUp\" ? -1 : 1;\n\t\t\t\t\tconst full_page_size = $folder_view.height();\n\t\t\t\t\tconst item_height = $folder_view.find(\".desktop-icon\").outerHeight();\n\t\t\t\t\tconst page_increment = full_page_size - item_height;\n\t\t\t\t\tfor (let increment = page_increment; increment > 0; increment -= item_height) {\n\t\t\t\t\t\tif (navigate_grid(0, y_dir * increment / item_height, e)) { // grid units\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (e.key == \"Home\") {\n\t\t\t\te.preventDefault();\n\t\t\t\tselect_item(self.items[0], e);\n\t\t\t} else if (e.key == \"End\") {\n\t\t\t\te.preventDefault();\n\t\t\t\tselect_item(self.items[self.items.length - 1], e);\n\t\t\t} else if (e.key == \" \" && search_string.length === 0) {\n\t\t\t\t// Usually there's something focused,\n\t\t\t\t// so this is pretty \"niche\", but space bar selects the focused item.\n\t\t\t\t// Ctrl+Space toggles selection of the focused item.\n\t\t\t\te.preventDefault();\n\t\t\t\tif ((e.ctrlKey || e.metaKey) && $folder_view.find(\".desktop-icon.selected\").length > 0) {\n\t\t\t\t\t$folder_view.find(\".desktop-icon.focused\").toggleClass(\"selected\");\n\t\t\t\t} else {\n\t\t\t\t\t$folder_view.find(\".desktop-icon.focused\").addClass(\"selected\"); // don't use select_item() as it shouldn't unselect anything\n\t\t\t\t}\n\t\t\t\tupdateStatus();\n\t\t\t} else if (e.key === \"F2\") {\n\t\t\t\te.preventDefault();\n\t\t\t\tself.start_rename();\n\t\t\t} else {\n\t\t\t\tif (e.isDefaultPrevented() || e.ctrlKey || e.altKey || e.metaKey) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (search_timeout) {\n\t\t\t\t\tclearTimeout(search_timeout);\n\t\t\t\t}\n\t\t\t\tif (search_string === e.key) {\n\t\t\t\t\t// cycle through items starting with the same letter\n\t\t\t\t\t// Note: not adding to search_string here, so it stays as e.key\n\t\t\t\t\t// @TODO: what if you have an item like \"Llama Photos\", can you not search for \"Llama\" to go to it, in the presence of other 'L' items?\n\t\t\t\t\tconst candidates = self.items.filter((item) => {\n\t\t\t\t\t\tconst title = item.element.querySelector(\".title\").textContent; // @TODO: proper access\n\t\t\t\t\t\treturn title.toLocaleLowerCase().startsWith(search_string.toLocaleLowerCase());\n\t\t\t\t\t});\n\t\t\t\t\tif (candidates.length > 0) {\n\t\t\t\t\t\tconst index = candidates.findIndex((item) => item.element.classList.contains(\"focused\"));\n\t\t\t\t\t\tif (index === -1) {\n\t\t\t\t\t\t\tselect_item(candidates[0], e);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tselect_item(candidates[(index + 1) % candidates.length], e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// focus item matching search string\n\t\t\t\t\tif (e.key !== \"Shift\" && e.key !== \"Compose\") { // Note: composition doesn't actually work; I'd need an input element to do this properly\n\t\t\t\t\t\tsearch_string += e.key;\n\t\t\t\t\t}\n\t\t\t\t\t// console.log(\"search_string: \" + search_string);\n\t\t\t\t\tsearch_timeout = setTimeout(function () {\n\t\t\t\t\t\tsearch_string = \"\";\n\t\t\t\t\t\t// console.log(\"reset search_string\");\n\t\t\t\t\t}, 1000);\n\n\t\t\t\t\tif (search_string.length > 0) {\n\t\t\t\t\t\tfor (const item of self.items) {\n\t\t\t\t\t\t\tconst title = item.element.querySelector(\".title\").textContent; // @TODO: proper access\n\t\t\t\t\t\t\tif (title.toLocaleLowerCase().startsWith(search_string.toLocaleLowerCase())) {\n\t\t\t\t\t\t\t\tselect_item(item, {}); // passing fake event so it doesn't use shiftKey to determine multi-select\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tvar selection_anchor_item_el;\n\n\t\tfunction select_item(item_or_item_el, event, delay_scroll) {\n\t\t\tconst item_el_to_select = item_or_item_el instanceof Element ? item_or_item_el : item_or_item_el.element;\n\t\t\tconst extend_selection = event.shiftKey;\n\t\t\tif (selection_anchor_item_el && !self.items.some(item => item.element === selection_anchor_item_el)) {\n\t\t\t\tselection_anchor_item_el = null; // item was removed somehow\n\t\t\t}\n\t\t\tif (extend_selection && !selection_anchor_item_el) {\n\t\t\t\t// select_item() hasn't been called yet (e.g. hitting Shift+Down without first hitting an arrow key without Shift, in a newly loaded folder view)\n\t\t\t\t// use the focused item as the anchor\n\t\t\t\tselection_anchor_item_el = self.items.find((item) => item.element.classList.contains(\"focused\"))/*?*/.element ||/*??*/ item_el_to_select;\n\t\t\t}\n\t\t\t// console.log(\"select_item\", item_or_item_el, event, \"extend_selection\", extend_selection);\n\t\t\t$folder_view.find(\".desktop-icon\").each(function (i, item_el) {\n\t\t\t\tif (extend_selection) {\n\t\t\t\t\t// select items in a rectangle between the anchor and the new item\n\t\t\t\t\tconst anchor_rect = selection_anchor_item_el.getBoundingClientRect();\n\t\t\t\t\tconst item_el_to_select_rect = item_el_to_select.getBoundingClientRect();\n\t\t\t\t\tconst item_el_rect = item_el.getBoundingClientRect();\n\t\t\t\t\tconst rectangle = {\n\t\t\t\t\t\ttop: Math.min(anchor_rect.top, item_el_to_select_rect.top),\n\t\t\t\t\t\tleft: Math.min(anchor_rect.left, item_el_to_select_rect.left),\n\t\t\t\t\t\tbottom: Math.max(anchor_rect.bottom, item_el_to_select_rect.bottom),\n\t\t\t\t\t\tright: Math.max(anchor_rect.right, item_el_to_select_rect.right)\n\t\t\t\t\t};\n\t\t\t\t\t$(item_el).toggleClass(\"selected\", (\n\t\t\t\t\t\titem_el_rect.top >= rectangle.top &&\n\t\t\t\t\t\titem_el_rect.left >= rectangle.left &&\n\t\t\t\t\t\titem_el_rect.bottom <= rectangle.bottom &&\n\t\t\t\t\t\titem_el_rect.right <= rectangle.right\n\t\t\t\t\t));\n\t\t\t\t} else {\n\t\t\t\t\tif (event.type === \"pointerdown\" && (event.ctrlKey || event.metaKey)) {\n\t\t\t\t\t\t// toggle with Ctrl+click\n\t\t\t\t\t\tif (item_el === item_el_to_select) {\n\t\t\t\t\t\t\t$(item_el).toggleClass(\"selected\");\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// select with click or arrow keys,\n\t\t\t\t\t\t// but if holding Ctrl it should only move focus, not select.\n\t\t\t\t\t\tif (!event.ctrlKey && !event.metaKey) {\n\t\t\t\t\t\t\titem_el.classList.toggle(\"selected\", item_el === item_el_to_select);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\titem_el.classList.toggle(\"focused\", item_el === item_el_to_select);\n\t\t\t});\n\t\t\tif (delay_scroll) {\n\t\t\t\t// Windows 98 does this for clicks.\n\t\t\t\t// I'm not sure if it's to make it less jarring (I feel like there's a case for that),\n\t\t\t\t// or if it's to avoid some problems with drag and drop perhaps.\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\titem_el_to_select.scrollIntoView({ block: \"nearest\" });\n\t\t\t\t}, 500);\n\t\t\t} else {\n\t\t\t\titem_el_to_select.scrollIntoView({ block: \"nearest\" });\n\t\t\t}\n\t\t\tupdateStatus();\n\n\t\t\tif (!event.shiftKey) {\n\t\t\t\tselection_anchor_item_el = item_el_to_select;\n\t\t\t}\n\t\t}\n\n\t\tfunction navigate_grid(move_x, move_y, event) {\n\t\t\t// @TODO: how this is supposed to work for icons not aligned to the grid?\n\t\t\t// I can imagine a few ways of doing it, like scanning for the nearest icon with a sweeping line or perhaps a \"cone\" (triangle) (changing width line)\n\t\t\t// but it'd be nice to know for sure\n\n\t\t\tlet $starting_icon = $folder_view.find(\".desktop-icon.focused\");\n\t\t\t// ideally we'd keep a focused icon always,\n\t\t\t// use the nearest icon upwards after a delete etc.\n\t\t\t// but I can't guarantee that\n\t\t\tif ($starting_icon.length == 0) {\n\t\t\t\t$starting_icon = $folder_view.find(\".desktop-icon\");\n\t\t\t}\n\t\t\tif ($starting_icon.length == 0) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t// @TODO: use the actual grid size, not a calculated item size\n\t\t\t// or make it more grid-agnostic (Windows 98 allowed freely moving icons around)\n\t\t\tconst item_width = $starting_icon.outerWidth();\n\t\t\tconst item_height = $starting_icon.outerHeight();\n\t\t\t// const item_pos = $starting_icon.position();\n\t\t\tconst item_pos = $starting_icon[0].getBoundingClientRect();\n\t\t\tlet x = item_pos.left;// + item_width / 2;\n\t\t\tlet y = item_pos.top;// + item_height / 2;\n\t\t\tx += move_x * item_width;\n\t\t\ty += move_y * item_height;\n\t\t\tconst candidates = $folder_view.find(\".desktop-icon\").toArray().sort(function (a, b) {\n\t\t\t\t// const a_pos = $(a).position();\n\t\t\t\t// const b_pos = $(b).position();\n\t\t\t\tconst a_pos = a.getBoundingClientRect();\n\t\t\t\tconst b_pos = b.getBoundingClientRect();\n\t\t\t\tconst a_dist = Math.abs(a_pos.left - x) + Math.abs(a_pos.top - y);\n\t\t\t\tconst b_dist = Math.abs(b_pos.left - x) + Math.abs(b_pos.top - y);\n\t\t\t\treturn a_dist - b_dist;\n\t\t\t});\n\t\t\tconst $icon = $(candidates[0]);\n\t\t\tif ($icon.length > 0) {\n\t\t\t\tselect_item($icon[0], event);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\n\t\tvar stat = function (file_path) {\n\t\t\t// fs should be guaranteed available at this point\n\t\t\t// as this function is currently used\n\t\t\tvar fs = BrowserFS.BFSRequire('fs');\n\t\t\treturn new Promise(function (resolve, reject) {\n\t\t\t\tfs.stat(file_path, function (err, stats) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn reject(err);\n\t\t\t\t\t}\n\t\t\t\t\tresolve(stats);\n\t\t\t\t});\n\t\t\t});\n\t\t};\n\t\tvar icon_id_from_stats_and_path = function (stats, file_path) {\n\t\t\tif (stats.isDirectory()) {\n\t\t\t\t// if extending this to different folder icons,\n\t\t\t\t// note that \"folder\" is relied on (for sorting)\n\t\t\t\treturn \"folder\";\n\t\t\t}\n\t\t\tvar file_extension = helpers.file_extension_from_path(file_path);\n\t\t\t// TODO: look inside exe for icons\n\t\t\tvar icon_name = file_extension_icons[file_extension.toLowerCase()];\n\t\t\treturn icon_name || \"document\";\n\t\t};\n\t\tvar icons_from_icon_id = function (icon_id) {\n\t\t\treturn {\n\t\t\t\t16: helpers.getIconPath(icon_id, 16),\n\t\t\t\t32: helpers.getIconPath(icon_id, 32),\n\t\t\t\t48: helpers.getIconPath(icon_id, 48),\n\t\t\t};\n\t\t};\n\n\t\t// var add_fs_item = function(file_path, x, y){\n\t\tvar add_fs_item = function (initial_file_name, x, y) {\n\t\t\tvar initial_file_path = folder_path + initial_file_name;\n\t\t\tvar item = new FolderViewItem({\n\t\t\t\ttitle: initial_file_name,\n\t\t\t\topen: async function () {\n\t\t\t\t\tif (openFolder) {\n\t\t\t\t\t\tlet stats = item.resolvedStats;\n\t\t\t\t\t\tif (!stats) {\n\t\t\t\t\t\t\tif (item.pendingStatPromise) {\n\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\tstats = await item.pendingStatPromise;\n\t\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\t\talert(`Failed to get info about '${item.file_path}':\\n\\n${error}`);\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\talert(`Cannot open '${item.file_path}'. File type information not available.`);\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (stats.isDirectory()) {\n\t\t\t\t\t\t\topenFolder(item.file_path);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (openFileOrFolder) {\n\t\t\t\t\t\topenFileOrFolder(item.file_path);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\talert(`No handler for opening files or folders.`);\n\t\t\t\t},\n\t\t\t\trename: (new_name) => {\n\t\t\t\t\tvar fs = BrowserFS.BFSRequire('fs');\n\t\t\t\t\treturn new Promise(function (resolve, reject) {\n\t\t\t\t\t\tconst new_file_path = folder_path + new_name;\n\t\t\t\t\t\tfs.rename(item.file_path, new_file_path, function (err) {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\treturn reject(err);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\titem.file_path = new_file_path;\n\t\t\t\t\t\t\titem.title = new_name;\n\t\t\t\t\t\t\titem.element.dataset.filePath = new_file_path;\n\t\t\t\t\t\t\tif (item.resolvedStats) {\n\t\t\t\t\t\t\t\tconst icon_id = icon_id_from_stats_and_path(item.resolvedStats, new_file_path);\n\t\t\t\t\t\t\t\titem.setIcons(icons_from_icon_id(icon_id));\n\t\t\t\t\t\t\t} // else the icon will be updated when the stats are resolved\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tshortcut: initial_file_path.match(/\\.url$/),\n\t\t\t\tfile_path: initial_file_path,\n\t\t\t\ticonSize: icon_size_by_view_mode[self.config.view_mode],\n\t\t\t});\n\t\t\titem.pendingStatPromise = stat(initial_file_path);\n\t\t\titem.pendingStatPromise.then((stats) => {\n\t\t\t\titem.pendingStatPromise = null;\n\t\t\t\titem.resolvedStats = stats; // trying to indicate in the name the async nature\n\t\t\t\t// @TODO: know which sizes are available\n\t\t\t\tconst icon_id = icon_id_from_stats_and_path(stats, item.file_path);\n\t\t\t\titem.setIcons(icons_from_icon_id(icon_id));\n\t\t\t}, (error) => {\n\t\t\t\t// Without this, the folder view infinitely recursed arranging items because\n\t\t\t\t// it was waiting for the promise to be settled (resolved or rejected),\n\t\t\t\t// but checking for item.pendingStatPromise to see if it's still pending.\n\t\t\t\titem.pendingStatPromise = null;\n\t\t\t});\n\t\t\tself.add_item(item);\n\t\t\t$(item.element).css({\n\t\t\t\tleft: x,\n\t\t\t\ttop: y,\n\t\t\t});\n\t\t};\n\t\tvar drop_file = function (file, x, y) {\n\n\t\t\tvar Buffer = BrowserFS.BFSRequire('buffer').Buffer;\n\t\t\tvar fs = BrowserFS.BFSRequire('fs');\n\n\t\t\tvar file_path = folder_path + file.name;\n\n\t\t\tvar reader = new FileReader;\n\t\t\treader.onerror = function (error) {\n\t\t\t\tthrow error;\n\t\t\t};\n\t\t\treader.onload = function (e) {\n\t\t\t\tvar buffer = Buffer.from(reader.result);\n\t\t\t\tfs.writeFile(file_path, buffer, { flag: \"wx\" }, function (error) {\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\tif (error.code === \"EEXIST\") {\n\t\t\t\t\t\t\t// TODO: options to replace or keep both files with numbers like \"file (1).txt\"\n\t\t\t\t\t\t\talert(\"File already exists!\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthrow error;\n\t\t\t\t\t}\n\t\t\t\t\t// TODO: could do utimes as well with file.lastModified or file.lastModifiedDate\n\n\t\t\t\t\tadd_fs_item(file.name, x, y);\n\t\t\t\t});\n\t\t\t};\n\t\t\treader.readAsArrayBuffer(file);\n\t\t};\n\n\t\tvar dragover_pageX = 0;\n\t\tvar dragover_pageY = 0;\n\t\t$folder_view.on(\"dragover\", function (e) {\n\t\t\te.preventDefault();\n\t\t\tdragover_pageX = e.originalEvent.pageX;\n\t\t\tdragover_pageY = e.originalEvent.pageY;\n\t\t});\n\t\t$folder_view.on(\"drop\", function (e) {\n\t\t\te.preventDefault();\n\t\t\tvar x = e.originalEvent.pageX || dragover_pageX;\n\t\t\tvar y = e.originalEvent.pageY || e.dragover_pageY\n\t\t\t// TODO: handle dragging icons onto other icons\n\t\t\twithFilesystem(function () {\n\t\t\t\tvar files = e.originalEvent.dataTransfer.files;\n\t\t\t\t$.map(files, function (file) {\n\t\t\t\t\t// TODO: stagger positions, don't just put everything on top of each other\n\t\t\t\t\t// also center on the mouse position; currently it's placed via the top left\n\t\t\t\t\tdrop_file(file, x, y);\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\treturn FolderView;\n});\ndefine('skylark-98js/os-gui/$Window',[\n\t\"skylark-jquery\",\n\t\"../win98\"\n],function($,win98js){\n\n\t// TODO: E\\(\"([a-z]+)\"\\) -> \"<$1>\" or get rid of jQuery as a dependency\n\tfunction E(tagName) {\n\t\treturn document.createElement(tagName);\n\t}\n\n\tfunction element_to_string(element) {\n\t\t// returns a CSS-selector-like string for the given element\n\t\t// if (element instanceof Element) { // doesn't work with different window.Element from iframes\n\t\tif (typeof element === \"object\" && \"tagName\" in element) {\n\t\t\treturn element.tagName.toLowerCase() +\n\t\t\t\t(element.id ? \"#\" + element.id : \"\") +\n\t\t\t\t(element.className ? \".\" + element.className.split(\" \").join(\".\") : \"\") +\n\t\t\t\t(element.src ? `[src=\"${element.src}\"]` : \"\") + // Note: not escaped; may not actually work as a selector (but this is for debugging)\n\t\t\t\t(element.srcdoc ? \"[srcdoc]\" : \"\") + // (srcdoc can be long)\n\t\t\t\t(element.href ? `[href=\"${element.href}\"]` : \"\");\n\t\t} else if (element) {\n\t\t\treturn element.constructor.name;\n\t\t} else {\n\t\t\treturn `${element}`;\n\t\t}\n\t}\n\n\tfunction find_tabstops(container_el) {\n\t\tconst $el = $(container_el);\n\t\t// This function finds focusable controls, but not necessarily all of them;\n\t\t// for radio elements, it only gives one: either the checked one, or the first one if none are checked.\n\n\t\t// Note: for audio[controls], Chrome at least has two tabstops (the audio element and three dots menu button).\n\t\t// It might be possible to detect this in the shadow DOM, I don't know, I haven't worked with the shadow DOM.\n\t\t// But it might be more reliable to make a dummy tabstop element to detect when you tab out of the first/last element.\n\t\t// Also for iframes!\n\t\t// Assuming that doesn't mess with screen readers.\n\t\t// Right now you can't tab to the three dots menu if it's the last element.\n\t\t// @TODO: see what ally.js does. Does it handle audio[controls]? https://allyjs.io/api/query/tabsequence.html\n\n\t\tlet $controls = $el.find(`\n\t\t\tinput:enabled,\n\t\t\ttextarea:enabled,\n\t\t\tselect:enabled,\n\t\t\tbutton:enabled,\n\t\t\ta[href],\n\t\t\t[tabIndex='0'],\n\t\t\tdetails summary,\n\t\t\tiframe,\n\t\t\tobject,\n\t\t\tembed,\n\t\t\tvideo[controls],\n\t\t\taudio[controls],\n\t\t\t[contenteditable]:not([contenteditable='false'])\n\t\t`).filter(\":visible\");\n\t\t// const $controls = $el.find(\":tabbable\"); // https://api.jqueryui.com/tabbable-selector/\n\n\t\t// Radio buttons should be treated as a group with one tabstop.\n\t\t// If there's no selected (\"checked\") radio, it should still visit the group,\n\t\t// but if there is a selected radio in the group, it should skip all unselected radios in the group.\n\t\tconst radios = {}; // best radio found so far, per group\n\t\tconst to_skip = [];\n\t\tfor (const el of $controls.toArray()) {\n\t\t\tif (el.nodeName.toLowerCase() === \"input\" && el.type === \"radio\") {\n\t\t\t\tif (radios[el.name]) {\n\t\t\t\t\tif (el.checked) {\n\t\t\t\t\t\tto_skip.push(radios[el.name]);\n\t\t\t\t\t\tradios[el.name] = el;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tto_skip.push(el);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tradios[el.name] = el;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tconst $tabstops = $controls.not(to_skip);\n\t\t// debug viz:\n\t\t// $tabstops.css({boxShadow: \"0 0 2px 2px green\"});\n\t\t// $(to_skip).css({boxShadow: \"0 0 2px 2px gray\"})\n\t\treturn $tabstops;\n\t}\n\tvar $G = $(window);\n\n\n\t$Window.Z_INDEX = 5;\n\n\tvar minimize_slots = []; // for if there's no taskbar\n\n\t// @TODO: make this a class,\n\t// instead of a weird pseudo-class\n\tfunction $Window(options) {\n\t\toptions = options || {};\n\t\t// @TODO: handle all option defaults here\n\t\t// and validate options.\n\n\t\tvar $w = $(E(\"div\")).addClass(\"window os-window\").appendTo(\"body\");\n\t\t$w[0].$window = $w;\n\t\t$w.element = $w[0];\n\t\t$w[0].id = `os-window-${Math.random().toString(36).substr(2, 9)}`;\n\t\t$w.$titlebar = $(E(\"div\")).addClass(\"window-titlebar\").appendTo($w);\n\t\t$w.$title_area = $(E(\"div\")).addClass(\"window-title-area\").appendTo($w.$titlebar);\n\t\t$w.$title = $(E(\"span\")).addClass(\"window-title\").appendTo($w.$title_area);\n\t\tif (options.toolWindow) {\n\t\t\toptions.minimizeButton = false;\n\t\t\toptions.maximizeButton = false;\n\t\t}\n\t\tif (options.minimizeButton !== false) {\n\t\t\t$w.$minimize = $(E(\"button\")).addClass(\"window-minimize-button window-action-minimize window-button\").appendTo($w.$titlebar);\n\t\t\t$w.$minimize.attr(\"aria-label\", \"Minimize window\"); // @TODO: for taskbarless minimized windows, \"restore\"\n\t\t\t$w.$minimize.append(\"<span class='window-button-icon'></span>\");\n\t\t}\n\t\tif (options.maximizeButton !== false) {\n\t\t\t$w.$maximize = $(E(\"button\")).addClass(\"window-maximize-button window-action-maximize window-button\").appendTo($w.$titlebar);\n\t\t\t$w.$maximize.attr(\"aria-label\", \"Maximize or restore window\"); // @TODO: specific text for the state\n\t\t\tif (!options.resizable) {\n\t\t\t\t$w.$maximize.attr(\"disabled\", true);\n\t\t\t}\n\t\t\t$w.$maximize.append(\"<span class='window-button-icon'></span>\");\n\t\t}\n\t\tif (options.closeButton !== false) {\n\t\t\t$w.$x = $(E(\"button\")).addClass(\"window-close-button window-action-close window-button\").appendTo($w.$titlebar);\n\t\t\t$w.$x.attr(\"aria-label\", \"Close window\");\n\t\t\t$w.$x.append(\"<span class='window-button-icon'></span>\");\n\t\t}\n\t\t$w.$content = $(E(\"div\")).addClass(\"window-content\").appendTo($w);\n\t\t$w.$content.attr(\"tabIndex\", \"-1\");\n\t\t$w.$content.css(\"outline\", \"none\");\n\t\tif (options.toolWindow) {\n\t\t\t$w.addClass(\"tool-window\");\n\t\t}\n\t\tif (options.parentWindow) {\n\t\t\toptions.parentWindow.addChildWindow($w);\n\t\t\t// semantic parent logic is currently only suited for tool windows\n\t\t\t// for dialog windows, it would make the dialog window not show as focused\n\t\t\t// (alternatively, I could simply, when following the semantic parent chain, look for windows that are not tool windows)\n\t\t\tif (options.toolWindow) {\n\t\t\t\t$w[0].dataset.semanticParent = options.parentWindow[0].id;\n\t\t\t}\n\t\t}\n\n\t\tvar $component = options.$component;\n\t\tif (typeof options.icon === \"object\" && \"tagName\" in options.icon) {\n\t\t\toptions.icons = { any: options.icon };\n\t\t} else if (options.icon) {\n\t\t\t// old terrible API using globals that you have to define\n\t\t\tconsole.warn(\"DEPRECATED: use options.icons instead of options.icon, e.g. new $Window({icons: {16: 'app-16x16.png', any: 'app-icon.svg'}})\");\n\t\t\tif (typeof $Icon !== \"undefined\" && typeof TITLEBAR_ICON_SIZE !== \"undefined\") {\n\t\t\t\t$w.icon_name = options.icon;\n\t\t\t\t$w.$icon = $Icon(options.icon, TITLEBAR_ICON_SIZE).prependTo($w.$titlebar);\n\t\t\t} else {\n\t\t\t\tthrow new Error(\"Use {icon: img_element} or {icons: {16: url_or_img_element}} options\");\n\t\t\t}\n\t\t}\n\t\t$w.icons = options.icons || {};\n\t\tlet iconSize = 16;\n\t\t$w.setTitlebarIconSize = function (target_icon_size) {\n\t\t\tif ($w.icons) {\n\t\t\t\t$w.$icon && $w.$icon.remove();\n\t\t\t\t$w.$icon = $($w.getIconAtSize(target_icon_size));\n\t\t\t\t$w.$icon.prependTo($w.$titlebar);\n\t\t\t}\n\t\t\ticonSize = target_icon_size;\n\t\t\t$w.trigger(\"icon-change\");\n\t\t};\n\t\t$w.getTitlebarIconSize = function () {\n\t\t\treturn iconSize;\n\t\t};\n\t\t// @TODO: this could be a static method, like OSGUI.getIconAtSize(icons, targetSize)\n\t\t$w.getIconAtSize = function (target_icon_size) {\n\t\t\tlet icon_size;\n\t\t\tif ($w.icons[target_icon_size]) {\n\t\t\t\ticon_size = target_icon_size;\n\t\t\t} else if ($w.icons[\"any\"]) {\n\t\t\t\ticon_size = \"any\";\n\t\t\t} else {\n\t\t\t\tconst sizes = Object.keys($w.icons).filter(size => isFinite(size) && isFinite(parseFloat(size)));\n\t\t\t\tsizes.sort((a, b) => Math.abs(a - target_icon_size) - Math.abs(b - target_icon_size));\n\t\t\t\ticon_size = sizes[0];\n\t\t\t}\n\t\t\tif (icon_size) {\n\t\t\t\tconst icon = $w.icons[icon_size];\n\t\t\t\tlet icon_element;\n\t\t\t\tif (icon.nodeType !== undefined) {\n\t\t\t\t\ticon_element = icon.cloneNode(true);\n\t\t\t\t} else {\n\t\t\t\t\ticon_element = E(\"img\");\n\t\t\t\t\tconst $icon = $(icon_element);\n\t\t\t\t\tif (icon.srcset) {\n\t\t\t\t\t\t$icon.attr(\"srcset\", icon.srcset);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$icon.attr(\"src\", icon.src || icon);\n\t\t\t\t\t}\n\t\t\t\t\t$icon.attr({\n\t\t\t\t\t\twidth: icon_size,\n\t\t\t\t\t\theight: icon_size,\n\t\t\t\t\t\tdraggable: false,\n\t\t\t\t\t});\n\t\t\t\t\t$icon.css({\n\t\t\t\t\t\twidth: target_icon_size,\n\t\t\t\t\t\theight: target_icon_size,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn icon_element;\n\t\t\t}\n\t\t\treturn null;\n\t\t};\n\t\t// @TODO: automatically update icon size based on theme (with a CSS variable)\n\t\t$w.setTitlebarIconSize(iconSize);\n\n\t\t$w.getIconName = () => {\n\t\t\tconsole.warn(\"DEPRECATED: use $w.icons object instead of $w.icon_name\");\n\t\t\treturn $w.icon_name;\n\t\t};\n\t\t$w.setIconByID = (icon_name) => {\n\t\t\tconsole.warn(\"DEPRECATED: use $w.setIcons(icons) instead of $w.setIconByID(icon_name)\");\n\t\t\tvar old_$icon = $w.$icon;\n\t\t\t$w.$icon = $Icon(icon_name, TITLEBAR_ICON_SIZE);\n\t\t\told_$icon.replaceWith($w.$icon);\n\t\t\t$w.icon_name = icon_name;\n\t\t\t$w.task && $w.task.updateIcon();\n\t\t\t$w.trigger(\"icon-change\");\n\t\t\treturn $w;\n\t\t};\n\t\t$w.setIcons = (icons) => {\n\t\t\t$w.icons = icons;\n\t\t\t$w.setTitlebarIconSize(iconSize);\n\t\t\t$w.task && $w.task.updateIcon();\n\t\t\t// icon-change already sent by setTitlebarIconSize\n\t\t};\n\n\t\tif ($component) {\n\t\t\t$w.addClass(\"component-window\");\n\t\t}\n\n\t\tsetTimeout(() => {\n\t\t\tif (get_direction() == \"rtl\") {\n\t\t\t\t$w.addClass(\"rtl\"); // for reversing the titlebar gradient\n\t\t\t}\n\t\t}, 0);\n\n\t\t// returns writing/layout direction, \"ltr\" or \"rtl\"\n\t\tfunction get_direction() {\n\t\t\treturn window.get_direction ? window.get_direction() : getComputedStyle($w[0]).direction;\n\t\t}\n\n\t\t// This is very silly, using jQuery's event handling to implement simpler event handling.\n\t\t// But I'll implement it in a non-silly way at least when I remove jQuery. Maybe sooner.\n\t\tconst $event_target = $({});\n\t\tconst make_simple_listenable = (name) => {\n\t\t\treturn (callback) => {\n\t\t\t\tconst fn = () => {\n\t\t\t\t\tcallback();\n\t\t\t\t};\n\t\t\t\t$event_target.on(name, fn);\n\t\t\t\tconst dispose = () => {\n\t\t\t\t\t$event_target.off(name, fn);\n\t\t\t\t};\n\t\t\t\treturn dispose;\n\t\t\t};\n\t\t};\n\t\t$w.onFocus = make_simple_listenable(\"focus\");\n\t\t$w.onBlur = make_simple_listenable(\"blur\");\n\t\t$w.onClosed = make_simple_listenable(\"closed\");\n\n\t\t$w.setDimensions = ({ innerWidth, innerHeight, outerWidth, outerHeight }) => {\n\t\t\tlet width_from_frame, height_from_frame;\n\t\t\t// It's good practice to make all measurements first, then update the DOM.\n\t\t\t// Once you update the DOM, the browser has to recalculate layout, which can be slow.\n\t\t\tif (innerWidth) {\n\t\t\t\twidth_from_frame = $w.outerWidth() - $w.$content.outerWidth();\n\t\t\t}\n\t\t\tif (innerHeight) {\n\t\t\t\theight_from_frame = $w.outerHeight() - $w.$content.outerHeight();\n\t\t\t\tconst $menu_bar = $w.$content.find(\".menus\"); // only if inside .content; might move to a slot outside .content later\n\t\t\t\tif ($menu_bar.length) {\n\t\t\t\t\t// maybe this isn't technically part of the frame, per se? but it's part of the non-client area, which is what I technically mean.\n\t\t\t\t\theight_from_frame += $menu_bar.outerHeight();\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (outerWidth) {\n\t\t\t\t$w.outerWidth(outerWidth);\n\t\t\t}\n\t\t\tif (outerHeight) {\n\t\t\t\t$w.outerHeight(outerHeight);\n\t\t\t}\n\t\t\tif (innerWidth) {\n\t\t\t\t$w.outerWidth(innerWidth + width_from_frame);\n\t\t\t}\n\t\t\tif (innerHeight) {\n\t\t\t\t$w.outerHeight(innerHeight + height_from_frame);\n\t\t\t}\n\t\t};\n\t\t$w.setDimensions(options);\n\n\t\tlet child_$windows = [];\n\t\t$w.addChildWindow = ($child_window) => {\n\t\t\tchild_$windows.push($child_window);\n\t\t};\n\t\tconst showAsFocused = () => {\n\t\t\tif ($w.hasClass(\"focused\")) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t$w.addClass(\"focused\");\n\t\t\t$event_target.triggerHandler(\"focus\");\n\t\t\t$w.trigger(\"focus\");\n\t\t};\n\t\tconst stopShowingAsFocused = () => {\n\t\t\tif (!$w.hasClass(\"focused\")) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t$w.removeClass(\"focused\");\n\t\t\t$event_target.triggerHandler(\"blur\");\n\t\t\t$w.trigger(\"blur\");\n\t\t};\n\t\t$w.focus = () => {\n\t\t\t// showAsFocused();\t\n\t\t\t$w.bringToFront();\n\t\t\trefocus();\n\t\t};\n\t\t$w.blur = () => {\n\t\t\tstopShowingAsFocused();\n\t\t\tif (document.activeElement && document.activeElement.closest(\".window\") == $w[0]) {\n\t\t\t\tdocument.activeElement.blur();\n\t\t\t}\n\t\t};\n\n\t\tif (options.toolWindow) {\n\t\t\tif (options.parentWindow) {\n\t\t\t\toptions.parentWindow.onFocus(showAsFocused);\n\t\t\t\toptions.parentWindow.onBlur(stopShowingAsFocused);\n\t\t\t\t// TODO: also show as focused if focus is within the window\n\n\t\t\t\t// initial state\n\t\t\t\t// might need a setTimeout, idk...\n\t\t\t\tif (document.activeElement && document.activeElement.closest(\".window\") == options.parentWindow[0]) {\n\t\t\t\t\tshowAsFocused();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// the browser window is the parent window\n\t\t\t\t// show focus whenever the browser window is focused\n\t\t\t\t$(window).on(\"focus\", showAsFocused);\n\t\t\t\t$(window).on(\"blur\", stopShowingAsFocused);\n\t\t\t\t// initial state\n\t\t\t\tif (document.hasFocus()) {\n\t\t\t\t\tshowAsFocused();\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// global focusout is needed, to continue showing as focused while child windows or menu popups are focused (@TODO: Is this redundant with focusin?)\n\t\t\t// global focusin is needed, to show as focused when a child window becomes focused (when perhaps nothing was focused before, so no focusout event)\n\t\t\t// global blur is needed, to show as focused when an iframe gets focus, because focusin/out doesn't fire at all in that case\n\t\t\t// global focus is needed, to stop showing as focused when an iframe loses focus\n\t\t\t// pretty ridiculous!!\n\t\t\t// but it still doesn't handle the case where the browser window is not focused, and the user clicks an iframe directly.\n\t\t\t// for that, we need to listen inside the iframe, because no events are fired at all outside in that case,\n\t\t\t// and :focus/:focus-within doesn't work with iframes so we can't even do a hack with transitionstart.\n\t\t\t// @TODO: simplify the strategy; I ended up piling a few strategies on top of each other, and the earlier ones may be redundant.\n\t\t\t// In particular, 1. I ended up making it proactively inject into iframes, rather than when focused since there's a case where focus can't be detected otherwise.\n\t\t\t// 2. I ended up simulating focusin events for iframes.\n\t\t\t// I may want to rely on that, or, I may want to remove that and set up a refocus chain directly instead,\n\t\t\t// avoiding refocus() which may interfere with drag operations in an iframe when focusing the iframe (e.g. clicking into Paint to draw or drag a sub-window).\n\n\t\t\t// console.log(\"adding global focusin/focusout/blur/focus for window\", $w[0].id);\n\t\t\tconst global_focus_update_handler = make_focus_in_out_handler($w[0], true); // must be $w and not $content so semantic parent chain works, with [data-semantic-parent] pointing to the window not the content\n\t\t\twindow.addEventListener(\"focusin\", global_focus_update_handler);\n\t\t\twindow.addEventListener(\"focusout\", global_focus_update_handler);\n\t\t\twindow.addEventListener(\"blur\", global_focus_update_handler);\n\t\t\twindow.addEventListener(\"focus\", global_focus_update_handler);\n\n\t\t\tfunction setupIframe(iframe) {\n\t\t\t\tif (!focus_update_handlers_by_container.has(iframe)) {\n\t\t\t\t\tconst iframe_update_focus = make_focus_in_out_handler(iframe, false);\n\t\t\t\t\t// this also operates as a flag to prevent multiple handlers from being added, or waiting for the iframe to load duplicately\n\t\t\t\t\tfocus_update_handlers_by_container.set(iframe, iframe_update_focus);\n\n\t\t\t\t\t// @TODO: try removing setTimeout(s)\n\t\t\t\t\tsetTimeout(() => { // for iframe src to be set? I forget.\n\t\t\t\t\t\t// Note: try must be INSIDE setTimeout, not outside, to work.\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst wait_for_iframe_load = (callback) => {\n\t\t\t\t\t\t\t\t// Note: error may occur accessing iframe.contentDocument; this must be handled by the caller.\n\t\t\t\t\t\t\t\t// To that end, this function must access it synchronously, to allow the caller to handle the error.\n\t\t\t\t\t\t\t\tif (iframe.contentDocument.readyState == \"complete\") {\n\t\t\t\t\t\t\t\t\tcallback();\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t// iframe.contentDocument.addEventListener(\"readystatechange\", () => {\n\t\t\t\t\t\t\t\t\t// \tif (iframe.contentDocument.readyState == \"complete\") {\n\t\t\t\t\t\t\t\t\t// \t\tcallback();\n\t\t\t\t\t\t\t\t\t// \t}\n\t\t\t\t\t\t\t\t\t// });\n\t\t\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t\t\twait_for_iframe_load(callback);\n\t\t\t\t\t\t\t\t\t}, 100);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\twait_for_iframe_load(() => {\n\t\t\t\t\t\t\t\t// console.log(\"adding focusin/focusout/blur/focus for iframe\", iframe);\n\t\t\t\t\t\t\t\tiframe.contentWindow.addEventListener(\"focusin\", iframe_update_focus);\n\t\t\t\t\t\t\t\tiframe.contentWindow.addEventListener(\"focusout\", iframe_update_focus);\n\t\t\t\t\t\t\t\tiframe.contentWindow.addEventListener(\"blur\", iframe_update_focus);\n\t\t\t\t\t\t\t\tiframe.contentWindow.addEventListener(\"focus\", iframe_update_focus);\n\t\t\t\t\t\t\t\tobserveIframes(iframe.contentDocument);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\twarn_iframe_access(iframe, error);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 100);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction observeIframes(container_node) {\n\t\t\t\tconst observer = new MutationObserver((mutations) => {\n\t\t\t\t\tfor (const mutation of mutations) {\n\t\t\t\t\t\tfor (const node of mutation.addedNodes) {\n\t\t\t\t\t\t\tif (node.tagName == \"IFRAME\") {\n\t\t\t\t\t\t\t\tsetupIframe(node);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tobserver.observe(container_node, { childList: true, subtree: true });\n\t\t\t\t// needed in recursive calls (for iframes inside iframes)\n\t\t\t\t// (for the window, it shouldn't be able to have iframes yet)\n\t\t\t\tfor (const iframe of container_node.querySelectorAll(\"iframe\")) {\n\t\t\t\t\tsetupIframe(iframe);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tobserveIframes($w.$content[0]);\n\t\t\t\n\t\t\tfunction make_focus_in_out_handler(logical_container_el, is_root) {\n\t\t\t\t// In case of iframes, logical_container_el is the iframe, and container_node is the iframe's contentDocument.\n\t\t\t\t// container_node is not a parameter here because it can change over time, may be an empty document before the iframe is loaded.\n\n\t\t\t\treturn function handle_focus_in_out(event) {\n\t\t\t\t\tconst container_node = logical_container_el.tagName == \"IFRAME\" ? logical_container_el.contentDocument : logical_container_el;\n\t\t\t\t\tconst document = container_node.ownerDocument /*??*/ ||  container_node;\n\t\t\t\t\t// is this equivalent?\n\t\t\t\t\t// const document = logical_container_el.tagName == \"IFRAME\" ? logical_container_el.contentDocument : logical_container_el.ownerDocument;\n\n\t\t\t\t\t// console.log(`handling ${event.type} for container`, container_el);\n\t\t\t\t\tlet newly_focused = event ? (event.type === \"focusout\" || event.type === \"blur\") ? event.relatedTarget : event.target : document.activeElement;\n\t\t\t\t\tif (event && event.type === \"blur\") {\n\t\t\t\t\t\tnewly_focused = null; // only handle iframe\n\t\t\t\t\t}\n\n\t\t\t\t\t// console.log(`[${$w.title()}] (is_root=${is_root})`, `newly_focused is (preliminarily)`, element_to_string(newly_focused), `\\nlogical_container_el`, logical_container_el, `\\ncontainer_node`, container_node, `\\ndocument.activeElement`, document.activeElement, `\\ndocument.hasFocus()`, document.hasFocus(), `\\ndocument`, document);\n\n\t\t\t\t\t// Iframes are stingy about focus events, so we need to check if focus is actually within an iframe.\n\t\t\t\t\tif (\n\t\t\t\t\t\tdocument.activeElement &&\n\t\t\t\t\t\tdocument.activeElement.tagName === \"IFRAME\" &&\n\t\t\t\t\t\t(event && event.type === \"focusout\" || event && event.type === \"blur\") &&\n\t\t\t\t\t\t!newly_focused // doesn't exist for security reasons in this case\n\t\t\t\t\t) {\n\t\t\t\t\t\tnewly_focused = document.activeElement;\n\t\t\t\t\t\t// console.log(`[${$w.title()}] (is_root=${is_root})`, `newly_focused is (actually)`, element_to_string(newly_focused));\n\t\t\t\t\t}\n\n\t\t\t\t\tconst outside_or_at_exactly =\n\t\t\t\t\t\t!newly_focused ||\n\t\t\t\t\t\t// contains() only works with DOM nodes (elements and documents), not window objects.\n\t\t\t\t\t\t// Since container_node is a DOM node, it will never have a Window inside of it (ignoring iframes).\n\t\t\t\t\t\tnewly_focused.window === newly_focused || // is a Window object (cross-frame test)\n\t\t\t\t\t\t!container_node.contains(newly_focused); // Note: node.contains(node) === true\n\t\t\t\t\tconst firmly_outside = outside_or_at_exactly && container_node !== newly_focused;\n\n\t\t\t\t\t// console.log(`[${$w.title()}] (is_root=${is_root})`, `outside_or_at_exactly=${outside_or_at_exactly}`, `firmly_outside=${firmly_outside}`);\n\t\t\t\t\tif (firmly_outside && is_root) {\n\t\t\t\t\t\tstopShowingAsFocused();\n\t\t\t\t\t}\n\t\t\t\t\tif (\n\t\t\t\t\t\t!outside_or_at_exactly &&\n\t\t\t\t\t\tnewly_focused.tagName !== \"HTML\" &&\n\t\t\t\t\t\tnewly_focused.tagName !== \"BODY\" &&\n\t\t\t\t\t\tnewly_focused !== container_node &&\n\t\t\t\t\t\t!newly_focused.matches(\".window-content\") &&\n\t\t\t\t\t\t!newly_focused.closest(\".menus\") &&\n\t\t\t\t\t\t!newly_focused.closest(\".window-titlebar\")\n\t\t\t\t\t) {\n\t\t\t\t\t\tlast_focus_by_container.set(logical_container_el, newly_focused); // overwritten for iframes below\n\t\t\t\t\t\tdebug_focus_tracking(document, container_node, newly_focused, is_root);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t!outside_or_at_exactly &&\n\t\t\t\t\t\tnewly_focused.tagName === \"IFRAME\"\n\t\t\t\t\t) {\n\t\t\t\t\t\tconst iframe = newly_focused;\n\t\t\t\t\t\t// console.log(\"iframe\", iframe, onfocusin_by_container.has(iframe));\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst focus_in_iframe = iframe.contentDocument.activeElement;\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\tfocus_in_iframe &&\n\t\t\t\t\t\t\t\tfocus_in_iframe.tagName !== \"HTML\" &&\n\t\t\t\t\t\t\t\tfocus_in_iframe.tagName !== \"BODY\" &&\n\t\t\t\t\t\t\t\t!focus_in_iframe.closest(\".menus\")\n\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t// last_focus_by_container.set(logical_container_el, iframe); // done above\n\t\t\t\t\t\t\t\tlast_focus_by_container.set(iframe, focus_in_iframe);\n\t\t\t\t\t\t\t\tdebug_focus_tracking(iframe.contentDocument, iframe.contentDocument, focus_in_iframe, is_root);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\twarn_iframe_access(iframe, e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\n\t\t\t\t\t// For child windows and menu popups, follow \"semantic parent\" chain.\n\t\t\t\t\t// Menu popups and child windows aren't descendants of the window they belong to,\n\t\t\t\t\t// but should keep the window shown as focused.\n\t\t\t\t\t// (In principle this sort of feature could be useful for focus tracking*,\n\t\t\t\t\t// but right now it's only for child windows and menu popups, which should not be tracked for refocus,\n\t\t\t\t\t// so I'm doing this after last_focus_by_container.set, for now anyway.)\n\t\t\t\t\t// ((*: and it may even be surprising if it doesn't work, if one sees the attribute on menus and attempts to use it.\n\t\t\t\t\t// But who's going to see that? The menus close so it's a pain to see the DOM structure! :P **))\n\t\t\t\t\t// (((**: without window.debugKeepMenusOpen)))\n\t\t\t\t\tif (is_root) {\n\t\t\t\t\t\tdo {\n\t\t\t\t\t\t\t// if (!newly_focused?.closest) {\n\t\t\t\t\t\t\t// \tconsole.warn(\"what is this?\", newly_focused);\n\t\t\t\t\t\t\t// \tbreak;\n\t\t\t\t\t\t\t// }\n\t\t\t\t\t\t\tconst waypoint = newly_focused && newly_focused.closest && newly_focused.closest(\"[data-semantic-parent]\");\n\t\t\t\t\t\t\tif (waypoint) {\n\t\t\t\t\t\t\t\tconst id = waypoint.dataset.semanticParent;\n\t\t\t\t\t\t\t\tconst parent = waypoint.ownerDocument.getElementById(id);\n\t\t\t\t\t\t\t\t// console.log(\"following semantic parent, from\", newly_focused, \"\\nto\", parent, \"\\nvia\", waypoint);\n\t\t\t\t\t\t\t\tnewly_focused = parent;\n\t\t\t\t\t\t\t\tif (!parent) {\n\t\t\t\t\t\t\t\t\tconsole.warn(\"semantic parent not found with id\", id);\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} while (true);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Note: allowing showing window as focused from listeners inside iframe (non-root) too,\n\t\t\t\t\t// in order to handle clicking an iframe when the browser window was not previously focused (e.g. after reload)\n\t\t\t\t\tif (\n\t\t\t\t\t\tnewly_focused &&\n\t\t\t\t\t\tnewly_focused.window !== newly_focused && // cross-frame test for Window object\n\t\t\t\t\t\tcontainer_node.contains(newly_focused)\n\t\t\t\t\t) {\n\t\t\t\t\t\tshowAsFocused();\n\t\t\t\t\t\t$w.bringToFront();\n\t\t\t\t\t\tif (!is_root) {\n\t\t\t\t\t\t\t// trigger focusin events for iframes\n\t\t\t\t\t\t\t// @TODO: probably don't need showAsFocused() here since it'll be handled externally (on this simulated focusin),\n\t\t\t\t\t\t\t// and might not need a lot of other logic frankly if I'm simulating focusin events\n\t\t\t\t\t\t\tlet el = logical_container_el;\n\t\t\t\t\t\t\twhile (el) {\n\t\t\t\t\t\t\t\t// console.log(\"dispatching focusin event for\", el);\n\t\t\t\t\t\t\t\tel.dispatchEvent(new Event(\"focusin\", {\n\t\t\t\t\t\t\t\t\tbubbles: true,\n\t\t\t\t\t\t\t\t\ttarget: el,\n\t\t\t\t\t\t\t\t\tview: el.ownerDocument.defaultView,\n\t\t\t\t\t\t\t\t}));\n\t\t\t\t\t\t\t\tel = el.currentView && el.currentView.frameElement;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (is_root) {\n\t\t\t\t\t\tstopShowingAsFocused();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// initial state is unfocused\n\t\t}\n\n\t\t$w.css(\"touch-action\", \"none\");\n\n\t\tlet minimize_target_el = null; // taskbar button (optional)\n\t\t$w.setMinimizeTarget = function (new_taskbar_button_el) {\n\t\t\tminimize_target_el = new_taskbar_button_el;\n\t\t};\n\n\t\tlet task;\n\t\tObject.defineProperty($w, \"task\", {\n\t\t\tget() {\n\t\t\t\treturn task;\n\t\t\t},\n\t\t\tset(new_task) {\n\t\t\t\tconsole.warn(\"DEPRECATED: use $w.setMinimizeTarget(taskbar_button_el) instead of setting $window.task object\");\n\t\t\t\ttask = new_task;\n\t\t\t},\n\t\t});\n\n\t\tlet before_minimize;\n\t\t$w.minimize = () => {\n\t\t\tminimize_target_el = minimize_target_el || task && task.$task[0];\n\t\t\tif (animating_titlebar) {\n\t\t\t\twhen_done_animating_titlebar.push($w.minimize);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($w.is(\":visible\")) {\n\t\t\t\tif (minimize_target_el && !$w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t\tconst before_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\t\tconst after_rect = minimize_target_el.getBoundingClientRect();\n\t\t\t\t\t$w.animateTitlebar(before_rect, after_rect, () => {\n\t\t\t\t\t\t$w.hide();\n\t\t\t\t\t\t$w.blur();\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\t// no taskbar\n\n\t\t\t\t\t// @TODO: make this metrically similar to what Windows 98 does\n\t\t\t\t\t// @TODO: DRY! This is copied heavily from maximize()\n\t\t\t\t\t// @TODO: after minimize (without taskbar) and maximize, restore should restore original position before minimize\n\t\t\t\t\t// OR should it not maximize but restore the unmaximized state? I think I tested it but I forget.\n\n\t\t\t\t\tconst to_width = 150;\n\t\t\t\t\tconst spacing = 10;\n\t\t\t\t\tif ($w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t\t\t// unminimizing\n\t\t\t\t\t\tminimize_slots[$w._minimize_slot_index] = null;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// minimizing\n\t\t\t\t\t\tlet i = 0;\n\t\t\t\t\t\twhile (minimize_slots[i]) {\n\t\t\t\t\t\t\ti++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$w._minimize_slot_index = i;\n\t\t\t\t\t\tminimize_slots[i] = $w;\n\t\t\t\t\t}\n\t\t\t\t\tconst to_x = $w._minimize_slot_index * (to_width + spacing) + 10;\n\t\t\t\t\tconst titlebar_height = $w.$titlebar.outerHeight();\n\t\t\t\t\tlet before_unminimize;\n\t\t\t\t\tconst instantly_minimize = () => {\n\t\t\t\t\t\tbefore_minimize = {\n\t\t\t\t\t\t\tposition: $w.css(\"position\"),\n\t\t\t\t\t\t\tleft: $w.css(\"left\"),\n\t\t\t\t\t\t\ttop: $w.css(\"top\"),\n\t\t\t\t\t\t\twidth: $w.css(\"width\"),\n\t\t\t\t\t\t\theight: $w.css(\"height\"),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t$w.addClass(\"minimized-without-taskbar\");\n\t\t\t\t\t\tif ($w.hasClass(\"maximized\")) {\n\t\t\t\t\t\t\t$w.removeClass(\"maximized\");\n\t\t\t\t\t\t\t$w.addClass(\"was-maximized\");\n\t\t\t\t\t\t\t$w.$maximize.removeClass(\"window-action-restore\");\n\t\t\t\t\t\t\t$w.$maximize.addClass(\"window-action-maximize\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$w.$minimize.removeClass(\"window-action-minimize\");\n\t\t\t\t\t\t$w.$minimize.addClass(\"window-action-restore\");\n\t\t\t\t\t\tif (before_unminimize) {\n\t\t\t\t\t\t\t$w.css({\n\t\t\t\t\t\t\t\tposition: before_unminimize.position,\n\t\t\t\t\t\t\t\tleft: before_unminimize.left,\n\t\t\t\t\t\t\t\ttop: before_unminimize.top,\n\t\t\t\t\t\t\t\twidth: before_unminimize.width,\n\t\t\t\t\t\t\t\theight: before_unminimize.height,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$w.css({\n\t\t\t\t\t\t\t\tposition: \"fixed\",\n\t\t\t\t\t\t\t\ttop: `calc(100% - ${titlebar_height + 5}px)`,\n\t\t\t\t\t\t\t\tleft: to_x,\n\t\t\t\t\t\t\t\twidth: to_width,\n\t\t\t\t\t\t\t\theight: titlebar_height,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tconst instantly_unminimize = () => {\n\t\t\t\t\t\tbefore_unminimize = {\n\t\t\t\t\t\t\tposition: $w.css(\"position\"),\n\t\t\t\t\t\t\tleft: $w.css(\"left\"),\n\t\t\t\t\t\t\ttop: $w.css(\"top\"),\n\t\t\t\t\t\t\twidth: $w.css(\"width\"),\n\t\t\t\t\t\t\theight: $w.css(\"height\"),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t$w.removeClass(\"minimized-without-taskbar\");\n\t\t\t\t\t\tif ($w.hasClass(\"was-maximized\")) {\n\t\t\t\t\t\t\t$w.removeClass(\"was-maximized\");\n\t\t\t\t\t\t\t$w.addClass(\"maximized\");\n\t\t\t\t\t\t\t$w.$maximize.removeClass(\"window-action-maximize\");\n\t\t\t\t\t\t\t$w.$maximize.addClass(\"window-action-restore\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$w.$minimize.removeClass(\"window-action-restore\");\n\t\t\t\t\t\t$w.$minimize.addClass(\"window-action-minimize\");\n\t\t\t\t\t\t$w.css({ width: \"\", height: \"\" });\n\t\t\t\t\t\tif (before_minimize) {\n\t\t\t\t\t\t\t$w.css({\n\t\t\t\t\t\t\t\tposition: before_minimize.position,\n\t\t\t\t\t\t\t\tleft: before_minimize.left,\n\t\t\t\t\t\t\t\ttop: before_minimize.top,\n\t\t\t\t\t\t\t\twidth: before_minimize.width,\n\t\t\t\t\t\t\t\theight: before_minimize.height,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\tconst before_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\t\tlet after_rect;\n\t\t\t\t\t$w.css(\"transform\", \"\");\n\t\t\t\t\tif ($w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t\t\tinstantly_unminimize();\n\t\t\t\t\t\tafter_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\t\t\tinstantly_minimize();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tinstantly_minimize();\n\t\t\t\t\t\tafter_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\t\t\tinstantly_unminimize();\n\t\t\t\t\t}\n\t\t\t\t\t$w.animateTitlebar(before_rect, after_rect, () => {\n\t\t\t\t\t\tif ($w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t\t\t\tinstantly_unminimize();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tinstantly_minimize();\n\t\t\t\t\t\t\t$w.blur();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\t$w.unminimize = () => {\n\t\t\tif (animating_titlebar) {\n\t\t\t\twhen_done_animating_titlebar.push($w.unminimize);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t$w.minimize();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($w.is(\":hidden\")) {\n\t\t\t\tconst before_rect = minimize_target_el.getBoundingClientRect();\n\t\t\t\t$w.show();\n\t\t\t\tconst after_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\t$w.hide();\n\t\t\t\t$w.animateTitlebar(before_rect, after_rect, () => {\n\t\t\t\t\t$w.show();\n\t\t\t\t\t$w.bringToFront();\n\t\t\t\t\t$w.focus();\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\n\t\tlet before_maximize;\n\t\t$w.maximize = () => {\n\t\t\tif (!options.resizable) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (animating_titlebar) {\n\t\t\t\twhen_done_animating_titlebar.push($w.maximize);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t$w.minimize();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst instantly_maximize = () => {\n\t\t\t\tbefore_maximize = {\n\t\t\t\t\tposition: $w.css(\"position\"),\n\t\t\t\t\tleft: $w.css(\"left\"),\n\t\t\t\t\ttop: $w.css(\"top\"),\n\t\t\t\t\twidth: $w.css(\"width\"),\n\t\t\t\t\theight: $w.css(\"height\"),\n\t\t\t\t};\n\n\t\t\t\t$w.addClass(\"maximized\");\n\t\t\t\tconst $taskbar = $(\".taskbar\");\n\t\t\t\tconst scrollbar_width = window.innerWidth - $(window).width();\n\t\t\t\tconst scrollbar_height = window.innerHeight - $(window).height();\n\t\t\t\tconst taskbar_height = $taskbar.length ? $taskbar.outerHeight() + 1 : 0;\n\t\t\t\t$w.css({\n\t\t\t\t\tposition: \"fixed\",\n\t\t\t\t\ttop: 0,\n\t\t\t\t\tleft: 0,\n\t\t\t\t\twidth: `calc(100vw - ${scrollbar_width}px)`,\n\t\t\t\t\theight: `calc(100vh - ${scrollbar_height}px - ${taskbar_height}px)`,\n\t\t\t\t});\n\t\t\t};\n\t\t\tconst instantly_unmaximize = () => {\n\t\t\t\t$w.removeClass(\"maximized\");\n\t\t\t\t$w.css({ width: \"\", height: \"\" });\n\t\t\t\tif (before_maximize) {\n\t\t\t\t\t$w.css({\n\t\t\t\t\t\tposition: before_maximize.position,\n\t\t\t\t\t\tleft: before_maximize.left,\n\t\t\t\t\t\ttop: before_maximize.top,\n\t\t\t\t\t\twidth: before_maximize.width,\n\t\t\t\t\t\theight: before_maximize.height,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tconst before_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\tlet after_rect;\n\t\t\t$w.css(\"transform\", \"\");\n\t\t\tconst restoring = $w.hasClass(\"maximized\");\n\t\t\tif (restoring) {\n\t\t\t\tinstantly_unmaximize();\n\t\t\t\tafter_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\tinstantly_maximize();\n\t\t\t} else {\n\t\t\t\tinstantly_maximize();\n\t\t\t\tafter_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\tinstantly_unmaximize();\n\t\t\t}\n\t\t\t$w.animateTitlebar(before_rect, after_rect, () => {\n\t\t\t\tif (restoring) {\n\t\t\t\t\tinstantly_unmaximize(); // finalize in some way\n\t\t\t\t\t$w.$maximize.removeClass(\"window-action-restore\");\n\t\t\t\t\t$w.$maximize.addClass(\"window-action-maximize\");\n\t\t\t\t} else {\n\t\t\t\t\tinstantly_maximize(); // finalize in some way\n\t\t\t\t\t$w.$maximize.removeClass(\"window-action-maximize\");\n\t\t\t\t\t$w.$maximize.addClass(\"window-action-restore\");\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\t\t$w.restore = () => {\n\t\t\tif ($w.is(\".minimized-without-taskbar, .minimized\")) {\n\t\t\t\t$w.unminimize();\n\t\t\t} else if ($w.is(\".maximized\")) {\n\t\t\t\t$w.maximize();\n\t\t\t}\n\t\t};\n\t\t// must not pass event to functions by accident; also methods may not be defined yet\n\t\t$w.$minimize && $w.$minimize.on(\"click\", (e)=> { $w.minimize(); });\n\t\t$w.$maximize && $w.$maximize.on(\"click\", (e)=> { $w.maximize(); });\n\t\t$w.$x && $w.$x.on(\"click\", (e)=> { $w.close(); });\n\t\t$w.$title_area.on(\"dblclick\", (e)=> { $w.maximize(); });\n\n\t\t$w.css({\n\t\t\tposition: \"absolute\",\n\t\t\tzIndex: $Window.Z_INDEX++\n\t\t});\n\t\t$w.bringToFront = () => {\n\t\t\t$w.css({\n\t\t\t\tzIndex: $Window.Z_INDEX++\n\t\t\t});\n\t\t\tfor (const $childWindow of child_$windows) {\n\t\t\t\t$childWindow.bringToFront();\n\t\t\t}\n\t\t};\n\n\t\t// Keep track of last focused elements per container,\n\t\t// where containers include:\n\t\t// - window (global focus tracking)\n\t\t// - $w[0] (window-local, for restoring focus when refocusing window)\n\t\t// - any iframes that are same-origin (for restoring focus when refocusing window)\n\t\t// @TODO: should these be WeakMaps? probably.\n\t\t// @TODO: share this Map between all windows? but clean it up when destroying windows? or would a WeakMap take care of that?\n\t\tvar last_focus_by_container = new Map(); // element to restore focus to, by container\n\t\tvar focus_update_handlers_by_container = new Map(); // event handlers by container; note use as a flag to avoid adding multiple handlers\n\t\tvar debug_svg_by_container = new Map(); // visualization\n\t\tvar debug_svgs_in_window = []; // visualization\n\t\tvar warned_iframes = new WeakSet(); // prevent spamming console\n\n\t\tconst warn_iframe_access = (iframe, error) => {\n\t\t\tconst log_template = (message) => [`OS-GUI.js failed to access an iframe (${element_to_string(iframe)}) for focus integration.\n\t${message}\n\tOriginal error:\n\t`, error];\n\n\t\t\tlet cross_origin;\n\t\t\tif (iframe.srcdoc) {\n\t\t\t\tcross_origin = false;\n\t\t\t} else {\n\t\t\t\ttry {\n\t\t\t\t\tconst url = new URL(iframe.src);\n\t\t\t\t\tcross_origin = url.origin !== window.location.origin; // shouldn't need to use iframe.ownerDocument.location.origin because intermediate iframes must be same-origin\n\t\t\t\t} catch (parse_error) {\n\t\t\t\t\tconsole.error(...log_template(`This may be a bug in OS-GUI. Is this a cross-origin iframe? Failed to parse URL (${parse_error}).`));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (cross_origin) {\n\t\t\t\tif (options.iframes && options.iframes.ignoreCrossOrigin && !warned_iframes.has(iframe)) {\n\t\t\t\t\tconsole.warn(...log_template(`Only same-origin iframes can work with focus integration (showing window as focused, refocusing last focused controls).\n\tIf you can re-host the content on the same origin, you can resolve this and enable focus integration.\n\tYou can also disable this warning by passing {iframes: {ignoreCrossOrigin: true}} to $Window.`));\n\t\t\t\t\twarned_iframes.add(iframe);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.error(...log_template(`This may be a bug in OS-GUI, since it doesn't appear to be a cross-origin iframe.`));\n\t\t\t}\n\t\t};\n\n\t\tconst debug_focus_tracking = (document, container_el, descendant_el, is_root) => {\n\t\t\tif (!$Window.DEBUG_FOCUS) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet svg = debug_svg_by_container.get(container_el);\n\t\t\tif (!svg) {\n\t\t\t\tsvg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\n\t\t\t\tsvg.style.position = \"fixed\";\n\t\t\t\tsvg.style.top = \"0\";\n\t\t\t\tsvg.style.left = \"0\";\n\t\t\t\tsvg.style.width = \"100%\";\n\t\t\t\tsvg.style.height = \"100%\";\n\t\t\t\tsvg.style.pointerEvents = \"none\";\n\t\t\t\tsvg.style.zIndex = \"100000000\";\n\t\t\t\tsvg.style.direction = \"ltr\"; // position labels correctly\n\t\t\t\tdebug_svg_by_container.set(container_el, svg);\n\t\t\t\tdebug_svgs_in_window.push(svg);\n\t\t\t\tdocument.body.appendChild(svg);\n\t\t\t}\n\t\t\tsvg._container_el = container_el;\n\t\t\tsvg._descendant_el = descendant_el;\n\t\t\tsvg._is_root = is_root;\n\t\t\tanimate_debug_focus_tracking();\n\t\t};\n\t\tconst update_debug_focus_tracking = (svg) => {\n\t\t\tconst container_el = svg._container_el;\n\t\t\tconst descendant_el = svg._descendant_el;\n\t\t\tconst is_root = svg._is_root;\n\n\t\t\twhile (svg.lastChild) {\n\t\t\t\tsvg.removeChild(svg.lastChild);\n\t\t\t}\n\t\t\tconst descendant_rect = descendant_el.getBoundingClientRect && descendant_el.getBoundingClientRect() ||/*??*/ { left: 0, top: 0, width: innerWidth, height: innerHeight, right: innerWidth, bottom: innerHeight };\n\t\t\tconst container_rect = container_el.getBoundingClientRect && ontainer_el.getBoundingClientRect() ||/*??*/ { left: 0, top: 0, width: innerWidth, height: innerHeight, right: innerWidth, bottom: innerHeight };\n\t\t\t// draw rectangles with labels\n\t\t\tfor (const rect of [descendant_rect, container_rect]) {\n\t\t\t\tconst rect_el = document.createElementNS(\"http://www.w3.org/2000/svg\", \"rect\");\n\t\t\t\trect_el.setAttribute(\"x\", rect.left);\n\t\t\t\trect_el.setAttribute(\"y\", rect.top);\n\t\t\t\trect_el.setAttribute(\"width\", rect.width);\n\t\t\t\trect_el.setAttribute(\"height\", rect.height);\n\t\t\t\trect_el.setAttribute(\"stroke\", rect === descendant_rect ? \"#f44\" : \"#f44\");\n\t\t\t\trect_el.setAttribute(\"stroke-width\", \"2\");\n\t\t\t\trect_el.setAttribute(\"fill\", \"none\");\n\t\t\t\tif (!is_root) {\n\t\t\t\t\trect_el.setAttribute(\"stroke-dasharray\", \"5,5\");\n\t\t\t\t}\n\t\t\t\tsvg.appendChild(rect_el);\n\t\t\t\tconst text_el = document.createElementNS(\"http://www.w3.org/2000/svg\", \"text\");\n\t\t\t\ttext_el.setAttribute(\"x\", rect.left);\n\t\t\t\ttext_el.setAttribute(\"y\", rect.top + (rect === descendant_rect ? 20 : 0)); // align container text on outside, descendant text on inside\n\t\t\t\ttext_el.setAttribute(\"fill\", rect === descendant_rect ? \"#f44\" : \"aqua\");\n\t\t\t\ttext_el.setAttribute(\"font-size\", \"20\");\n\t\t\t\ttext_el.style.textShadow = \"1px 1px 1px black, 0 0 10px black\";\n\t\t\t\ttext_el.textContent = element_to_string(rect === descendant_rect ? descendant_el : container_el);\n\t\t\t\tsvg.appendChild(text_el);\n\t\t\t}\n\t\t\t// draw lines connecting the two rects\n\t\t\tconst lines = [\n\t\t\t\t[descendant_rect.left, descendant_rect.top, container_rect.left, container_rect.top],\n\t\t\t\t[descendant_rect.right, descendant_rect.top, container_rect.right, container_rect.top],\n\t\t\t\t[descendant_rect.left, descendant_rect.bottom, container_rect.left, container_rect.bottom],\n\t\t\t\t[descendant_rect.right, descendant_rect.bottom, container_rect.right, container_rect.bottom],\n\t\t\t];\n\t\t\tfor (const line of lines) {\n\t\t\t\tconst line_el = document.createElementNS(\"http://www.w3.org/2000/svg\", \"line\");\n\t\t\t\tline_el.setAttribute(\"x1\", line[0]);\n\t\t\t\tline_el.setAttribute(\"y1\", line[1]);\n\t\t\t\tline_el.setAttribute(\"x2\", line[2]);\n\t\t\t\tline_el.setAttribute(\"y2\", line[3]);\n\t\t\t\tline_el.setAttribute(\"stroke\", \"green\");\n\t\t\t\tline_el.setAttribute(\"stroke-width\", \"2\");\n\t\t\t\tsvg.appendChild(line_el);\n\t\t\t}\n\t\t};\n\t\tlet debug_animation_frame_id;\n\t\tconst animate_debug_focus_tracking = () => {\n\t\t\tcancelAnimationFrame(debug_animation_frame_id);\n\t\t\tif (!$Window.DEBUG_FOCUS) {\n\t\t\t\tclean_up_debug_focus_tracking();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tdebug_animation_frame_id = requestAnimationFrame(animate_debug_focus_tracking);\n\t\t\tfor (const svg of debug_svgs_in_window) {\n\t\t\t\tupdate_debug_focus_tracking(svg);\n\t\t\t}\n\t\t};\n\t\tconst clean_up_debug_focus_tracking = () => {\n\t\t\tcancelAnimationFrame(debug_animation_frame_id);\n\t\t\tfor (const svg of debug_svgs_in_window) {\n\t\t\t\tsvg.remove();\n\t\t\t}\n\t\t\tdebug_svgs_in_window.length = 0;\n\t\t\tdebug_svg_by_container.clear();\n\t\t};\n\n\t\tconst refocus = (container_el = $w.$content[0]) => {\n\t\t\tconst logical_container_el = container_el.matches(\".window-content\") ? $w[0] : container_el;\n\t\t\tconst last_focus = last_focus_by_container.get(logical_container_el);\n\t\t\tif (last_focus) {\n\t\t\t\tlast_focus.focus({ preventScroll: true });\n\t\t\t\tif (last_focus.tagName === \"IFRAME\") {\n\t\t\t\t\ttry {\n\t\t\t\t\t\trefocus(last_focus);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\twarn_iframe_access(last_focus, e);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst $tabstops = find_tabstops(container_el);\n\t\t\tconst $default = $tabstops.filter(\".default\");\n\t\t\tif ($default.length) {\n\t\t\t\t$default[0].focus({ preventScroll: true });\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($tabstops.length) {\n\t\t\t\tif ($tabstops[0].tagName === \"IFRAME\") {\n\t\t\t\t\ttry {\n\t\t\t\t\t\trefocus($tabstops[0]); // not .contentDocument.body because we want the container tracked by last_focus_by_container\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\twarn_iframe_access($tabstops[0], e);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$tabstops[0].focus({ preventScroll: true });\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (options.toolWindow && options.parentWindow) {\n\t\t\t\toptions.parentWindow.triggerHandler(\"refocus-window\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tcontainer_el.focus({ preventScroll: true });\n\t\t\tif (container_el.tagName === \"IFRAME\") {\n\t\t\t\ttry {\n\t\t\t\t\trefocus(container_el.contentDocument.body);\n\t\t\t\t} catch (e) {\n\t\t\t\t\twarn_iframe_access(container_el, e);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\t$w.on(\"refocus-window\", () => {\n\t\t\trefocus();\n\t\t});\n\n\t\t// redundant events are for handling synthetic events,\n\t\t// which may be sent individually, rather than in tandem\n\t\t$w.on(\"pointerdown mousedown\", handle_pointer_activation);\n\t\t// Note that jQuery treats some events differently, and can't listen for some synthetic events\n\t\t// but pointerdown and mousedown seem to be supported. That said, if you trigger() either,\n\t\t// addEventListener() handlers will not be called. So if I remove the dependency on jQuery,\n\t\t// it will not be possible to listen for some .trigger() events.\n\t\t// https://jsfiddle.net/1j01/ndvwts9y/1/\n\n\t\t// Assumption: focusin comes after pointerdown/mousedown\n\t\t// This is probably guaranteed, because you can prevent the default of focusing from pointerdown/mousedown\n\t\t$G.on(\"focusin\", (e) => {\n\t\t\tlast_focus_by_container.set(window, e.target);\n\t\t\t// debug_focus_tracking(document, window, e.target);\n\t\t});\n\n\t\tfunction handle_pointer_activation(event) {\n\t\t\t// console.log(\"handle_pointer_activation\", event.type, event.target);\n\t\t\t$w.bringToFront();\n\t\t\t// Test cases where it should refocus the last focused control in the window:\n\t\t\t// - Click in the blank space of the window\n\t\t\t//   - Click in blank space again now that something's focused\n\t\t\t// - Click on the window title bar\n\t\t\t//   - Click on title bar buttons\n\t\t\t// - Closing a second window should focus the first window\n\t\t\t//   - Open a dialog window from an app window that has a tool window, then close the dialog window\n\t\t\t//     - @TODO: Even if the tool window has controls, it should focus the parent window, I think\n\t\t\t// - Clicking on a control in the window should focus said control\n\t\t\t// - Clicking on a disabled control in the window should focus the window\n\t\t\t//   - Make sure to test this with another window previously focused\n\t\t\t// - Simulated clicks (important for JS Paint's eye gaze and speech recognition modes)\n\t\t\t// - (@TODO: Should clicking a child window focus the parent window?)\n\t\t\t// - After potentially selecting text but not selecting anything\n\t\t\t// It should NOT refocus when:\n\t\t\t// - Clicking on a control in a different window\n\t\t\t// - When other event handlers set focus\n\t\t\t//   - Using the keyboard to focus something outside the window, such as a menu popup\n\t\t\t//   - Clicking a control that focuses something outside the window\n\t\t\t//     - Button that opens another window (e.g. Recursive Dialog button in tests)\n\t\t\t//     - Button that focuses a control in another window (e.g. Focus Other button in tests)\n\t\t\t// - Trying to select text\n\n\t\t\t// Wait for other pointerdown handlers and default behavior, and focusin events.\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tconst last_focus_global = last_focus_by_container.get(window);\n\t\t\t\t// const last_focus_in_window = last_focus_by_container.get($w.$content[0]);\n\t\t\t\t// console.log(\"a tick after\", event.type, { last_focus_in_window, last_focus_global, activeElement: document.activeElement, win_elem: $w[0] });\n\t\t\t\t// console.log(\"did focus change?\", document.activeElement !== last_focus_global);\n\n\t\t\t\t// If something programmatically got focus, don't refocus.\n\t\t\t\tif (\n\t\t\t\t\tdocument.activeElement &&\n\t\t\t\t\tdocument.activeElement !== document &&\n\t\t\t\t\tdocument.activeElement !== document.body &&\n\t\t\t\t\tdocument.activeElement !== $w.$content[0] &&\n\t\t\t\t\tdocument.activeElement !== last_focus_global\n\t\t\t\t) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// If menus got focus, don't refocus.\n\t\t\t\tif (document.activeElement && document.activeElement.closest && document.activeElement.closest(\".menus, .menu-popup\")) {\n\t\t\t\t\t// console.log(\"click in menus\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// If the element is selectable, wait until the click is done and see if anything was selected first.\n\t\t\t\t// This is a bit of a weird compromise, for now.\n\t\t\t\tconst target_style = getComputedStyle(event.target);\n\t\t\t\tif (target_style.userSelect !== \"none\") {\n\t\t\t\t\t// Immediately show the window as focused, just don't refocus a specific control.\n\t\t\t\t\t$w.$content.focus();\n\n\t\t\t\t\t$w.one(\"pointerup pointercancel\", () => {\n\t\t\t\t\t\trequestAnimationFrame(() => { // this seems to make it more reliable in regards to double clicking\n\t\t\t\t\t\t\tif (!getSelection().toString().trim()) {\n\t\t\t\t\t\t\t\trefocus();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// Set focus to the last focused control, which should be updated if a click just occurred.\n\t\t\t\trefocus();\n\t\t\t});\n\t\t}\n\n\t\t$w.on(\"keydown\", (e) => {\n\t\t\tif (e.isDefaultPrevented()) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (e.ctrlKey || e.altKey || e.metaKey) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// console.log(\"keydown\", e.key, e.target);\n\t\t\tif (e.target.closest(\".menus\")) {\n\t\t\t\t// console.log(\"keydown in menus\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst $buttons = $w.$content.find(\"button\");\n\t\t\tconst $focused = $(document.activeElement);\n\t\t\tconst focused_index = $buttons.index($focused);\n\t\t\tswitch (e.keyCode) {\n\t\t\t\tcase 40: // Down\n\t\t\t\tcase 39: // Right\n\t\t\t\t\tif ($focused.is(\"button\") && !e.shiftKey) {\n\t\t\t\t\t\tif (focused_index < $buttons.length - 1) {\n\t\t\t\t\t\t\t$buttons[focused_index + 1].focus();\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 38: // Up\n\t\t\t\tcase 37: // Left\n\t\t\t\t\tif ($focused.is(\"button\") && !e.shiftKey) {\n\t\t\t\t\t\tif (focused_index > 0) {\n\t\t\t\t\t\t\t$buttons[focused_index - 1].focus();\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 32: // Space\n\t\t\t\tcase 13: // Enter (doesn't actually work in chrome because the button gets clicked immediately)\n\t\t\t\t\tif ($focused.is(\"button\") && !e.shiftKey) {\n\t\t\t\t\t\t$focused.addClass(\"pressed\");\n\t\t\t\t\t\tconst release = () => {\n\t\t\t\t\t\t\t$focused.removeClass(\"pressed\");\n\t\t\t\t\t\t\t$focused.off(\"focusout\", release);\n\t\t\t\t\t\t\t$(window).off(\"keyup\", keyup);\n\t\t\t\t\t\t};\n\t\t\t\t\t\tconst keyup = (e) => {\n\t\t\t\t\t\t\tif (e.keyCode === 32 || e.keyCode === 13) {\n\t\t\t\t\t\t\t\trelease();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t\t$focused.on(\"focusout\", release);\n\t\t\t\t\t\t$(window).on(\"keyup\", keyup);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 9: { // Tab\n\t\t\t\t\t// wrap around when tabbing through controls in a window\n\t\t\t\t\tconst $controls = find_tabstops($w.$content[0]);\n\t\t\t\t\tif ($controls.length > 0) {\n\t\t\t\t\t\tconst focused_control_index = $controls.index($focused);\n\t\t\t\t\t\tif (e.shiftKey) {\n\t\t\t\t\t\t\tif (focused_control_index === 0) {\n\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t$controls[$controls.length - 1].focus();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif (focused_control_index === $controls.length - 1) {\n\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t$controls[0].focus();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 27: // Escape\n\t\t\t\t\t// @TODO: make this optional, and probably default false\n\t\t\t\t\t$w.close();\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\n\t\t$w.applyBounds = () => {\n\t\t\t// TODO: outerWidth vs width? not sure\n\t\t\tconst bound_width = Math.max(document.body.scrollWidth, innerWidth);\n\t\t\tconst bound_height = Math.max(document.body.scrollHeight, innerHeight);\n\t\t\t$w.css({\n\t\t\t\tleft: Math.max(0, Math.min(bound_width - $w.width(), $w.position().left)),\n\t\t\t\ttop: Math.max(0, Math.min(bound_height - $w.height(), $w.position().top)),\n\t\t\t});\n\t\t};\n\n\t\t$w.bringTitleBarInBounds = () => {\n\t\t\t// Try to make the titlebar always accessible\n\t\t\tconst bound_width = Math.max(document.body.scrollWidth, innerWidth);\n\t\t\tconst bound_height = Math.max(document.body.scrollHeight, innerHeight);\n\t\t\tconst min_horizontal_pixels_on_screen = 40; // enough for space past a close button\n\t\t\t$w.css({\n\t\t\t\tleft: Math.max(\n\t\t\t\t\tmin_horizontal_pixels_on_screen - $w.outerWidth(),\n\t\t\t\t\tMath.min(\n\t\t\t\t\t\tbound_width - min_horizontal_pixels_on_screen,\n\t\t\t\t\t\t$w.position().left\n\t\t\t\t\t)\n\t\t\t\t),\n\t\t\t\ttop: Math.max(0, Math.min(\n\t\t\t\t\tbound_height - $w.$titlebar.outerHeight() - 5,\n\t\t\t\t\t$w.position().top\n\t\t\t\t)),\n\t\t\t});\n\t\t};\n\n\t\t$w.center = () => {\n\t\t\t$w.css({\n\t\t\t\tleft: (innerWidth - $w.width()) / 2 + window.scrollX,\n\t\t\t\ttop: (innerHeight - $w.height()) / 2 + window.scrollY,\n\t\t\t});\n\t\t\t$w.applyBounds();\n\t\t};\n\n\n\t\t$G.on(\"resize\", $w.bringTitleBarInBounds);\n\n\t\tvar drag_offset_x, drag_offset_y, drag_pointer_x, drag_pointer_y, drag_pointer_id;\n\t\tvar update_drag = (e) => {\n\t\t\tif (drag_pointer_id === (e.pointerId ||/*??*/ e.originalEvent.pointerId)) {\n\t\t\t\tdrag_pointer_x = e.clientX ||/*??*/ drag_pointer_x;\n\t\t\t\tdrag_pointer_y = e.clientY ||/*??*/ drag_pointer_y;\n\t\t\t}\n\t\t\t$w.css({\n\t\t\t\tleft: drag_pointer_x + scrollX - drag_offset_x,\n\t\t\t\ttop: drag_pointer_y + scrollY - drag_offset_y,\n\t\t\t});\n\t\t};\n\t\t$w.$titlebar.css(\"touch-action\", \"none\");\n\t\t$w.$titlebar.on(\"selectstart\", (e) => { // preventing mousedown would break :active state, I'm not sure if just selectstart is enough...\n\t\t\te.preventDefault();\n\t\t});\n\t\t$w.$titlebar.on(\"mousedown\", \"button\", (e) => {\n\t\t\t// Prevent focus on titlebar buttons.\n\t\t\t// This can break the :active state. In Firefox, a setTimeout before any focus() was enough,\n\t\t\t// but now in Chrome 95, focus() breaks the :active state too, and setTimeout only delays the brokenness,\n\t\t\t// so I have to use a CSS class now for the pressed state.\n\t\t\trefocus();\n\t\t\t// Emulate :enabled:active:hover state with .pressing class\n\t\t\tconst button = e.currentTarget;\n\t\t\tif (!$(button).is(\":enabled\")) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tbutton.classList.add(\"pressing\");\n\t\t\tconst release = (event) => {\n\t\t\t\t// blur is just to handle the edge case of alt+tabbing/ctrl+tabbing away\n\t\t\t\tif (event && event.type === \"blur\") {\n\t\t\t\t\t// if (document.activeElement?.tagName === \"IFRAME\") {\n\t\t\t\t\tif (document.hasFocus()) {\n\t\t\t\t\t\treturn; // the window isn't really blurred; an iframe got focus\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbutton.classList.remove(\"pressing\");\n\t\t\t\t$G.off(\"mouseup blur\", release);\n\t\t\t\t$(button).off(\"mouseenter\", on_mouse_enter);\n\t\t\t\t$(button).off(\"mouseleave\", on_mouse_leave);\n\t\t\t};\n\t\t\tconst on_mouse_enter = () => { button.classList.add(\"pressing\"); };\n\t\t\tconst on_mouse_leave = () => { button.classList.remove(\"pressing\"); };\n\t\t\t$G.on(\"mouseup blur\", release);\n\t\t\t$(button).on(\"mouseenter\", on_mouse_enter);\n\t\t\t$(button).on(\"mouseleave\", on_mouse_leave);\n\t\t});\n\t\t$w.$titlebar.on(\"pointerdown\", (e) => {\n\t\t\tif ($(e.target).closest(\"button\").length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($w.hasClass(\"maximized\")) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst customEvent = $.Event(\"window-drag-start\");\n\t\t\t$w.trigger(customEvent);\n\t\t\tif (customEvent.isDefaultPrevented()) {\n\t\t\t\treturn; // allow custom drag behavior of component windows in jspaint (Tools / Colors)\n\t\t\t}\n\t\t\tdrag_offset_x = e.clientX + scrollX - $w.position().left;\n\t\t\tdrag_offset_y = e.clientY + scrollY - $w.position().top;\n\t\t\tdrag_pointer_x = e.clientX;\n\t\t\tdrag_pointer_y = e.clientY;\n\t\t\tdrag_pointer_id = (e.pointerId ||/*??*/ e.originalEvent.pointerId);\n\t\t\t$G.on(\"pointermove\", update_drag);\n\t\t\t$G.on(\"scroll\", update_drag);\n\t\t\t$(\"body\").addClass(\"dragging\"); // for when mouse goes over an iframe\n\t\t});\n\t\t$G.on(\"pointerup pointercancel\", (e) => {\n\t\t\tif ((e.pointerId ||/*??*/ e.originalEvent.pointerId) !== drag_pointer_id) { return; }\n\t\t\t$G.off(\"pointermove\", update_drag);\n\t\t\t$G.off(\"scroll\", update_drag);\n\t\t\t$(\"body\").removeClass(\"dragging\");\n\t\t\t// $w.applyBounds(); // Windows doesn't really try to keep windows on screen\n\t\t\t// but you also can't really drag off of the desktop, whereas here you can drag to way outside the web page.\n\t\t\t$w.bringTitleBarInBounds();\n\t\t\tdrag_pointer_id = -1; // prevent bringTitleBarInBounds from making the window go to top left when unminimizing window from taskbar after previously dragging it\n\t\t});\n\t\t$w.$titlebar.on(\"dblclick\", (e) => {\n\t\t\tif ($component) {\n\t\t\t\t$component.dock();\n\t\t\t}\n\t\t});\n\n\t\tif (options.resizable) {\n\n\t\t\tconst HANDLE_MIDDLE = 0;\n\t\t\tconst HANDLE_START = -1;\n\t\t\tconst HANDLE_END = 1;\n\t\t\tconst HANDLE_LEFT = HANDLE_START;\n\t\t\tconst HANDLE_RIGHT = HANDLE_END;\n\t\t\tconst HANDLE_TOP = HANDLE_START;\n\t\t\tconst HANDLE_BOTTOM = HANDLE_END;\n\n\t\t\t[\n\t\t\t\t[HANDLE_TOP, HANDLE_RIGHT], // \n\t\t\t\t[HANDLE_TOP, HANDLE_MIDDLE], // \n\t\t\t\t[HANDLE_TOP, HANDLE_LEFT], // \n\t\t\t\t[HANDLE_MIDDLE, HANDLE_LEFT], // \n\t\t\t\t[HANDLE_BOTTOM, HANDLE_LEFT], // \n\t\t\t\t[HANDLE_BOTTOM, HANDLE_MIDDLE], // \n\t\t\t\t[HANDLE_BOTTOM, HANDLE_RIGHT], // \n\t\t\t\t[HANDLE_MIDDLE, HANDLE_RIGHT], // \n\t\t\t].forEach(([y_axis, x_axis]) => {\n\t\t\t\t// const resizes_height = y_axis !== HANDLE_MIDDLE;\n\t\t\t\t// const resizes_width = x_axis !== HANDLE_MIDDLE;\n\t\t\t\tconst $handle = $(\"<div>\").addClass(\"handle\").appendTo($w);\n\n\t\t\t\tlet cursor = \"\";\n\t\t\t\tif (y_axis === HANDLE_TOP) { cursor += \"n\"; }\n\t\t\t\tif (y_axis === HANDLE_BOTTOM) { cursor += \"s\"; }\n\t\t\t\tif (x_axis === HANDLE_LEFT) { cursor += \"w\"; }\n\t\t\t\tif (x_axis === HANDLE_RIGHT) { cursor += \"e\"; }\n\t\t\t\tcursor += \"-resize\";\n\n\t\t\t\t// Note: MISNOMER: innerWidth() is less \"inner\" than width(), because it includes padding!\n\t\t\t\t// Here's a little diagram of sorts:\n\t\t\t\t// outerWidth(true): margin, [ outerWidth(): border, [ innerWidth(): padding, [ width(): content ] ] ]\n\t\t\t\tconst handle_thickness = ($w.outerWidth() - $w.width()) / 2; // padding + border\n\t\t\t\tconst border_width = ($w.outerWidth() - $w.innerWidth()) / 2; // border; need to outset the handles by this amount so they overlap the border + padding, and not the content\n\t\t\t\tconst window_frame_height = $w.outerHeight() - $w.$content.outerHeight(); // includes titlebar and borders, padding, but not content\n\t\t\t\tconst window_frame_width = $w.outerWidth() - $w.$content.outerWidth(); // includes borders, padding, but not content\n\t\t\t\t$handle.css({\n\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\ttop: y_axis === HANDLE_TOP ? -border_width : y_axis === HANDLE_MIDDLE ? `calc(${handle_thickness}px - ${border_width}px)` : \"\",\n\t\t\t\t\tbottom: y_axis === HANDLE_BOTTOM ? -border_width : \"\",\n\t\t\t\t\tleft: x_axis === HANDLE_LEFT ? -border_width : x_axis === HANDLE_MIDDLE ? `calc(${handle_thickness}px - ${border_width}px)` : \"\",\n\t\t\t\t\tright: x_axis === HANDLE_RIGHT ? -border_width : \"\",\n\t\t\t\t\twidth: x_axis === HANDLE_MIDDLE ? `calc(100% - ${handle_thickness}px * 2 + ${border_width * 2}px)` : `${handle_thickness}px`,\n\t\t\t\t\theight: y_axis === HANDLE_MIDDLE ? `calc(100% - ${handle_thickness}px * 2 + ${border_width * 2}px)` : `${handle_thickness}px`,\n\t\t\t\t\t// background: x_axis === HANDLE_MIDDLE || y_axis === HANDLE_MIDDLE ? \"rgba(255,0,0,0.4)\" : \"rgba(0,255,0,0.8)\",\n\t\t\t\t\ttouchAction: \"none\",\n\t\t\t\t\tcursor,\n\t\t\t\t});\n\n\t\t\t\tlet rect;\n\t\t\t\tlet resize_offset_x, resize_offset_y, resize_pointer_x, resize_pointer_y, resize_pointer_id;\n\t\t\t\t$handle.on(\"pointerdown\", (e) => {\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t$G.on(\"pointermove\", handle_pointermove);\n\t\t\t\t\t$G.on(\"scroll\", update_resize); // scroll doesn't have clientX/Y, so we have to remember it\n\t\t\t\t\t$(\"body\").addClass(\"dragging\"); // for when mouse goes over an iframe\n\t\t\t\t\t$G.on(\"pointerup pointercancel\", end_resize);\n\n\t\t\t\t\trect = {\n\t\t\t\t\t\tx: $w.position().left,\n\t\t\t\t\t\ty: $w.position().top,\n\t\t\t\t\t\twidth: $w.outerWidth(),\n\t\t\t\t\t\theight: $w.outerHeight(),\n\t\t\t\t\t};\n\n\t\t\t\t\tresize_offset_x = e.clientX + scrollX - rect.x - (x_axis === HANDLE_RIGHT ? rect.width : 0);\n\t\t\t\t\tresize_offset_y = e.clientY + scrollY - rect.y - (y_axis === HANDLE_BOTTOM ? rect.height : 0);\n\t\t\t\t\tresize_pointer_x = e.clientX;\n\t\t\t\t\tresize_pointer_y = e.clientY;\n\t\t\t\t\tresize_pointer_id = (e.pointerId ||/*??*/ e.originalEvent.pointerId);\n\n\t\t\t\t\t$handle[0].setPointerCapture(resize_pointer_id); // keeps cursor consistent when mouse moves over other elements\n\n\t\t\t\t\t// handle_pointermove(e); // was useful for checking that the offset is correct (should not do anything, if it's correct!)\n\t\t\t\t});\n\t\t\t\tfunction handle_pointermove(e) {\n\t\t\t\t\tif ((e.pointerId ||/*??*/ e.originalEvent.pointerId) !== resize_pointer_id) { return; }\n\t\t\t\t\tresize_pointer_x = e.clientX;\n\t\t\t\t\tresize_pointer_y = e.clientY;\n\t\t\t\t\tupdate_resize();\n\t\t\t\t}\n\t\t\t\tfunction end_resize(e) {\n\t\t\t\t\tif ((e.pointerId ||/*??*/ e.originalEvent.pointerId) !== resize_pointer_id) { return; }\n\t\t\t\t\t$G.off(\"pointermove\", handle_pointermove);\n\t\t\t\t\t$G.off(\"scroll\", onscroll);\n\t\t\t\t\t$(\"body\").removeClass(\"dragging\");\n\t\t\t\t\t$G.off(\"pointerup pointercancel\", end_resize);\n\t\t\t\t\t$w.bringTitleBarInBounds();\n\t\t\t\t}\n\t\t\t\tfunction update_resize() {\n\t\t\t\t\tconst mouse_x = resize_pointer_x + scrollX - resize_offset_x;\n\t\t\t\t\tconst mouse_y = resize_pointer_y + scrollY - resize_offset_y;\n\t\t\t\t\tlet delta_x = 0;\n\t\t\t\t\tlet delta_y = 0;\n\t\t\t\t\tlet width, height;\n\t\t\t\t\tif (x_axis === HANDLE_RIGHT) {\n\t\t\t\t\t\tdelta_x = 0;\n\t\t\t\t\t\twidth = ~~(mouse_x - rect.x);\n\t\t\t\t\t} else if (x_axis === HANDLE_LEFT) {\n\t\t\t\t\t\tdelta_x = ~~(mouse_x - rect.x);\n\t\t\t\t\t\twidth = ~~(rect.x + rect.width - mouse_x);\n\t\t\t\t\t} else {\n\t\t\t\t\t\twidth = ~~(rect.width);\n\t\t\t\t\t}\n\t\t\t\t\tif (y_axis === HANDLE_BOTTOM) {\n\t\t\t\t\t\tdelta_y = 0;\n\t\t\t\t\t\theight = ~~(mouse_y - rect.y);\n\t\t\t\t\t} else if (y_axis === HANDLE_TOP) {\n\t\t\t\t\t\tdelta_y = ~~(mouse_y - rect.y);\n\t\t\t\t\t\theight = ~~(rect.y + rect.height - mouse_y);\n\t\t\t\t\t} else {\n\t\t\t\t\t\theight = ~~(rect.height);\n\t\t\t\t\t}\n\t\t\t\t\tlet new_rect = {\n\t\t\t\t\t\tx: rect.x + delta_x,\n\t\t\t\t\t\ty: rect.y + delta_y,\n\t\t\t\t\t\twidth,\n\t\t\t\t\t\theight,\n\t\t\t\t\t};\n\n\t\t\t\t\tnew_rect.width = Math.max(1, new_rect.width);\n\t\t\t\t\tnew_rect.height = Math.max(1, new_rect.height);\n\n\t\t\t\t\t// Constraints\n\t\t\t\t\tif (options.constrainRect) {\n\t\t\t\t\t\tnew_rect = options.constrainRect(new_rect, x_axis, y_axis);\n\t\t\t\t\t}\n\t\t\t\t\tnew_rect.width = Math.max(new_rect.width, options.minOuterWidth ||/*??*/ 100);\n\t\t\t\t\tnew_rect.height = Math.max(new_rect.height, options.minOuterHeight ||/*??*/ 0);\n\t\t\t\t\tnew_rect.width = Math.max(new_rect.width, (options.minInnerWidth ||/*??*/ 0) + window_frame_width);\n\t\t\t\t\tnew_rect.height = Math.max(new_rect.height, (options.minInnerHeight ||/*??*/ 0) + window_frame_height);\n\t\t\t\t\t// prevent free movement via resize past minimum size\n\t\t\t\t\tif (x_axis === HANDLE_LEFT) {\n\t\t\t\t\t\tnew_rect.x = Math.min(new_rect.x, rect.x + rect.width - new_rect.width);\n\t\t\t\t\t}\n\t\t\t\t\tif (y_axis === HANDLE_TOP) {\n\t\t\t\t\t\tnew_rect.y = Math.min(new_rect.y, rect.y + rect.height - new_rect.height);\n\t\t\t\t\t}\n\n\t\t\t\t\t$w.css({\n\t\t\t\t\t\ttop: new_rect.y,\n\t\t\t\t\t\tleft: new_rect.x,\n\t\t\t\t\t});\n\t\t\t\t\t$w.outerWidth(new_rect.width);\n\t\t\t\t\t$w.outerHeight(new_rect.height);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t$w.$Button = (text, handler) => {\n\t\t\tvar $b = $(E(\"button\"))\n\t\t\t\t.appendTo($w.$content)\n\t\t\t\t.text(text)\n\t\t\t\t.on(\"click\", () => {\n\t\t\t\t\tif (handler) {\n\t\t\t\t\t\thandler();\n\t\t\t\t\t}\n\t\t\t\t\t$w.close();\n\t\t\t\t});\n\t\t\treturn $b;\n\t\t};\n\t\t$w.title = title => {\n\t\t\tif (title) {\n\t\t\t\t$w.$title.text(title);\n\t\t\t\t$w.trigger(\"title-change\");\n\t\t\t\tif ($w.task) {\n\t\t\t\t\t$w.task.updateTitle();\n\t\t\t\t}\n\t\t\t\treturn $w;\n\t\t\t} else {\n\t\t\t\treturn $w.$title.text();\n\t\t\t}\n\t\t};\n\t\t$w.getTitle = () => {\n\t\t\treturn $w.title();\n\t\t};\n\t\tlet animating_titlebar = false;\n\t\tlet when_done_animating_titlebar = []; // queue of functions to call when done animating,\n\t\t// so maximize() / minimize() / restore() eventually gives the same result as if there was no animation\n\t\t$w.animateTitlebar = (from, to, callback = () => { }) => {\n\t\t\t// flying titlebar animation\n\t\t\tanimating_titlebar = true;\n\t\t\tconst $eye_leader = $w.$titlebar.clone(true);\n\t\t\t$eye_leader.find(\"button\").remove();\n\t\t\t$eye_leader.appendTo(\"body\");\n\t\t\tconst duration_ms = $Window.OVERRIDE_TRANSITION_DURATION ||/*??*/ 200; // TODO: how long?\n\t\t\tconst duration_str = `${duration_ms}ms`;\n\t\t\t$eye_leader.css({\n\t\t\t\ttransition: `left ${duration_str} linear, top ${duration_str} linear, width ${duration_str} linear, height ${duration_str} linear`,\n\t\t\t\tposition: \"fixed\",\n\t\t\t\tzIndex: 10000000,\n\t\t\t\tpointerEvents: \"none\",\n\t\t\t\tleft: from.left,\n\t\t\t\ttop: from.top,\n\t\t\t\twidth: from.width,\n\t\t\t\theight: from.height,\n\t\t\t});\n\t\t\tsetTimeout(() => {\n\t\t\t\t$eye_leader.css({\n\t\t\t\t\tleft: to.left,\n\t\t\t\t\ttop: to.top,\n\t\t\t\t\twidth: to.width,\n\t\t\t\t\theight: to.height,\n\t\t\t\t});\n\t\t\t}, 5);\n\t\t\tlet handled_transition_completion = false;\n\t\t\tconst handle_transition_completion = () => {\n\t\t\t\tif (handled_transition_completion) {\n\t\t\t\t\treturn; // ignore multiple calls (an idempotency pattern)\n\t\t\t\t} else {\n\t\t\t\t\thandled_transition_completion = true;\n\t\t\t\t}\n\t\t\t\tanimating_titlebar = false;\n\t\t\t\t$eye_leader.remove();\n\t\t\t\tcallback();\n\t\t\t\tlet anima = when_done_animating_titlebar.shift()\n\t\t\t\tanima && anima(); // relies on animating_titlebar = false;\n\t\t\t};\n\t\t\t$eye_leader.on(\"transitionend transitioncancel\", handle_transition_completion);\n\t\t\tsetTimeout(handle_transition_completion, duration_ms * 1.2);\n\t\t};\n\t\t$w.close = (force) => {\n\t\t\tif (force && force !== true) {\n\t\t\t\tthrow new TypeError(\"force must be a boolean or undefined, not \" + Object.prototype.toString.call(force));\n\t\t\t}\n\t\t\tif (!force) {\n\t\t\t\tvar e = $.Event(\"close\");\n\t\t\t\t$w.trigger(e);\n\t\t\t\tif (e.isDefaultPrevented()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($component) {\n\t\t\t\t$component.detach();\n\t\t\t}\n\t\t\t$w.closed = true;\n\t\t\t$event_target.triggerHandler(\"closed\");\n\t\t\t$w.trigger(\"closed\");\n\t\t\t// TODO: change usages of \"close\" to \"closed\" where appropriate\n\t\t\t// and probably rename the \"close\" event (\"before[-]close\"? \"may-close\"? \"close-request\"?)\n\n\t\t\t// MUST be after any events are triggered!\n\t\t\t$w.remove();\n\n\t\t\t// TODO: support modals, which should focus what was focused before the modal was opened.\n\t\t\t// (Note: must consider the element being removed from the DOM, or hidden, or made un-focusable)\n\t\t\t// (Also: modals should steal focus / be brought to the front when focusing the parent window, and the parent window's content should be inert/uninteractive)\n\t\t\t\n\t\t\t// Focus next-topmost window\n\t\t\tvar $next_topmost = $($(\".window:visible\").toArray().sort((a, b) => b.style.zIndex - a.style.zIndex)[0]);\n\t\t\t$next_topmost.triggerHandler(\"refocus-window\");\n\n\t\t\t// Cleanup\n\t\t\tclean_up_debug_focus_tracking();\n\t\t};\n\t\t$w.closed = false;\n\n\t\tlet current_menu_bar;\n\t\t// @TODO: should this be like setMenus(menu_definitions)?\n\t\t// It seems like setMenuBar(menu_bar) might be prone to bugs\n\t\t// trying to set the same menu bar on multiple windows.\n\t\t$w.setMenuBar = (menu_bar) => {\n\t\t\t// $w.find(\".menus\").remove(); // ugly, if only because of the class name haha\n\t\t\tif (current_menu_bar) {\n\t\t\t\tcurrent_menu_bar.element.remove();\n\t\t\t}\n\t\t\tif (menu_bar) {\n\t\t\t\t$w.$titlebar.after(menu_bar.element);\n\t\t\t\tmenu_bar.setKeyboardScope($w[0]);\n\t\t\t\tcurrent_menu_bar = menu_bar;\n\t\t\t}\n\t\t};\n\n\t\tif (options.title) {\n\t\t\t$w.title(options.title);\n\t\t}\n\n\t\tif (!$component) {\n\t\t\t$w.center();\n\t\t}\n\n\t\t// mustHaveMethods($w, windowInterfaceMethods);\n\n\t\treturn $w;\n\t}\n\n\tfunction $FormWindow(title) {\n\t\tvar $w = new $Window();\n\n\t\t$w.title(title);\n\t\t$w.$form = $(E(\"form\")).appendTo($w.$content);\n\t\t$w.$main = $(E(\"div\")).appendTo($w.$form);\n\t\t$w.$buttons = $(E(\"div\")).appendTo($w.$form).addClass(\"button-group\");\n\n\t\t$w.$Button = (label, action) => {\n\t\t\tvar $b = $(E(\"button\")).appendTo($w.$buttons).text(label);\n\t\t\t$b.on(\"click\", (e) => {\n\t\t\t\t// prevent the form from submitting\n\t\t\t\t// @TODO: instead, prevent the form's submit event\n\t\t\t\te.preventDefault();\n\n\t\t\t\taction();\n\t\t\t});\n\n\t\t\t$b.on(\"pointerdown\", () => {\n\t\t\t\t$b.focus();\n\t\t\t});\n\n\t\t\treturn $b;\n\t\t};\n\n\t\treturn $w;\n\t}\n\n\t$Window.$FormWindow = $FormWindow;\n\t\n\treturn $Window;\n});\n\ndefine('skylark-98js/iframe-windows',[\n\t\"skylark-jquery\",\n\t\"./win98\",\n\t\"./os-gui/$Window\"\n],function($,win98js,$Window){\n\tvar programs_being_loaded = 0;\n\n\tvar $G = $(window);\n\t\n\tfunction enhance_iframe(iframe) {\n\t\tvar $iframe = $(iframe);\n\n\t\t$(\"body\").addClass(\"loading-program\");\n\t\tprograms_being_loaded += 1;\n\n\t\t$iframe.on(\"load\", function () {\n\n\t\t\tif (--programs_being_loaded <= 0) {\n\t\t\t\t$(\"body\").removeClass(\"loading-program\");\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconsole.assert(iframe.contentWindow.document === iframe.contentDocument); // just something that won't get optimized away if we were to ever use a minifier (or by the JIT compiler??)\n\t\t\t} catch (e) {\n\t\t\t\tconsole.warn(`[enhance_iframe] iframe integration is not available for '${iframe.src}'`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (window.themeCSSProperties) {\n\t\t\t\tapplyTheme(themeCSSProperties, iframe.contentDocument.documentElement);\n\t\t\t}\n\n\t\t\t// Let the iframe to handle mouseup events outside itself\n\t\t\t// (without using setPointerCapture)\n\t\t\tiframe.contentDocument.addEventListener(\"mousedown\", (event) => {\n\t\t\t\tvar delegate_pointerup = function () {\n\t\t\t\t\tif (iframe.contentWindow && iframe.contentWindow.jQuery) {\n\t\t\t\t\t\tiframe.contentWindow.jQuery(\"body\").trigger(\"pointerup\");\n\t\t\t\t\t}\n\t\t\t\t\tif (iframe.contentWindow) {\n\t\t\t\t\t\tconst event = new iframe.contentWindow.MouseEvent(\"mouseup\", { button: 0 });\n\t\t\t\t\t\tiframe.contentWindow.dispatchEvent(event);\n\t\t\t\t\t\tconst event2 = new iframe.contentWindow.MouseEvent(\"mouseup\", { button: 2 });\n\t\t\t\t\t\tiframe.contentWindow.dispatchEvent(event2);\n\t\t\t\t\t}\n\t\t\t\t\tclean_up_delegation();\n\t\t\t\t};\n\t\t\t\t// @TODO: delegate pointermove events too?\n\t\t\t\t// @TODO: do delegation in os-gui.js library instead\n\t\t\t\t// is it delegation? I think I mean proxying (but I'm really tired and don't have internet right now so I can't say for sure haha)\n\n\t\t\t\t$G.on(\"mouseup blur\", delegate_pointerup);\n\t\t\t\tiframe.contentDocument.addEventListener(\"mouseup\", clean_up_delegation);\n\t\t\t\tfunction clean_up_delegation() {\n\t\t\t\t\t$G.off(\"mouseup blur\", delegate_pointerup);\n\t\t\t\t\tiframe.contentDocument.removeEventListener(\"mouseup\", clean_up_delegation);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Let the containing page handle keyboard events, with an opportunity to cancel them\n\t\t\tproxy_keyboard_events(iframe);\n\n\t\t\t// on Wayback Machine, and iframe's url not saved yet\n\t\t\tif (iframe.contentDocument.querySelector(\"#error #livewebInfo.available\")) {\n\t\t\t\tvar message = document.createElement(\"div\");\n\t\t\t\tmessage.style.position = \"absolute\";\n\t\t\t\tmessage.style.left = \"0\";\n\t\t\t\tmessage.style.right = \"0\";\n\t\t\t\tmessage.style.top = \"0\";\n\t\t\t\tmessage.style.bottom = \"0\";\n\t\t\t\tmessage.style.background = \"#c0c0c0\";\n\t\t\t\tmessage.style.color = \"#000\";\n\t\t\t\tmessage.style.padding = \"50px\";\n\t\t\t\tiframe.contentDocument.body.appendChild(message);\n\t\t\t\tmessage.innerHTML = `<a target=\"_blank\">Save this url in the Wayback Machine</a>`;\n\t\t\t\tmessage.querySelector(\"a\").href =\n\t\t\t\t\t\"https://web.archive.org/save/https://98.js.org/\" +\n\t\t\t\t\tiframe.src.replace(/.*https:\\/\\/98.js.org\\/?/, \"\");\n\t\t\t\tmessage.querySelector(\"a\").style.color = \"blue\";\n\t\t\t}\n\n\t\t\tvar $contentWindow = $(iframe.contentWindow);\n\t\t\t$contentWindow.on(\"pointerdown click\", function (e) {\n\t\t\t\tiframe.$window && iframe.$window.focus();\n\n\t\t\t\t// from close_menus in $MenuBar\n\t\t\t\t$(\".menu-button\").trigger(\"release\");\n\t\t\t\t// Close any rogue floating submenus\n\t\t\t\t$(\".menu-popup\").hide();\n\t\t\t});\n\t\t\t// We want to disable pointer events for other iframes, but not this one\n\t\t\t$contentWindow.on(\"pointerdown\", function (e) {\n\t\t\t\t$iframe.css(\"pointer-events\", \"all\");\n\t\t\t\t$(\"body\").addClass(\"drag\");\n\t\t\t});\n\t\t\t$contentWindow.on(\"pointerup\", function (e) {\n\t\t\t\t$(\"body\").removeClass(\"drag\");\n\t\t\t\t$iframe.css(\"pointer-events\", \"\");\n\t\t\t});\n\t\t\t// $(\"iframe\").css(\"pointer-events\", \"\"); is called elsewhere.\n\t\t\t// Otherwise iframes would get stuck in this interaction mode\n\n\t\t\tiframe.contentWindow.close = function () {\n\t\t\t\tiframe.$window && iframe.$window.close();\n\t\t\t};\n\t\t\t// TODO: hook into saveAs (a la FileSaver.js) and another function for opening files\n\t\t\t// iframe.contentWindow.saveAs = function(){\n\t\t\t// \tsaveAsDialog();\n\t\t\t// };\n\n\t\t\t// Don't override alert (except within the specific pages)\n\t\t\t// but override the underlying message box function that\n\t\t\t// the alert override uses, so that the message boxes can\n\t\t\t// go outside the window.\n\t\t\tiframe.contentWindow.showMessageBox = (options) => {\n\t\t\t\treturn showMessageBox({\n\t\t\t\t\ttitle: options.title /*??*/ ||  iframe.contentWindow.defaultMessageBoxTitle,\n\t\t\t\t\t...options,\n\t\t\t\t});\n\t\t\t};\n\t\t});\n\t\t$iframe.css({\n\t\t\tminWidth: 0,\n\t\t\tminHeight: 0, // overrides user agent styling apparently, fixes Sound Recorder\n\t\t\tflex: 1,\n\t\t\tborder: 0, // overrides user agent styling\n\t\t});\n\t}\n\n\t// Let the containing page handle keyboard events, with an opportunity to cancel them\n\tfunction proxy_keyboard_events(iframe) {\n\t\t// Note: iframe must be same-origin, or this will fail.\n\t\tfor (const event_type of [\"keyup\", \"keydown\", \"keypress\"]) {\n\t\t\tiframe.contentWindow.addEventListener(event_type, (event) => {\n\t\t\t\tconst proxied_event = new KeyboardEvent(event_type, {\n\t\t\t\t\ttarget: iframe,\n\t\t\t\t\tview: iframe.ownerDocument.defaultView,\n\t\t\t\t\tbubbles: true,\n\t\t\t\t\tcancelable: true,\n\t\t\t\t\tkey: event.key,\n\t\t\t\t\tkeyCode: event.keyCode,\n\t\t\t\t\twhich: event.which,\n\t\t\t\t\tcode: event.code,\n\t\t\t\t\tshiftKey: event.shiftKey,\n\t\t\t\t\tctrlKey: event.ctrlKey,\n\t\t\t\t\tmetaKey: event.metaKey,\n\t\t\t\t\taltKey: event.altKey,\n\t\t\t\t\trepeat: event.repeat,\n\t\t\t\t\t//...@TODO: should it copy ALL properties?\n\t\t\t\t});\n\t\t\t\tconst result = iframe.dispatchEvent(proxied_event);\n\t\t\t\t// console.log(\"proxied\", event, \"as\", proxied_event, \"result\", result);\n\t\t\t\tif (!result) {\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t}\n\t\t\t}, true);\n\t\t}\n\t}\n\n\tfunction make_iframe_window(options) {\n\t\t///options.resizable ??= true;\n\t\tif (options.resizable == undefined) {\n\t\t\toptions.resizable = true;\n\t\t}\n\t\tvar $win = new $Window(options);\n\n\t\tvar $iframe = $win.$iframe = $(\"<iframe>\").attr({ src: options.src });\n\t\tenhance_iframe($iframe[0]);\n\t\t$win.$content.append($iframe);\n\t\tvar iframe = $win.iframe = $iframe[0];\n\t\t// TODO: should I instead of having iframe.$window, have a get$Window type of dealio?\n\t\t// where all is $window needed?\n\t\t// I know it's used from within the iframe contents as frameElement.$window\n\t\tiframe.$window = $win;\n\n\t\t$iframe.on(\"load\", function () {\n\t\t\t$win.show();\n\t\t\t$win.focus();\n\t\t});\n\n\t\t$win.$content.css({\n\t\t\tdisplay: \"flex\",\n\t\t\tflexDirection: \"column\",\n\t\t});\n\n\t\t// TODO: cascade windows\n\t\t$win.center();\n\t\t$win.hide();\n\n\t\treturn $win;\n\t}\n\n\t// Fix dragging things (i.e. windows) over iframes (i.e. other windows)\n\t// (when combined with a bit of css, .drag iframe { pointer-events: none; })\n\t// (and a similar thing in make_iframe_window)\n\t$(window).on(\"pointerdown\", function (e) {\n\t\t//console.log(e.type);\n\t\t$(\"body\").addClass(\"drag\");\n\t});\n\t$(window).on(\"pointerup dragend blur\", function (e) {\n\t\t//console.log(e.type);\n\t\tif (e.type === \"blur\") {\n\t\t\tif (document.activeElement.tagName.match(/iframe/i)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\t$(\"body\").removeClass(\"drag\");\n\t\t$(\"iframe\").css(\"pointer-events\", \"\");\n\t});\n\n\treturn {\n\t\tenhance_iframe,\n\t\tproxy_keyboard_events,\n\t\tmake_iframe_window\n\t}\n\n});\ndefine('skylark-98js/Task',[\n\t\"skylark-jquery\",\n\t\"./win98\"\n],function($,win98js){\n\tfunction Task(win) {\n\t\tTask.all_tasks.push(this);\n\n\t\tthis.$window = win;\n\t\t\n\t\tconst $task = this.$task = $(\"<button class='task toggle'/>\").appendTo($(\".tasks\"));\n\t\tconst $title = $(\"<span class='title'/>\");\n\n\t\tthis.updateTitle = () => {\n\t\t\t$title.text(win.getTitle());\n\t\t};\n\n\t\tlet $icon;\n\t\tthis.updateIcon = () => {\n\t\t\tconst old_$icon = $icon;\n\t\t\t$icon = win.getIconAtSize(16);\n\t\t\tif (!$icon) {\n\t\t\t\t// $icon = $(\"<img src='images/icons/task-16x16.png'/>\");\n\t\t\t\told_$icon && old_$icon.remove();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (old_$icon) {\n\t\t\t\told_$icon.replaceWith($icon);\n\t\t\t} else {\n\t\t\t\t$task.prepend($icon);\n\t\t\t}\n\t\t};\n\n\t\tthis.updateTitle();\n\t\tthis.updateIcon();\n\n\t\twin.on(\"title-change\", this.updateTitle);\n\t\twin.on(\"icon-change\", this.updateIcon);\n\n\t\twin.setMinimizeTarget($task[0]);\n\n\t\t$task.append($icon, $title);\n\t\t$task.on(\"pointerdown\", function (e) {\n\t\t\te.preventDefault(); // prevent focus, so that the window keeps focus and we can know for minimization if it it should be focused or minimized\n\t\t\t// @TODO: do it on whole taskbar\n\t\t});\n\t\t$task.on(\"click\", function () {\n\t\t\tif ($task.hasClass(\"selected\")) {\n\t\t\t\twin.minimize();\n\t\t\t\twin.blur();\n\t\t\t} else {\n\t\t\t\twin.unminimize();\n\t\t\t\twin.bringToFront();\n\t\t\t\twin.focus();\n\t\t\t}\n\t\t});\n\n\t\t/*\n\t\twin.onFocus(() => {\n\t\t\t$task.addClass(\"selected\");\n\t\t});\n\t\twin.onBlur(() => {\n\t\t\t$task.removeClass(\"selected\");\n\t\t});\n\t\twin.onClosed(() => {\n\t\t\t$task.remove();\n\t\t\tconst index = Task.all_tasks.indexOf(this);\n\t\t\tif (index !== -1) {\n\t\t\t\tTask.all_tasks.splice(index, 1);\n\t\t\t}\n\t\t});\n\t\t*/\n\t\twin.on(\"focus\",() => {\n\t\t\t$task.addClass(\"selected\");\n\t\t});\n\t\twin.on(\"blur\",() => {\n\t\t\t$task.removeClass(\"selected\");\n\t\t});\n\t\twin.on(\"closed\",() => {\n\t\t\t$task.remove();\n\t\t\tconst index = Task.all_tasks.indexOf(this);\n\t\t\tif (index !== -1) {\n\t\t\t\tTask.all_tasks.splice(index, 1);\n\t\t\t}\n\t\t});\n\n\t\tif (win.is && win.is(\":visible\")) {\n\t\t\twin.focus();\n\t\t}\n\t}\n\n\tTask.all_tasks = [];\n\n\treturn Task;\n\n});\ndefine('skylark-98js/visualizer-overlay',[\n\t\"skylark-jquery\",\n\t\"./win98\"\n],function($,win98js){\n\tfunction getOffset(element, fromElement) {\n\t\tlet el = element,\n\t\t\toffsetLeft = 0,\n\t\t\toffsetTop = 0;\n\n\t\tdo {\n\t\t\toffsetLeft += el.offsetLeft;\n\t\t\toffsetTop += el.offsetTop;\n\n\t\t\tel = el.offsetParent;\n\t\t} while (el && el !== fromElement);\n\n\t\treturn { offsetLeft, offsetTop };\n\t}\n\n\twindow.monkey_patch_render = (obj) => obj.render();\n\n\tclass VisualizerOverlay {\n\t\tconstructor(visualizerCanvas, renderOptions) {\n\t\t\tthis.visualizerCanvas = visualizerCanvas;\n\n\t\t\tthis.wrappyCanvas = document.createElement(\"canvas\");\n\t\t\tthis.wrappyCtx = this.wrappyCanvas.getContext(\"2d\");\n\n\t\t\tthis.overlayCanvases = [];\n\t\t\tthis.animateFns = [];\n\n\t\t\twindow.monkey_patch_render = (obj) => {\n\t\t\t\t// check for Butterchurn's Visualizer class\n\t\t\t\tif (obj.audio && obj.renderer) {\n\t\t\t\t\tobj.render();\n\t\t\t\t\tthis.render(renderOptions);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\treturn obj.render();\n\t\t\t};\n\t\t}\n\n\t\tmakeOverlayCanvas(windowEl) {\n\t\t\tconst canvas = document.createElement(\"canvas\");\n\t\t\tconst ctx = canvas.getContext(\"2d\");\n\t\t\tcanvas.style.position = \"absolute\";\n\t\t\tcanvas.style.left = \"0\";\n\t\t\tcanvas.style.top = \"0\";\n\t\t\tcanvas.style.pointerEvents = \"none\";\n\t\t\tcanvas.style.mixBlendMode = \"color-dodge\";\n\t\t\tcanvas.style.willChange = \"opacity\"; // hint fixes flickering in chrome\n\t\t\tcanvas.className = \"visualizer-overlay-canvas\";\n\t\t\twindowEl.appendChild(canvas);\n\t\t\tthis.overlayCanvases.push(canvas);\n\t\t\tthis.animateFns.push(options => {\n\t\t\t\tctx.clearRect(0, 0, canvas.width, canvas.height);\n\t\t\t\tconst scale =\n\t\t\t\t\t(windowEl.classList.contains(\"doubled\") ? 2 : 1) *\n\t\t\t\t\t(window.devicePixelRatio || 1);\n\t\t\t\tif (\n\t\t\t\t\tcanvas.width !== windowEl.clientWidth * scale ||\n\t\t\t\t\tcanvas.height !== windowEl.clientHeight * scale\n\t\t\t\t) {\n\t\t\t\t\tcanvas.width = windowEl.clientWidth * scale;\n\t\t\t\t\tcanvas.height = windowEl.clientHeight * scale;\n\t\t\t\t}\n\t\t\t\tcanvas.style.width = windowEl.clientWidth + \"px\";\n\t\t\t\tcanvas.style.height = windowEl.clientHeight + \"px\";\n\t\t\t\tconst stuff = windowEl.querySelectorAll(\"*\");\n\t\t\t\tArray.from(stuff)\n\t\t\t\t\t.map(el => {\n\t\t\t\t\t\tconst width = el.clientWidth;\n\t\t\t\t\t\tconst height = el.clientHeight;\n\t\t\t\t\t\tconst area = width * height;\n\t\t\t\t\t\treturn { element: el, width, height, area };\n\t\t\t\t\t})\n\t\t\t\t\t.filter(({ area }) => area > 0)\n\t\t\t\t\t.sort((a, b) => b.area - a.area)\n\t\t\t\t\t.forEach(({ element, width, height, area }) => {\n\t\t\t\t\t\tconst { offsetLeft, offsetTop } = getOffset(element, windowEl);\n\t\t\t\t\t\tctx.save();\n\t\t\t\t\t\tctx.scale(scale, scale);\n\t\t\t\t\t\tctx.translate(offsetLeft, offsetTop);\n\t\t\t\t\t\tif (options.stretch) {\n\t\t\t\t\t\t\tctx.drawImage(this.wrappyCanvas, 0, 0, width, height);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tctx.drawImage(\n\t\t\t\t\t\t\t\tthis.wrappyCanvas,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\twidth,\n\t\t\t\t\t\t\t\theight,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\twidth,\n\t\t\t\t\t\t\t\theight\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (area < 30 * 30) {\n\t\t\t\t\t\t\tctx.globalCompositeOperation = \"destination-out\";\n\t\t\t\t\t\t\tctx.globalAlpha = 0.5;\n\t\t\t\t\t\t\tctx.fillStyle = \"black\";\n\t\t\t\t\t\t\tctx.fillRect(0, 0, width, height);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tctx.restore();\n\t\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\trender(options) {\n\t\t\tconst { visualizerCanvas, wrappyCanvas, wrappyCtx, animateFns } = this;\n\t\t\tconst { width, height } = visualizerCanvas;\n\t\t\tif (options.mirror) {\n\t\t\t\tconst drawImage = () => {\n\t\t\t\t\twrappyCtx.drawImage(\n\t\t\t\t\t\tvisualizerCanvas,\n\t\t\t\t\t\t0,\n\t\t\t\t\t\t0,\n\t\t\t\t\t\twidth,\n\t\t\t\t\t\theight,\n\t\t\t\t\t\t0,\n\t\t\t\t\t\t0,\n\t\t\t\t\t\twidth,\n\t\t\t\t\t\theight\n\t\t\t\t\t);\n\t\t\t\t\t// zoom in the source area:\n\t\t\t\t\t// wrappyCtx.drawImage(visualizerCanvas, width/4, height/4, width/2, height/2, 0, 0, width, height);\n\t\t\t\t\t// wrappyCtx.drawImage(visualizerCanvas, width/4, height/4, width/4, height/4, 0, 0, width, height);\n\t\t\t\t\t// for testing:\n\t\t\t\t\t// wrappyCtx.fillStyle = \"aqua\";\n\t\t\t\t\t// wrappyCtx.fillRect(0, 0, width, height);\n\t\t\t\t};\n\t\t\t\twrappyCanvas.width = width * 2;\n\t\t\t\twrappyCanvas.height = height * 2;\n\t\t\t\twrappyCtx.save();\n\t\t\t\tdrawImage();\n\t\t\t\twrappyCtx.translate(0, height);\n\t\t\t\twrappyCtx.scale(1, -1);\n\t\t\t\twrappyCtx.translate(0, -height);\n\t\t\t\tdrawImage();\n\t\t\t\twrappyCtx.translate(width, 0);\n\t\t\t\twrappyCtx.scale(-1, 1);\n\t\t\t\twrappyCtx.translate(-width, 0);\n\t\t\t\tdrawImage();\n\t\t\t\twrappyCtx.translate(0, height);\n\t\t\t\twrappyCtx.scale(1, -1);\n\t\t\t\twrappyCtx.translate(0, -height);\n\t\t\t\tdrawImage();\n\t\t\t\twrappyCtx.restore();\n\t\t\t} else if (options.tile) {\n\t\t\t\twrappyCanvas.width = width * 2;\n\t\t\t\twrappyCanvas.height = height * 2;\n\t\t\t\tfor (let xi = 0; xi < 2; xi++) {\n\t\t\t\t\tfor (let yi = 0; yi < 2; yi++) {\n\t\t\t\t\t\twrappyCtx.drawImage(\n\t\t\t\t\t\t\tvisualizerCanvas,\n\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\twidth,\n\t\t\t\t\t\t\theight,\n\t\t\t\t\t\t\twidth * xi,\n\t\t\t\t\t\t\theight * yi,\n\t\t\t\t\t\t\twidth,\n\t\t\t\t\t\t\theight\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\twrappyCanvas.width = width;\n\t\t\t\twrappyCanvas.height = height;\n\t\t\t\twrappyCtx.drawImage(visualizerCanvas, 0, 0, width, height);\n\t\t\t}\n\n\t\t\tanimateFns.forEach(fn => fn(options));\n\t\t}\n\t\tcleanUp() {\n\t\t\tthis.overlayCanvases.forEach(canvas => {\n\t\t\t\tcanvas.remove();\n\t\t\t});\n\t\t\twindow.monkey_patch_render = (obj) => obj.render();\n\t\t}\n\t\tfadeOutAndCleanUp() {\n\t\t\tthis.fadeOut();\n\t\t\tthis.overlayCanvases[0].addEventListener(\"transitionend\", () => {\n\t\t\t\tthis.cleanUp();\n\t\t\t});\n\t\t}\n\t\tfadeOut() {\n\t\t\tthis.overlayCanvases.forEach(canvas => {\n\t\t\t\tcanvas.style.transition =\n\t\t\t\t\t\"opacity 1s cubic-bezier(0.125, 0.960, 0.475, 0.915)\";\n\t\t\t\tcanvas.style.opacity = \"0\";\n\t\t\t});\n\t\t}\n\t\tfadeIn() {\n\t\t\tthis.overlayCanvases.forEach(canvas => {\n\t\t\t\tcanvas.style.transition = \"opacity 0.2s ease\";\n\t\t\t\tcanvas.style.opacity = \"1\";\n\t\t\t});\n\t\t}\n\t}\n\n\n\treturn VisualizerOverlay;\n});\ndefine('skylark-98js/programs',[\n\t\"skylark-jquery\",\n\t\"skylark-browserfs\",\n\t\"./win98\",\n\t\"./filesystem-setup\",\n\t\"./helpers\",\n\t\"./FolderViewItem\",\n\t\"./iframe-windows\",\n\t\"./Task\",\n\t\"./visualizer-overlay\",\n\t\"./os-gui/$Window\"\n],function($,BrowserFS, win98js,FilesystemSetup,helpers,FolderViewItem,iframeWindows,Task,VisualizerOverlay, $Window){\n\tlet make_iframe_window = iframeWindows.make_iframe_window;\n\n\tfunction show_help(options) {\n\t\tconst $help_window = $Window({\n\t\t\ttitle: options.title || \"Help Topics\",\n\t\t\ticons: iconsAtTwoSizes(\"chm\"),\n\t\t\tresizable: true,\n\t\t})\n\t\t$help_window.addClass(\"help-window\");\n\n\t\tlet ignore_one_load = true;\n\t\tlet back_length = 0;\n\t\tlet forward_length = 0;\n\n\t\tconst $main = $(E(\"div\")).addClass(\"main\");\n\t\tconst $toolbar = $(E(\"div\")).addClass(\"toolbar\");\n\t\tconst add_toolbar_button = (name, sprite_n, action_fn, enabled_fn) => {\n\t\t\tconst $button = $(\"<button class='lightweight'>\")\n\t\t\t\t.append($(\"<span>\").text(name))\n\t\t\t\t.appendTo($toolbar)\n\t\t\t\t.on(\"click\", () => {\n\t\t\t\t\taction_fn();\n\t\t\t\t});\n\t\t\t$(\"<div class='icon'/>\")\n\t\t\t\t.appendTo($button)\n\t\t\t\t.css({\n\t\t\t\t\tbackgroundPosition: `${-sprite_n * 55}px 0px`,\n\t\t\t\t});\n\t\t\tconst update_enabled = () => {\n\t\t\t\t$button[0].disabled = enabled_fn && !enabled_fn();\n\t\t\t};\n\t\t\tupdate_enabled();\n\t\t\t$help_window.on(\"click\", \"*\", update_enabled);\n\t\t\t$help_window.on(\"update-buttons\", update_enabled);\n\t\t\treturn $button;\n\t\t};\n\t\tconst measure_sidebar_width = () =>\n\t\t\t$contents.outerWidth() +\n\t\t\tparseFloat(getComputedStyle($contents[0]).getPropertyValue(\"margin-left\")) +\n\t\t\tparseFloat(getComputedStyle($contents[0]).getPropertyValue(\"margin-right\")) +\n\t\t\t$resizer.outerWidth();\n\t\tconst $hide_button = add_toolbar_button(\"Hide\", 0, () => {\n\t\t\tconst toggling_width = measure_sidebar_width();\n\t\t\t$contents.hide();\n\t\t\t$resizer.hide();\n\t\t\t$hide_button.hide();\n\t\t\t$show_button.show();\n\t\t\t$help_window.width($help_window.width() - toggling_width);\n\t\t\t$help_window.css(\"left\", $help_window.offset().left + toggling_width);\n\t\t});\n\t\tconst $show_button = add_toolbar_button(\"Show\", 5, () => {\n\t\t\t$contents.show();\n\t\t\t$resizer.show();\n\t\t\t$show_button.hide();\n\t\t\t$hide_button.show();\n\t\t\tconst toggling_width = measure_sidebar_width();\n\t\t\t$help_window.width($help_window.width() + toggling_width);\n\t\t\t$help_window.css(\"left\", $help_window.offset().left - toggling_width);\n\t\t\t// $help_window.applyBounds() would push the window to fit (before trimming it only if needed)\n\t\t\t// Trim the window to fit (especially for if maximized)\n\t\t\tif ($help_window.offset().left < 0) {\n\t\t\t\t$help_window.width($help_window.width() + $help_window.offset().left);\n\t\t\t\t$help_window.css(\"left\", 0);\n\t\t\t}\n\t\t}).hide();\n\t\tadd_toolbar_button(\"Back\", 1, () => {\n\t\t\t$iframe[0].contentWindow.history.back();\n\t\t\tignore_one_load = true;\n\t\t\tback_length -= 1;\n\t\t\tforward_length += 1;\n\t\t}, () => back_length > 0);\n\t\tadd_toolbar_button(\"Forward\", 2, () => {\n\t\t\t$iframe[0].contentWindow.history.forward();\n\t\t\tignore_one_load = true;\n\t\t\tforward_length -= 1;\n\t\t\tback_length += 1;\n\t\t}, () => forward_length > 0);\n\t\tadd_toolbar_button(\"Options\", 3, () => { }, () => false); // TODO: hotkey and underline on O\n\t\tadd_toolbar_button(\"Web Help\", 4, () => {\n\t\t\tiframe.src = \"help/online_support.htm\";\n\t\t});\n\n\t\tconst $iframe = $(\"<iframe sandbox='allow-same-origin allow-scripts allow-forms allow-modals allow-popups allow-downloads'>\")\n\t\t\t.attr({ src: \"help/default.html\" })\n\t\t\t.addClass(\"inset-deep\");\n\t\tconst iframe = $iframe[0];\n\t\tenhance_iframe(iframe);\n\t\tiframe.$window = $help_window; // for focus handling integration\n\t\tconst $resizer = $(E(\"div\")).addClass(\"resizer\");\n\t\tconst $contents = $(E(\"ul\")).addClass(\"contents inset-deep\");\n\n\t\t// TODO: fix race conditions\n\t\t$iframe.on(\"load\", () => {\n\t\t\tif (!ignore_one_load) {\n\t\t\t\tback_length += 1;\n\t\t\t\tforward_length = 0;\n\t\t\t}\n\t\t\tiframe.contentWindow.location.href\n\t\t\tignore_one_load = false;\n\t\t\t$help_window.triggerHandler(\"update-buttons\");\n\t\t});\n\n\t\t$main.append($contents, $resizer, $iframe);\n\t\t$help_window.$content.append($toolbar, $main);\n\n\t\t$help_window.css({ width: 800, height: 600 });\n\n\t\t$iframe.attr({ name: \"help-frame\" });\n\t\t$iframe.css({\n\t\t\tbackgroundColor: \"white\",\n\t\t\tborder: \"\",\n\t\t\tmargin: \"1px\",\n\t\t});\n\t\t$contents.css({\n\t\t\tmargin: \"1px\",\n\t\t});\n\t\t$help_window.center();\n\n\t\t$main.css({\n\t\t\tposition: \"relative\", // for resizer\n\t\t});\n\n\t\tconst resizer_width = 4;\n\t\t$resizer.css({\n\t\t\tcursor: \"ew-resize\",\n\t\t\twidth: resizer_width,\n\t\t\tboxSizing: \"border-box\",\n\t\t\tbackground: \"var(--ButtonFace)\",\n\t\t\tborderLeft: \"1px solid var(--ButtonShadow)\",\n\t\t\tboxShadow: \"inset 1px 0 0 var(--ButtonHilight)\",\n\t\t\ttop: 0,\n\t\t\tbottom: 0,\n\t\t\tzIndex: 1,\n\t\t});\n\t\t$resizer.on(\"pointerdown\", (e) => {\n\t\t\tlet pointermove, pointerup;\n\t\t\tconst getPos = (e) =>\n\t\t\t\tMath.min($help_window.width() - 100, Math.max(20,\n\t\t\t\t\te.clientX - $help_window.$content.offset().left\n\t\t\t\t));\n\t\t\t$G.on(\"pointermove\", pointermove = (e) => {\n\t\t\t\t$resizer.css({\n\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\tleft: getPos(e)\n\t\t\t\t});\n\t\t\t\t$contents.css({\n\t\t\t\t\tmarginRight: resizer_width,\n\t\t\t\t});\n\t\t\t});\n\t\t\t$G.on(\"pointerup\", pointerup = (e) => {\n\t\t\t\t$G.off(\"pointermove\", pointermove);\n\t\t\t\t$G.off(\"pointerup\", pointerup);\n\t\t\t\t$resizer.css({\n\t\t\t\t\tposition: \"\",\n\t\t\t\t\tleft: \"\"\n\t\t\t\t});\n\t\t\t\t$contents.css({\n\t\t\t\t\tflexBasis: getPos(e) - resizer_width,\n\t\t\t\t\tmarginRight: \"\",\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tconst parse_object_params = $object => {\n\t\t\t// parse an $(<object>) to a plain object of key value pairs\n\t\t\tconst object = {};\n\t\t\tfor (const param of $object.children(\"param\").get()) {\n\t\t\t\tobject[param.name] = param.value;\n\t\t\t}\n\t\t\treturn object;\n\t\t};\n\n\t\tlet $last_expanded;\n\n\t\tconst make_$item = text => {\n\t\t\tconst $item = $(E(\"div\")).addClass(\"item\").text(text);\n\t\t\t$item.on(\"mousedown\", () => {\n\t\t\t\t$contents.find(\".item\").removeClass(\"selected\");\n\t\t\t\t$item.addClass(\"selected\");\n\t\t\t});\n\t\t\t$item.on(\"click\", () => {\n\t\t\t\tconst $li = $item.parent();\n\t\t\t\tif ($li.is(\".folder\")) {\n\t\t\t\t\tif ($last_expanded) {\n\t\t\t\t\t\t$last_expanded.not($li).removeClass(\"expanded\");\n\t\t\t\t\t}\n\t\t\t\t\t$li.toggleClass(\"expanded\");\n\t\t\t\t\t$last_expanded = $li;\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn $item;\n\t\t};\n\n\t\tconst $default_item_li = $(E(\"li\")).addClass(\"page\");\n\t\t$default_item_li.append(make_$item(\"Welcome to Help\").on(\"click\", () => {\n\t\t\t$iframe.attr({ src: \"help/default.html\" });\n\t\t}));\n\t\t$contents.append($default_item_li);\n\n\t\tfunction renderItemFromContents(source_li, $folder_items_ul) {\n\t\t\tconst object = parse_object_params($(source_li).children(\"object\"));\n\t\t\tif ($(source_li).find(\"li\").length > 0) {\n\n\t\t\t\tconst $folder_li = $(E(\"li\")).addClass(\"folder\");\n\t\t\t\t$folder_li.append(make_$item(object.Name));\n\t\t\t\t$contents.append($folder_li);\n\n\t\t\t\tconst $folder_items_ul = $(E(\"ul\"));\n\t\t\t\t$folder_li.append($folder_items_ul);\n\n\t\t\t\t$(source_li).children(\"ul\").children().get().forEach((li) => {\n\t\t\t\t\trenderItemFromContents(li, $folder_items_ul);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tconst $item_li = $(E(\"li\")).addClass(\"page\");\n\t\t\t\t$item_li.append(make_$item(object.Name).on(\"click\", () => {\n\t\t\t\t\t$iframe.attr({ src: `${options.root}/${object.Local}` });\n\t\t\t\t}));\n\t\t\t\tif ($folder_items_ul) {\n\t\t\t\t\t$folder_items_ul.append($item_li);\n\t\t\t\t} else {\n\t\t\t\t\t$contents.append($item_li);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t$.get(options.contentsFile, hhc => {\n\t\t\t$($.parseHTML(hhc)).filter(\"ul\").children().get().forEach((li) => {\n\t\t\t\trenderItemFromContents(li, null);\n\t\t\t});\n\t\t});\n\n\t\t// @TODO: keyboard accessability\n\t\t// $help_window.on(\"keydown\", (e)=> {\n\t\t// \tswitch(e.keyCode){\n\t\t// \t\tcase 37:\n\t\t// \t\t\tshow_error_message(\"MOVE IT\");\n\t\t// \t\t\tbreak;\n\t\t// \t}\n\t\t// });\n\t\tvar task = new Task($help_window);\n\t\ttask.$help_window = $help_window;\n\t\treturn task;\n\t}\n\n\tfunction Notepad(file_path) {\n\t\t// TODO: DRY the default file names and title code (use document.title of the page in the iframe, in make_iframe_window)\n\t\tvar document_title = file_path ? file_name_from_path(file_path) : \"Untitled\";\n\t\tvar win_title = document_title + \" - Notepad\";\n\t\t// TODO: focus existing window if file is currently open?\n\n\t\tvar $win = make_iframe_window({\n\t\t\tsrc: \"programs/notepad/index.html\" + (file_path ? (\"?path=\" + file_path) : \"\"),\n\t\t\ticons: iconsAtTwoSizes(\"notepad\"),\n\t\t\ttitle: win_title,\n\t\t\touterWidth: 480,\n\t\t\touterHeight: 321,\n\t\t\tresizable: true,\n\t\t});\n\t\treturn new Task($win);\n\t}\n\tNotepad.acceptsFilePaths = true;\n\n\tfunction Paint(file_path) {\n\t\tvar $win = make_iframe_window({\n\t\t\tsrc: \"programs/jspaint/index.html\",\n\t\t\ticons: iconsAtTwoSizes(\"paint\"),\n\t\t\t// NOTE: in Windows 98, \"untitled\" is lowercase, but TODO: we should just make it consistent\n\t\t\ttitle: \"untitled - Paint\",\n\t\t\touterWidth: 275,\n\t\t\touterHeight: 400,\n\t\t\tminOuterWidth: 275,\n\t\t\tminOuterHeight: 400,\n\t\t});\n\n\t\tvar contentWindow = $win.$iframe[0].contentWindow;\n\n\t\tvar waitUntil = function (test, interval, callback) {\n\t\t\tif (test()) {\n\t\t\t\tcallback();\n\t\t\t} else {\n\t\t\t\tsetTimeout(waitUntil, interval, test, interval, callback);\n\t\t\t}\n\t\t};\n\n\t\tconst systemHooks = {\n\t\t\treadBlobFromHandle: (file_path) => {\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tFilesystemSetup.withFilesystem(() => {\n\t\t\t\t\t\tvar fs = BrowserFS.BFSRequire(\"fs\");\n\t\t\t\t\t\tfs.readFile(file_path, (err, buffer) => {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\treturn reject(err);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst byte_array = new Uint8Array(buffer);\n\t\t\t\t\t\t\tconst blob = new Blob([byte_array]);\n\t\t\t\t\t\t\tconst file_name = file_path.replace(/.*\\//g, \"\");\n\t\t\t\t\t\t\tconst file = new File([blob], file_name);\n\t\t\t\t\t\t\tresolve(file);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t},\n\t\t\twriteBlobToHandle: async (file_path, blob) => {\n\t\t\t\tconst arrayBuffer = await blob.arrayBuffer();\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tFilesystemSetup.withFilesystem(()=> {\n\t\t\t\t\t\tconst fs = BrowserFS.BFSRequire(\"fs\");\n\t\t\t\t\t\tconst { Buffer } = BrowserFS.BFSRequire(\"buffer\");\n\t\t\t\t\t\tconst buffer = Buffer.from(arrayBuffer);\n\t\t\t\t\t\tfs.writeFile(file_path, buffer, (err)=> {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\treturn reject(err);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t},\n\t\t\tsetWallpaperCentered: (canvas) => {\n\t\t\t\tcanvas.toBlob((blob) => {\n\t\t\t\t\tsetDesktopWallpaper(blob, \"no-repeat\", true);\n\t\t\t\t});\n\t\t\t},\n\t\t\tsetWallpaperTiled: (canvas) => {\n\t\t\t\tcanvas.toBlob((blob) => {\n\t\t\t\t\tsetDesktopWallpaper(blob, \"repeat\", true);\n\t\t\t\t});\n\t\t\t},\n\t\t};\n\n\t\t// it seems like I should be able to use onload here, but when it works (overrides the function),\n\t\t// it for some reason *breaks the scrollbar styling* in jspaint\n\t\t// I don't know what's going on there\n\n\t\t// contentWindow.addEventListener(\"load\", function(){\n\t\t// $(contentWindow).on(\"load\", function(){\n\t\t// $win.$iframe.load(function(){\n\t\t// $win.$iframe[0].addEventListener(\"load\", function(){\n\t\twaitUntil(()=> contentWindow.systemHooks, 500, ()=> {\n\t\t\tObject.assign(contentWindow.systemHooks, systemHooks);\n\n\t\t\tlet $help_window;\n\t\t\tcontentWindow.show_help = () => {\n\t\t\t\tif ($help_window) {\n\t\t\t\t\t$help_window.focus();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t$help_window = show_help({\n\t\t\t\t\ttitle: \"Paint Help\",\n\t\t\t\t\tcontentsFile: \"programs/jspaint/help/mspaint.hhc\",\n\t\t\t\t\troot: \"programs/jspaint/help\",\n\t\t\t\t}).$help_window;\n\t\t\t\t$help_window.on(\"close\", () => {\n\t\t\t\t\t$help_window = null;\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tif (file_path) {\n\t\t\t\t// window.initial_system_file_handle = ...; is too late to set this here\n\t\t\t\t// contentWindow.open_from_file_handle(...); doesn't exist\n\t\t\t\tsystemHooks.readBlobFromHandle(file_path).then(file => {\n\t\t\t\t\tif (file) {\n\t\t\t\t\t\tcontentWindow.open_from_file(file, file_path);\n\t\t\t\t\t}\n\t\t\t\t}, (error) => {\n\t\t\t\t\t// this handler may not always called for errors, sometimes error message is shown via readBlobFromHandle\n\t\t\t\t\tcontentWindow.show_error_message(`Failed to open file ${file_path}`, error);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tvar old_update_title = contentWindow.update_title;\n\t\t\tcontentWindow.update_title = () => {\n\t\t\t\told_update_title();\n\t\t\t\t$win.title(contentWindow.document.title);\n\t\t\t};\n\t\t});\n\n\t\treturn new Task($win);\n\t}\n\tPaint.acceptsFilePaths = true;\n\n\tfunction Minesweeper() {\n\t\tvar $win = make_iframe_window({\n\t\t\tsrc: \"programs/minesweeper/index.html\",\n\t\t\ticons: iconsAtTwoSizes(\"minesweeper\"),\n\t\t\ttitle: \"Minesweeper\",\n\t\t\tinnerWidth: 280,\n\t\t\tinnerHeight: 320 + 21,\n\t\t\tresizable: false,\n\t\t});\n\t\treturn new Task($win);\n\t}\n\n\tfunction SoundRecorder(file_path) {\n\t\t// TODO: DRY the default file names and title code (use document.title of the page in the iframe, in make_iframe_window)\n\t\tvar document_title = file_path ? file_name_from_path(file_path) : \"Sound\";\n\t\tvar win_title = document_title + \" - Sound Recorder\";\n\t\t// TODO: focus existing window if file is currently open?\n\t\tvar $win = make_iframe_window({\n\t\t\tsrc: \"programs/sound-recorder/index.html\" + (file_path ? (\"?path=\" + file_path) : \"\"),\n\t\t\ticons: iconsAtTwoSizes(\"speaker\"),\n\t\t\ttitle: win_title,\n\t\t\tinnerWidth: 270,\n\t\t\tinnerHeight: 108 + 21,\n\t\t\tminInnerWidth: 270,\n\t\t\tminInnerHeight: 108 + 21,\n\t\t});\n\t\treturn new Task($win);\n\t}\n\tSoundRecorder.acceptsFilePaths = true;\n\n\tfunction Solitaire() {\n\t\tvar $win = make_iframe_window({\n\t\t\tsrc: \"programs/js-solitaire/index.html\",\n\t\t\ticons: iconsAtTwoSizes(\"solitaire\"),\n\t\t\ttitle: \"Solitaire\",\n\t\t\tinnerWidth: 585,\n\t\t\tinnerHeight: 384 + 21,\n\t\t});\n\t\treturn new Task($win);\n\t}\n\n\tfunction showScreensaver(iframeSrc) {\n\t\tconst mouseDistanceToExit = 15;\n\t\tconst $iframe = $(\"<iframe>\").attr(\"src\", iframeSrc);\n\t\tconst $backing = $(\"<div>\");\n\t\t$backing.css({\n\t\t\tposition: \"fixed\",\n\t\t\tleft: 0,\n\t\t\ttop: 0,\n\t\t\twidth: \"100%\",\n\t\t\theight: \"100%\",\n\t\t\tzIndex: $Window.Z_INDEX + 9998,\n\t\t\tcursor: \"none\",\n\t\t\tbackgroundColor: \"black\",\n\t\t});\n\t\t$iframe.css({\n\t\t\tposition: \"fixed\",\n\t\t\tleft: 0,\n\t\t\ttop: 0,\n\t\t\twidth: \"100%\",\n\t\t\theight: \"100%\",\n\t\t\tzIndex: $Window.Z_INDEX + 9999,\n\t\t\tborder: 0,\n\t\t\tpointerEvents: \"none\",\n\t\t});\n\t\t$backing.appendTo(\"body\");\n\t\t$iframe.appendTo(\"body\");\n\t\tconst cleanUp = () => {\n\t\t\t$backing.remove();\n\t\t\t$iframe.remove();\n\t\t\tconst prevent = (event) => {\n\t\t\t\tevent.preventDefault();\n\t\t\t};\n\t\t\t$(window).on(\"contextmenu\", prevent);\n\t\t\tsetTimeout(() => {\n\t\t\t\t$(window).off(\"contextmenu\", prevent);\n\t\t\t\twindow.removeEventListener(\"keydown\", keydownHandler, true);\n\t\t\t}, 500);\n\t\t};\n\t\tconst keydownHandler = (event) => {\n\t\t\t// Trying to let you change the display or capture the output\n\t\t\t// not allowing Ctrl+PrintScreen etc. because no modifiers\n\t\t\tif (!([\"F11\", \"F12\", \"ZoomToggle\", \"PrintScreen\", \"MediaRecord\", \"BrightnessDown\", \"BrightnessUp\", \"Dimmer\"].includes(event.key))) {\n\t\t\t\tevent.preventDefault();\n\t\t\t\tevent.stopPropagation();\n\t\t\t\tcleanUp();\n\t\t\t}\n\t\t};\n\t\tlet startMouseX, startMouseY;\n\t\t$backing.on(\"mousemove pointermove\", (event) => {\n\t\t\tif (startMouseX === undefined) {\n\t\t\t\tstartMouseX = event.pageX;\n\t\t\t\tstartMouseY = event.pageY;\n\t\t\t}\n\t\t\tif (Math.hypot(startMouseX - event.pageX, startMouseY - event.pageY) > mouseDistanceToExit) {\n\t\t\t\tcleanUp();\n\t\t\t}\n\t\t});\n\t\t$backing.on(\"mousedown pointerdown touchstart\", (event) => {\n\t\t\tevent.preventDefault();\n\t\t\tcleanUp();\n\t\t});\n\t\t// useCapture needed for scenario where you hit Enter, with a desktop icon selected\n\t\t// (If it relaunches the screensaver, it's like you can't exit it!)\n\t\twindow.addEventListener(\"keydown\", keydownHandler, true);\n\t}\n\n\tfunction Pipes() {\n\t\tconst options = { hideUI: true };\n\t\tshowScreensaver(`programs/pipes/index.html#${encodeURIComponent(JSON.stringify(options))}`);\n\t}\n\n\tfunction FlowerBox() {\n\t\tshowScreensaver(\"programs/3D-FlowerBox/index.html\");\n\t}\n\n\tfunction CommandPrompt() {\n\t\tvar $win = make_iframe_window({\n\t\t\tsrc: \"programs/command/index.html\",\n\t\t\ticons: iconsAtTwoSizes(\"msdos\"),\n\t\t\ttitle: \"MS-DOS Prompt\",\n\t\t\t// TODO: default dimensions\n\t\t\tinnerWidth: 640,\n\t\t\tinnerHeight: 400,\n\t\t\tconstrainRect(rect, x_axis, y_axis) {\n\t\t\t\tconst char_width = 8;\n\t\t\t\tconst char_height = 16;\n\t\t\t\tconst border = ($win.outerWidth() - $win.$content.outerWidth()) / 2;\n\t\t\t\tconst inner_rect = {\n\t\t\t\t\tx: rect.x + border,\n\t\t\t\t\ty: rect.y + border + $win.$titlebar.outerHeight(),\n\t\t\t\t\twidth: rect.width - $win.outerWidth() + $win.$content.outerWidth(),\n\t\t\t\t\theight: rect.height - $win.outerHeight() + $win.$content.outerHeight(),\n\t\t\t\t};\n\t\t\t\tconst new_inner_rect = {\n\t\t\t\t\twidth: Math.floor(inner_rect.width / char_width) * char_width,\n\t\t\t\t\theight: Math.floor(inner_rect.height / char_height) * char_height,\n\t\t\t\t};\n\t\t\t\tconst new_rect = {\n\t\t\t\t\tx: inner_rect.x - border,\n\t\t\t\t\ty: inner_rect.y - border - $win.$titlebar.outerHeight(),\n\t\t\t\t\twidth: new_inner_rect.width + $win.outerWidth() - $win.$content.outerWidth(),\n\t\t\t\t\theight: new_inner_rect.height + $win.outerHeight() - $win.$content.outerHeight(),\n\t\t\t\t};\n\t\t\t\tif (x_axis === -1) {\n\t\t\t\t\tnew_rect.x = rect.x + rect.width - new_rect.width;\n\t\t\t\t}\n\t\t\t\tif (y_axis === -1) {\n\t\t\t\t\tnew_rect.y = rect.y + rect.height - new_rect.height;\n\t\t\t\t}\n\t\t\t\treturn new_rect;\n\t\t\t},\n\t\t\t// TODO: make the API simpler / more flexible like:\n\t\t\t// constrainDimensions({ innerWidth, innerHeight }) {\n\t\t\t// \tconst charWidth = 8;\n\t\t\t// \tconst charHeight = 16;\n\t\t\t// \tinnerWidth = Math.floor(innerWidth / charWidth) * charWidth;\n\t\t\t// \tinnerHeight = Math.floor(innerHeight / charHeight) * charHeight;\n\t\t\t// \treturn { innerWidth, innerHeight };\n\t\t\t// },\n\t\t});\n\t\treturn new Task($win);\n\t}\n\n\tfunction Calculator() {\n\t\tvar $win = make_iframe_window({\n\t\t\tsrc: \"programs/calculator/index.html\",\n\t\t\ticons: iconsAtTwoSizes(\"calculator\"),\n\t\t\ttitle: \"Calculator\",\n\t\t\tinnerWidth: 256,\n\t\t\tinnerHeight: 208 + 21,\n\t\t\tminInnerWidth: 256,\n\t\t\tminInnerHeight: 208 + 21,\n\t\t});\n\t\treturn new Task($win);\n\t}\n\n\tfunction Pinball() {\n\t\tvar $win = make_iframe_window({\n\t\t\tsrc: \"programs/pinball/space-cadet.html\",\n\t\t\ticons: iconsAtTwoSizes(\"pinball\"),\n\t\t\ttitle: \"3D Pinball for Windows - Space Cadet\",\n\t\t\tinnerWidth: 600,\n\t\t\tinnerHeight: 416 + 20, // @TODO: where's this 20 coming from?\n\t\t\tminInnerWidth: 600,\n\t\t\tminInnerHeight: 416 + 20,\n\t\t\t// resizable: false, // @TODO (maybe) once gray maximized button is implemented\n\t\t\toverride_alert: false, // to handle the alert as a fatal error, and to compensate for overzealous preventDefault()\n\t\t});\n\t\tconst $splash = $(\"<div>\").css({\n\t\t\tposition: \"fixed\",\n\t\t\ttop: 0,\n\t\t\tleft: 0,\n\t\t\twidth: \"100%\",\n\t\t\theight: \"100%\",\n\t\t\tbackground: \"url(images/pinball-splash.png) no-repeat center center\",\n\t\t\tbackgroundColor: \"black\",\n\t\t\tzIndex: $Window.Z_INDEX + 6000,\n\t\t}).appendTo(\"body\");\n\t\tsetTimeout(() => {\n\t\t\t$splash.remove(); // just in case\n\t\t}, 5000);\n\t\t$win.$content.find(\"iframe\").on(\"game-loaded\", () => { // custom event dispatched from within the iframe\n\t\t\t$splash.remove();\n\t\t});\n\t\t$win.$content.find(\"iframe\").on(\"game-load-failed\", () => { // custom event dispatched from within the iframe\n\t\t\t$splash.remove();\n\t\t\t// on some systems, if the game fails to load,\n\t\t\t// it may result in the canvas showing through to the desktop behind the browser window\n\t\t\t// let's call it a feature, tie it in thematically,\n\t\t\t// and pretend like we did it on purpose, to baffle and amuse.\n\t\t\t// This happens for me on Chrome on Ubuntu with Xfce, when coming out of suspend.\n\t\t\t// It says \"Could not create renderer / Couldn't find matching render driver\"\n\t\t\t// It keeps happening with live reload, but stops on a regular reload, or duplicating the tab.\n\t\t\t$win.title(\"Wormhole Window - Space Cadet\");\n\t\t});\n\t\treturn new Task($win);\n\t}\n\n\tfunction Explorer(address) {\n\t\t// TODO: DRY the default file names and title code (use document.title of the page in the iframe, in make_iframe_window)\n\t\tvar document_title = address;\n\t\tvar win_title = document_title;\n\t\t// TODO: focus existing window if folder is currently open\n\t\tvar $win = make_iframe_window({\n\t\t\tsrc: \"programs/explorer/index.html\" + (address ? (\"?address=\" + encodeURIComponent(address)) : \"\"),\n\t\t\ticons: iconsAtTwoSizes(\"folder-open\"),\n\t\t\ttitle: win_title,\n\t\t\t// this is based on one measurement, but it uses different sizes depending on the screen resolution,\n\t\t\t// and may be different for different Explorer window types (Microsoft Internet Explorer, \"Exploring\", normal Windows Explorer*),\n\t\t\t// and may store the window positions, even for different types or folders, so I might have a non-standard default size measurement.\n\t\t\t// *See different types (resized for posing this screenshot): https://imgur.com/nxAcT9C\n\t\t\tinnerWidth: Math.min(856, innerWidth * 0.9),\n\t\t\tinnerHeight: Math.min(547, innerHeight * 0.7),\n\t\t});\n\t\treturn new Task($win);\n\t}\n\tExplorer.acceptsFilePaths = true;\n\n\tvar webamp_bundle_loaded = false;\n\tvar load_winamp_bundle_if_not_loaded = function (includeButterchurn, callback) {\n\t\t// FIXME: webamp_bundle_loaded not actually set to true when loaded\n\t\t// TODO: also maybe handle already-loading-but-not-done\n\t\tif (webamp_bundle_loaded) {\n\t\t\tcallback();\n\t\t} else {\n\t\t\t// TODO: parallelize (if possible)\n\t\t\t$.getScript(\"programs/winamp/lib/webamp.bundle.min.js\", () => {\n\t\t\t\tif (includeButterchurn) {\n\t\t\t\t\t$.getScript(\"programs/winamp/lib/butterchurn.min.js\", () => {\n\t\t\t\t\t\t$.getScript(\"programs/winamp/lib/butterchurnPresets.min.js\", () => {\n\t\t\t\t\t\t\tcallback();\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tcallback();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t// from https://github.com/jberg/butterchurn/blob/master/src/isSupported.js\n\tconst isButterchurnSupported = () => {\n\t\tconst canvas = document.createElement('canvas');\n\t\tlet gl;\n\t\ttry {\n\t\t\tgl = canvas.getContext('webgl2');\n\t\t} catch (x) {\n\t\t\tgl = null;\n\t\t}\n\n\t\tconst webGL2Supported = !!gl;\n\t\tconst audioApiSupported = !!(window.AudioContext || window.webkitAudioContext);\n\n\t\treturn webGL2Supported && audioApiSupported;\n\t};\n\n\tlet webamp;\n\tlet $webamp;\n\tlet winamp_task;\n\tlet winamp_interface;\n\tlet winamp_loading = false;\n\t// TODO: support opening multiple files at once\n\tfunction openWinamp(file_path) {\n\t\tconst filePathToBlob = (file_path) => {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tFilesystemSetup.withFilesystem(function () {\n\t\t\t\t\tvar fs = BrowserFS.BFSRequire(\"fs\");\n\t\t\t\t\tfs.readFile(file_path, function (err, buffer) {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\treturn reject(err);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst byte_array = new Uint8Array(buffer);\n\t\t\t\t\t\tconst blob = new Blob([byte_array]);\n\t\t\t\t\t\tresolve(blob);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t};\n\n\t\tconst filePathToTrack = async (file_path) => {\n\t\t\tconst blob = await filePathToBlob(file_path);\n\t\t\tconst blob_url = URL.createObjectURL(blob);\n\t\t\t// TODO: revokeObjectURL\n\t\t\tconst track = {\n\t\t\t\turl: blob_url,\n\t\t\t\tdefaultName: file_name_from_path(file_path).replace(/\\.[a-z0-9]+$/i, \"\"),\n\t\t\t};\n\t\t\treturn track;\n\t\t};\n\n\t\tconst whenLoaded = async () => {\n\t\t\tif ($webamp.css(\"display\") === \"none\") {\n\t\t\t\twinamp_interface.unminimize();\n\t\t\t}\n\n\t\t\twinamp_interface.focus();\n\n\t\t\tif (file_path) {\n\t\t\t\tif (file_path.match(/(\\.wsz|\\.zip)$/i)) {\n\t\t\t\t\tconst blob = await filePathToBlob(file_path);\n\t\t\t\t\tconst url = URL.createObjectURL(blob);\n\t\t\t\t\twebamp.setSkinFromUrl(url);\n\t\t\t\t} else if (file_path.match(/(\\.m3u|\\.pls)$/i)) {\n\t\t\t\t\talert(\"Sorry, we don't support playlists yet.\");\n\t\t\t\t} else {\n\t\t\t\t\tconst track = await filePathToTrack(file_path);\n\t\t\t\t\twebamp.setTracksToPlay([track]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\twinamp_loading = false;\n\t\t}\n\t\tif (winamp_task) {\n\t\t\twhenLoaded()\n\t\t\treturn;\n\t\t}\n\t\tif (winamp_loading) {\n\t\t\treturn; // TODO: queue up files?\n\t\t}\n\t\twinamp_loading = true;\n\n\t\t// This check creates a WebGL context, so don't do it if you try to open Winamp while it's opening or open.\n\t\t// (Otherwise it will lead to \"WARNING: Too many active WebGL contexts. Oldest context will be lost.\")\n\t\tconst includeButterchurn = isButterchurnSupported();\n\n\t\tload_winamp_bundle_if_not_loaded(includeButterchurn, function () {\n\t\t\tconst webamp_options = {\n\t\t\t\tinitialTracks: [{\n\t\t\t\t\tmetaData: {\n\t\t\t\t\t\tartist: \"DJ Mike Llama\",\n\t\t\t\t\t\ttitle: \"Llama Whippin' Intro\",\n\t\t\t\t\t},\n\t\t\t\t\turl: \"programs/winamp/mp3/llama-2.91.mp3\",\n\t\t\t\t\tduration: 5.322286,\n\t\t\t\t}],\n\t\t\t\t// initialSkin: {\n\t\t\t\t// \turl: \"programs/winamp/skins/base-2.91.wsz\",\n\t\t\t\t// },\n\t\t\t\tenableHotkeys: true,\n\t\t\t\thandleTrackDropEvent: (event) =>\n\t\t\t\t\tPromise.all(\n\t\t\t\t\t\tdragging_file_paths.map(filePathToTrack)\n\t\t\t\t\t),\n\t\t\t\t// TODO: filePickers\n\t\t\t};\n\t\t\tif (includeButterchurn) {\n\t\t\t\twebamp_options.__butterchurnOptions = {\n\t\t\t\t\timportButterchurn: () => Promise.resolve(window.butterchurn),\n\t\t\t\t\tgetPresets: () => {\n\t\t\t\t\t\tconst presets = window.butterchurnPresets.getPresets();\n\t\t\t\t\t\treturn Object.keys(presets).map((name) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t\tbutterchurnPresetObject: presets[name]\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\tbutterchurnOpen: true,\n\t\t\t\t};\n\t\t\t\twebamp_options.__initialWindowLayout = {\n\t\t\t\t\tmain: { position: { x: 0, y: 0 } },\n\t\t\t\t\tequalizer: { position: { x: 0, y: 116 } },\n\t\t\t\t\tplaylist: { position: { x: 0, y: 232 }, size: [0, 4] },\n\t\t\t\t\tmilkdrop: { position: { x: 275, y: 0 }, size: [7, 12] }\n\t\t\t\t};\n\t\t\t}\n\t\t\twebamp = new Webamp(webamp_options);\n\n\t\t\tvar visual_container = document.createElement(\"div\");\n\t\t\tvisual_container.classList.add(\"webamp-visual-container\");\n\t\t\tvisual_container.style.position = \"absolute\";\n\t\t\tvisual_container.style.left = \"0\";\n\t\t\tvisual_container.style.right = \"0\";\n\t\t\tvisual_container.style.top = \"0\";\n\t\t\tvisual_container.style.bottom = \"0\";\n\t\t\tvisual_container.style.pointerEvents = \"none\";\n\t\t\tdocument.body.appendChild(visual_container);\n\t\t\t// Render after the skin has loaded.\n\t\t\twebamp.renderWhenReady(visual_container).then(() => {\n\t\t\t\twindow.console && console.log(\"Webamp rendered\");\n\n\t\t\t\t$webamp = $(\"#webamp\");\n\t\t\t\t// Bring window to front, initially and when clicked\n\t\t\t\t$webamp.css({\n\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\tleft: 0,\n\t\t\t\t\ttop: 0,\n\t\t\t\t\tzIndex: $Window.Z_INDEX++\n\t\t\t\t});\n\n\t\t\t\tconst $eventTarget = $({});\n\t\t\t\tconst makeSimpleListenable = (name) => {\n\t\t\t\t\treturn (callback) => {\n\t\t\t\t\t\tconst fn = () => {\n\t\t\t\t\t\t\tcallback();\n\t\t\t\t\t\t};\n\t\t\t\t\t\t$eventTarget.on(name, fn);\n\t\t\t\t\t\tconst dispose = () => {\n\t\t\t\t\t\t\t$eventTarget.off(name, fn);\n\t\t\t\t\t\t};\n\t\t\t\t\t\treturn dispose;\n\t\t\t\t\t};\n\t\t\t\t};\n\n\t\t\t\twinamp_interface = {};\n\t\t\t\twinamp_interface.onFocus = makeSimpleListenable(\"focus\");\n\t\t\t\twinamp_interface.onBlur = makeSimpleListenable(\"blur\");\n\t\t\t\twinamp_interface.onClosed = makeSimpleListenable(\"closed\");\n\t\t\t\twinamp_interface.getIconAtSize = (target_icon_size) => {\n\t\t\t\t\tif (target_icon_size !== 32 && target_icon_size !== 16) {\n\t\t\t\t\t\ttarget_icon_size = 32;\n\t\t\t\t\t}\n\t\t\t\t\tconst img = document.createElement(\"img\");\n\t\t\t\t\timg.src = helpers.getIconPath(\"winamp2\", target_icon_size);\n\t\t\t\t\treturn img;\n\t\t\t\t};\n\t\t\t\twinamp_interface.bringToFront = () => {\n\t\t\t\t\t$webamp.css({\n\t\t\t\t\t\tzIndex: $Window.Z_INDEX++\n\t\t\t\t\t});\n\t\t\t\t};\n\t\t\t\twinamp_interface.element = winamp_interface[0] = $webamp[0]; // for checking z-index in window switcher\n\t\t\t\twinamp_interface.hasClass = (className) => { // also for window switcher (@TODO: clean this stuff up)\n\t\t\t\t\tif (className === \"focused\") {\n\t\t\t\t\t\treturn $webamp.hasClass(\"focused\");\n\t\t\t\t\t}\n\t\t\t\t\treturn false;\n\t\t\t\t};\n\t\t\t\twinamp_interface.focus = () => {\n\t\t\t\t\tif (!$webamp.hasClass(\"focused\")) {\n\t\t\t\t\t\t$webamp.addClass(\"focused\");\n\t\t\t\t\t\twinamp_interface.bringToFront();\n\t\t\t\t\t\t$eventTarget.triggerHandler(\"focus\");\n\t\t\t\t\t\t// @TODO: focus last focused window/control?\n\t\t\t\t\t\t$webamp.find(\"#main-window [tabindex='-1']\").focus();\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\twinamp_interface.blur = () => {\n\t\t\t\t\tif ($webamp.hasClass(\"focused\")) {\n\t\t\t\t\t\t$webamp.removeClass(\"focused\");\n\t\t\t\t\t\t$eventTarget.triggerHandler(\"blur\");\n\t\t\t\t\t\t// TODO: really blur\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\twinamp_interface.minimize = () => {\n\t\t\t\t\t// TODO: are these actually useful or does webamp hide it?\n\t\t\t\t\t$webamp.hide();\n\t\t\t\t};\n\t\t\t\twinamp_interface.unminimize = () => {\n\t\t\t\t\t// more to the point does this work necessarily??\n\t\t\t\t\t$webamp.show();\n\t\t\t\t\t// $webamp.focus();\n\t\t\t\t};\n\t\t\t\twinamp_interface.close = () => {\n\t\t\t\t\t// not allowing canceling close event in this case (generally used *by* an application (for \"Save changes?\"), not outside of it)\n\t\t\t\t\t// TODO: probably something like winamp_task.close()\n\t\t\t\t\t// winamp_interface.triggerHandler(\"close\");\n\t\t\t\t\t// winamp_interface.triggerHandler(\"closed\");\n\t\t\t\t\twebamp.dispose();\n\t\t\t\t\t$webamp.remove();\n\n\t\t\t\t\t$eventTarget.triggerHandler(\"closed\");\n\n\t\t\t\t\twebamp = null;\n\t\t\t\t\t$webamp = null;\n\t\t\t\t\twinamp_task = null;\n\t\t\t\t\twinamp_interface = null;\n\t\t\t\t};\n\t\t\t\twinamp_interface.getTitle = () => {\n\t\t\t\t\tlet taskTitle = \"Winamp 2.91\";\n\t\t\t\t\tconst $cell = $webamp.find(\".playlist-track-titles .track-cell.current\");\n\t\t\t\t\tif ($cell.length) {\n\t\t\t\t\t\ttaskTitle = `${$cell.text()} - Winamp`;\n\t\t\t\t\t\tswitch (webamp.getMediaStatus()) {\n\t\t\t\t\t\t\tcase \"STOPPED\":\n\t\t\t\t\t\t\t\ttaskTitle = `${taskTitle} [Stopped]`\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase \"PAUSED\":\n\t\t\t\t\t\t\t\ttaskTitle = `${taskTitle} [Paused]`\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn taskTitle;\n\t\t\t\t};\n\t\t\t\twinamp_interface.setMinimizeTarget = () => {\n\t\t\t\t\t// dummy function; it won't animate to the minimize target anyway\n\t\t\t\t\t// (did Winamp on Windows 98 animate minimize/restore?)\n\t\t\t\t};\n\t\t\t\t// @TODO: this wasn't supposed to be part of the API, but it's needed for the taskbar\n\t\t\t\twinamp_interface.on = (event_name, callback) => {\n\t\t\t\t\tif (event_name === \"title-change\") {\n\t\t\t\t\t\twebamp.onTrackDidChange(callback);\n\t\t\t\t\t} else if (event_name === \"icon-change\") {\n\t\t\t\t\t\t// icon will never change\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn(`Unsupported event: ${event_name}`);\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\thelpers.mustHaveMethods(winamp_interface, helpers.windowInterfaceMethods);\n\n\t\t\t\tlet raf_id;\n\t\t\t\tlet global_pointerdown;\n\n\t\t\t\twinamp_task = new Task(winamp_interface);\n\t\t\t\twebamp.onClose(function () {\n\t\t\t\t\twinamp_interface.close();\n\t\t\t\t\tcancelAnimationFrame(raf_id);\n\t\t\t\t\tvisualizerOverlay.fadeOutAndCleanUp();\n\t\t\t\t});\n\t\t\t\twebamp.onMinimize(function () {\n\t\t\t\t\twinamp_interface.minimize();\n\t\t\t\t});\n\n\t\t\t\t$webamp.on(\"focusin\", () => {\n\t\t\t\t\twinamp_interface.focus();\n\t\t\t\t});\n\t\t\t\t$webamp.on(\"focusout\", () => {\n\t\t\t\t\t// could use relatedTarget, no?\n\t\t\t\t\tif (\n\t\t\t\t\t\t!document.activeElement ||\n\t\t\t\t\t\t!document.activeElement.closest ||\n\t\t\t\t\t\t!document.activeElement.closest(\"#webamp\")\n\t\t\t\t\t) {\n\t\t\t\t\t\twinamp_interface.blur();\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tconst visualizerOverlay = new VisualizerOverlay(\n\t\t\t\t\t$webamp.find(\".gen-window canvas\")[0],\n\t\t\t\t\t{ mirror: true, stretch: true },\n\t\t\t\t);\n\n\t\t\t\t// TODO: replace with setInterval\n\t\t\t\t// Note: can't access butterchurn canvas image data during a requestAnimationFrame here\n\t\t\t\t// because of double buffering\n\t\t\t\tconst animate = () => {\n\t\t\t\t\tconst windowElements = $(\".os-window, .window:not(.gen-window)\").toArray();\n\t\t\t\t\twindowElements.forEach(windowEl => {\n\t\t\t\t\t\tif (!windowEl.hasOverlayCanvas) {\n\t\t\t\t\t\t\tvisualizerOverlay.makeOverlayCanvas(windowEl);\n\t\t\t\t\t\t\twindowEl.hasOverlayCanvas = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tif (webamp.getMediaStatus() === \"PLAYING\") {\n\t\t\t\t\t\tvisualizerOverlay.fadeIn();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvisualizerOverlay.fadeOut();\n\t\t\t\t\t}\n\t\t\t\t\traf_id = requestAnimationFrame(animate);\n\t\t\t\t};\n\t\t\t\traf_id = requestAnimationFrame(animate);\n\n\t\t\t\twhenLoaded()\n\t\t\t}, (error) => {\n\t\t\t\t// TODO: show_error_message(\"Failed to load Webamp:\", error);\n\t\t\t\talert(\"Failed to render Webamp:\\n\\n\" + error);\n\t\t\t\tconsole.error(error);\n\t\t\t});\n\t\t});\n\t}\n\topenWinamp.acceptsFilePaths = true;\n\n\t/*\n\tfunction saveAsDialog(){\n\t\tvar $win = new $Window();\n\t\t$win.title(\"Save As\");\n\t\treturn $win;\n\t}\n\tfunction openFileDialog(){\n\t\tvar $win = new $Window();\n\t\t$win.title(\"Open\");\n\t\treturn $win;\n\t}\n\t*/\n\n\tfunction openURLFile(file_path) {\n\t\tFilesystemSetup.withFilesystem(function () {\n\t\t\tvar fs = BrowserFS.BFSRequire(\"fs\");\n\t\t\tfs.readFile(file_path, \"utf8\", function (err, content) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn alert(err);\n\t\t\t\t}\n\t\t\t\t// it's supposed to be an ini-style file, but lets handle files that are literally just a URL as well, just in case\n\t\t\t\tvar match = content.match(/URL\\s*=\\s*([^\\n\\r]+)/i);\n\t\t\t\tvar url = match ? match[1] : content;\n\t\t\t\tExplorer(url);\n\t\t\t});\n\t\t});\n\t}\n\topenURLFile.acceptsFilePaths = true;\n\n\tfunction openThemeFile(file_path) {\n\t\tFilesystemSetup.withFilesystem(function () {\n\t\t\tvar fs = BrowserFS.BFSRequire(\"fs\");\n\t\t\tfs.readFile(file_path, \"utf8\", function (err, content) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn alert(err);\n\t\t\t\t}\n\t\t\t\tloadThemeFromText(content);\n\t\t\t\ttry {\n\t\t\t\t\tlocalStorage.setItem(\"desktop-theme\", content);\n\t\t\t\t\tlocalStorage.setItem(\"desktop-theme-path\", file_path);\n\t\t\t\t} catch (error) {\n\t\t\t\t\t// no local storage\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\topenThemeFile.acceptsFilePaths = true;\n\n\t// Note: extensions must be lowercase here. This is used to implement case-insensitive matching.\n\tvar file_extension_associations = {\n\t\t// Fonts:\n\t\t// - eot (Embedded OpenType)\n\t\t// - otf (OpenType)\n\t\t// - ttf (TrueType)\n\t\t// - woff (Web Open Font Format)\n\t\t// - woff2 (Web Open Font Format 2)\n\t\t// - (also svg but that's mainly an image format)\n\n\t\t// Misc binary:\n\t\t// - wasm (WebAssembly)\n\t\t// - o (Object file)\n\t\t// - so (Shared Object)\n\t\t// - dll (Dynamic Link Library)\n\t\t// - exe (Executable file)\n\t\t// - a (static library)\n\t\t// - lib (static library)\n\t\t// - pdb (Program Debug database)\n\t\t// - idb (Intermediate Debug file)\n\t\t// - bcmap (Binary Character Map)\n\t\t// - bin (generic binary file extension)\n\n\t\t// Text:\n\t\t\"\": Notepad, // bare files such as LICENSE, Makefile, CNAME, etc.\n\t\tahk: Notepad,\n\t\tai: Paint,\n\t\tbat: Notepad,\n\t\tcheck_cache: Notepad,\n\t\tcmake: Notepad,\n\t\tcmd: Notepad,\n\t\tconf: Notepad,\n\t\tcpp: Notepad,\n\t\tcss: Notepad,\n\t\td: Notepad,\n\t\teditorconfig: Notepad,\n\t\tfilters: Notepad,\n\t\tgitattributes: Notepad,\n\t\tgitignore: Notepad,\n\t\tgitrepo: Notepad,\n\t\th: Notepad,\n\t\thhc: Notepad,\n\t\thhk: Notepad,\n\t\thtml: Notepad,\n\t\tini: Notepad,\n\t\tjs: Notepad,\n\t\tjson: Notepad,\n\t\tlog: Notepad,\n\t\tmake: Notepad,\n\t\tmap: Notepad,\n\t\tmarks: Notepad,\n\t\tmd: Notepad,\n\t\tprettierignore: Notepad,\n\t\tproperties: Notepad,\n\t\trc: Notepad,\n\t\trsp: Notepad,\n\t\tsh: Notepad,\n\t\tts: Notepad,\n\t\ttxt: Notepad,\n\t\tvcxproj: Notepad,\n\t\twebmanifest: Notepad,\n\t\txml: Notepad,\n\t\tyml: Notepad,\n\n\t\t// Images:\n\t\tbmp: Paint,\n\t\tcur: Paint,\n\t\teps: Paint,\n\t\tgif: Paint,\n\t\ticns: Paint,\n\t\tico: Paint,\n\t\tjpeg: Paint,\n\t\tjpg: Paint,\n\t\tkra: Paint,\n\t\tpbm: Paint,\n\t\tpdf: Paint, // yes I added PDF support to JS Paint (not all formats listed here are supported though)\n\t\tpdn: Paint,\n\t\tpgm: Paint,\n\t\tpng: Paint,\n\t\tpnm: Paint,\n\t\tppm: Paint,\n\t\tps: Paint,\n\t\tpsd: Paint,\n\t\tsvg: Paint,\n\t\ttga: Paint,\n\t\ttif: Paint,\n\t\ttiff: Paint,\n\t\twebp: Paint,\n\t\txbm: Paint,\n\t\txcf: Paint,\n\t\txcfbz2: Paint,\n\t\txcfgz: Paint,\n\t\txpm: Paint,\n\n\t\t// Winamp Skins:\n\t\twsz: openWinamp, // winamp skin zip\n\t\tzip: openWinamp, // MIGHT be a winamp skin zip, so might as well for now\n\n\t\t// Audio:\n\t\twav: SoundRecorder,\n\t\tmp3: openWinamp,\n\t\togg: openWinamp,\n\t\twma: openWinamp,\n\t\tm4a: openWinamp,\n\t\taac: openWinamp,\n\t\tflac: openWinamp,\n\t\tmka: openWinamp,\n\t\tmpc: openWinamp,\n\t\t\"mp+\": openWinamp,\n\n\t\t// Playlists:\n\t\tm3u: openWinamp,\n\t\tpls: openWinamp,\n\n\t\t// Misc:\n\t\thtm: Explorer,\n\t\thtml: Explorer,\n\t\turl: openURLFile,\n\t\ttheme: openThemeFile,\n\t\tthemepack: openThemeFile,\n\t};\n\n\t// Note: global systemExecuteFile called by explorer\n\tfunction systemExecuteFile(file_path) {\n\t\t// execute file with default handler\n\t\t// like the START command in CMD.EXE\n\n\t\tFilesystemSetup.withFilesystem(function () {\n\t\t\tvar fs = BrowserFS.BFSRequire(\"fs\");\n\t\t\tfs.stat(file_path, function (err, stats) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn alert(\"Failed to get info about \" + file_path + \"\\n\\n\" + err);\n\t\t\t\t}\n\t\t\t\tif (stats.isDirectory()) {\n\t\t\t\t\tExplorer(file_path);\n\t\t\t\t} else {\n\t\t\t\t\tvar file_extension = file_extension_from_path(file_path);\n\t\t\t\t\tvar program = file_extension_associations[file_extension.toLowerCase()];\n\t\t\t\t\tif (program) {\n\t\t\t\t\t\tif (!program.acceptsFilePaths) {\n\t\t\t\t\t\t\talert(program.name + \" does not support opening files via the virtual filesystem yet\");\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprogram(file_path);\n\t\t\t\t\t} else {\n\t\t\t\t\t\talert(\"No program is associated with \" + file_extension + \" files\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\n\n\tfunction initDesktopFolderView(folder_view) {\n\t\t// TODO: base all the desktop icons off of the filesystem\n\t\t// Note: `C:\\Windows\\Desktop` doesn't contain My Computer, My Documents, Network Neighborhood, Recycle Bin, or Internet Explorer,\n\t\t// or Connect to the Internet, or Setup MSN Internet Access,\n\t\t// whereas `Desktop` does (that's the full address it shows; it's one of them \"special locations\")\n\t\tvar add_icon_not_via_filesystem = function (options) {\n\t\t\tfolder_view.add_item(new FolderViewItem({\n\t\t\t\ticons: {\n\t\t\t\t\t// @TODO: know what sizes are available\n\t\t\t\t\t[helpers.DESKTOP_ICON_SIZE]: helpers.getIconPath(options.iconID, helpers.DESKTOP_ICON_SIZE),\n\t\t\t\t},\n\t\t\t\t...options,\n\t\t\t}));\n\t\t};\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"My Computer\",\n\t\t\ticonID: \"my-computer\",\n\t\t\topen: function () { systemExecuteFile(\"/\"); },\n\t\t\t// file_path: \"/\",\n\t\t\tis_system_folder: true,\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"My Documents\",\n\t\t\ticonID: \"my-documents-folder\",\n\t\t\topen: function () { systemExecuteFile(\"/my-documents\"); },\n\t\t\t// file_path: \"/my-documents/\",\n\t\t\tis_system_folder: true,\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Network Neighborhood\",\n\t\t\ticonID: \"network\",\n\t\t\topen: function () { systemExecuteFile(\"/network-neighborhood\"); },\n\t\t\t// file_path: \"/network-neighborhood/\",\n\t\t\tis_system_folder: true,\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Recycle Bin\",\n\t\t\ticonID: \"recycle-bin\",\n\t\t\topen: function () { Explorer(\"https://www.epa.gov/recycle/\"); },\n\t\t\tis_system_folder: true,\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"My Pictures\",\n\t\t\ticonID: \"folder\",\n\t\t\topen: function () { systemExecuteFile(\"/my-pictures\"); },\n\t\t\t// file_path: \"/my-pictures/\",\n\t\t\tis_system_folder: true,\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Internet Explorer\",\n\t\t\ticonID: \"internet-explorer\",\n\t\t\topen: function () { Explorer(\"https://www.google.com/\"); }\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Paint\",\n\t\t\ticonID: \"paint\",\n\t\t\topen: Paint,\n\t\t\tshortcut: true\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Minesweeper\",\n\t\t\ticonID: \"minesweeper\",\n\t\t\topen: Minesweeper,\n\t\t\tshortcut: true\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Sound Recorder\",\n\t\t\ticonID: \"speaker\",\n\t\t\topen: SoundRecorder,\n\t\t\tshortcut: true\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Solitaire\",\n\t\t\ticonID: \"solitaire\",\n\t\t\topen: Solitaire,\n\t\t\tshortcut: true\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Notepad\",\n\t\t\ticonID: \"notepad\",\n\t\t\topen: Notepad,\n\t\t\tshortcut: true\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Winamp\",\n\t\t\ticonID: \"winamp2\",\n\t\t\topen: openWinamp,\n\t\t\tshortcut: true\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"3D Pipes\",\n\t\t\ticonID: \"pipes\",\n\t\t\topen: Pipes,\n\t\t\tshortcut: true\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"3D Flower Box\",\n\t\t\ticonID: \"pipes\",\n\t\t\topen: FlowerBox,\n\t\t\tshortcut: true\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"MS-DOS Prompt\",\n\t\t\ticonID: \"msdos\",\n\t\t\topen: CommandPrompt,\n\t\t\tshortcut: true\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Calculator\",\n\t\t\ticonID: \"calculator\",\n\t\t\topen: Calculator,\n\t\t\tshortcut: true\n\t\t});\n\t\tadd_icon_not_via_filesystem({\n\t\t\ttitle: \"Pinball\",\n\t\t\ticonID: \"pinball\",\n\t\t\topen: Pinball,\n\t\t\tshortcut: true\n\t\t});\n\n\t\tfolder_view.arrange_icons();\n\n\t}\n\n\n\tfunction iconsAtTwoSizes(iconID) {\n\t\treturn {\n\t\t\t16: `images/icons/${iconID}-16x16.png`,\n\t\t\t32: `images/icons/${iconID}-32x32.png`,\n\t\t};\n\t}\n\n\treturn {\n\t\tsystemExecuteFile,\n\t\tinitDesktopFolderView\n\t};\n\n});\ndefine('skylark-98js/$desktop',[\n\t\"skylark-jquery\",\n\t\"./win98\",\n\t\"./FolderView\",\n\t\"./programs\"\n],function($,win98js,FolderView,programs){\n    \"use strict\";\n\n\tconst desktop_folder_path = \"/desktop/\";\n\n\tvar $desktop = $(\".desktop\");\n\t$desktop.css(\"touch-action\", \"none\"); // TODO: should this be in FolderView, or is it to prevent scrolling the page or what?\n\n\tvar folder_view = new FolderView(desktop_folder_path, {\n\t\tasDesktop: true,\n\t\topenFileOrFolder: (path) => { // Note: may not be defined yet, so wrapping with a function.\n\t\t\tprograms.systemExecuteFile(path);\n\t\t},\n\t});\n\t$(folder_view.element).appendTo($desktop);\n\n\tfunction setDesktopWallpaper(file, repeat, saveToLocalStorage) {\n\t\tconst blob_url = URL.createObjectURL(file);\n\t\t$desktop.css({\n\t\t\tbackgroundImage: `url(${blob_url})`,\n\t\t\tbackgroundRepeat: repeat,\n\t\t\tbackgroundPosition: \"center\",\n\t\t\tbackgroundSize: \"auto\",\n\t\t});\n\t\tif (saveToLocalStorage) {\n\t\t\tvar fr = new FileReader();\n\t\t\twindow.fr = fr;\n\t\t\tfr.onload = () => {\n\t\t\t\tlocalStorage.setItem(\"wallpaper-data-url\", fr.result);\n\t\t\t\tlocalStorage.setItem(\"wallpaper-repeat\", repeat);\n\t\t\t};\n\t\t\tfr.onerror = () => {\n\t\t\t\tconsole.error(\"Error reading file (for setting wallpaper)\", file);\n\t\t\t};\n\t\t\tfr.readAsDataURL(file);\n\t\t}\n\t}\n\ttry {\n\t\tvar wallpaper_data_url = localStorage.getItem(\"wallpaper-data-url\");\n\t\tvar wallpaper_repeat = localStorage.getItem(\"wallpaper-repeat\");\n\t\tvar theme_file_content = localStorage.getItem(\"desktop-theme\");\n\t\tif (wallpaper_data_url) {\n\t\t\tfetch(wallpaper_data_url).then(r => r.blob()).then(file => {\n\t\t\t\tsetDesktopWallpaper(file, wallpaper_repeat, false);\n\t\t\t});\n\t\t}\n\t\tif (theme_file_content) {\n\t\t\tloadThemeFromText(theme_file_content);\n\t\t}\n\t} catch (error) {\n\t\tconsole.error(error);\n\t}\n\n\t// Prevent drag and drop from redirecting the page (the browser default behavior for files)\n\t// TODO: only prevent if there are actually files; there's nothing that uses text inputs atm that's not in an iframe, so it doesn't matter YET (afaik)\n\t// $G.on(\"dragover\", function(e){\n\t// \te.preventDefault();\n\t// });\n\t// $G.on(\"drop\", function(e){\n\t// \te.preventDefault();\n\t// });\n\n\tfunction loadThemeFile(file) {\n\t\tvar reader = new FileReader();\n\t\treader.onload = () => {\n\t\t\tloadThemeFromText(reader.result);\n\t\t};\n\t\treader.readAsText(file);\n\t}\n\tfunction applyTheme(cssProperties, documentElement = document.documentElement) {\n\t\tapplyCSSProperties(cssProperties, { element: documentElement, recurseIntoIframes: true });\n\t}\n\tfunction loadThemeFromText(fileText) {\n\t\tvar cssProperties = parseThemeFileString(fileText);\n\t\tapplyTheme(cssProperties);\n\t\twindow.themeCSSProperties = cssProperties;\n\t}\n\n\t$(\"html\").on(\"dragover\", function (event) {\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\t});\n\t$(\"html\").on(\"dragleave\", function (event) {\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\t});\n\t$(\"html\").on(\"drop\", function (event) {\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\t\tvar files = [...event.originalEvent.dataTransfer.files];\n\t\tfor (var file of files) {\n\t\t\tif (file.name.match(/\\.theme(pack)?$/i)) {\n\t\t\t\tloadThemeFile(file);\n\t\t\t}\n\t\t}\n\t});\n\n\t// Despite overflow:hidden on html and body,\n\t// focusing elements that are partially offscreen can still scroll the page.\n\t// For example, with opening Paint and moving it partially offscreen and opening Image > Attributes,\n\t// the default focused button can scroll the entire desktop.\n\t// We need to prevent (reset) scroll, and also avoid scrollIntoView().\n\t$(window).on(\"scroll focusin\", () => {\n\t\twindow.scrollTo(0, 0);\n\t});\n\n\n\tprograms.initDesktopFolderView(folder_view);\n\n\n\t$desktop.reflow();\n\n\treturn win98js.$desktop = $desktop;\n});\ndefine('skylark-98js/$start-menu',[\n\t\"skylark-jquery\",\n\t\"./win98\",\n\t\"./os-gui/$Window\"\n],function($,win98js,$Window){\n\t// TODO: start menu\n\n\t/*\n\t// if running from file: protocol, try to sniff the username >:)\n\tvar username_match = location.href.match(/\\/(Users|home)\\/(\\w+)\\//);\n\tvar username = username_match && username_match[1] || \"Admin\";\n\t*/\n\n\tvar $start_menu = $(\".start-menu\");\n\t$start_menu.hide();\n\t// TODO: legitimate contents or whatever\n\tvar open_start_menu = function () {\n\t\t$start_button.addClass(\"selected\");\n\t\t$start_menu.attr(\"hidden\", null);\n\t\t$start_menu.slideDown(100); // DOWN AS IN UP (stupid jQuery)\n\t\t$start_menu.css({ zIndex: ++$Window.Z_INDEX + 5001 });\n\t};\n\tvar close_start_menu = function () {\n\t\t$start_button.removeClass(\"selected\");\n\t\t$start_menu.attr(\"hidden\", \"hidden\");\n\t\t$start_menu.hide();\n\t};\n\tvar toggle_start_menu = function () {\n\t\tif ($start_menu.is(\":hidden\")) {\n\t\t\topen_start_menu();\n\t\t} else {\n\t\t\tclose_start_menu();\n\t\t}\n\t};\n\n\tvar $start_button = $(\".start-button\");\n\t$start_button.on(\"pointerdown\", function () {\n\t\ttoggle_start_menu();\n\t});\n\n\t$(\"body\").on(\"pointerdown\", function (e) {\n\t\tif ($(e.target).closest(\".start-menu, .start-button\").length === 0) {\n\t\t\tclose_start_menu();\n\t\t}\n\t});\n\t// Note: A lot of the time it's good to use focusout (in jQuery, or else blur with useCapture?[1]) as opposed to \n\t// That might be the case here as well, but maybe not since programs opening might grab focus and that probably shouldn't close the start menu\n\t// Although at the operating system level it would probably prevent focus switching in the first place, so maybe we could do that\n\t// The point being this is an operating system control and so it may warrant special handling,\n\t// but generally I'd recommend making a control focusable and detecting loss of focus as in this answer:\n\t// [1]: https://stackoverflow.com/a/38317768/2624876\n\n\t$(window).on(\"keydown\", function (e) {\n\t\tif (e.which === 27) { // Esc to close\n\t\t\tclose_start_menu();\n\t\t}\n\t});\n\n\treturn $start_menu;\n});\ndefine('skylark-98js/$taskbar-time',[\n\t\"skylark-jquery\",\n\t\"./win98\"\n],function($,win98js){\n\tvar $time = $(\".taskbar-time\");\n\tvar update_time = function () {\n\t\t$time.text(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));\n\t\t$time.attr(\"title\", new Date().toLocaleString([], { weekday: 'long', month: 'long', day: '2-digit', minute: '2-digit', hour: '2-digit' }));\n\t\tsetTimeout(update_time, 1000);\n\t};\n\tupdate_time();\n\n\treturn $time;\n});\n\ndefine('skylark-98js/msgbox',[\n\t\"skylark-jquery\",\n\t\"./win98\",\n\t\"./os-gui/$Window\"\n],function($,win98js,$Window){\n\t// Prefer a function injected from outside an iframe,\n\t// which will make dialogs that can go outside the iframe.\n\t// Note that this API must be kept in sync with the version in jspaint.\n\n\t// Note `defaultMessageBoxTitle` handling in make_iframe_window\n\t// Any other default parameters need to be handled there (as it works now)\n\n\tvar chord_audio = new Audio(\"/audio/CHORD.WAV\");\n\n\twindow.showMessageBox = window.showMessageBox || (({\n\t\ttitle = window.defaultMessageBoxTitle /*??*/ ||  \"Alert\",\n\t\tmessage,\n\t\tmessageHTML,\n\t\tbuttons = [{ label: \"OK\", value: \"ok\", default: true }],\n\t\ticonID = \"warning\", // \"error\", \"warning\", \"info\", or \"nuke\" for deleting files/folders\n\t\twindowOptions = {}, // for controlling width, etc.\n\t}) => {\n\t\tlet $window, $message;\n\t\tconst promise = new Promise((resolve, reject) => {\n\t\t\t$window = new $Window(Object.assign({\n\t\t\t\ttitle,\n\t\t\t\tresizable: false,\n\t\t\t\tinnerWidth: 400,\n\t\t\t\tmaximizeButton: false,\n\t\t\t\tminimizeButton: false,\n\t\t\t}, windowOptions));\n\t\t\t// $window.addClass(\"dialog-window horizontal-buttons\");\n\t\t\t$message =\n\t\t\t\t$(\"<div>\").css({\n\t\t\t\t\ttextAlign: \"left\",\n\t\t\t\t\tfontFamily: \"MS Sans Serif, Arial, sans-serif\",\n\t\t\t\t\tfontSize: \"14px\",\n\t\t\t\t\tmarginTop: \"22px\",\n\t\t\t\t\tflex: 1,\n\t\t\t\t\tminWidth: 0, // Fixes hidden overflow, see https://css-tricks.com/flexbox-truncated-text/\n\t\t\t\t\twhiteSpace: \"normal\", // overriding .window:not(.squish)\n\t\t\t\t});\n\t\t\tif (messageHTML) {\n\t\t\t\t$message.html(messageHTML);\n\t\t\t} else if (message) { // both are optional because you may populate later with dynamic content\n\t\t\t\t$message.text(message).css({\n\t\t\t\t\twhiteSpace: \"pre-wrap\",\n\t\t\t\t\twordWrap: \"break-word\",\n\t\t\t\t});\n\t\t\t}\n\t\t\t$(\"<div>\").append(\n\t\t\t\t$(\"<img width='32' height='32'>\").attr(\"src\", `../../images/icons/${iconID}-32x32-8bpp.png`).css({\n\t\t\t\t\tmargin: \"16px\",\n\t\t\t\t\tdisplay: \"block\",\n\t\t\t\t}),\n\t\t\t\t$message\n\t\t\t).css({\n\t\t\t\tdisplay: \"flex\",\n\t\t\t\tflexDirection: \"row\",\n\t\t\t}).appendTo($window.$content);\n\n\t\t\t$window.$content.css({\n\t\t\t\ttextAlign: \"center\",\n\t\t\t});\n\t\t\tfor (const button of buttons) {\n\t\t\t\tconst $button = $window.$Button(button.label, () => {\n\t\t\t\t\tbutton.action && button.action(); // API may be required for using user gesture requiring APIs\n\t\t\t\t\tresolve(button.value);\n\t\t\t\t\t$window.close(); // actually happens automatically\n\t\t\t\t});\n\t\t\t\tif (button.default) {\n\t\t\t\t\t$button.addClass(\"default\");\n\t\t\t\t\t$button.focus();\n\t\t\t\t\tsetTimeout(() => $button.focus(), 0); // @TODO: why is this needed? does it have to do with the iframe window handling?\n\t\t\t\t}\n\t\t\t\t$button.css({\n\t\t\t\t\tminWidth: 75,\n\t\t\t\t\theight: 23,\n\t\t\t\t\tmargin: \"16px 2px\",\n\t\t\t\t});\n\t\t\t}\n\t\t\t$window.on(\"focusin\", \"button\", (event) => {\n\t\t\t\t$(event.currentTarget).addClass(\"default\");\n\t\t\t});\n\t\t\t$window.on(\"focusout\", \"button\", (event) => {\n\t\t\t\t$(event.currentTarget).removeClass(\"default\");\n\t\t\t});\n\t\t\t$window.on(\"closed\", () => {\n\t\t\t\tresolve(\"closed\"); // or \"cancel\"? do you need to distinguish?\n\t\t\t});\n\t\t\t$window.center();\n\t\t});\n\t\tpromise.$window = $window;\n\t\tpromise.$message = $message;\n\t\tpromise.promise = promise; // for easy destructuring\n\t\ttry {\n\t\t\tchord_audio.play();\n\t\t} catch (error) {\n\t\t\tconsole.log(`Failed to play ${chord_audio.src}: `, error);\n\t\t}\n\t\treturn promise;\n\t});\n\n\twindow.alert = (message) => {\n\t\tshowMessageBox({ message });\n\t};\n\n});\ndefine('skylark-98js/window-switcher',[\n\t\"skylark-jquery\",\n\t\"skylark-clippy\",\n\t\"./win98\",\n\t\"./Task\"\n],function($,clippy,win98js,Task){\n\t\n\tvar $window_switcher = $(\"<div class='window-switcher outset-deep'>\");\n\tvar $window_switcher_list = $(\"<ul class='window-switcher-list'>\").appendTo($window_switcher);\n\tvar $window_switcher_window_name = $(\"<div class='window-switcher-window-name inset-deep'>\").appendTo($window_switcher);\n\tvar agent;\n\tvar used_window_switcher = false;\n\n\tfunction activate_window($window) {\n\t\t// console.log(\"Activating window:\", $window);\n\t\t$window.unminimize();\n\t\t$window.bringToFront();\n\t\t$window.focus(); // unminimize will focus but only if it was minimized (that's the current behavior anyway)\n\t}\n\n\tfunction show_window_switcher(cycle_backwards) {\n\t\tif ($window_switcher.is(\":visible\")) {\n\t\t\tcycle_window_switcher(cycle_backwards);\n\t\t\treturn;\n\t\t}\n\t\t$window_switcher_list.empty();\n\t\tconst tasks = Task.all_tasks;\n\t\tif (tasks.length === 1) {\n\t\t\tactivate_window(tasks[0].$window);\n\t\t\tif (!used_window_switcher) {\n\t\t\t\tagent && agent.stopCurrent(); // needed to continue on from the message with `hold` set (speak(message, true))\n\t\t\t\tagent && agent.speak(\"If there's only one window, Alt+` will switch to it right away.\");\n\t\t\t\t// used_window_switcher = true; // allow the switching message to be spoken later\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tif (tasks.length < 2) {\n\t\t\treturn;\n\t\t}\n\t\ttasks.sort((a, b) =>\n\t\t\t// using z-index, as it's similar to last-used order\n\t\t\tb.$window[0].style.zIndex - a.$window[0].style.zIndex\n\t\t);\n\t\tfor (const task of tasks) {\n\t\t\tvar $window = task.$window;\n\t\t\tvar $item = $(\"<li>\").addClass(\"window-switcher-item\");\n\t\t\t$item.append($window.getIconAtSize(32) /*??*/ ||  $(\"<img>\").attr({\n\t\t\t\tsrc: \"/images/icons/task-32x32.png\",\n\t\t\t\twidth: 32,\n\t\t\t\theight: 32,\n\t\t\t\talt: $window.getTitle()\n\t\t\t}));\n\t\t\t$item.data(\"$window\", $window);\n\t\t\t// $item.on(\"click\", function () { // Windows 98 didn't allow clicking items in the window switcher.\n\t\t\t// \tactivate_window($window);\n\t\t\t// });\n\t\t\t$window_switcher_list.append($item);\n\t\t\tif ($window.hasClass(\"focused\")) {\n\t\t\t\t$item.addClass(\"active\");\n\t\t\t}\n\t\t}\n\t\tcycle_window_switcher(cycle_backwards);\n\t\t$window_switcher.appendTo(\"body\");\n\t\t// console.log(\"Showing window switcher\", $window_switcher[0]);\n\t\tif (!used_window_switcher) {\n\t\t\tagent && agent.stopCurrent(); // needed to continue on from the message with `hold` set (speak(message, true))\n\t\t\t// Um, if you know about Alt+Tab, you can guess about how Alt+` works. But Clippy is supposed to be annoying, right?\n\t\t\tagent && agent.speak(\"There you go! Press grave accent until you get to the window you want.\");\n\t\t\tused_window_switcher = true;\n\t\t}\n\t}\n\tfunction cycle_window_switcher(cycle_backwards) {\n\t\tconst items = $window_switcher.find(\".window-switcher-item\").toArray();\n\t\tconst $active = $window_switcher.find(\".active\");\n\t\tconst old_index = items.indexOf($active[0]);\n\t\tconst new_index = ((old_index + (cycle_backwards ? -1 : 1)) + items.length) % items.length;\n\t\t$active.removeClass(\"active\");\n\t\tconst new_item = items[new_index];\n\t\t$(new_item).addClass(\"active\");\n\t\t$window_switcher_window_name.text($(new_item).data(\"$window\").getTitle());\n\t}\n\tfunction window_switcher_close_and_select() {\n\t\tif (!$window_switcher.is(\":visible\")) {\n\t\t\treturn;\n\t\t}\n\t\tconst $active = $window_switcher.find(\".active\");\n\t\tif ($active.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tactivate_window($active.data(\"$window\"));\n\t\t$window_switcher.remove(); // must remove only after getting data()\n\t}\n\tfunction window_switcher_cancel() {\n\t\t$window_switcher.remove();\n\t}\n\n\twindow.addEventListener(\"keydown\", handle_keydown, true);\n\twindow.addEventListener(\"keyup\", handle_keyup, true);\n\twindow.addEventListener(\"blur\", window_switcher_cancel); // this may be from an iframe getting focus (e.g. an app was loading), but in that case we might not be able to get the keyup anyways\n\t// @TODO: detect if it's an iframe we've integrated with and thus could get the keyup event\n\t// @TODO: also detect blur inside iframes, to cancel window switching\n\n\tvar iid;\n\tvar alt_held = false; // for detecting likely Alt+Tab\n\tvar notice_shown = false;\n\tfunction handle_keydown(e) {\n\t\tif (e.altKey && (e.key === \"4\" || e.key === \"F4\")) { // we can't actually intercept Alt+F4, but might as well try, right?\n\t\t\te.preventDefault();\n\t\t\tconst $window = e.target.closest(\".os-window\") && e.target.closest(\".os-window\").$window;\n\t\t\tconsole.log(\"Alt+4 detected, closing window\", $window, e.target);\n\t\t\t$window && $window.close();\n\t\t}\n\t\t// console.log(e.key, e.code);\n\t\tif (e.altKey && (e.code === \"Backquote\" || e.code === \"Tab\")) {\n\t\t\tshow_window_switcher(e.shiftKey);\n\t\t} else {\n\t\t\twindow_switcher_cancel();\n\t\t}\n\t\tif (e.key === \"Alt\") {\n\t\t\talt_held = true;\n\t\t\t// console.log(\"Alt held\");\n\t\t\tclearInterval(iid);\n\t\t\tiid = setInterval(look_for_focus_loss, 200);\n\t\t}\n\t}\n\tfunction handle_keyup(e) {\n\t\t// console.log(\"keyup\", e.key, e.code);\n\t\t// if (e.key === \"Alt\") { // on my Ubuntu XFCE, it's giving \"Meta\" if Shift is held\n\t\tif (!e.altKey) {\n\t\t\talt_held = false;\n\t\t\tclearInterval(iid);\n\t\t\t// console.log(\"Alt released\");\n\t\t\twindow_switcher_close_and_select();\n\t\t}\n\t}\n\tfunction look_for_focus_loss() {\n\t\t// Welcome to Heuristic Hurdles! I'm your host, Hacky Hairy. Today we're going to be detecting Alt+Tab.\n\t\t// Alt+Tab is a common shortcut for switching between windows, but we can't actually intercept it.\n\t\t// In fact, the browser doesn't even know about it. It's handled by the window manager directly.\n\t\t// We'll have to pick another shortcut, but who's going to know about it? Wouldn't it be nice if we could at least detect Alt+Tab,\n\t\t// to inform users of the new shortcut? How are we going to do that, in mere JavaScript?\n\t\t// Heuristics! *queue Heuristic Hurdles theme song*\n\n\t\t// console.log(\"alt_held\", alt_held, \"!top.document.hasFocus()\", !top.document.hasFocus(), \"top.document.hasFocus()\", top.document.hasFocus(), \"top.document\", top.document, \"top.activeElement\", top.document.activeElement);\n\t\tif (alt_held && !top.document.hasFocus()) {\n\t\t\t// Some things like closing a window with Alt+4 can cause the document to lose focus, without Alt+Tab.\n\t\t\t// But if the window's really lost focus, we shouldn't be able to focus an element in it to focus the document.\n\t\t\t// So we can use that to refine the heuristic.\n\t\t\tif (\n\t\t\t\t!top.document.activeElement ||\n\t\t\t\ttop.document.activeElement === top.document.body ||\n\t\t\t\ttop.document.activeElement === top.document.documentElement\n\t\t\t) {\n\t\t\t\t// try focusing the document (or window, rather)\n\t\t\t\ttop.focus();\n\t\t\t\tif (top.document.hasFocus()) {\n\t\t\t\t\t// console.log(\"Focused document\");\n\t\t\t\t\treturn;\n\t\t\t\t} else {\n\t\t\t\t\t// console.log(\"Couldn't focus document, so you've probably Alt+Tabbed\");\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// console.log(\"Active element is\", top.document.activeElement, \" despite hasFocus() being false so you've probably Alt+Tabbed\");\n\t\t\t}\n\n\t\t\t// False positives:\n\t\t\t// - Alt+D focuses the address bar in Chrome\n\t\t\t// - Hold Alt and click outside the browser window\n\t\t\t// - Alt+Space shows the system window menu on some platforms, and on Ubuntu XFCE in Firefox this causes a false positive but not in Chrome apparently (weird!)\n\t\t\t// - Alt+(number) focuses a tab in Chrome, but it actually lets us cancel it; @TODO: detect this as not an Alt+Tab (could use a timeout after any key pressed while holding Alt)\n\n\t\t\tclearInterval(iid);\n\t\t\talt_held = false;\n\n\t\t\tif (Task.all_tasks.length < 2) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!notice_shown) {\n\t\t\t\tnew clippy.load(\"Clippy\", function (loaded_agent) {\n\t\t\t\t\tagent = loaded_agent;\n\t\t\t\t\tagent.show();\n\t\t\t\t\tconst message = \"It looks like you're trying to switch windows.\\n\\nUse Alt+` (grave accent) instead of Alt+Tab within the 98.js desktop.\\n\\nAlso, use Alt+4 instead of Alt+F4 to close windows.\";\n\t\t\t\t\tagent.speak(message, true);\n\t\t\t\t\t// held message causes double click to not animate Clippy, for some reason (even after message is cleared)\n\t\t\t\t\t$(agent._el).one(\"dblclick\", function () {\n\t\t\t\t\t\tagent.stopCurrent();\n\t\t\t\t\t\tagent.animate();\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\tnotice_shown = true;\n\t\t\t}\n\t\t}\n\t}\n\n});\n\ndefine('skylark-98js/main',[\r\n\t\"./$desktop\",\r\n\t\"./$start-menu\",\r\n\t\"./$taskbar-time\",\r\n\t\"./filesystem-setup\",\r\n\t\"./FolderView\",\r\n\t\"./FolderViewItem\",\r\n\t\"./msgbox\",\r\n\t\"./Task\",\r\n\t\"./visualizer-overlay\",\r\n\t\"./window-switcher\"\r\n],function(){\r\n\t\r\n});\ndefine('skylark-98js', ['skylark-98js/main'], function (main) { return main; });\n\n"]}