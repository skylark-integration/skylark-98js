/**
 * skylark-98js - A version of 98js.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-98js/
 * @license MIT
 */
define(["skylark-jquery","skylark-browserfs","./win98","./FolderViewItem","./filesystem-setup","./helpers"],function(e,t,o,i,n,s){const l=75,r=75,a=150,c=17;window.resetAllFolderCustomizations=(()=>{for(let e=0;e<localStorage.length;e++)localStorage.key(e).startsWith("folder-config:")&&localStorage.removeItem(localStorage.key(e))});const f={LARGE_ICONS:32,SMALL_ICONS:16,DETAILS:16,LIST:16,DESKTOP:32};u.VIEW_MODES={THUMBNAILS:"THUMBNAILS",LARGE_ICONS:"LARGE_ICONS",SMALL_ICONS:"SMALL_ICONS",DETAILS:"DETAILS",LIST:"LIST",DESKTOP:"DESKTOP"},u.SORT_MODES={NAME:"NAME",TYPE:"TYPE",SIZE:"SIZE",DATE:"DATE"};var d={txt:"notepad-file",md:"notepad-file",json:"notepad-file",js:"notepad-file",css:"notepad-file",html:"notepad-file",gitattributes:"notepad-file",gitignore:"notepad-file",png:"image-gif",jpg:"image-jpeg",jpeg:"image-jpeg",gif:"image-gif",webp:"image-other",bmp:"paint-file",tif:"kodak-imaging-file",tiff:"kodak-imaging-file",wav:"sound",mp3:"sound",ogg:"sound",wma:"sound",exe:"task",htm:"html",html:"html",url:"html",theme:"themes",themepack:"themes"};const g={"/":"(C:)","/my-pictures/":"My Pictures","/my-documents/":"My Documents","/network-neighborhood/":"Network Neighborhood","/desktop/":"Desktop","/programs/":"Program Files","/recycle-bin/":"Recycle Bin"},m=Object.fromEntries(Object.entries(g).map(([e,t])=>[t,e])),h=(Object.fromEntries(Object.entries(m).map(([e,t])=>[e.toLowerCase(),t])),e=>{window.dragging_file_paths=e;let t=window;for(;t!==t.parent;)(t=t.parent).dragging_file_paths=e});function u(o,{asDesktop:m=!1,onStatus:p,openFolder:S,openFileOrFolder:_,onConfigure:y}={}){const w=this;var v=e('<div class="folder-view" tabindex="0">');this.element=v[0],this.items=[],this.add_item=(e=>{v.append(e.element),this.items.push(e)}),this.config={};var E=`folder-config:${m?"desktop":o}`;try{const e=localStorage.getItem(E),t=JSON.parse(e);t&&Object.assign(this.config,t)}catch(e){console.error("Failed to read folder config:",e)}u.VIEW_MODES[this.config.view_mode]||(this.config.view_mode=m?u.VIEW_MODES.DESKTOP:u.VIEW_MODES.LARGE_ICONS),u.SORT_MODES[this.config.sort_mode]||(this.config.sort_mode=u.SORT_MODES.NAME),this.config.view_as_web_page||(this.config.view_as_web_page="/desktop/"!==o),this.element.dataset.viewMode=this.config.view_mode,this.configure=(e=>{Object.assign(this.config,e),e.view_mode&&(this.element.dataset.viewMode=e.view_mode),this.arrange_icons();try{localStorage.setItem(E,JSON.stringify(this.config))}catch(e){console.error("Can't write to localStorage:",e)}y&&y(e)}),this.cycle_view_mode=(()=>{const e=[u.VIEW_MODES.LARGE_ICONS,u.VIEW_MODES.SMALL_ICONS,u.VIEW_MODES.LIST],t=(e.indexOf(this.config.view_mode)+1)%e.length;this.configure({view_mode:e[t]})});let k=!1;function D(){p&&p({items:w.items,selectedItems:w.items.filter(e=>e.element.classList.contains("selected"))})}function L(e,t){if(e.statSync(t).isDirectory()){for(const o of e.readdirSync(t))L(t+"/"+o);e.rmdirSync(t)}else e.unlinkSync(t)}this.arrange_icons=(()=>{if(k)return;if(!w.element.isConnected)return;const t=this.items.map(e=>e.pendingStatPromise).filter(Boolean),o=t.length>0;o&&(k||Promise.allSettled(t).then(()=>{k=!1,w.arrange_icons()}),k=!0);const i=this.config.view_mode===u.VIEW_MODES.LARGE_ICONS||this.config.view_mode===u.VIEW_MODES.SMALL_ICONS,n=this.config.view_mode===u.VIEW_MODES.LARGE_ICONS||this.config.view_mode===u.VIEW_MODES.DESKTOP,s=f[this.config.view_mode]||32,d=n?l:a,g=n?r:c;var m=0,h=0;const p=e=>e.is_system_folder?2:e.resolvedStats&&e.resolvedStats.isDirectory()?1:0,S=e=>(e.file_path||"").split(".").pop();this.config.sort_mode===u.SORT_MODES.NAME?this.items.sort((e,t)=>p(t)-p(e)||(e.title||"").localeCompare(t.title||"")):this.config.sort_mode===u.SORT_MODES.TYPE?this.items.sort((e,t)=>p(t)-p(e)||(S(e)||"").localeCompare(S(t)||"")):this.config.sort_mode===u.SORT_MODES.SIZE?this.items.sort((e,t)=>p(t)-p(e)||(e.resolvedStats.size||0)-(t.resolvedStats&&t.resolvedStats.size||0)):this.config.sort_mode===u.SORT_MODES.DATE&&this.items.sort((e,t)=>p(t)-p(e)||(e.resolvedStats&&e.resolvedStats.mtime||0)-(t.resolvedStats&&t.resolvedStats.mtime||0));for(const t of this.items)e(t.element).css({left:m,top:h}),i?(m+=d)+d>v[0].clientWidth&&(h+=g,m=0):(h+=g)+g>v[0].clientHeight&&(m+=d,h=0),t.setIconSize(s);o||(this.items.forEach((e,t)=>{e.element.classList.toggle("focused",0===t)}),this.items[0]&&this.items[0].element.focus(),D())}),w.focus=function(){v.is(":focus-within")||(v.focus(),0===v.find(".desktop-icon.focused").length&&this.items[0]&&this.items[0].element.focus())},w.select_all=function(){v.find(".desktop-icon").addClass("selected"),D()},w.select_inverse=function(){v.find(".desktop-icon").each(function(){e(this).toggleClass("selected")}),D()},w.delete_selected=function(){const e=v.find(".desktop-icon.selected").toArray().map(e=>e.dataset.filePath).filter(e=>void 0===g[e]);if(0===e.length)return;const o=v.find(".desktop-icon.selected .title").text().replace(/\.([^.]+)$/,"");showMessageBox({title:1===e.length?"Confirm File Delete":"Confirm Multiple File Delete",message:1===e.length?`Are you sure you want to delete '${o}'?`:`Are you sure you want to delete these ${e.length} items?`,buttons:[{label:"Yes",value:"yes",default:!0},{label:"No",value:"no"}],iconID:"nuke"}).then(o=>{"yes"===o&&n.withFilesystem(function(){const o=t.BFSRequire("fs");let i=0;for(const t of e){let e=!1;try{L(o,t),e=!0,i+=1}catch(e){console.log("failed to delete",t,e)}e&&w.items.forEach(e=>{e.element.dataset.filePath===t&&(e.element.remove(),D())})}i<e.length&&alert(`Failed to delete ${e.length-i} items.`)})})},w.start_rename=(()=>{for(const e of w.items)if(e.element.classList.contains("focused")){e.start_rename();break}}),n.withFilesystem(function(){t.BFSRequire("fs").readdir(o,function(e,t){if(e)throw alert("Failed to read contents of the directory "+o),e;for(var i=0;i<t.length;i++){var n=t[i];R(n,-1e3,-1e3)}w.arrange_icons()})}),new ResizeObserver(e=>{w.arrange_icons()}).observe(w.element),function(){var t=e("<div class='marquee'/>").appendTo(v).hide(),o={x:0,y:0},i={x:0,y:0},n=!1,s=function(){var n=Math.min(o.x,i.x),s=Math.min(o.y,i.y),l=Math.max(o.x,i.x),r=Math.max(o.y,i.y);t.show().css({position:"absolute",left:n,top:s,width:l-n,height:r-s}),v.find(".desktop-icon").each(function(t,o){e(o).offset();var i=parseFloat(e(o).css("left")),a=parseFloat(e(o).css("top")),c=e(o).width(),f=e(o).height();o.classList.toggle("selected",i<l&&a<r&&i+c>n&&a+f>s)}),D()};function l(e){var t=w.element.getBoundingClientRect();i={x:e.pageX-t.left+v[0].scrollLeft,y:e.pageY-t.top+v[0].scrollTop};const o=v.width()-v[0].clientWidth,l=v.height()-v[0].clientHeight,r=v[0].scrollLeft,a=v[0].scrollTop,c=v.width()+v[0].scrollLeft-o,f=v.height()+v[0].scrollTop-l;if(i.x=Math.max(r,Math.min(c,i.x)),i.y=Math.max(a,Math.min(f,i.y)),n){s();const e=10;i.x===r?v[0].scrollLeft-=e:i.x===c&&(v[0].scrollLeft+=e),i.y===a?v[0].scrollTop-=e:i.y===f&&(v[0].scrollTop+=e)}}function r(){t.hide(),n=!1,h([]),e(v[0].ownerDocument).off("pointermove",l),e(v[0].ownerDocument).off("pointerup blur",r)}v.on("pointerdown",".desktop-icon",function(e){const t=e.currentTarget;t._was_selected_at_pointerdown=t.classList.contains("selected"),C(t,e,!0)}),v.on("pointerdown",function(a){var c=v.is(":focus-within");w.focus();var f=e(a.target).closest(".desktop-icon");t.hide();var d=w.element.getBoundingClientRect();if(o={x:a.pageX-d.left+v[0].scrollLeft,y:a.pageY-d.top+v[0].scrollTop},i={x:a.pageX-d.left+v[0].scrollLeft,y:a.pageY-d.top+v[0].scrollTop},f.length>0)t.hide(),h(e(".desktop-icon.selected").get().map(e=>e.dataset.filePath).filter(e=>e));else{h([]);let e=v[0].offsetWidth-v[0].clientWidth,t=v[0].offsetHeight-v[0].clientHeight;e+=2,t+=2;const o=v[0].getBoundingClientRect(),i=a.clientX>o.right-e||a.clientY>o.bottom-t;(n=!i)&&c&&s()}e(v[0].ownerDocument).on("pointermove",l),e(v[0].ownerDocument).on("pointerup blur",r)})}();let I,O="";var M;function C(t,o,i){const n=t instanceof Element?t:t.element,s=o.shiftKey;M&&!w.items.some(e=>e.element===M)&&(M=null),s&&!M&&(M=w.items.find(e=>e.element.classList.contains("focused")).element||n),v.find(".desktop-icon").each(function(t,i){if(s){const t=M.getBoundingClientRect(),o=n.getBoundingClientRect(),s=i.getBoundingClientRect(),l={top:Math.min(t.top,o.top),left:Math.min(t.left,o.left),bottom:Math.max(t.bottom,o.bottom),right:Math.max(t.right,o.right)};e(i).toggleClass("selected",s.top>=l.top&&s.left>=l.left&&s.bottom<=l.bottom&&s.right<=l.right)}else"pointerdown"===o.type&&(o.ctrlKey||o.metaKey)?i===n&&e(i).toggleClass("selected"):o.ctrlKey||o.metaKey||i.classList.toggle("selected",i===n);i.classList.toggle("focused",i===n)}),i?setTimeout(()=>{n.scrollIntoView({block:"nearest"})},500):n.scrollIntoView({block:"nearest"}),D(),o.shiftKey||(M=n)}function T(t,o,i){let n=v.find(".desktop-icon.focused");if(0==n.length&&(n=v.find(".desktop-icon")),0==n.length)return!1;const s=n.outerWidth(),l=n.outerHeight(),r=n[0].getBoundingClientRect();let a=r.left,c=r.top;a+=t*s,c+=o*l;const f=v.find(".desktop-icon").toArray().sort(function(e,t){const o=e.getBoundingClientRect(),i=t.getBoundingClientRect();return Math.abs(o.left-a)+Math.abs(o.top-c)-(Math.abs(i.left-a)+Math.abs(i.top-c))}),d=e(f[0]);return d.length>0&&(C(d[0],i),!0)}v.on("keydown",function(e){if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName)if("Enter"==e.key)v.find(".desktop-icon.selected").trigger("dblclick");else if(e.ctrlKey&&"a"==e.key)folder_view.select_all(),e.preventDefault();else if("Delete"==e.key)w.delete_selected(),e.preventDefault();else if("ArrowLeft"==e.key||"ArrowRight"==e.key||"ArrowUp"==e.key||"ArrowDown"==e.key){e.preventDefault(),T("ArrowLeft"==e.key?-1:"ArrowRight"==e.key?1:0,"ArrowUp"==e.key?-1:"ArrowDown"==e.key?1:0,e)}else if("PageUp"==e.key||"PageDown"==e.key)if(e.preventDefault(),w.config.view_mode===u.VIEW_MODES.LIST){const t="PageUp"==e.key?-1:1,o=v.width(),i=v.find(".desktop-icon").outerWidth();for(let n=o-i;n>0&&!T(t*n/i,0,e);n-=i);}else{const t="PageUp"==e.key?-1:1,o=v.height(),i=v.find(".desktop-icon").outerHeight();for(let n=o-i;n>0&&!T(0,t*n/i,e);n-=i);}else if("Home"==e.key)e.preventDefault(),C(w.items[0],e);else if("End"==e.key)e.preventDefault(),C(w.items[w.items.length-1],e);else if(" "==e.key&&0===O.length)e.preventDefault(),(e.ctrlKey||e.metaKey)&&v.find(".desktop-icon.selected").length>0?v.find(".desktop-icon.focused").toggleClass("selected"):v.find(".desktop-icon.focused").addClass("selected"),D();else if("F2"===e.key)e.preventDefault(),w.start_rename();else{if(e.isDefaultPrevented()||e.ctrlKey||e.altKey||e.metaKey)return;if(I&&clearTimeout(I),O===e.key){const t=w.items.filter(e=>{return e.element.querySelector(".title").textContent.toLocaleLowerCase().startsWith(O.toLocaleLowerCase())});if(t.length>0){const o=t.findIndex(e=>e.element.classList.contains("focused"));C(-1===o?t[0]:t[(o+1)%t.length],e)}}else if("Shift"!==e.key&&"Compose"!==e.key&&(O+=e.key),I=setTimeout(function(){O=""},1e3),O.length>0)for(const e of w.items){if(e.element.querySelector(".title").textContent.toLocaleLowerCase().startsWith(O.toLocaleLowerCase())){C(e,{});break}}}});var b=function(e,t){if(e.isDirectory())return"folder";var o=s.file_extension_from_path(t);return d[o.toLowerCase()]||"document"},A=function(e){return{16:s.getIconPath(e,16),32:s.getIconPath(e,32),48:s.getIconPath(e,48)}},R=function(n,s,l){var r,a,c=o+n,d=new i({title:n,open:async function(){if(S){let e=d.resolvedStats;if(!e){if(!d.pendingStatPromise)return void alert(`Cannot open '${d.file_path}'. File type information not available.`);try{e=await d.pendingStatPromise}catch(e){return void alert(`Failed to get info about '${d.file_path}':\n\n${e}`)}}if(e.isDirectory())return void S(d.file_path)}_?_(d.file_path):alert("No handler for opening files or folders.")},rename:e=>{var i=t.BFSRequire("fs");return new Promise(function(t,n){const s=o+e;i.rename(d.file_path,s,function(o){if(o)return n(o);if(t(),d.file_path=s,d.title=e,d.element.dataset.filePath=s,d.resolvedStats){const e=b(d.resolvedStats,s);d.setIcons(A(e))}})})},shortcut:c.match(/\.url$/),file_path:c,iconSize:f[w.config.view_mode]});d.pendingStatPromise=(r=c,a=t.BFSRequire("fs"),new Promise(function(e,t){a.stat(r,function(o,i){if(o)return t(o);e(i)})})),d.pendingStatPromise.then(e=>{d.pendingStatPromise=null,d.resolvedStats=e;const t=b(e,d.file_path);d.setIcons(A(t))},e=>{d.pendingStatPromise=null}),w.add_item(d),e(d.element).css({left:s,top:l})},P=0;v.on("dragover",function(e){e.preventDefault(),P=e.originalEvent.pageX,e.originalEvent.pageY}),v.on("drop",function(i){i.preventDefault();var n=i.originalEvent.pageX||P,s=i.originalEvent.pageY||i.dragover_pageY;withFilesystem(function(){var l=i.originalEvent.dataTransfer.files;e.map(l,function(e){!function(e,i,n){var s=t.BFSRequire("buffer").Buffer,l=t.BFSRequire("fs"),r=o+e.name,a=new FileReader;a.onerror=function(e){throw e},a.onload=function(t){var o=s.from(a.result);l.writeFile(r,o,{flag:"wx"},function(t){if(t)throw"EEXIST"===t.code&&alert("File already exists!"),t;R(e.name,i,n)})},a.readAsArrayBuffer(e)}(e,n,s)})})})}return u});
//# sourceMappingURL=sourcemaps/FolderView.js.map
