/**
 * skylark-98js - A version of 98js.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-98js/
 * @license MIT
 */
define(["skylark-jquery","./win98","./FolderViewItem","./filesystem-setup","./helpers"],function(e,t,o,i,n){const s=75,l=75,r=150,a=17;window.resetAllFolderCustomizations=(()=>{for(let e=0;e<localStorage.length;e++)localStorage.key(e).startsWith("folder-config:")&&localStorage.removeItem(localStorage.key(e))});const c={LARGE_ICONS:32,SMALL_ICONS:16,DETAILS:16,LIST:16,DESKTOP:32};h.VIEW_MODES={THUMBNAILS:"THUMBNAILS",LARGE_ICONS:"LARGE_ICONS",SMALL_ICONS:"SMALL_ICONS",DETAILS:"DETAILS",LIST:"LIST",DESKTOP:"DESKTOP"},h.SORT_MODES={NAME:"NAME",TYPE:"TYPE",SIZE:"SIZE",DATE:"DATE"};var f={txt:"notepad-file",md:"notepad-file",json:"notepad-file",js:"notepad-file",css:"notepad-file",html:"notepad-file",gitattributes:"notepad-file",gitignore:"notepad-file",png:"image-gif",jpg:"image-jpeg",jpeg:"image-jpeg",gif:"image-gif",webp:"image-other",bmp:"paint-file",tif:"kodak-imaging-file",tiff:"kodak-imaging-file",wav:"sound",mp3:"sound",ogg:"sound",wma:"sound",exe:"task",htm:"html",html:"html",url:"html",theme:"themes",themepack:"themes"};const d={"/":"(C:)","/my-pictures/":"My Pictures","/my-documents/":"My Documents","/network-neighborhood/":"Network Neighborhood","/desktop/":"Desktop","/programs/":"Program Files","/recycle-bin/":"Recycle Bin"},g=Object.fromEntries(Object.entries(d).map(([e,t])=>[t,e])),m=(Object.fromEntries(Object.entries(g).map(([e,t])=>[e.toLowerCase(),t])),e=>{window.dragging_file_paths=e;let t=window;for(;t!==t.parent;)(t=t.parent).dragging_file_paths=e});function h(t,{asDesktop:g=!1,onStatus:u,openFolder:p,openFileOrFolder:S,onConfigure:_}={}){const w=this;var y=e('<div class="folder-view" tabindex="0">');this.element=y[0],this.items=[],this.add_item=(e=>{y.append(e.element),this.items.push(e)}),this.config={};var v=`folder-config:${g?"desktop":t}`;try{const e=localStorage.getItem(v),t=JSON.parse(e);t&&Object.assign(this.config,t)}catch(e){console.error("Failed to read folder config:",e)}h.VIEW_MODES[this.config.view_mode]||(this.config.view_mode=g?h.VIEW_MODES.DESKTOP:h.VIEW_MODES.LARGE_ICONS),h.SORT_MODES[this.config.sort_mode]||(this.config.sort_mode=h.SORT_MODES.NAME),this.config.view_as_web_page||(this.config.view_as_web_page="/desktop/"!==t),this.element.dataset.viewMode=this.config.view_mode,this.configure=(e=>{Object.assign(this.config,e),e.view_mode&&(this.element.dataset.viewMode=e.view_mode),this.arrange_icons();try{localStorage.setItem(v,JSON.stringify(this.config))}catch(e){console.error("Can't write to localStorage:",e)}_&&_(e)}),this.cycle_view_mode=(()=>{const e=[h.VIEW_MODES.LARGE_ICONS,h.VIEW_MODES.SMALL_ICONS,h.VIEW_MODES.LIST],t=(e.indexOf(this.config.view_mode)+1)%e.length;this.configure({view_mode:e[t]})});let E=!1;function k(){u&&u({items:w.items,selectedItems:w.items.filter(e=>e.element.classList.contains("selected"))})}function D(e,t){if(e.statSync(t).isDirectory()){for(const o of e.readdirSync(t))D(t+"/"+o);e.rmdirSync(t)}else e.unlinkSync(t)}this.arrange_icons=(()=>{if(E)return;if(!w.element.isConnected)return;const t=this.items.map(e=>e.pendingStatPromise).filter(Boolean),o=t.length>0;o&&(E||Promise.allSettled(t).then(()=>{E=!1,w.arrange_icons()}),E=!0);const i=this.config.view_mode===h.VIEW_MODES.LARGE_ICONS||this.config.view_mode===h.VIEW_MODES.SMALL_ICONS,n=this.config.view_mode===h.VIEW_MODES.LARGE_ICONS||this.config.view_mode===h.VIEW_MODES.DESKTOP,f=c[this.config.view_mode]||32,d=n?s:r,g=n?l:a;var m=0,u=0;const p=e=>e.is_system_folder?2:e.resolvedStats&&e.resolvedStats.isDirectory()?1:0,S=e=>(e.file_path||"").split(".").pop();this.config.sort_mode===h.SORT_MODES.NAME?this.items.sort((e,t)=>p(t)-p(e)||(e.title||"").localeCompare(t.title||"")):this.config.sort_mode===h.SORT_MODES.TYPE?this.items.sort((e,t)=>p(t)-p(e)||(S(e)||"").localeCompare(S(t)||"")):this.config.sort_mode===h.SORT_MODES.SIZE?this.items.sort((e,t)=>p(t)-p(e)||(e.resolvedStats.size||0)-(t.resolvedStats&&t.resolvedStats.size||0)):this.config.sort_mode===h.SORT_MODES.DATE&&this.items.sort((e,t)=>p(t)-p(e)||(e.resolvedStats&&e.resolvedStats.mtime||0)-(t.resolvedStats&&t.resolvedStats.mtime||0));for(const t of this.items)e(t.element).css({left:m,top:u}),i?(m+=d)+d>y[0].clientWidth&&(u+=g,m=0):(u+=g)+g>y[0].clientHeight&&(m+=d,u=0),t.setIconSize(f);o||(this.items.forEach((e,t)=>{e.element.classList.toggle("focused",0===t)}),this.items[0]&&this.items[0].element.focus(),k())}),w.focus=function(){y.is(":focus-within")||(y.focus(),0===y.find(".desktop-icon.focused").length&&this.items[0]&&this.items[0].element.focus())},w.select_all=function(){y.find(".desktop-icon").addClass("selected"),k()},w.select_inverse=function(){y.find(".desktop-icon").each(function(){e(this).toggleClass("selected")}),k()},w.delete_selected=function(){const e=y.find(".desktop-icon.selected").toArray().map(e=>e.dataset.filePath).filter(e=>void 0===d[e]);if(0===e.length)return;const t=y.find(".desktop-icon.selected .title").text().replace(/\.([^.]+)$/,"");showMessageBox({title:1===e.length?"Confirm File Delete":"Confirm Multiple File Delete",message:1===e.length?`Are you sure you want to delete '${t}'?`:`Are you sure you want to delete these ${e.length} items?`,buttons:[{label:"Yes",value:"yes",default:!0},{label:"No",value:"no"}],iconID:"nuke"}).then(t=>{"yes"===t&&i.withFilesystem(function(){const t=BrowserFS.BFSRequire("fs");let o=0;for(const i of e){let e=!1;try{D(t,i),e=!0,o+=1}catch(e){console.log("failed to delete",i,e)}e&&w.items.forEach(e=>{e.element.dataset.filePath===i&&(e.element.remove(),k())})}o<e.length&&alert(`Failed to delete ${e.length-o} items.`)})})},w.start_rename=(()=>{for(const e of w.items)if(e.element.classList.contains("focused")){e.start_rename();break}}),i.withFilesystem(function(){BrowserFS.BFSRequire("fs").readdir(t,function(e,o){if(e)throw alert("Failed to read contents of the directory "+t),e;for(var i=0;i<o.length;i++){var n=o[i];A(n,-1e3,-1e3)}w.arrange_icons()})}),new ResizeObserver(e=>{w.arrange_icons()}).observe(w.element),function(){var t=e("<div class='marquee'/>").appendTo(y).hide(),o={x:0,y:0},i={x:0,y:0},n=!1,s=function(){var n=Math.min(o.x,i.x),s=Math.min(o.y,i.y),l=Math.max(o.x,i.x),r=Math.max(o.y,i.y);t.show().css({position:"absolute",left:n,top:s,width:l-n,height:r-s}),y.find(".desktop-icon").each(function(t,o){e(o).offset();var i=parseFloat(e(o).css("left")),a=parseFloat(e(o).css("top")),c=e(o).width(),f=e(o).height();o.classList.toggle("selected",i<l&&a<r&&i+c>n&&a+f>s)}),k()};function l(e){var t=w.element.getBoundingClientRect();i={x:e.pageX-t.left+y[0].scrollLeft,y:e.pageY-t.top+y[0].scrollTop};const o=y.width()-y[0].clientWidth,l=y.height()-y[0].clientHeight,r=y[0].scrollLeft,a=y[0].scrollTop,c=y.width()+y[0].scrollLeft-o,f=y.height()+y[0].scrollTop-l;if(i.x=Math.max(r,Math.min(c,i.x)),i.y=Math.max(a,Math.min(f,i.y)),n){s();const e=10;i.x===r?y[0].scrollLeft-=e:i.x===c&&(y[0].scrollLeft+=e),i.y===a?y[0].scrollTop-=e:i.y===f&&(y[0].scrollTop+=e)}}function r(){t.hide(),n=!1,m([]),e(y[0].ownerDocument).off("pointermove",l),e(y[0].ownerDocument).off("pointerup blur",r)}y.on("pointerdown",".desktop-icon",function(e){const t=e.currentTarget;t._was_selected_at_pointerdown=t.classList.contains("selected"),M(t,e,!0)}),y.on("pointerdown",function(a){var c=y.is(":focus-within");w.focus();var f=e(a.target).closest(".desktop-icon");t.hide();var d=w.element.getBoundingClientRect();if(o={x:a.pageX-d.left+y[0].scrollLeft,y:a.pageY-d.top+y[0].scrollTop},i={x:a.pageX-d.left+y[0].scrollLeft,y:a.pageY-d.top+y[0].scrollTop},f.length>0)t.hide(),m(e(".desktop-icon.selected").get().map(e=>e.dataset.filePath).filter(e=>e));else{m([]);let e=y[0].offsetWidth-y[0].clientWidth,t=y[0].offsetHeight-y[0].clientHeight;e+=2,t+=2;const o=y[0].getBoundingClientRect(),i=a.clientX>o.right-e||a.clientY>o.bottom-t;(n=!i)&&c&&s()}e(y[0].ownerDocument).on("pointermove",l),e(y[0].ownerDocument).on("pointerup blur",r)})}();let L,I="";var O;function M(t,o,i){const n=t instanceof Element?t:t.element,s=o.shiftKey;O&&!w.items.some(e=>e.element===O)&&(O=null),s&&!O&&(O=w.items.find(e=>e.element.classList.contains("focused")).element||n),y.find(".desktop-icon").each(function(t,i){if(s){const t=O.getBoundingClientRect(),o=n.getBoundingClientRect(),s=i.getBoundingClientRect(),l={top:Math.min(t.top,o.top),left:Math.min(t.left,o.left),bottom:Math.max(t.bottom,o.bottom),right:Math.max(t.right,o.right)};e(i).toggleClass("selected",s.top>=l.top&&s.left>=l.left&&s.bottom<=l.bottom&&s.right<=l.right)}else"pointerdown"===o.type&&(o.ctrlKey||o.metaKey)?i===n&&e(i).toggleClass("selected"):o.ctrlKey||o.metaKey||i.classList.toggle("selected",i===n);i.classList.toggle("focused",i===n)}),i?setTimeout(()=>{n.scrollIntoView({block:"nearest"})},500):n.scrollIntoView({block:"nearest"}),k(),o.shiftKey||(O=n)}function C(t,o,i){let n=y.find(".desktop-icon.focused");if(0==n.length&&(n=y.find(".desktop-icon")),0==n.length)return!1;const s=n.outerWidth(),l=n.outerHeight(),r=n[0].getBoundingClientRect();let a=r.left,c=r.top;a+=t*s,c+=o*l;const f=y.find(".desktop-icon").toArray().sort(function(e,t){const o=e.getBoundingClientRect(),i=t.getBoundingClientRect();return Math.abs(o.left-a)+Math.abs(o.top-c)-(Math.abs(i.left-a)+Math.abs(i.top-c))}),d=e(f[0]);return d.length>0&&(M(d[0],i),!0)}y.on("keydown",function(e){if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName)if("Enter"==e.key)y.find(".desktop-icon.selected").trigger("dblclick");else if(e.ctrlKey&&"a"==e.key)folder_view.select_all(),e.preventDefault();else if("Delete"==e.key)w.delete_selected(),e.preventDefault();else if("ArrowLeft"==e.key||"ArrowRight"==e.key||"ArrowUp"==e.key||"ArrowDown"==e.key){e.preventDefault(),C("ArrowLeft"==e.key?-1:"ArrowRight"==e.key?1:0,"ArrowUp"==e.key?-1:"ArrowDown"==e.key?1:0,e)}else if("PageUp"==e.key||"PageDown"==e.key)if(e.preventDefault(),w.config.view_mode===h.VIEW_MODES.LIST){const t="PageUp"==e.key?-1:1,o=y.width(),i=y.find(".desktop-icon").outerWidth();for(let n=o-i;n>0&&!C(t*n/i,0,e);n-=i);}else{const t="PageUp"==e.key?-1:1,o=y.height(),i=y.find(".desktop-icon").outerHeight();for(let n=o-i;n>0&&!C(0,t*n/i,e);n-=i);}else if("Home"==e.key)e.preventDefault(),M(w.items[0],e);else if("End"==e.key)e.preventDefault(),M(w.items[w.items.length-1],e);else if(" "==e.key&&0===I.length)e.preventDefault(),(e.ctrlKey||e.metaKey)&&y.find(".desktop-icon.selected").length>0?y.find(".desktop-icon.focused").toggleClass("selected"):y.find(".desktop-icon.focused").addClass("selected"),k();else if("F2"===e.key)e.preventDefault(),w.start_rename();else{if(e.isDefaultPrevented()||e.ctrlKey||e.altKey||e.metaKey)return;if(L&&clearTimeout(L),I===e.key){const t=w.items.filter(e=>{return e.element.querySelector(".title").textContent.toLocaleLowerCase().startsWith(I.toLocaleLowerCase())});if(t.length>0){const o=t.findIndex(e=>e.element.classList.contains("focused"));M(-1===o?t[0]:t[(o+1)%t.length],e)}}else if("Shift"!==e.key&&"Compose"!==e.key&&(I+=e.key),L=setTimeout(function(){I=""},1e3),I.length>0)for(const e of w.items){if(e.element.querySelector(".title").textContent.toLocaleLowerCase().startsWith(I.toLocaleLowerCase())){M(e,{});break}}}});var T=function(e,t){if(e.isDirectory())return"folder";var o=n.file_extension_from_path(t);return f[o.toLowerCase()]||"document"},b=function(e){return{16:n.getIconPath(e,16),32:n.getIconPath(e,32),48:n.getIconPath(e,48)}},A=function(i,n,s){var l,r,a=t+i,f=new o({title:i,open:async function(){if(p){let e=f.resolvedStats;if(!e){if(!f.pendingStatPromise)return void alert(`Cannot open '${f.file_path}'. File type information not available.`);try{e=await f.pendingStatPromise}catch(e){return void alert(`Failed to get info about '${f.file_path}':\n\n${e}`)}}if(e.isDirectory())return void p(f.file_path)}S?S(f.file_path):alert("No handler for opening files or folders.")},rename:e=>{var o=BrowserFS.BFSRequire("fs");return new Promise(function(i,n){const s=t+e;o.rename(f.file_path,s,function(t){if(t)return n(t);if(i(),f.file_path=s,f.title=e,f.element.dataset.filePath=s,f.resolvedStats){const e=T(f.resolvedStats,s);f.setIcons(b(e))}})})},shortcut:a.match(/\.url$/),file_path:a,iconSize:c[w.config.view_mode]});f.pendingStatPromise=(l=a,r=BrowserFS.BFSRequire("fs"),new Promise(function(e,t){r.stat(l,function(o,i){if(o)return t(o);e(i)})})),f.pendingStatPromise.then(e=>{f.pendingStatPromise=null,f.resolvedStats=e;const t=T(e,f.file_path);f.setIcons(b(t))},e=>{f.pendingStatPromise=null}),w.add_item(f),e(f.element).css({left:n,top:s})},R=0;y.on("dragover",function(e){e.preventDefault(),R=e.originalEvent.pageX,e.originalEvent.pageY}),y.on("drop",function(o){o.preventDefault();var i=o.originalEvent.pageX||R,n=o.originalEvent.pageY||o.dragover_pageY;withFilesystem(function(){var s=o.originalEvent.dataTransfer.files;e.map(s,function(e){!function(e,o,i){var n=BrowserFS.BFSRequire("buffer").Buffer,s=BrowserFS.BFSRequire("fs"),l=t+e.name,r=new FileReader;r.onerror=function(e){throw e},r.onload=function(t){var a=n.from(r.result);s.writeFile(l,a,{flag:"wx"},function(t){if(t)throw"EEXIST"===t.code&&alert("File already exists!"),t;A(e.name,o,i)})},r.readAsArrayBuffer(e)}(e,i,n)})})})}return h});
//# sourceMappingURL=sourcemaps/FolderView.js.map
