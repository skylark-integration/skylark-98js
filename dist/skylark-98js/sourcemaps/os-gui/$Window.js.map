{"version":3,"sources":["os-gui/$Window.js"],"names":["define","$","win98js","E","tagName","document","createElement","element_to_string","element","toLowerCase","id","className","split","join","src","srcdoc","href","constructor","name","find_tabstops","container_el","$controls","find","filter","radios","to_skip","el","toArray","nodeName","type","checked","push","not","$G","window","$Window","Z_INDEX","minimize_slots","options","$w","addClass","appendTo","$window","Math","random","toString","substr","$titlebar","$title_area","$title","toolWindow","minimizeButton","maximizeButton","$minimize","attr","append","$maximize","resizable","closeButton","$x","$content","css","parentWindow","addChildWindow","dataset","semanticParent","$component","icon","icons","any","console","warn","$Icon","TITLEBAR_ICON_SIZE","Error","icon_name","$icon","prependTo","iconSize","setTitlebarIconSize","target_icon_size","remove","getIconAtSize","trigger","getTitlebarIconSize","icon_size","sizes","Object","keys","size","isFinite","parseFloat","sort","a","b","abs","icon_element","undefined","nodeType","cloneNode","srcset","width","height","draggable","getIconName","setIconByID","old_$icon","replaceWith","task","updateIcon","setIcons","setTimeout","get_direction","getComputedStyle","direction","$event_target","make_simple_listenable","callback","fn","on","off","onFocus","onBlur","onClosed","setDimensions","innerWidth","innerHeight","outerWidth","outerHeight","width_from_frame","height_from_frame","$menu_bar","length","child_$windows","$child_window","showAsFocused","hasClass","triggerHandler","stopShowingAsFocused","removeClass","focus","bringToFront","refocus","blur","activeElement","closest","hasFocus","global_focus_update_handler","make_focus_in_out_handler","setupIframe","iframe","focus_update_handlers_by_container","has","iframe_update_focus","set","wait_for_iframe_load","contentDocument","readyState","contentWindow","addEventListener","observeIframes","error","warn_iframe_access","container_node","MutationObserver","mutations","mutation","node","addedNodes","observe","childList","subtree","querySelectorAll","logical_container_el","is_root","event","ownerDocument","newly_focused","relatedTarget","target","outside_or_at_exactly","contains","matches","last_focus_by_container","debug_focus_tracking","focus_in_iframe","e","waypoint","parent","getElementById","dispatchEvent","Event","bubbles","view","defaultView","currentView","frameElement","before_minimize","before_maximize","minimize_target_el","setMinimizeTarget","new_taskbar_button_el","defineProperty","get","[object Object]","new_task","minimize","$task","animating_titlebar","when_done_animating_titlebar","is","before_rect","getBoundingClientRect","after_rect","animateTitlebar","hide","to_width","spacing","_minimize_slot_index","i","to_x","titlebar_height","before_unminimize","instantly_minimize","position","left","top","instantly_unminimize","unminimize","show","maximize","instantly_maximize","$taskbar","scrollbar_width","scrollbar_height","taskbar_height","instantly_unmaximize","restoring","restore","close","zIndex","$childWindow","Map","debug_svg_by_container","debug_svgs_in_window","warned_iframes","WeakSet","log_template","message","cross_origin","URL","origin","location","parse_error","iframes","ignoreCrossOrigin","add","descendant_el","DEBUG_FOCUS","svg","createElementNS","style","pointerEvents","body","appendChild","_container_el","_descendant_el","_is_root","animate_debug_focus_tracking","update_debug_focus_tracking","lastChild","removeChild","descendant_rect","right","bottom","container_rect","ontainer_el","rect","rect_el","setAttribute","text_el","textShadow","textContent","lines","line","line_el","debug_animation_frame_id","cancelAnimationFrame","requestAnimationFrame","clean_up_debug_focus_tracking","clear","last_focus","preventScroll","$tabstops","$default","drag_offset_x","drag_offset_y","drag_pointer_x","drag_pointer_y","drag_pointer_id","last_focus_global","target_style","userSelect","one","getSelection","trim","isDefaultPrevented","ctrlKey","altKey","metaKey","$buttons","$focused","focused_index","index","keyCode","shiftKey","preventDefault","release","keyup","focused_control_index","applyBounds","bound_width","max","scrollWidth","bound_height","scrollHeight","min","bringTitleBarInBounds","center","scrollX","scrollY","update_drag","pointerId","originalEvent","clientX","clientY","button","currentTarget","classList","on_mouse_enter","on_mouse_leave","customEvent","dock","HANDLE_MIDDLE","HANDLE_START","HANDLE_END","HANDLE_LEFT","HANDLE_RIGHT","HANDLE_TOP","HANDLE_BOTTOM","forEach","y_axis","x_axis","$handle","cursor","handle_thickness","border_width","window_frame_height","window_frame_width","resize_offset_x","resize_offset_y","resize_pointer_x","resize_pointer_y","resize_pointer_id","handle_pointermove","update_resize","end_resize","onscroll","mouse_x","mouse_y","delta_x","delta_y","x","y","new_rect","constrainRect","minOuterWidth","minOuterHeight","minInnerWidth","minInnerHeight","touchAction","setPointerCapture","$Button","text","handler","title","updateTitle","getTitle","current_menu_bar","from","to","$eye_leader","clone","duration_ms","OVERRIDE_TRANSITION_DURATION","duration_str","transition","handled_transition_completion","handle_transition_completion","anima","shift","force","TypeError","prototype","call","detach","closed","setMenuBar","menu_bar","after","setKeyboardScope","$FormWindow","$form","$main","label","action","$b"],"mappings":"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","file":"../../os-gui/$Window.js","sourcesContent":["define([\n\t\"skylark-jquery\",\n\t\"../win98\"\n],function($,win98js){\n\n\t// TODO: E\\(\"([a-z]+)\"\\) -> \"<$1>\" or get rid of jQuery as a dependency\n\tfunction E(tagName) {\n\t\treturn document.createElement(tagName);\n\t}\n\n\tfunction element_to_string(element) {\n\t\t// returns a CSS-selector-like string for the given element\n\t\t// if (element instanceof Element) { // doesn't work with different window.Element from iframes\n\t\tif (typeof element === \"object\" && \"tagName\" in element) {\n\t\t\treturn element.tagName.toLowerCase() +\n\t\t\t\t(element.id ? \"#\" + element.id : \"\") +\n\t\t\t\t(element.className ? \".\" + element.className.split(\" \").join(\".\") : \"\") +\n\t\t\t\t(element.src ? `[src=\"${element.src}\"]` : \"\") + // Note: not escaped; may not actually work as a selector (but this is for debugging)\n\t\t\t\t(element.srcdoc ? \"[srcdoc]\" : \"\") + // (srcdoc can be long)\n\t\t\t\t(element.href ? `[href=\"${element.href}\"]` : \"\");\n\t\t} else if (element) {\n\t\t\treturn element.constructor.name;\n\t\t} else {\n\t\t\treturn `${element}`;\n\t\t}\n\t}\n\n\tfunction find_tabstops(container_el) {\n\t\tconst $el = $(container_el);\n\t\t// This function finds focusable controls, but not necessarily all of them;\n\t\t// for radio elements, it only gives one: either the checked one, or the first one if none are checked.\n\n\t\t// Note: for audio[controls], Chrome at least has two tabstops (the audio element and three dots menu button).\n\t\t// It might be possible to detect this in the shadow DOM, I don't know, I haven't worked with the shadow DOM.\n\t\t// But it might be more reliable to make a dummy tabstop element to detect when you tab out of the first/last element.\n\t\t// Also for iframes!\n\t\t// Assuming that doesn't mess with screen readers.\n\t\t// Right now you can't tab to the three dots menu if it's the last element.\n\t\t// @TODO: see what ally.js does. Does it handle audio[controls]? https://allyjs.io/api/query/tabsequence.html\n\n\t\tlet $controls = $el.find(`\n\t\t\tinput:enabled,\n\t\t\ttextarea:enabled,\n\t\t\tselect:enabled,\n\t\t\tbutton:enabled,\n\t\t\ta[href],\n\t\t\t[tabIndex='0'],\n\t\t\tdetails summary,\n\t\t\tiframe,\n\t\t\tobject,\n\t\t\tembed,\n\t\t\tvideo[controls],\n\t\t\taudio[controls],\n\t\t\t[contenteditable]:not([contenteditable='false'])\n\t\t`).filter(\":visible\");\n\t\t// const $controls = $el.find(\":tabbable\"); // https://api.jqueryui.com/tabbable-selector/\n\n\t\t// Radio buttons should be treated as a group with one tabstop.\n\t\t// If there's no selected (\"checked\") radio, it should still visit the group,\n\t\t// but if there is a selected radio in the group, it should skip all unselected radios in the group.\n\t\tconst radios = {}; // best radio found so far, per group\n\t\tconst to_skip = [];\n\t\tfor (const el of $controls.toArray()) {\n\t\t\tif (el.nodeName.toLowerCase() === \"input\" && el.type === \"radio\") {\n\t\t\t\tif (radios[el.name]) {\n\t\t\t\t\tif (el.checked) {\n\t\t\t\t\t\tto_skip.push(radios[el.name]);\n\t\t\t\t\t\tradios[el.name] = el;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tto_skip.push(el);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tradios[el.name] = el;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tconst $tabstops = $controls.not(to_skip);\n\t\t// debug viz:\n\t\t// $tabstops.css({boxShadow: \"0 0 2px 2px green\"});\n\t\t// $(to_skip).css({boxShadow: \"0 0 2px 2px gray\"})\n\t\treturn $tabstops;\n\t}\n\tvar $G = $(window);\n\n\n\t$Window.Z_INDEX = 5;\n\n\tvar minimize_slots = []; // for if there's no taskbar\n\n\t// @TODO: make this a class,\n\t// instead of a weird pseudo-class\n\tfunction $Window(options) {\n\t\toptions = options || {};\n\t\t// @TODO: handle all option defaults here\n\t\t// and validate options.\n\n\t\tvar $w = $(E(\"div\")).addClass(\"window os-window\").appendTo(\"body\");\n\t\t$w[0].$window = $w;\n\t\t$w.element = $w[0];\n\t\t$w[0].id = `os-window-${Math.random().toString(36).substr(2, 9)}`;\n\t\t$w.$titlebar = $(E(\"div\")).addClass(\"window-titlebar\").appendTo($w);\n\t\t$w.$title_area = $(E(\"div\")).addClass(\"window-title-area\").appendTo($w.$titlebar);\n\t\t$w.$title = $(E(\"span\")).addClass(\"window-title\").appendTo($w.$title_area);\n\t\tif (options.toolWindow) {\n\t\t\toptions.minimizeButton = false;\n\t\t\toptions.maximizeButton = false;\n\t\t}\n\t\tif (options.minimizeButton !== false) {\n\t\t\t$w.$minimize = $(E(\"button\")).addClass(\"window-minimize-button window-action-minimize window-button\").appendTo($w.$titlebar);\n\t\t\t$w.$minimize.attr(\"aria-label\", \"Minimize window\"); // @TODO: for taskbarless minimized windows, \"restore\"\n\t\t\t$w.$minimize.append(\"<span class='window-button-icon'></span>\");\n\t\t}\n\t\tif (options.maximizeButton !== false) {\n\t\t\t$w.$maximize = $(E(\"button\")).addClass(\"window-maximize-button window-action-maximize window-button\").appendTo($w.$titlebar);\n\t\t\t$w.$maximize.attr(\"aria-label\", \"Maximize or restore window\"); // @TODO: specific text for the state\n\t\t\tif (!options.resizable) {\n\t\t\t\t$w.$maximize.attr(\"disabled\", true);\n\t\t\t}\n\t\t\t$w.$maximize.append(\"<span class='window-button-icon'></span>\");\n\t\t}\n\t\tif (options.closeButton !== false) {\n\t\t\t$w.$x = $(E(\"button\")).addClass(\"window-close-button window-action-close window-button\").appendTo($w.$titlebar);\n\t\t\t$w.$x.attr(\"aria-label\", \"Close window\");\n\t\t\t$w.$x.append(\"<span class='window-button-icon'></span>\");\n\t\t}\n\t\t$w.$content = $(E(\"div\")).addClass(\"window-content\").appendTo($w);\n\t\t$w.$content.attr(\"tabIndex\", \"-1\");\n\t\t$w.$content.css(\"outline\", \"none\");\n\t\tif (options.toolWindow) {\n\t\t\t$w.addClass(\"tool-window\");\n\t\t}\n\t\tif (options.parentWindow) {\n\t\t\toptions.parentWindow.addChildWindow($w);\n\t\t\t// semantic parent logic is currently only suited for tool windows\n\t\t\t// for dialog windows, it would make the dialog window not show as focused\n\t\t\t// (alternatively, I could simply, when following the semantic parent chain, look for windows that are not tool windows)\n\t\t\tif (options.toolWindow) {\n\t\t\t\t$w[0].dataset.semanticParent = options.parentWindow[0].id;\n\t\t\t}\n\t\t}\n\n\t\tvar $component = options.$component;\n\t\tif (typeof options.icon === \"object\" && \"tagName\" in options.icon) {\n\t\t\toptions.icons = { any: options.icon };\n\t\t} else if (options.icon) {\n\t\t\t// old terrible API using globals that you have to define\n\t\t\tconsole.warn(\"DEPRECATED: use options.icons instead of options.icon, e.g. new $Window({icons: {16: 'app-16x16.png', any: 'app-icon.svg'}})\");\n\t\t\tif (typeof $Icon !== \"undefined\" && typeof TITLEBAR_ICON_SIZE !== \"undefined\") {\n\t\t\t\t$w.icon_name = options.icon;\n\t\t\t\t$w.$icon = $Icon(options.icon, TITLEBAR_ICON_SIZE).prependTo($w.$titlebar);\n\t\t\t} else {\n\t\t\t\tthrow new Error(\"Use {icon: img_element} or {icons: {16: url_or_img_element}} options\");\n\t\t\t}\n\t\t}\n\t\t$w.icons = options.icons || {};\n\t\tlet iconSize = 16;\n\t\t$w.setTitlebarIconSize = function (target_icon_size) {\n\t\t\tif ($w.icons) {\n\t\t\t\t$w.$icon && $w.$icon.remove();\n\t\t\t\t$w.$icon = $($w.getIconAtSize(target_icon_size));\n\t\t\t\t$w.$icon.prependTo($w.$titlebar);\n\t\t\t}\n\t\t\ticonSize = target_icon_size;\n\t\t\t$w.trigger(\"icon-change\");\n\t\t};\n\t\t$w.getTitlebarIconSize = function () {\n\t\t\treturn iconSize;\n\t\t};\n\t\t// @TODO: this could be a static method, like OSGUI.getIconAtSize(icons, targetSize)\n\t\t$w.getIconAtSize = function (target_icon_size) {\n\t\t\tlet icon_size;\n\t\t\tif ($w.icons[target_icon_size]) {\n\t\t\t\ticon_size = target_icon_size;\n\t\t\t} else if ($w.icons[\"any\"]) {\n\t\t\t\ticon_size = \"any\";\n\t\t\t} else {\n\t\t\t\tconst sizes = Object.keys($w.icons).filter(size => isFinite(size) && isFinite(parseFloat(size)));\n\t\t\t\tsizes.sort((a, b) => Math.abs(a - target_icon_size) - Math.abs(b - target_icon_size));\n\t\t\t\ticon_size = sizes[0];\n\t\t\t}\n\t\t\tif (icon_size) {\n\t\t\t\tconst icon = $w.icons[icon_size];\n\t\t\t\tlet icon_element;\n\t\t\t\tif (icon.nodeType !== undefined) {\n\t\t\t\t\ticon_element = icon.cloneNode(true);\n\t\t\t\t} else {\n\t\t\t\t\ticon_element = E(\"img\");\n\t\t\t\t\tconst $icon = $(icon_element);\n\t\t\t\t\tif (icon.srcset) {\n\t\t\t\t\t\t$icon.attr(\"srcset\", icon.srcset);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$icon.attr(\"src\", icon.src || icon);\n\t\t\t\t\t}\n\t\t\t\t\t$icon.attr({\n\t\t\t\t\t\twidth: icon_size,\n\t\t\t\t\t\theight: icon_size,\n\t\t\t\t\t\tdraggable: false,\n\t\t\t\t\t});\n\t\t\t\t\t$icon.css({\n\t\t\t\t\t\twidth: target_icon_size,\n\t\t\t\t\t\theight: target_icon_size,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn icon_element;\n\t\t\t}\n\t\t\treturn null;\n\t\t};\n\t\t// @TODO: automatically update icon size based on theme (with a CSS variable)\n\t\t$w.setTitlebarIconSize(iconSize);\n\n\t\t$w.getIconName = () => {\n\t\t\tconsole.warn(\"DEPRECATED: use $w.icons object instead of $w.icon_name\");\n\t\t\treturn $w.icon_name;\n\t\t};\n\t\t$w.setIconByID = (icon_name) => {\n\t\t\tconsole.warn(\"DEPRECATED: use $w.setIcons(icons) instead of $w.setIconByID(icon_name)\");\n\t\t\tvar old_$icon = $w.$icon;\n\t\t\t$w.$icon = $Icon(icon_name, TITLEBAR_ICON_SIZE);\n\t\t\told_$icon.replaceWith($w.$icon);\n\t\t\t$w.icon_name = icon_name;\n\t\t\t$w.task && $w.task.updateIcon();\n\t\t\t$w.trigger(\"icon-change\");\n\t\t\treturn $w;\n\t\t};\n\t\t$w.setIcons = (icons) => {\n\t\t\t$w.icons = icons;\n\t\t\t$w.setTitlebarIconSize(iconSize);\n\t\t\t$w.task && $w.task.updateIcon();\n\t\t\t// icon-change already sent by setTitlebarIconSize\n\t\t};\n\n\t\tif ($component) {\n\t\t\t$w.addClass(\"component-window\");\n\t\t}\n\n\t\tsetTimeout(() => {\n\t\t\tif (get_direction() == \"rtl\") {\n\t\t\t\t$w.addClass(\"rtl\"); // for reversing the titlebar gradient\n\t\t\t}\n\t\t}, 0);\n\n\t\t// returns writing/layout direction, \"ltr\" or \"rtl\"\n\t\tfunction get_direction() {\n\t\t\treturn window.get_direction ? window.get_direction() : getComputedStyle($w[0]).direction;\n\t\t}\n\n\t\t// This is very silly, using jQuery's event handling to implement simpler event handling.\n\t\t// But I'll implement it in a non-silly way at least when I remove jQuery. Maybe sooner.\n\t\tconst $event_target = $({});\n\t\tconst make_simple_listenable = (name) => {\n\t\t\treturn (callback) => {\n\t\t\t\tconst fn = () => {\n\t\t\t\t\tcallback();\n\t\t\t\t};\n\t\t\t\t$event_target.on(name, fn);\n\t\t\t\tconst dispose = () => {\n\t\t\t\t\t$event_target.off(name, fn);\n\t\t\t\t};\n\t\t\t\treturn dispose;\n\t\t\t};\n\t\t};\n\t\t$w.onFocus = make_simple_listenable(\"focus\");\n\t\t$w.onBlur = make_simple_listenable(\"blur\");\n\t\t$w.onClosed = make_simple_listenable(\"closed\");\n\n\t\t$w.setDimensions = ({ innerWidth, innerHeight, outerWidth, outerHeight }) => {\n\t\t\tlet width_from_frame, height_from_frame;\n\t\t\t// It's good practice to make all measurements first, then update the DOM.\n\t\t\t// Once you update the DOM, the browser has to recalculate layout, which can be slow.\n\t\t\tif (innerWidth) {\n\t\t\t\twidth_from_frame = $w.outerWidth() - $w.$content.outerWidth();\n\t\t\t}\n\t\t\tif (innerHeight) {\n\t\t\t\theight_from_frame = $w.outerHeight() - $w.$content.outerHeight();\n\t\t\t\tconst $menu_bar = $w.$content.find(\".menus\"); // only if inside .content; might move to a slot outside .content later\n\t\t\t\tif ($menu_bar.length) {\n\t\t\t\t\t// maybe this isn't technically part of the frame, per se? but it's part of the non-client area, which is what I technically mean.\n\t\t\t\t\theight_from_frame += $menu_bar.outerHeight();\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (outerWidth) {\n\t\t\t\t$w.outerWidth(outerWidth);\n\t\t\t}\n\t\t\tif (outerHeight) {\n\t\t\t\t$w.outerHeight(outerHeight);\n\t\t\t}\n\t\t\tif (innerWidth) {\n\t\t\t\t$w.outerWidth(innerWidth + width_from_frame);\n\t\t\t}\n\t\t\tif (innerHeight) {\n\t\t\t\t$w.outerHeight(innerHeight + height_from_frame);\n\t\t\t}\n\t\t};\n\t\t$w.setDimensions(options);\n\n\t\tlet child_$windows = [];\n\t\t$w.addChildWindow = ($child_window) => {\n\t\t\tchild_$windows.push($child_window);\n\t\t};\n\t\tconst showAsFocused = () => {\n\t\t\tif ($w.hasClass(\"focused\")) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t$w.addClass(\"focused\");\n\t\t\t$event_target.triggerHandler(\"focus\");\n\t\t\t$w.trigger(\"focus\");\n\t\t};\n\t\tconst stopShowingAsFocused = () => {\n\t\t\tif (!$w.hasClass(\"focused\")) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t$w.removeClass(\"focused\");\n\t\t\t$event_target.triggerHandler(\"blur\");\n\t\t\t$w.trigger(\"blur\");\n\t\t};\n\t\t$w.focus = () => {\n\t\t\t// showAsFocused();\t\n\t\t\t$w.bringToFront();\n\t\t\trefocus();\n\t\t};\n\t\t$w.blur = () => {\n\t\t\tstopShowingAsFocused();\n\t\t\tif (document.activeElement && document.activeElement.closest(\".window\") == $w[0]) {\n\t\t\t\tdocument.activeElement.blur();\n\t\t\t}\n\t\t};\n\n\t\tif (options.toolWindow) {\n\t\t\tif (options.parentWindow) {\n\t\t\t\toptions.parentWindow.onFocus(showAsFocused);\n\t\t\t\toptions.parentWindow.onBlur(stopShowingAsFocused);\n\t\t\t\t// TODO: also show as focused if focus is within the window\n\n\t\t\t\t// initial state\n\t\t\t\t// might need a setTimeout, idk...\n\t\t\t\tif (document.activeElement && document.activeElement.closest(\".window\") == options.parentWindow[0]) {\n\t\t\t\t\tshowAsFocused();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// the browser window is the parent window\n\t\t\t\t// show focus whenever the browser window is focused\n\t\t\t\t$(window).on(\"focus\", showAsFocused);\n\t\t\t\t$(window).on(\"blur\", stopShowingAsFocused);\n\t\t\t\t// initial state\n\t\t\t\tif (document.hasFocus()) {\n\t\t\t\t\tshowAsFocused();\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// global focusout is needed, to continue showing as focused while child windows or menu popups are focused (@TODO: Is this redundant with focusin?)\n\t\t\t// global focusin is needed, to show as focused when a child window becomes focused (when perhaps nothing was focused before, so no focusout event)\n\t\t\t// global blur is needed, to show as focused when an iframe gets focus, because focusin/out doesn't fire at all in that case\n\t\t\t// global focus is needed, to stop showing as focused when an iframe loses focus\n\t\t\t// pretty ridiculous!!\n\t\t\t// but it still doesn't handle the case where the browser window is not focused, and the user clicks an iframe directly.\n\t\t\t// for that, we need to listen inside the iframe, because no events are fired at all outside in that case,\n\t\t\t// and :focus/:focus-within doesn't work with iframes so we can't even do a hack with transitionstart.\n\t\t\t// @TODO: simplify the strategy; I ended up piling a few strategies on top of each other, and the earlier ones may be redundant.\n\t\t\t// In particular, 1. I ended up making it proactively inject into iframes, rather than when focused since there's a case where focus can't be detected otherwise.\n\t\t\t// 2. I ended up simulating focusin events for iframes.\n\t\t\t// I may want to rely on that, or, I may want to remove that and set up a refocus chain directly instead,\n\t\t\t// avoiding refocus() which may interfere with drag operations in an iframe when focusing the iframe (e.g. clicking into Paint to draw or drag a sub-window).\n\n\t\t\t// console.log(\"adding global focusin/focusout/blur/focus for window\", $w[0].id);\n\t\t\tconst global_focus_update_handler = make_focus_in_out_handler($w[0], true); // must be $w and not $content so semantic parent chain works, with [data-semantic-parent] pointing to the window not the content\n\t\t\twindow.addEventListener(\"focusin\", global_focus_update_handler);\n\t\t\twindow.addEventListener(\"focusout\", global_focus_update_handler);\n\t\t\twindow.addEventListener(\"blur\", global_focus_update_handler);\n\t\t\twindow.addEventListener(\"focus\", global_focus_update_handler);\n\n\t\t\tfunction setupIframe(iframe) {\n\t\t\t\tif (!focus_update_handlers_by_container.has(iframe)) {\n\t\t\t\t\tconst iframe_update_focus = make_focus_in_out_handler(iframe, false);\n\t\t\t\t\t// this also operates as a flag to prevent multiple handlers from being added, or waiting for the iframe to load duplicately\n\t\t\t\t\tfocus_update_handlers_by_container.set(iframe, iframe_update_focus);\n\n\t\t\t\t\t// @TODO: try removing setTimeout(s)\n\t\t\t\t\tsetTimeout(() => { // for iframe src to be set? I forget.\n\t\t\t\t\t\t// Note: try must be INSIDE setTimeout, not outside, to work.\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst wait_for_iframe_load = (callback) => {\n\t\t\t\t\t\t\t\t// Note: error may occur accessing iframe.contentDocument; this must be handled by the caller.\n\t\t\t\t\t\t\t\t// To that end, this function must access it synchronously, to allow the caller to handle the error.\n\t\t\t\t\t\t\t\tif (iframe.contentDocument.readyState == \"complete\") {\n\t\t\t\t\t\t\t\t\tcallback();\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t// iframe.contentDocument.addEventListener(\"readystatechange\", () => {\n\t\t\t\t\t\t\t\t\t// \tif (iframe.contentDocument.readyState == \"complete\") {\n\t\t\t\t\t\t\t\t\t// \t\tcallback();\n\t\t\t\t\t\t\t\t\t// \t}\n\t\t\t\t\t\t\t\t\t// });\n\t\t\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t\t\twait_for_iframe_load(callback);\n\t\t\t\t\t\t\t\t\t}, 100);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\twait_for_iframe_load(() => {\n\t\t\t\t\t\t\t\t// console.log(\"adding focusin/focusout/blur/focus for iframe\", iframe);\n\t\t\t\t\t\t\t\tiframe.contentWindow.addEventListener(\"focusin\", iframe_update_focus);\n\t\t\t\t\t\t\t\tiframe.contentWindow.addEventListener(\"focusout\", iframe_update_focus);\n\t\t\t\t\t\t\t\tiframe.contentWindow.addEventListener(\"blur\", iframe_update_focus);\n\t\t\t\t\t\t\t\tiframe.contentWindow.addEventListener(\"focus\", iframe_update_focus);\n\t\t\t\t\t\t\t\tobserveIframes(iframe.contentDocument);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\twarn_iframe_access(iframe, error);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 100);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction observeIframes(container_node) {\n\t\t\t\tconst observer = new MutationObserver((mutations) => {\n\t\t\t\t\tfor (const mutation of mutations) {\n\t\t\t\t\t\tfor (const node of mutation.addedNodes) {\n\t\t\t\t\t\t\tif (node.tagName == \"IFRAME\") {\n\t\t\t\t\t\t\t\tsetupIframe(node);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tobserver.observe(container_node, { childList: true, subtree: true });\n\t\t\t\t// needed in recursive calls (for iframes inside iframes)\n\t\t\t\t// (for the window, it shouldn't be able to have iframes yet)\n\t\t\t\tfor (const iframe of container_node.querySelectorAll(\"iframe\")) {\n\t\t\t\t\tsetupIframe(iframe);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tobserveIframes($w.$content[0]);\n\t\t\t\n\t\t\tfunction make_focus_in_out_handler(logical_container_el, is_root) {\n\t\t\t\t// In case of iframes, logical_container_el is the iframe, and container_node is the iframe's contentDocument.\n\t\t\t\t// container_node is not a parameter here because it can change over time, may be an empty document before the iframe is loaded.\n\n\t\t\t\treturn function handle_focus_in_out(event) {\n\t\t\t\t\tconst container_node = logical_container_el.tagName == \"IFRAME\" ? logical_container_el.contentDocument : logical_container_el;\n\t\t\t\t\tconst document = container_node.ownerDocument /*??*/ ||  container_node;\n\t\t\t\t\t// is this equivalent?\n\t\t\t\t\t// const document = logical_container_el.tagName == \"IFRAME\" ? logical_container_el.contentDocument : logical_container_el.ownerDocument;\n\n\t\t\t\t\t// console.log(`handling ${event.type} for container`, container_el);\n\t\t\t\t\tlet newly_focused = event ? (event.type === \"focusout\" || event.type === \"blur\") ? event.relatedTarget : event.target : document.activeElement;\n\t\t\t\t\tif (event && event.type === \"blur\") {\n\t\t\t\t\t\tnewly_focused = null; // only handle iframe\n\t\t\t\t\t}\n\n\t\t\t\t\t// console.log(`[${$w.title()}] (is_root=${is_root})`, `newly_focused is (preliminarily)`, element_to_string(newly_focused), `\\nlogical_container_el`, logical_container_el, `\\ncontainer_node`, container_node, `\\ndocument.activeElement`, document.activeElement, `\\ndocument.hasFocus()`, document.hasFocus(), `\\ndocument`, document);\n\n\t\t\t\t\t// Iframes are stingy about focus events, so we need to check if focus is actually within an iframe.\n\t\t\t\t\tif (\n\t\t\t\t\t\tdocument.activeElement &&\n\t\t\t\t\t\tdocument.activeElement.tagName === \"IFRAME\" &&\n\t\t\t\t\t\t(event && event.type === \"focusout\" || event && event.type === \"blur\") &&\n\t\t\t\t\t\t!newly_focused // doesn't exist for security reasons in this case\n\t\t\t\t\t) {\n\t\t\t\t\t\tnewly_focused = document.activeElement;\n\t\t\t\t\t\t// console.log(`[${$w.title()}] (is_root=${is_root})`, `newly_focused is (actually)`, element_to_string(newly_focused));\n\t\t\t\t\t}\n\n\t\t\t\t\tconst outside_or_at_exactly =\n\t\t\t\t\t\t!newly_focused ||\n\t\t\t\t\t\t// contains() only works with DOM nodes (elements and documents), not window objects.\n\t\t\t\t\t\t// Since container_node is a DOM node, it will never have a Window inside of it (ignoring iframes).\n\t\t\t\t\t\tnewly_focused.window === newly_focused || // is a Window object (cross-frame test)\n\t\t\t\t\t\t!container_node.contains(newly_focused); // Note: node.contains(node) === true\n\t\t\t\t\tconst firmly_outside = outside_or_at_exactly && container_node !== newly_focused;\n\n\t\t\t\t\t// console.log(`[${$w.title()}] (is_root=${is_root})`, `outside_or_at_exactly=${outside_or_at_exactly}`, `firmly_outside=${firmly_outside}`);\n\t\t\t\t\tif (firmly_outside && is_root) {\n\t\t\t\t\t\tstopShowingAsFocused();\n\t\t\t\t\t}\n\t\t\t\t\tif (\n\t\t\t\t\t\t!outside_or_at_exactly &&\n\t\t\t\t\t\tnewly_focused.tagName !== \"HTML\" &&\n\t\t\t\t\t\tnewly_focused.tagName !== \"BODY\" &&\n\t\t\t\t\t\tnewly_focused !== container_node &&\n\t\t\t\t\t\t!newly_focused.matches(\".window-content\") &&\n\t\t\t\t\t\t!newly_focused.closest(\".menus\") &&\n\t\t\t\t\t\t!newly_focused.closest(\".window-titlebar\")\n\t\t\t\t\t) {\n\t\t\t\t\t\tlast_focus_by_container.set(logical_container_el, newly_focused); // overwritten for iframes below\n\t\t\t\t\t\tdebug_focus_tracking(document, container_node, newly_focused, is_root);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t!outside_or_at_exactly &&\n\t\t\t\t\t\tnewly_focused.tagName === \"IFRAME\"\n\t\t\t\t\t) {\n\t\t\t\t\t\tconst iframe = newly_focused;\n\t\t\t\t\t\t// console.log(\"iframe\", iframe, onfocusin_by_container.has(iframe));\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst focus_in_iframe = iframe.contentDocument.activeElement;\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\tfocus_in_iframe &&\n\t\t\t\t\t\t\t\tfocus_in_iframe.tagName !== \"HTML\" &&\n\t\t\t\t\t\t\t\tfocus_in_iframe.tagName !== \"BODY\" &&\n\t\t\t\t\t\t\t\t!focus_in_iframe.closest(\".menus\")\n\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t// last_focus_by_container.set(logical_container_el, iframe); // done above\n\t\t\t\t\t\t\t\tlast_focus_by_container.set(iframe, focus_in_iframe);\n\t\t\t\t\t\t\t\tdebug_focus_tracking(iframe.contentDocument, iframe.contentDocument, focus_in_iframe, is_root);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\twarn_iframe_access(iframe, e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\n\t\t\t\t\t// For child windows and menu popups, follow \"semantic parent\" chain.\n\t\t\t\t\t// Menu popups and child windows aren't descendants of the window they belong to,\n\t\t\t\t\t// but should keep the window shown as focused.\n\t\t\t\t\t// (In principle this sort of feature could be useful for focus tracking*,\n\t\t\t\t\t// but right now it's only for child windows and menu popups, which should not be tracked for refocus,\n\t\t\t\t\t// so I'm doing this after last_focus_by_container.set, for now anyway.)\n\t\t\t\t\t// ((*: and it may even be surprising if it doesn't work, if one sees the attribute on menus and attempts to use it.\n\t\t\t\t\t// But who's going to see that? The menus close so it's a pain to see the DOM structure! :P **))\n\t\t\t\t\t// (((**: without window.debugKeepMenusOpen)))\n\t\t\t\t\tif (is_root) {\n\t\t\t\t\t\tdo {\n\t\t\t\t\t\t\t// if (!newly_focused?.closest) {\n\t\t\t\t\t\t\t// \tconsole.warn(\"what is this?\", newly_focused);\n\t\t\t\t\t\t\t// \tbreak;\n\t\t\t\t\t\t\t// }\n\t\t\t\t\t\t\tconst waypoint = newly_focused && newly_focused.closest && newly_focused.closest(\"[data-semantic-parent]\");\n\t\t\t\t\t\t\tif (waypoint) {\n\t\t\t\t\t\t\t\tconst id = waypoint.dataset.semanticParent;\n\t\t\t\t\t\t\t\tconst parent = waypoint.ownerDocument.getElementById(id);\n\t\t\t\t\t\t\t\t// console.log(\"following semantic parent, from\", newly_focused, \"\\nto\", parent, \"\\nvia\", waypoint);\n\t\t\t\t\t\t\t\tnewly_focused = parent;\n\t\t\t\t\t\t\t\tif (!parent) {\n\t\t\t\t\t\t\t\t\tconsole.warn(\"semantic parent not found with id\", id);\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} while (true);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Note: allowing showing window as focused from listeners inside iframe (non-root) too,\n\t\t\t\t\t// in order to handle clicking an iframe when the browser window was not previously focused (e.g. after reload)\n\t\t\t\t\tif (\n\t\t\t\t\t\tnewly_focused &&\n\t\t\t\t\t\tnewly_focused.window !== newly_focused && // cross-frame test for Window object\n\t\t\t\t\t\tcontainer_node.contains(newly_focused)\n\t\t\t\t\t) {\n\t\t\t\t\t\tshowAsFocused();\n\t\t\t\t\t\t$w.bringToFront();\n\t\t\t\t\t\tif (!is_root) {\n\t\t\t\t\t\t\t// trigger focusin events for iframes\n\t\t\t\t\t\t\t// @TODO: probably don't need showAsFocused() here since it'll be handled externally (on this simulated focusin),\n\t\t\t\t\t\t\t// and might not need a lot of other logic frankly if I'm simulating focusin events\n\t\t\t\t\t\t\tlet el = logical_container_el;\n\t\t\t\t\t\t\twhile (el) {\n\t\t\t\t\t\t\t\t// console.log(\"dispatching focusin event for\", el);\n\t\t\t\t\t\t\t\tel.dispatchEvent(new Event(\"focusin\", {\n\t\t\t\t\t\t\t\t\tbubbles: true,\n\t\t\t\t\t\t\t\t\ttarget: el,\n\t\t\t\t\t\t\t\t\tview: el.ownerDocument.defaultView,\n\t\t\t\t\t\t\t\t}));\n\t\t\t\t\t\t\t\tel = el.currentView && el.currentView.frameElement;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (is_root) {\n\t\t\t\t\t\tstopShowingAsFocused();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// initial state is unfocused\n\t\t}\n\n\t\t$w.css(\"touch-action\", \"none\");\n\n\t\tlet minimize_target_el = null; // taskbar button (optional)\n\t\t$w.setMinimizeTarget = function (new_taskbar_button_el) {\n\t\t\tminimize_target_el = new_taskbar_button_el;\n\t\t};\n\n\t\tlet task;\n\t\tObject.defineProperty($w, \"task\", {\n\t\t\tget() {\n\t\t\t\treturn task;\n\t\t\t},\n\t\t\tset(new_task) {\n\t\t\t\tconsole.warn(\"DEPRECATED: use $w.setMinimizeTarget(taskbar_button_el) instead of setting $window.task object\");\n\t\t\t\ttask = new_task;\n\t\t\t},\n\t\t});\n\n\t\tlet before_minimize;\n\t\t$w.minimize = () => {\n\t\t\tminimize_target_el = minimize_target_el || task && task.$task[0];\n\t\t\tif (animating_titlebar) {\n\t\t\t\twhen_done_animating_titlebar.push($w.minimize);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($w.is(\":visible\")) {\n\t\t\t\tif (minimize_target_el && !$w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t\tconst before_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\t\tconst after_rect = minimize_target_el.getBoundingClientRect();\n\t\t\t\t\t$w.animateTitlebar(before_rect, after_rect, () => {\n\t\t\t\t\t\t$w.hide();\n\t\t\t\t\t\t$w.blur();\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\t// no taskbar\n\n\t\t\t\t\t// @TODO: make this metrically similar to what Windows 98 does\n\t\t\t\t\t// @TODO: DRY! This is copied heavily from maximize()\n\t\t\t\t\t// @TODO: after minimize (without taskbar) and maximize, restore should restore original position before minimize\n\t\t\t\t\t// OR should it not maximize but restore the unmaximized state? I think I tested it but I forget.\n\n\t\t\t\t\tconst to_width = 150;\n\t\t\t\t\tconst spacing = 10;\n\t\t\t\t\tif ($w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t\t\t// unminimizing\n\t\t\t\t\t\tminimize_slots[$w._minimize_slot_index] = null;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// minimizing\n\t\t\t\t\t\tlet i = 0;\n\t\t\t\t\t\twhile (minimize_slots[i]) {\n\t\t\t\t\t\t\ti++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$w._minimize_slot_index = i;\n\t\t\t\t\t\tminimize_slots[i] = $w;\n\t\t\t\t\t}\n\t\t\t\t\tconst to_x = $w._minimize_slot_index * (to_width + spacing) + 10;\n\t\t\t\t\tconst titlebar_height = $w.$titlebar.outerHeight();\n\t\t\t\t\tlet before_unminimize;\n\t\t\t\t\tconst instantly_minimize = () => {\n\t\t\t\t\t\tbefore_minimize = {\n\t\t\t\t\t\t\tposition: $w.css(\"position\"),\n\t\t\t\t\t\t\tleft: $w.css(\"left\"),\n\t\t\t\t\t\t\ttop: $w.css(\"top\"),\n\t\t\t\t\t\t\twidth: $w.css(\"width\"),\n\t\t\t\t\t\t\theight: $w.css(\"height\"),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t$w.addClass(\"minimized-without-taskbar\");\n\t\t\t\t\t\tif ($w.hasClass(\"maximized\")) {\n\t\t\t\t\t\t\t$w.removeClass(\"maximized\");\n\t\t\t\t\t\t\t$w.addClass(\"was-maximized\");\n\t\t\t\t\t\t\t$w.$maximize.removeClass(\"window-action-restore\");\n\t\t\t\t\t\t\t$w.$maximize.addClass(\"window-action-maximize\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$w.$minimize.removeClass(\"window-action-minimize\");\n\t\t\t\t\t\t$w.$minimize.addClass(\"window-action-restore\");\n\t\t\t\t\t\tif (before_unminimize) {\n\t\t\t\t\t\t\t$w.css({\n\t\t\t\t\t\t\t\tposition: before_unminimize.position,\n\t\t\t\t\t\t\t\tleft: before_unminimize.left,\n\t\t\t\t\t\t\t\ttop: before_unminimize.top,\n\t\t\t\t\t\t\t\twidth: before_unminimize.width,\n\t\t\t\t\t\t\t\theight: before_unminimize.height,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$w.css({\n\t\t\t\t\t\t\t\tposition: \"fixed\",\n\t\t\t\t\t\t\t\ttop: `calc(100% - ${titlebar_height + 5}px)`,\n\t\t\t\t\t\t\t\tleft: to_x,\n\t\t\t\t\t\t\t\twidth: to_width,\n\t\t\t\t\t\t\t\theight: titlebar_height,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tconst instantly_unminimize = () => {\n\t\t\t\t\t\tbefore_unminimize = {\n\t\t\t\t\t\t\tposition: $w.css(\"position\"),\n\t\t\t\t\t\t\tleft: $w.css(\"left\"),\n\t\t\t\t\t\t\ttop: $w.css(\"top\"),\n\t\t\t\t\t\t\twidth: $w.css(\"width\"),\n\t\t\t\t\t\t\theight: $w.css(\"height\"),\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t$w.removeClass(\"minimized-without-taskbar\");\n\t\t\t\t\t\tif ($w.hasClass(\"was-maximized\")) {\n\t\t\t\t\t\t\t$w.removeClass(\"was-maximized\");\n\t\t\t\t\t\t\t$w.addClass(\"maximized\");\n\t\t\t\t\t\t\t$w.$maximize.removeClass(\"window-action-maximize\");\n\t\t\t\t\t\t\t$w.$maximize.addClass(\"window-action-restore\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$w.$minimize.removeClass(\"window-action-restore\");\n\t\t\t\t\t\t$w.$minimize.addClass(\"window-action-minimize\");\n\t\t\t\t\t\t$w.css({ width: \"\", height: \"\" });\n\t\t\t\t\t\tif (before_minimize) {\n\t\t\t\t\t\t\t$w.css({\n\t\t\t\t\t\t\t\tposition: before_minimize.position,\n\t\t\t\t\t\t\t\tleft: before_minimize.left,\n\t\t\t\t\t\t\t\ttop: before_minimize.top,\n\t\t\t\t\t\t\t\twidth: before_minimize.width,\n\t\t\t\t\t\t\t\theight: before_minimize.height,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\tconst before_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\t\tlet after_rect;\n\t\t\t\t\t$w.css(\"transform\", \"\");\n\t\t\t\t\tif ($w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t\t\tinstantly_unminimize();\n\t\t\t\t\t\tafter_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\t\t\tinstantly_minimize();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tinstantly_minimize();\n\t\t\t\t\t\tafter_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\t\t\tinstantly_unminimize();\n\t\t\t\t\t}\n\t\t\t\t\t$w.animateTitlebar(before_rect, after_rect, () => {\n\t\t\t\t\t\tif ($w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t\t\t\tinstantly_unminimize();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tinstantly_minimize();\n\t\t\t\t\t\t\t$w.blur();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\t$w.unminimize = () => {\n\t\t\tif (animating_titlebar) {\n\t\t\t\twhen_done_animating_titlebar.push($w.unminimize);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t$w.minimize();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($w.is(\":hidden\")) {\n\t\t\t\tconst before_rect = minimize_target_el.getBoundingClientRect();\n\t\t\t\t$w.show();\n\t\t\t\tconst after_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\t$w.hide();\n\t\t\t\t$w.animateTitlebar(before_rect, after_rect, () => {\n\t\t\t\t\t$w.show();\n\t\t\t\t\t$w.bringToFront();\n\t\t\t\t\t$w.focus();\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\n\t\tlet before_maximize;\n\t\t$w.maximize = () => {\n\t\t\tif (!options.resizable) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (animating_titlebar) {\n\t\t\t\twhen_done_animating_titlebar.push($w.maximize);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($w.hasClass(\"minimized-without-taskbar\")) {\n\t\t\t\t$w.minimize();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst instantly_maximize = () => {\n\t\t\t\tbefore_maximize = {\n\t\t\t\t\tposition: $w.css(\"position\"),\n\t\t\t\t\tleft: $w.css(\"left\"),\n\t\t\t\t\ttop: $w.css(\"top\"),\n\t\t\t\t\twidth: $w.css(\"width\"),\n\t\t\t\t\theight: $w.css(\"height\"),\n\t\t\t\t};\n\n\t\t\t\t$w.addClass(\"maximized\");\n\t\t\t\tconst $taskbar = $(\".taskbar\");\n\t\t\t\tconst scrollbar_width = window.innerWidth - $(window).width();\n\t\t\t\tconst scrollbar_height = window.innerHeight - $(window).height();\n\t\t\t\tconst taskbar_height = $taskbar.length ? $taskbar.outerHeight() + 1 : 0;\n\t\t\t\t$w.css({\n\t\t\t\t\tposition: \"fixed\",\n\t\t\t\t\ttop: 0,\n\t\t\t\t\tleft: 0,\n\t\t\t\t\twidth: `calc(100vw - ${scrollbar_width}px)`,\n\t\t\t\t\theight: `calc(100vh - ${scrollbar_height}px - ${taskbar_height}px)`,\n\t\t\t\t});\n\t\t\t};\n\t\t\tconst instantly_unmaximize = () => {\n\t\t\t\t$w.removeClass(\"maximized\");\n\t\t\t\t$w.css({ width: \"\", height: \"\" });\n\t\t\t\tif (before_maximize) {\n\t\t\t\t\t$w.css({\n\t\t\t\t\t\tposition: before_maximize.position,\n\t\t\t\t\t\tleft: before_maximize.left,\n\t\t\t\t\t\ttop: before_maximize.top,\n\t\t\t\t\t\twidth: before_maximize.width,\n\t\t\t\t\t\theight: before_maximize.height,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tconst before_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\tlet after_rect;\n\t\t\t$w.css(\"transform\", \"\");\n\t\t\tconst restoring = $w.hasClass(\"maximized\");\n\t\t\tif (restoring) {\n\t\t\t\tinstantly_unmaximize();\n\t\t\t\tafter_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\tinstantly_maximize();\n\t\t\t} else {\n\t\t\t\tinstantly_maximize();\n\t\t\t\tafter_rect = $w.$titlebar[0].getBoundingClientRect();\n\t\t\t\tinstantly_unmaximize();\n\t\t\t}\n\t\t\t$w.animateTitlebar(before_rect, after_rect, () => {\n\t\t\t\tif (restoring) {\n\t\t\t\t\tinstantly_unmaximize(); // finalize in some way\n\t\t\t\t\t$w.$maximize.removeClass(\"window-action-restore\");\n\t\t\t\t\t$w.$maximize.addClass(\"window-action-maximize\");\n\t\t\t\t} else {\n\t\t\t\t\tinstantly_maximize(); // finalize in some way\n\t\t\t\t\t$w.$maximize.removeClass(\"window-action-maximize\");\n\t\t\t\t\t$w.$maximize.addClass(\"window-action-restore\");\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\t\t$w.restore = () => {\n\t\t\tif ($w.is(\".minimized-without-taskbar, .minimized\")) {\n\t\t\t\t$w.unminimize();\n\t\t\t} else if ($w.is(\".maximized\")) {\n\t\t\t\t$w.maximize();\n\t\t\t}\n\t\t};\n\t\t// must not pass event to functions by accident; also methods may not be defined yet\n\t\t$w.$minimize && $w.$minimize.on(\"click\", (e)=> { $w.minimize(); });\n\t\t$w.$maximize && $w.$maximize.on(\"click\", (e)=> { $w.maximize(); });\n\t\t$w.$x && $w.$x.on(\"click\", (e)=> { $w.close(); });\n\t\t$w.$title_area.on(\"dblclick\", (e)=> { $w.maximize(); });\n\n\t\t$w.css({\n\t\t\tposition: \"absolute\",\n\t\t\tzIndex: $Window.Z_INDEX++\n\t\t});\n\t\t$w.bringToFront = () => {\n\t\t\t$w.css({\n\t\t\t\tzIndex: $Window.Z_INDEX++\n\t\t\t});\n\t\t\tfor (const $childWindow of child_$windows) {\n\t\t\t\t$childWindow.bringToFront();\n\t\t\t}\n\t\t};\n\n\t\t// Keep track of last focused elements per container,\n\t\t// where containers include:\n\t\t// - window (global focus tracking)\n\t\t// - $w[0] (window-local, for restoring focus when refocusing window)\n\t\t// - any iframes that are same-origin (for restoring focus when refocusing window)\n\t\t// @TODO: should these be WeakMaps? probably.\n\t\t// @TODO: share this Map between all windows? but clean it up when destroying windows? or would a WeakMap take care of that?\n\t\tvar last_focus_by_container = new Map(); // element to restore focus to, by container\n\t\tvar focus_update_handlers_by_container = new Map(); // event handlers by container; note use as a flag to avoid adding multiple handlers\n\t\tvar debug_svg_by_container = new Map(); // visualization\n\t\tvar debug_svgs_in_window = []; // visualization\n\t\tvar warned_iframes = new WeakSet(); // prevent spamming console\n\n\t\tconst warn_iframe_access = (iframe, error) => {\n\t\t\tconst log_template = (message) => [`OS-GUI.js failed to access an iframe (${element_to_string(iframe)}) for focus integration.\n\t${message}\n\tOriginal error:\n\t`, error];\n\n\t\t\tlet cross_origin;\n\t\t\tif (iframe.srcdoc) {\n\t\t\t\tcross_origin = false;\n\t\t\t} else {\n\t\t\t\ttry {\n\t\t\t\t\tconst url = new URL(iframe.src);\n\t\t\t\t\tcross_origin = url.origin !== window.location.origin; // shouldn't need to use iframe.ownerDocument.location.origin because intermediate iframes must be same-origin\n\t\t\t\t} catch (parse_error) {\n\t\t\t\t\tconsole.error(...log_template(`This may be a bug in OS-GUI. Is this a cross-origin iframe? Failed to parse URL (${parse_error}).`));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (cross_origin) {\n\t\t\t\tif (options.iframes && options.iframes.ignoreCrossOrigin && !warned_iframes.has(iframe)) {\n\t\t\t\t\tconsole.warn(...log_template(`Only same-origin iframes can work with focus integration (showing window as focused, refocusing last focused controls).\n\tIf you can re-host the content on the same origin, you can resolve this and enable focus integration.\n\tYou can also disable this warning by passing {iframes: {ignoreCrossOrigin: true}} to $Window.`));\n\t\t\t\t\twarned_iframes.add(iframe);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.error(...log_template(`This may be a bug in OS-GUI, since it doesn't appear to be a cross-origin iframe.`));\n\t\t\t}\n\t\t};\n\n\t\tconst debug_focus_tracking = (document, container_el, descendant_el, is_root) => {\n\t\t\tif (!$Window.DEBUG_FOCUS) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet svg = debug_svg_by_container.get(container_el);\n\t\t\tif (!svg) {\n\t\t\t\tsvg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\n\t\t\t\tsvg.style.position = \"fixed\";\n\t\t\t\tsvg.style.top = \"0\";\n\t\t\t\tsvg.style.left = \"0\";\n\t\t\t\tsvg.style.width = \"100%\";\n\t\t\t\tsvg.style.height = \"100%\";\n\t\t\t\tsvg.style.pointerEvents = \"none\";\n\t\t\t\tsvg.style.zIndex = \"100000000\";\n\t\t\t\tsvg.style.direction = \"ltr\"; // position labels correctly\n\t\t\t\tdebug_svg_by_container.set(container_el, svg);\n\t\t\t\tdebug_svgs_in_window.push(svg);\n\t\t\t\tdocument.body.appendChild(svg);\n\t\t\t}\n\t\t\tsvg._container_el = container_el;\n\t\t\tsvg._descendant_el = descendant_el;\n\t\t\tsvg._is_root = is_root;\n\t\t\tanimate_debug_focus_tracking();\n\t\t};\n\t\tconst update_debug_focus_tracking = (svg) => {\n\t\t\tconst container_el = svg._container_el;\n\t\t\tconst descendant_el = svg._descendant_el;\n\t\t\tconst is_root = svg._is_root;\n\n\t\t\twhile (svg.lastChild) {\n\t\t\t\tsvg.removeChild(svg.lastChild);\n\t\t\t}\n\t\t\tconst descendant_rect = descendant_el.getBoundingClientRect && descendant_el.getBoundingClientRect() ||/*??*/ { left: 0, top: 0, width: innerWidth, height: innerHeight, right: innerWidth, bottom: innerHeight };\n\t\t\tconst container_rect = container_el.getBoundingClientRect && ontainer_el.getBoundingClientRect() ||/*??*/ { left: 0, top: 0, width: innerWidth, height: innerHeight, right: innerWidth, bottom: innerHeight };\n\t\t\t// draw rectangles with labels\n\t\t\tfor (const rect of [descendant_rect, container_rect]) {\n\t\t\t\tconst rect_el = document.createElementNS(\"http://www.w3.org/2000/svg\", \"rect\");\n\t\t\t\trect_el.setAttribute(\"x\", rect.left);\n\t\t\t\trect_el.setAttribute(\"y\", rect.top);\n\t\t\t\trect_el.setAttribute(\"width\", rect.width);\n\t\t\t\trect_el.setAttribute(\"height\", rect.height);\n\t\t\t\trect_el.setAttribute(\"stroke\", rect === descendant_rect ? \"#f44\" : \"#f44\");\n\t\t\t\trect_el.setAttribute(\"stroke-width\", \"2\");\n\t\t\t\trect_el.setAttribute(\"fill\", \"none\");\n\t\t\t\tif (!is_root) {\n\t\t\t\t\trect_el.setAttribute(\"stroke-dasharray\", \"5,5\");\n\t\t\t\t}\n\t\t\t\tsvg.appendChild(rect_el);\n\t\t\t\tconst text_el = document.createElementNS(\"http://www.w3.org/2000/svg\", \"text\");\n\t\t\t\ttext_el.setAttribute(\"x\", rect.left);\n\t\t\t\ttext_el.setAttribute(\"y\", rect.top + (rect === descendant_rect ? 20 : 0)); // align container text on outside, descendant text on inside\n\t\t\t\ttext_el.setAttribute(\"fill\", rect === descendant_rect ? \"#f44\" : \"aqua\");\n\t\t\t\ttext_el.setAttribute(\"font-size\", \"20\");\n\t\t\t\ttext_el.style.textShadow = \"1px 1px 1px black, 0 0 10px black\";\n\t\t\t\ttext_el.textContent = element_to_string(rect === descendant_rect ? descendant_el : container_el);\n\t\t\t\tsvg.appendChild(text_el);\n\t\t\t}\n\t\t\t// draw lines connecting the two rects\n\t\t\tconst lines = [\n\t\t\t\t[descendant_rect.left, descendant_rect.top, container_rect.left, container_rect.top],\n\t\t\t\t[descendant_rect.right, descendant_rect.top, container_rect.right, container_rect.top],\n\t\t\t\t[descendant_rect.left, descendant_rect.bottom, container_rect.left, container_rect.bottom],\n\t\t\t\t[descendant_rect.right, descendant_rect.bottom, container_rect.right, container_rect.bottom],\n\t\t\t];\n\t\t\tfor (const line of lines) {\n\t\t\t\tconst line_el = document.createElementNS(\"http://www.w3.org/2000/svg\", \"line\");\n\t\t\t\tline_el.setAttribute(\"x1\", line[0]);\n\t\t\t\tline_el.setAttribute(\"y1\", line[1]);\n\t\t\t\tline_el.setAttribute(\"x2\", line[2]);\n\t\t\t\tline_el.setAttribute(\"y2\", line[3]);\n\t\t\t\tline_el.setAttribute(\"stroke\", \"green\");\n\t\t\t\tline_el.setAttribute(\"stroke-width\", \"2\");\n\t\t\t\tsvg.appendChild(line_el);\n\t\t\t}\n\t\t};\n\t\tlet debug_animation_frame_id;\n\t\tconst animate_debug_focus_tracking = () => {\n\t\t\tcancelAnimationFrame(debug_animation_frame_id);\n\t\t\tif (!$Window.DEBUG_FOCUS) {\n\t\t\t\tclean_up_debug_focus_tracking();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tdebug_animation_frame_id = requestAnimationFrame(animate_debug_focus_tracking);\n\t\t\tfor (const svg of debug_svgs_in_window) {\n\t\t\t\tupdate_debug_focus_tracking(svg);\n\t\t\t}\n\t\t};\n\t\tconst clean_up_debug_focus_tracking = () => {\n\t\t\tcancelAnimationFrame(debug_animation_frame_id);\n\t\t\tfor (const svg of debug_svgs_in_window) {\n\t\t\t\tsvg.remove();\n\t\t\t}\n\t\t\tdebug_svgs_in_window.length = 0;\n\t\t\tdebug_svg_by_container.clear();\n\t\t};\n\n\t\tconst refocus = (container_el = $w.$content[0]) => {\n\t\t\tconst logical_container_el = container_el.matches(\".window-content\") ? $w[0] : container_el;\n\t\t\tconst last_focus = last_focus_by_container.get(logical_container_el);\n\t\t\tif (last_focus) {\n\t\t\t\tlast_focus.focus({ preventScroll: true });\n\t\t\t\tif (last_focus.tagName === \"IFRAME\") {\n\t\t\t\t\ttry {\n\t\t\t\t\t\trefocus(last_focus);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\twarn_iframe_access(last_focus, e);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst $tabstops = find_tabstops(container_el);\n\t\t\tconst $default = $tabstops.filter(\".default\");\n\t\t\tif ($default.length) {\n\t\t\t\t$default[0].focus({ preventScroll: true });\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($tabstops.length) {\n\t\t\t\tif ($tabstops[0].tagName === \"IFRAME\") {\n\t\t\t\t\ttry {\n\t\t\t\t\t\trefocus($tabstops[0]); // not .contentDocument.body because we want the container tracked by last_focus_by_container\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\twarn_iframe_access($tabstops[0], e);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$tabstops[0].focus({ preventScroll: true });\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (options.toolWindow && options.parentWindow) {\n\t\t\t\toptions.parentWindow.triggerHandler(\"refocus-window\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tcontainer_el.focus({ preventScroll: true });\n\t\t\tif (container_el.tagName === \"IFRAME\") {\n\t\t\t\ttry {\n\t\t\t\t\trefocus(container_el.contentDocument.body);\n\t\t\t\t} catch (e) {\n\t\t\t\t\twarn_iframe_access(container_el, e);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\t$w.on(\"refocus-window\", () => {\n\t\t\trefocus();\n\t\t});\n\n\t\t// redundant events are for handling synthetic events,\n\t\t// which may be sent individually, rather than in tandem\n\t\t$w.on(\"pointerdown mousedown\", handle_pointer_activation);\n\t\t// Note that jQuery treats some events differently, and can't listen for some synthetic events\n\t\t// but pointerdown and mousedown seem to be supported. That said, if you trigger() either,\n\t\t// addEventListener() handlers will not be called. So if I remove the dependency on jQuery,\n\t\t// it will not be possible to listen for some .trigger() events.\n\t\t// https://jsfiddle.net/1j01/ndvwts9y/1/\n\n\t\t// Assumption: focusin comes after pointerdown/mousedown\n\t\t// This is probably guaranteed, because you can prevent the default of focusing from pointerdown/mousedown\n\t\t$G.on(\"focusin\", (e) => {\n\t\t\tlast_focus_by_container.set(window, e.target);\n\t\t\t// debug_focus_tracking(document, window, e.target);\n\t\t});\n\n\t\tfunction handle_pointer_activation(event) {\n\t\t\t// console.log(\"handle_pointer_activation\", event.type, event.target);\n\t\t\t$w.bringToFront();\n\t\t\t// Test cases where it should refocus the last focused control in the window:\n\t\t\t// - Click in the blank space of the window\n\t\t\t//   - Click in blank space again now that something's focused\n\t\t\t// - Click on the window title bar\n\t\t\t//   - Click on title bar buttons\n\t\t\t// - Closing a second window should focus the first window\n\t\t\t//   - Open a dialog window from an app window that has a tool window, then close the dialog window\n\t\t\t//     - @TODO: Even if the tool window has controls, it should focus the parent window, I think\n\t\t\t// - Clicking on a control in the window should focus said control\n\t\t\t// - Clicking on a disabled control in the window should focus the window\n\t\t\t//   - Make sure to test this with another window previously focused\n\t\t\t// - Simulated clicks (important for JS Paint's eye gaze and speech recognition modes)\n\t\t\t// - (@TODO: Should clicking a child window focus the parent window?)\n\t\t\t// - After potentially selecting text but not selecting anything\n\t\t\t// It should NOT refocus when:\n\t\t\t// - Clicking on a control in a different window\n\t\t\t// - When other event handlers set focus\n\t\t\t//   - Using the keyboard to focus something outside the window, such as a menu popup\n\t\t\t//   - Clicking a control that focuses something outside the window\n\t\t\t//     - Button that opens another window (e.g. Recursive Dialog button in tests)\n\t\t\t//     - Button that focuses a control in another window (e.g. Focus Other button in tests)\n\t\t\t// - Trying to select text\n\n\t\t\t// Wait for other pointerdown handlers and default behavior, and focusin events.\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tconst last_focus_global = last_focus_by_container.get(window);\n\t\t\t\t// const last_focus_in_window = last_focus_by_container.get($w.$content[0]);\n\t\t\t\t// console.log(\"a tick after\", event.type, { last_focus_in_window, last_focus_global, activeElement: document.activeElement, win_elem: $w[0] });\n\t\t\t\t// console.log(\"did focus change?\", document.activeElement !== last_focus_global);\n\n\t\t\t\t// If something programmatically got focus, don't refocus.\n\t\t\t\tif (\n\t\t\t\t\tdocument.activeElement &&\n\t\t\t\t\tdocument.activeElement !== document &&\n\t\t\t\t\tdocument.activeElement !== document.body &&\n\t\t\t\t\tdocument.activeElement !== $w.$content[0] &&\n\t\t\t\t\tdocument.activeElement !== last_focus_global\n\t\t\t\t) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// If menus got focus, don't refocus.\n\t\t\t\tif (document.activeElement && document.activeElement.closest && document.activeElement.closest(\".menus, .menu-popup\")) {\n\t\t\t\t\t// console.log(\"click in menus\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// If the element is selectable, wait until the click is done and see if anything was selected first.\n\t\t\t\t// This is a bit of a weird compromise, for now.\n\t\t\t\tconst target_style = getComputedStyle(event.target);\n\t\t\t\tif (target_style.userSelect !== \"none\") {\n\t\t\t\t\t// Immediately show the window as focused, just don't refocus a specific control.\n\t\t\t\t\t$w.$content.focus();\n\n\t\t\t\t\t$w.one(\"pointerup pointercancel\", () => {\n\t\t\t\t\t\trequestAnimationFrame(() => { // this seems to make it more reliable in regards to double clicking\n\t\t\t\t\t\t\tif (!getSelection().toString().trim()) {\n\t\t\t\t\t\t\t\trefocus();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// Set focus to the last focused control, which should be updated if a click just occurred.\n\t\t\t\trefocus();\n\t\t\t});\n\t\t}\n\n\t\t$w.on(\"keydown\", (e) => {\n\t\t\tif (e.isDefaultPrevented()) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (e.ctrlKey || e.altKey || e.metaKey) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// console.log(\"keydown\", e.key, e.target);\n\t\t\tif (e.target.closest(\".menus\")) {\n\t\t\t\t// console.log(\"keydown in menus\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst $buttons = $w.$content.find(\"button\");\n\t\t\tconst $focused = $(document.activeElement);\n\t\t\tconst focused_index = $buttons.index($focused);\n\t\t\tswitch (e.keyCode) {\n\t\t\t\tcase 40: // Down\n\t\t\t\tcase 39: // Right\n\t\t\t\t\tif ($focused.is(\"button\") && !e.shiftKey) {\n\t\t\t\t\t\tif (focused_index < $buttons.length - 1) {\n\t\t\t\t\t\t\t$buttons[focused_index + 1].focus();\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 38: // Up\n\t\t\t\tcase 37: // Left\n\t\t\t\t\tif ($focused.is(\"button\") && !e.shiftKey) {\n\t\t\t\t\t\tif (focused_index > 0) {\n\t\t\t\t\t\t\t$buttons[focused_index - 1].focus();\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 32: // Space\n\t\t\t\tcase 13: // Enter (doesn't actually work in chrome because the button gets clicked immediately)\n\t\t\t\t\tif ($focused.is(\"button\") && !e.shiftKey) {\n\t\t\t\t\t\t$focused.addClass(\"pressed\");\n\t\t\t\t\t\tconst release = () => {\n\t\t\t\t\t\t\t$focused.removeClass(\"pressed\");\n\t\t\t\t\t\t\t$focused.off(\"focusout\", release);\n\t\t\t\t\t\t\t$(window).off(\"keyup\", keyup);\n\t\t\t\t\t\t};\n\t\t\t\t\t\tconst keyup = (e) => {\n\t\t\t\t\t\t\tif (e.keyCode === 32 || e.keyCode === 13) {\n\t\t\t\t\t\t\t\trelease();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t\t$focused.on(\"focusout\", release);\n\t\t\t\t\t\t$(window).on(\"keyup\", keyup);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 9: { // Tab\n\t\t\t\t\t// wrap around when tabbing through controls in a window\n\t\t\t\t\tconst $controls = find_tabstops($w.$content[0]);\n\t\t\t\t\tif ($controls.length > 0) {\n\t\t\t\t\t\tconst focused_control_index = $controls.index($focused);\n\t\t\t\t\t\tif (e.shiftKey) {\n\t\t\t\t\t\t\tif (focused_control_index === 0) {\n\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t$controls[$controls.length - 1].focus();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif (focused_control_index === $controls.length - 1) {\n\t\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\t\t$controls[0].focus();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 27: // Escape\n\t\t\t\t\t// @TODO: make this optional, and probably default false\n\t\t\t\t\t$w.close();\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\n\t\t$w.applyBounds = () => {\n\t\t\t// TODO: outerWidth vs width? not sure\n\t\t\tconst bound_width = Math.max(document.body.scrollWidth, innerWidth);\n\t\t\tconst bound_height = Math.max(document.body.scrollHeight, innerHeight);\n\t\t\t$w.css({\n\t\t\t\tleft: Math.max(0, Math.min(bound_width - $w.width(), $w.position().left)),\n\t\t\t\ttop: Math.max(0, Math.min(bound_height - $w.height(), $w.position().top)),\n\t\t\t});\n\t\t};\n\n\t\t$w.bringTitleBarInBounds = () => {\n\t\t\t// Try to make the titlebar always accessible\n\t\t\tconst bound_width = Math.max(document.body.scrollWidth, innerWidth);\n\t\t\tconst bound_height = Math.max(document.body.scrollHeight, innerHeight);\n\t\t\tconst min_horizontal_pixels_on_screen = 40; // enough for space past a close button\n\t\t\t$w.css({\n\t\t\t\tleft: Math.max(\n\t\t\t\t\tmin_horizontal_pixels_on_screen - $w.outerWidth(),\n\t\t\t\t\tMath.min(\n\t\t\t\t\t\tbound_width - min_horizontal_pixels_on_screen,\n\t\t\t\t\t\t$w.position().left\n\t\t\t\t\t)\n\t\t\t\t),\n\t\t\t\ttop: Math.max(0, Math.min(\n\t\t\t\t\tbound_height - $w.$titlebar.outerHeight() - 5,\n\t\t\t\t\t$w.position().top\n\t\t\t\t)),\n\t\t\t});\n\t\t};\n\n\t\t$w.center = () => {\n\t\t\t$w.css({\n\t\t\t\tleft: (innerWidth - $w.width()) / 2 + window.scrollX,\n\t\t\t\ttop: (innerHeight - $w.height()) / 2 + window.scrollY,\n\t\t\t});\n\t\t\t$w.applyBounds();\n\t\t};\n\n\n\t\t$G.on(\"resize\", $w.bringTitleBarInBounds);\n\n\t\tvar drag_offset_x, drag_offset_y, drag_pointer_x, drag_pointer_y, drag_pointer_id;\n\t\tvar update_drag = (e) => {\n\t\t\tif (drag_pointer_id === (e.pointerId ||/*??*/ e.originalEvent.pointerId)) {\n\t\t\t\tdrag_pointer_x = e.clientX ||/*??*/ drag_pointer_x;\n\t\t\t\tdrag_pointer_y = e.clientY ||/*??*/ drag_pointer_y;\n\t\t\t}\n\t\t\t$w.css({\n\t\t\t\tleft: drag_pointer_x + scrollX - drag_offset_x,\n\t\t\t\ttop: drag_pointer_y + scrollY - drag_offset_y,\n\t\t\t});\n\t\t};\n\t\t$w.$titlebar.css(\"touch-action\", \"none\");\n\t\t$w.$titlebar.on(\"selectstart\", (e) => { // preventing mousedown would break :active state, I'm not sure if just selectstart is enough...\n\t\t\te.preventDefault();\n\t\t});\n\t\t$w.$titlebar.on(\"mousedown\", \"button\", (e) => {\n\t\t\t// Prevent focus on titlebar buttons.\n\t\t\t// This can break the :active state. In Firefox, a setTimeout before any focus() was enough,\n\t\t\t// but now in Chrome 95, focus() breaks the :active state too, and setTimeout only delays the brokenness,\n\t\t\t// so I have to use a CSS class now for the pressed state.\n\t\t\trefocus();\n\t\t\t// Emulate :enabled:active:hover state with .pressing class\n\t\t\tconst button = e.currentTarget;\n\t\t\tif (!$(button).is(\":enabled\")) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tbutton.classList.add(\"pressing\");\n\t\t\tconst release = (event) => {\n\t\t\t\t// blur is just to handle the edge case of alt+tabbing/ctrl+tabbing away\n\t\t\t\tif (event && event.type === \"blur\") {\n\t\t\t\t\t// if (document.activeElement?.tagName === \"IFRAME\") {\n\t\t\t\t\tif (document.hasFocus()) {\n\t\t\t\t\t\treturn; // the window isn't really blurred; an iframe got focus\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbutton.classList.remove(\"pressing\");\n\t\t\t\t$G.off(\"mouseup blur\", release);\n\t\t\t\t$(button).off(\"mouseenter\", on_mouse_enter);\n\t\t\t\t$(button).off(\"mouseleave\", on_mouse_leave);\n\t\t\t};\n\t\t\tconst on_mouse_enter = () => { button.classList.add(\"pressing\"); };\n\t\t\tconst on_mouse_leave = () => { button.classList.remove(\"pressing\"); };\n\t\t\t$G.on(\"mouseup blur\", release);\n\t\t\t$(button).on(\"mouseenter\", on_mouse_enter);\n\t\t\t$(button).on(\"mouseleave\", on_mouse_leave);\n\t\t});\n\t\t$w.$titlebar.on(\"pointerdown\", (e) => {\n\t\t\tif ($(e.target).closest(\"button\").length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ($w.hasClass(\"maximized\")) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst customEvent = $.Event(\"window-drag-start\");\n\t\t\t$w.trigger(customEvent);\n\t\t\tif (customEvent.isDefaultPrevented()) {\n\t\t\t\treturn; // allow custom drag behavior of component windows in jspaint (Tools / Colors)\n\t\t\t}\n\t\t\tdrag_offset_x = e.clientX + scrollX - $w.position().left;\n\t\t\tdrag_offset_y = e.clientY + scrollY - $w.position().top;\n\t\t\tdrag_pointer_x = e.clientX;\n\t\t\tdrag_pointer_y = e.clientY;\n\t\t\tdrag_pointer_id = (e.pointerId ||/*??*/ e.originalEvent.pointerId);\n\t\t\t$G.on(\"pointermove\", update_drag);\n\t\t\t$G.on(\"scroll\", update_drag);\n\t\t\t$(\"body\").addClass(\"dragging\"); // for when mouse goes over an iframe\n\t\t});\n\t\t$G.on(\"pointerup pointercancel\", (e) => {\n\t\t\tif ((e.pointerId ||/*??*/ e.originalEvent.pointerId) !== drag_pointer_id) { return; }\n\t\t\t$G.off(\"pointermove\", update_drag);\n\t\t\t$G.off(\"scroll\", update_drag);\n\t\t\t$(\"body\").removeClass(\"dragging\");\n\t\t\t// $w.applyBounds(); // Windows doesn't really try to keep windows on screen\n\t\t\t// but you also can't really drag off of the desktop, whereas here you can drag to way outside the web page.\n\t\t\t$w.bringTitleBarInBounds();\n\t\t\tdrag_pointer_id = -1; // prevent bringTitleBarInBounds from making the window go to top left when unminimizing window from taskbar after previously dragging it\n\t\t});\n\t\t$w.$titlebar.on(\"dblclick\", (e) => {\n\t\t\tif ($component) {\n\t\t\t\t$component.dock();\n\t\t\t}\n\t\t});\n\n\t\tif (options.resizable) {\n\n\t\t\tconst HANDLE_MIDDLE = 0;\n\t\t\tconst HANDLE_START = -1;\n\t\t\tconst HANDLE_END = 1;\n\t\t\tconst HANDLE_LEFT = HANDLE_START;\n\t\t\tconst HANDLE_RIGHT = HANDLE_END;\n\t\t\tconst HANDLE_TOP = HANDLE_START;\n\t\t\tconst HANDLE_BOTTOM = HANDLE_END;\n\n\t\t\t[\n\t\t\t\t[HANDLE_TOP, HANDLE_RIGHT], // \n\t\t\t\t[HANDLE_TOP, HANDLE_MIDDLE], // \n\t\t\t\t[HANDLE_TOP, HANDLE_LEFT], // \n\t\t\t\t[HANDLE_MIDDLE, HANDLE_LEFT], // \n\t\t\t\t[HANDLE_BOTTOM, HANDLE_LEFT], // \n\t\t\t\t[HANDLE_BOTTOM, HANDLE_MIDDLE], // \n\t\t\t\t[HANDLE_BOTTOM, HANDLE_RIGHT], // \n\t\t\t\t[HANDLE_MIDDLE, HANDLE_RIGHT], // \n\t\t\t].forEach(([y_axis, x_axis]) => {\n\t\t\t\t// const resizes_height = y_axis !== HANDLE_MIDDLE;\n\t\t\t\t// const resizes_width = x_axis !== HANDLE_MIDDLE;\n\t\t\t\tconst $handle = $(\"<div>\").addClass(\"handle\").appendTo($w);\n\n\t\t\t\tlet cursor = \"\";\n\t\t\t\tif (y_axis === HANDLE_TOP) { cursor += \"n\"; }\n\t\t\t\tif (y_axis === HANDLE_BOTTOM) { cursor += \"s\"; }\n\t\t\t\tif (x_axis === HANDLE_LEFT) { cursor += \"w\"; }\n\t\t\t\tif (x_axis === HANDLE_RIGHT) { cursor += \"e\"; }\n\t\t\t\tcursor += \"-resize\";\n\n\t\t\t\t// Note: MISNOMER: innerWidth() is less \"inner\" than width(), because it includes padding!\n\t\t\t\t// Here's a little diagram of sorts:\n\t\t\t\t// outerWidth(true): margin, [ outerWidth(): border, [ innerWidth(): padding, [ width(): content ] ] ]\n\t\t\t\tconst handle_thickness = ($w.outerWidth() - $w.width()) / 2; // padding + border\n\t\t\t\tconst border_width = ($w.outerWidth() - $w.innerWidth()) / 2; // border; need to outset the handles by this amount so they overlap the border + padding, and not the content\n\t\t\t\tconst window_frame_height = $w.outerHeight() - $w.$content.outerHeight(); // includes titlebar and borders, padding, but not content\n\t\t\t\tconst window_frame_width = $w.outerWidth() - $w.$content.outerWidth(); // includes borders, padding, but not content\n\t\t\t\t$handle.css({\n\t\t\t\t\tposition: \"absolute\",\n\t\t\t\t\ttop: y_axis === HANDLE_TOP ? -border_width : y_axis === HANDLE_MIDDLE ? `calc(${handle_thickness}px - ${border_width}px)` : \"\",\n\t\t\t\t\tbottom: y_axis === HANDLE_BOTTOM ? -border_width : \"\",\n\t\t\t\t\tleft: x_axis === HANDLE_LEFT ? -border_width : x_axis === HANDLE_MIDDLE ? `calc(${handle_thickness}px - ${border_width}px)` : \"\",\n\t\t\t\t\tright: x_axis === HANDLE_RIGHT ? -border_width : \"\",\n\t\t\t\t\twidth: x_axis === HANDLE_MIDDLE ? `calc(100% - ${handle_thickness}px * 2 + ${border_width * 2}px)` : `${handle_thickness}px`,\n\t\t\t\t\theight: y_axis === HANDLE_MIDDLE ? `calc(100% - ${handle_thickness}px * 2 + ${border_width * 2}px)` : `${handle_thickness}px`,\n\t\t\t\t\t// background: x_axis === HANDLE_MIDDLE || y_axis === HANDLE_MIDDLE ? \"rgba(255,0,0,0.4)\" : \"rgba(0,255,0,0.8)\",\n\t\t\t\t\ttouchAction: \"none\",\n\t\t\t\t\tcursor,\n\t\t\t\t});\n\n\t\t\t\tlet rect;\n\t\t\t\tlet resize_offset_x, resize_offset_y, resize_pointer_x, resize_pointer_y, resize_pointer_id;\n\t\t\t\t$handle.on(\"pointerdown\", (e) => {\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t$G.on(\"pointermove\", handle_pointermove);\n\t\t\t\t\t$G.on(\"scroll\", update_resize); // scroll doesn't have clientX/Y, so we have to remember it\n\t\t\t\t\t$(\"body\").addClass(\"dragging\"); // for when mouse goes over an iframe\n\t\t\t\t\t$G.on(\"pointerup pointercancel\", end_resize);\n\n\t\t\t\t\trect = {\n\t\t\t\t\t\tx: $w.position().left,\n\t\t\t\t\t\ty: $w.position().top,\n\t\t\t\t\t\twidth: $w.outerWidth(),\n\t\t\t\t\t\theight: $w.outerHeight(),\n\t\t\t\t\t};\n\n\t\t\t\t\tresize_offset_x = e.clientX + scrollX - rect.x - (x_axis === HANDLE_RIGHT ? rect.width : 0);\n\t\t\t\t\tresize_offset_y = e.clientY + scrollY - rect.y - (y_axis === HANDLE_BOTTOM ? rect.height : 0);\n\t\t\t\t\tresize_pointer_x = e.clientX;\n\t\t\t\t\tresize_pointer_y = e.clientY;\n\t\t\t\t\tresize_pointer_id = (e.pointerId ||/*??*/ e.originalEvent.pointerId);\n\n\t\t\t\t\t$handle[0].setPointerCapture(resize_pointer_id); // keeps cursor consistent when mouse moves over other elements\n\n\t\t\t\t\t// handle_pointermove(e); // was useful for checking that the offset is correct (should not do anything, if it's correct!)\n\t\t\t\t});\n\t\t\t\tfunction handle_pointermove(e) {\n\t\t\t\t\tif ((e.pointerId ||/*??*/ e.originalEvent.pointerId) !== resize_pointer_id) { return; }\n\t\t\t\t\tresize_pointer_x = e.clientX;\n\t\t\t\t\tresize_pointer_y = e.clientY;\n\t\t\t\t\tupdate_resize();\n\t\t\t\t}\n\t\t\t\tfunction end_resize(e) {\n\t\t\t\t\tif ((e.pointerId ||/*??*/ e.originalEvent.pointerId) !== resize_pointer_id) { return; }\n\t\t\t\t\t$G.off(\"pointermove\", handle_pointermove);\n\t\t\t\t\t$G.off(\"scroll\", onscroll);\n\t\t\t\t\t$(\"body\").removeClass(\"dragging\");\n\t\t\t\t\t$G.off(\"pointerup pointercancel\", end_resize);\n\t\t\t\t\t$w.bringTitleBarInBounds();\n\t\t\t\t}\n\t\t\t\tfunction update_resize() {\n\t\t\t\t\tconst mouse_x = resize_pointer_x + scrollX - resize_offset_x;\n\t\t\t\t\tconst mouse_y = resize_pointer_y + scrollY - resize_offset_y;\n\t\t\t\t\tlet delta_x = 0;\n\t\t\t\t\tlet delta_y = 0;\n\t\t\t\t\tlet width, height;\n\t\t\t\t\tif (x_axis === HANDLE_RIGHT) {\n\t\t\t\t\t\tdelta_x = 0;\n\t\t\t\t\t\twidth = ~~(mouse_x - rect.x);\n\t\t\t\t\t} else if (x_axis === HANDLE_LEFT) {\n\t\t\t\t\t\tdelta_x = ~~(mouse_x - rect.x);\n\t\t\t\t\t\twidth = ~~(rect.x + rect.width - mouse_x);\n\t\t\t\t\t} else {\n\t\t\t\t\t\twidth = ~~(rect.width);\n\t\t\t\t\t}\n\t\t\t\t\tif (y_axis === HANDLE_BOTTOM) {\n\t\t\t\t\t\tdelta_y = 0;\n\t\t\t\t\t\theight = ~~(mouse_y - rect.y);\n\t\t\t\t\t} else if (y_axis === HANDLE_TOP) {\n\t\t\t\t\t\tdelta_y = ~~(mouse_y - rect.y);\n\t\t\t\t\t\theight = ~~(rect.y + rect.height - mouse_y);\n\t\t\t\t\t} else {\n\t\t\t\t\t\theight = ~~(rect.height);\n\t\t\t\t\t}\n\t\t\t\t\tlet new_rect = {\n\t\t\t\t\t\tx: rect.x + delta_x,\n\t\t\t\t\t\ty: rect.y + delta_y,\n\t\t\t\t\t\twidth,\n\t\t\t\t\t\theight,\n\t\t\t\t\t};\n\n\t\t\t\t\tnew_rect.width = Math.max(1, new_rect.width);\n\t\t\t\t\tnew_rect.height = Math.max(1, new_rect.height);\n\n\t\t\t\t\t// Constraints\n\t\t\t\t\tif (options.constrainRect) {\n\t\t\t\t\t\tnew_rect = options.constrainRect(new_rect, x_axis, y_axis);\n\t\t\t\t\t}\n\t\t\t\t\tnew_rect.width = Math.max(new_rect.width, options.minOuterWidth ||/*??*/ 100);\n\t\t\t\t\tnew_rect.height = Math.max(new_rect.height, options.minOuterHeight ||/*??*/ 0);\n\t\t\t\t\tnew_rect.width = Math.max(new_rect.width, (options.minInnerWidth ||/*??*/ 0) + window_frame_width);\n\t\t\t\t\tnew_rect.height = Math.max(new_rect.height, (options.minInnerHeight ||/*??*/ 0) + window_frame_height);\n\t\t\t\t\t// prevent free movement via resize past minimum size\n\t\t\t\t\tif (x_axis === HANDLE_LEFT) {\n\t\t\t\t\t\tnew_rect.x = Math.min(new_rect.x, rect.x + rect.width - new_rect.width);\n\t\t\t\t\t}\n\t\t\t\t\tif (y_axis === HANDLE_TOP) {\n\t\t\t\t\t\tnew_rect.y = Math.min(new_rect.y, rect.y + rect.height - new_rect.height);\n\t\t\t\t\t}\n\n\t\t\t\t\t$w.css({\n\t\t\t\t\t\ttop: new_rect.y,\n\t\t\t\t\t\tleft: new_rect.x,\n\t\t\t\t\t});\n\t\t\t\t\t$w.outerWidth(new_rect.width);\n\t\t\t\t\t$w.outerHeight(new_rect.height);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t$w.$Button = (text, handler) => {\n\t\t\tvar $b = $(E(\"button\"))\n\t\t\t\t.appendTo($w.$content)\n\t\t\t\t.text(text)\n\t\t\t\t.on(\"click\", () => {\n\t\t\t\t\tif (handler) {\n\t\t\t\t\t\thandler();\n\t\t\t\t\t}\n\t\t\t\t\t$w.close();\n\t\t\t\t});\n\t\t\treturn $b;\n\t\t};\n\t\t$w.title = title => {\n\t\t\tif (title) {\n\t\t\t\t$w.$title.text(title);\n\t\t\t\t$w.trigger(\"title-change\");\n\t\t\t\tif ($w.task) {\n\t\t\t\t\t$w.task.updateTitle();\n\t\t\t\t}\n\t\t\t\treturn $w;\n\t\t\t} else {\n\t\t\t\treturn $w.$title.text();\n\t\t\t}\n\t\t};\n\t\t$w.getTitle = () => {\n\t\t\treturn $w.title();\n\t\t};\n\t\tlet animating_titlebar = false;\n\t\tlet when_done_animating_titlebar = []; // queue of functions to call when done animating,\n\t\t// so maximize() / minimize() / restore() eventually gives the same result as if there was no animation\n\t\t$w.animateTitlebar = (from, to, callback = () => { }) => {\n\t\t\t// flying titlebar animation\n\t\t\tanimating_titlebar = true;\n\t\t\tconst $eye_leader = $w.$titlebar.clone(true);\n\t\t\t$eye_leader.find(\"button\").remove();\n\t\t\t$eye_leader.appendTo(\"body\");\n\t\t\tconst duration_ms = $Window.OVERRIDE_TRANSITION_DURATION ||/*??*/ 200; // TODO: how long?\n\t\t\tconst duration_str = `${duration_ms}ms`;\n\t\t\t$eye_leader.css({\n\t\t\t\ttransition: `left ${duration_str} linear, top ${duration_str} linear, width ${duration_str} linear, height ${duration_str} linear`,\n\t\t\t\tposition: \"fixed\",\n\t\t\t\tzIndex: 10000000,\n\t\t\t\tpointerEvents: \"none\",\n\t\t\t\tleft: from.left,\n\t\t\t\ttop: from.top,\n\t\t\t\twidth: from.width,\n\t\t\t\theight: from.height,\n\t\t\t});\n\t\t\tsetTimeout(() => {\n\t\t\t\t$eye_leader.css({\n\t\t\t\t\tleft: to.left,\n\t\t\t\t\ttop: to.top,\n\t\t\t\t\twidth: to.width,\n\t\t\t\t\theight: to.height,\n\t\t\t\t});\n\t\t\t}, 5);\n\t\t\tlet handled_transition_completion = false;\n\t\t\tconst handle_transition_completion = () => {\n\t\t\t\tif (handled_transition_completion) {\n\t\t\t\t\treturn; // ignore multiple calls (an idempotency pattern)\n\t\t\t\t} else {\n\t\t\t\t\thandled_transition_completion = true;\n\t\t\t\t}\n\t\t\t\tanimating_titlebar = false;\n\t\t\t\t$eye_leader.remove();\n\t\t\t\tcallback();\n\t\t\t\tlet anima = when_done_animating_titlebar.shift()\n\t\t\t\tanima && anima(); // relies on animating_titlebar = false;\n\t\t\t};\n\t\t\t$eye_leader.on(\"transitionend transitioncancel\", handle_transition_completion);\n\t\t\tsetTimeout(handle_transition_completion, duration_ms * 1.2);\n\t\t};\n\t\t$w.close = (force) => {\n\t\t\tif (force && force !== true) {\n\t\t\t\tthrow new TypeError(\"force must be a boolean or undefined, not \" + Object.prototype.toString.call(force));\n\t\t\t}\n\t\t\tif (!force) {\n\t\t\t\tvar e = $.Event(\"close\");\n\t\t\t\t$w.trigger(e);\n\t\t\t\tif (e.isDefaultPrevented()) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($component) {\n\t\t\t\t$component.detach();\n\t\t\t}\n\t\t\t$w.closed = true;\n\t\t\t$event_target.triggerHandler(\"closed\");\n\t\t\t$w.trigger(\"closed\");\n\t\t\t// TODO: change usages of \"close\" to \"closed\" where appropriate\n\t\t\t// and probably rename the \"close\" event (\"before[-]close\"? \"may-close\"? \"close-request\"?)\n\n\t\t\t// MUST be after any events are triggered!\n\t\t\t$w.remove();\n\n\t\t\t// TODO: support modals, which should focus what was focused before the modal was opened.\n\t\t\t// (Note: must consider the element being removed from the DOM, or hidden, or made un-focusable)\n\t\t\t// (Also: modals should steal focus / be brought to the front when focusing the parent window, and the parent window's content should be inert/uninteractive)\n\t\t\t\n\t\t\t// Focus next-topmost window\n\t\t\tvar $next_topmost = $($(\".window:visible\").toArray().sort((a, b) => b.style.zIndex - a.style.zIndex)[0]);\n\t\t\t$next_topmost.triggerHandler(\"refocus-window\");\n\n\t\t\t// Cleanup\n\t\t\tclean_up_debug_focus_tracking();\n\t\t};\n\t\t$w.closed = false;\n\n\t\tlet current_menu_bar;\n\t\t// @TODO: should this be like setMenus(menu_definitions)?\n\t\t// It seems like setMenuBar(menu_bar) might be prone to bugs\n\t\t// trying to set the same menu bar on multiple windows.\n\t\t$w.setMenuBar = (menu_bar) => {\n\t\t\t// $w.find(\".menus\").remove(); // ugly, if only because of the class name haha\n\t\t\tif (current_menu_bar) {\n\t\t\t\tcurrent_menu_bar.element.remove();\n\t\t\t}\n\t\t\tif (menu_bar) {\n\t\t\t\t$w.$titlebar.after(menu_bar.element);\n\t\t\t\tmenu_bar.setKeyboardScope($w[0]);\n\t\t\t\tcurrent_menu_bar = menu_bar;\n\t\t\t}\n\t\t};\n\n\t\tif (options.title) {\n\t\t\t$w.title(options.title);\n\t\t}\n\n\t\tif (!$component) {\n\t\t\t$w.center();\n\t\t}\n\n\t\t// mustHaveMethods($w, windowInterfaceMethods);\n\n\t\treturn $w;\n\t}\n\n\tfunction $FormWindow(title) {\n\t\tvar $w = new $Window();\n\n\t\t$w.title(title);\n\t\t$w.$form = $(E(\"form\")).appendTo($w.$content);\n\t\t$w.$main = $(E(\"div\")).appendTo($w.$form);\n\t\t$w.$buttons = $(E(\"div\")).appendTo($w.$form).addClass(\"button-group\");\n\n\t\t$w.$Button = (label, action) => {\n\t\t\tvar $b = $(E(\"button\")).appendTo($w.$buttons).text(label);\n\t\t\t$b.on(\"click\", (e) => {\n\t\t\t\t// prevent the form from submitting\n\t\t\t\t// @TODO: instead, prevent the form's submit event\n\t\t\t\te.preventDefault();\n\n\t\t\t\taction();\n\t\t\t});\n\n\t\t\t$b.on(\"pointerdown\", () => {\n\t\t\t\t$b.focus();\n\t\t\t});\n\n\t\t\treturn $b;\n\t\t};\n\n\t\treturn $w;\n\t}\n\n\t$Window.$FormWindow = $FormWindow;\n\t\n\treturn $Window;\n});\n"]}