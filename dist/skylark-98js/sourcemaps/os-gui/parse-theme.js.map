{"version":3,"sources":["os-gui/parse-theme.js"],"names":["parseINIString","data","regex","section","param","comment","value","split","forEach","line","test","match","length","renderThemeGraphics","cssProperties","getProp","propName","getPropertyValue","canvas","document","createElement","width","height","ctx","getContext","fillStyle","fillRect","checker","toDataURL","scrollbar_size","parseInt","isFinite","scrollbar_button_inner_size","arrow_size","Math","floor","arrow_width","arrow_canvas","arrow_ctx","y","x","i","horizontal","decrement","save","translate","rotate","PI","scale","drawImage","restore","globalCompositeOperation","scrollbar_arrows_ButtonText","scrollbar_arrows_GrayText","scrollbar_arrows_ButtonHilight","border_image","border_size","svg_contents","slice_size","svg","replace","attr","n","encodeURIComponent","button_active_border_image","button_default_active_border_image","--checker","--button-active-border-image","--button-normal-border-image","--inset-deep-border-image","--button-default-border-image","--button-default-active-border-image","--scrollbar-arrows-ButtonText","--scrollbar-arrows-GrayText","--scrollbar-arrows-ButtonHilight","--scrollbar-size","--scrollbar-button-inner-size","parseThemeFileString","themeIni","theme","colors","alert","console","log","k","join","Object","assign","applyCSSProperties","options","element","recurseIntoIframes","warn","documentElement","style","setProperty","iframes","querySelectorAll","contentDocument","error","makeThemeCSSFile","css","makeBlackToInsetFilter","getElementById","$","appendTo"],"mappings":"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","file":"../../os-gui/parse-theme.js","sourcesContent":["function parseINIString(data) {\n\tvar regex = {\n\t\tsection: /^\\s*\\[\\s*([^\\]]*)\\s*\\]\\s*$/,\n\t\tparam: /^\\s*([^=]+?)\\s*=\\s*(.*?)\\s*$/,\n\t\tcomment: /^\\s*;.*$/\n\t};\n\tvar value = {};\n\tvar lines = data.split(/[\\r\\n]+/);\n\tvar section = null;\n\tlines.forEach(function (line) {\n\t\tif (regex.comment.test(line)) {\n\t\t\treturn;\n\t\t} else if (regex.param.test(line)) {\n\t\t\tvar match = line.match(regex.param);\n\t\t\tif (section) {\n\t\t\t\tvalue[section][match[1]] = match[2];\n\t\t\t} else {\n\t\t\t\tvalue[match[1]] = match[2];\n\t\t\t}\n\t\t} else if (regex.section.test(line)) {\n\t\t\tvar match = line.match(regex.section);\n\t\t\tvalue[match[1]] = {};\n\t\t\tsection = match[1];\n\t\t} else if (line.length == 0 && section) {\n\t\t\tsection = null;\n\t\t};\n\t});\n\treturn value;\n}\n\n// takes a CSSStyleDeclaration or simple object of CSS properties\nfunction renderThemeGraphics(cssProperties) {\n\tvar getProp = (propName) => cssProperties.getPropertyValue ? cssProperties.getPropertyValue(propName) : cssProperties[propName];\n\n\tvar canvas = document.createElement(\"canvas\");\n\tcanvas.width = canvas.height = 2;\n\tvar ctx = canvas.getContext(\"2d\");\n\tctx.fillStyle = getProp(\"--ButtonFace\");\n\tctx.fillRect(0, 1, 1, 1);\n\tctx.fillRect(1, 0, 1, 1);\n\tctx.fillStyle = getProp(\"--ButtonHilight\");\n\tctx.fillRect(0, 0, 1, 1);\n\tctx.fillRect(1, 1, 1, 1);\n\tvar checker = `url(\"${canvas.toDataURL()}\")`;\n\n\tvar scrollbar_size = parseInt(getProp(\"--scrollbar-size\"));\n\tif (!isFinite(scrollbar_size)) {\n\t\tscrollbar_size = 13;\n\t}\n\tvar scrollbar_button_inner_size = scrollbar_size - 4;\n\n\t// I don't know the exact formula, so approximate and special-case it for now\n\t// (It may very well *be* special cased, tho)\n\tvar arrow_size = Math.floor(0.3 * scrollbar_size);\n\tif (scrollbar_size < 16 && scrollbar_size > 13) arrow_size -= 1;\n\n\tvar arrow_width = arrow_size * 2 - 1;\n\n\tvar arrow_canvas = document.createElement(\"canvas\");\n\tvar arrow_ctx = arrow_canvas.getContext(\"2d\");\n\tarrow_canvas.width = arrow_width;\n\tarrow_canvas.height = arrow_size;\n\tarrow_ctx.fillStyle = \"white\";\n\tfor (let y = 0; y < arrow_size; y += 1) {\n\t\tfor (let x = y; x < arrow_width - y; x += 1) {\n\t\t\tarrow_ctx.fillRect(x, y, 1, 1);\n\t\t}\n\t}\n\n\tcanvas.width = scrollbar_button_inner_size * 4;\n\tcanvas.height = scrollbar_button_inner_size;\n\tlet i = 0;\n\tfor (let horizontal = 0; horizontal < 2; horizontal += 1) {\n\t\tfor (let decrement = 0; decrement < 2; decrement += 1) {\n\t\t\tctx.save();\n\t\t\tctx.translate(i * scrollbar_button_inner_size, 0);\n\t\t\tctx.translate(scrollbar_button_inner_size / 2, scrollbar_button_inner_size / 2);\n\t\t\t// ctx.rotate(i * Math.PI / 2);\n\t\t\tif (horizontal) {\n\t\t\t\tctx.rotate(-Math.PI / 2);\n\t\t\t}\n\t\t\tif (decrement) {\n\t\t\t\tctx.scale(1, -1);\n\t\t\t}\n\t\t\tctx.translate(-scrollbar_button_inner_size / 2, -scrollbar_button_inner_size / 2);\n\t\t\tctx.drawImage(arrow_canvas, ~~(scrollbar_button_inner_size / 2 - arrow_width / 2), ~~(scrollbar_button_inner_size / 2 - arrow_size / 2));\n\t\t\tctx.restore();\n\t\t\ti += 1;\n\t\t}\n\t}\n\n\tctx.save();\n\tctx.globalCompositeOperation = \"source-in\";\n\tctx.fillStyle = getProp(\"--ButtonText\");\n\tctx.fillRect(0, 0, canvas.width, canvas.height);\n\tvar scrollbar_arrows_ButtonText = `url(\"${canvas.toDataURL()}\")`;\n\tctx.fillStyle = getProp(\"--GrayText\");\n\tctx.fillRect(0, 0, canvas.width, canvas.height);\n\tvar scrollbar_arrows_GrayText = `url(\"${canvas.toDataURL()}\")`;\n\tctx.fillStyle = getProp(\"--ButtonHilight\");\n\tctx.fillRect(0, 0, canvas.width, canvas.height);\n\tvar scrollbar_arrows_ButtonHilight = `url(\"${canvas.toDataURL()}\")`;\n\t// ctx.fillStyle = \"red\";\n\t// ctx.fillRect(0, 0, canvas.width, canvas.height);\n\t// canvas.style.background = \"rgba(0, 0, 0, 0.2)\";\n\t// $(\"h1\").append(arrow_canvas).append(canvas);\n\tctx.restore();\n\n\tfunction border_image(border_size, svg_contents) {\n\t\tvar base_size = 8;\n\t\tvar border_size = border_size;\n\t\tvar scale = 32;\n\t\tvar slice_size = border_size * scale;\n\t\tvar view_size = base_size * scale;\n\t\t// transform causes janky buggy garbage\n\t\t// var svg = `<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" width=\"${view_size}px\" height=\"${view_size}px\" viewBox=\"0 0 ${view_size} ${view_size}\">\n\t\t// \t<g transform=\"scale(${scale})\">\n\t\t// \t\t${svg_contents}\n\t\t// \t</g>\n\t\t// </svg>`;\n\t\tvar svg = `<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" width=\"${view_size}px\" height=\"${view_size}px\" viewBox=\"0 0 ${view_size} ${view_size}\">\n\t\t\t${svg_contents.replace(/(d|x|y|width|height|stroke-width)=\"[^\"]*\"/g, (attr) => attr.replace(/\\d+/g, (n) => n * scale))}\n\t\t</svg>`;\n\t\tvar url = `data:image/svg+xml,${encodeURIComponent(svg)}`;\n\t\treturn `url(\"${url}\") ${slice_size} / ${border_size}px`;\n\t}\n\n\tvar button_active_border_image = border_image(2, `\n\t\t<path d=\"M0 0h8v8h-8v-8z\" fill=\"${getProp(\"--ButtonDkShadow\")}\"/>\n\t\t<path d=\"M1 1h6v6h-6v-6z\" fill=\"${getProp(\"--ButtonShadow\")}\"/>\n\t\t<path d=\"M2 2h4v4h-4v-4z\" fill=\"${getProp(\"--ButtonFace\")}\"/>\n\t`);\n\tvar button_default_active_border_image = border_image(2, `\n\t\t<path d=\"M0 0h8v8h-8v-8z\" fill=\"${getProp(\"--ButtonDkShadow\")}\"/>\n\t\t<path d=\"M1 1h6v6h-6v-6z\" fill=\"${getProp(\"--ButtonShadow\")}\"/>\n\t\t<path d=\"M2 2h4v4h-4v-4z\" fill=\"${getProp(\"--ButtonFace\")}\"/>\n\t\t<rect x=\"0\" y=\"0\" width=\"8\" height=\"8\" stroke-width=\"2\" stroke=\"${getProp(\"--WindowFrame\")}\" fill=\"none\"/>\n\t`);\n\t// TODO: rename\n\tvar button_normal_border_image = border_image(2, `\n\t\t<path d=\"M0 0h7v1h-6v6h-1v-7z\" fill=\"${getProp(\"--ButtonHilight\")}\"/>\n\t\t<path d=\"M7 0h1v8h-8v-1h7v-7z\" fill=\"${getProp(\"--ButtonDkShadow\")}\"/>\n\t\t<path d=\"M1 1h5v1h-4v4h-1v-5z\" fill=\"${getProp(\"--ButtonLight\")}\"/>\n\t\t<path d=\"M6 1h1v6h-6v-1h5v-5z\" fill=\"${getProp(\"--ButtonShadow\")}\"/>\n\t\t<path d=\"M2 2h4v4h-4v-4z\" fill=\"${getProp(\"--ButtonFace\")}\"/>\n\t`);\n\tvar inset_deep_border_image = border_image(2, `\n\t\t<path d=\"M0 0h7v1h-6v6h-1v-7z\" fill=\"${getProp(\"--ButtonDkShadow\")}\"/>\n\t\t<path d=\"M7 0h1v8h-8v-1h7v-7z\" fill=\"${getProp(\"--ButtonHilight\")}\"/>\n\t\t<path d=\"M1 1h5v1h-4v4h-1v-5z\" fill=\"${getProp(\"--ButtonShadow\")}\"/>\n\t\t<path d=\"M6 1h1v6h-6v-1h5v-5z\" fill=\"${getProp(\"--ButtonLight\")}\"/>\n\t\t<path d=\"M2 2h4v4h-4v-4z\" fill=\"${getProp(\"--ButtonFace\")}\"/>\n\t`);\n\tvar button_default_border_image = border_image(3, `\n\t\t<path d=\"M0 0h8v8h-8v-8z\" fill=\"${getProp(\"--ButtonDkShadow\")}\"/>\n\t\t<path d=\"M1 1h5v1h-4v4h-1v-5z\" fill=\"${getProp(\"--ButtonHilight\")}\"/>\n\t\t<path d=\"M2 2h3v1h-2v2h-1v-3z\" fill=\"${getProp(\"--ButtonLight\")}\"/>\n\t\t<path d=\"M5 2h1v4h-4v-1h3v-3z\" fill=\"${getProp(\"--ButtonShadow\")}\"/>\n\t\t<path d=\"M3 3h2v2h-2v-2z\" fill=\"${getProp(\"--ButtonFace\")}\"/>\n\t\t<rect x=\"0\" y=\"0\" width=\"8\" height=\"8\" stroke-width=\"2\" stroke=\"${getProp(\"--WindowFrame\")}\" fill=\"none\"/>\n\t`);\n\n\treturn {\n\t\t\"--checker\": checker,\n\t\t\"--button-active-border-image\": button_active_border_image,\n\t\t\"--button-normal-border-image\": button_normal_border_image,\n\t\t\"--inset-deep-border-image\": inset_deep_border_image,\n\t\t\"--button-default-border-image\": button_default_border_image,\n\t\t\"--button-default-active-border-image\": button_default_active_border_image,\n\t\t\"--scrollbar-arrows-ButtonText\": scrollbar_arrows_ButtonText,\n\t\t\"--scrollbar-arrows-GrayText\": scrollbar_arrows_GrayText,\n\t\t\"--scrollbar-arrows-ButtonHilight\": scrollbar_arrows_ButtonHilight,\n\t\t\"--scrollbar-size\": `${scrollbar_size}px`,\n\t\t\"--scrollbar-button-inner-size\": `${scrollbar_button_inner_size}px`,\n\t};\n}\n\n// Parse NonClientMetrics\n// https://docs.microsoft.com/en-us/windows/win32/controls/themesfileformat-overview?redirectedfrom=MSDN#metrics-section\n// https://docs.microsoft.com/en-us/windows/win32/winprog/windows-data-types\n\n// using https://github.com/toji/js-struct\n\n// var NonClientMetricsStruct = Struct.create(\n//     Struct.uint32(\"cbSize\"),\n//     Struct.int32(\"iBorderWidth\"),\n//     Struct.int32(\"iScrollWidth\"),\n//     Struct.int32(\"iScrollHeight\"),\n//     Struct.int32(\"iCaptionWidth\"),\n//     Struct.int32(\"iCaptionHeight\"),\n// \t// after that, it may be W or A\n// //   LOGFONTW lfCaptionFont;\n// //   int      iSmCaptionWidth;\n// //   int      iSmCaptionHeight;\n// //   LOGFONTW lfSmCaptionFont;\n// //   int      iMenuWidth;\n// //   int      iMenuHeight;\n// //   LOGFONTW lfMenuFont;\n// //   LOGFONTW lfStatusFont;\n// //   LOGFONTW lfMessageFont;\n// //   int      iPaddedBorderWidth;\n// );\n\n// var NonClientMetrics_buffer = new Uint8Array(NonClientMetrics_string.split(\" \").map((str)=> parseInt(str))).buffer;\n\n// NonClientMetricsStruct.readStructs(NonClientMetrics_buffer, 0, 1)[0];\n\nfunction parseThemeFileString(themeIni) {\n\t// .theme is a renamed .ini text file\n\t// .themepack is a renamed .cab file, and parsing it as .ini seems to work well enough for the most part, as the .ini data appears in plain,\n\t// but it may not if compression is enabled for the .cab file\n\tvar theme = parseINIString(themeIni);\n\tvar colors = theme[\"Control Panel\\\\Colors\"];\n\tif (!colors) {\n\t\talert(\"Invalid theme file, no [Control Panel\\\\Colors] section\");\n\t\tconsole.log(theme);\n\t\treturn;\n\t}\n\tfor (var k in colors) {\n\t\t// for .themepack file support, just ignore bad keys that were parsed\n\t\tif (k.match(/\\W/)) {\n\t\t\tdelete colors[k];\n\t\t} else {\n\t\t\tcolors[k] = `rgb(${colors[k].split(\" \").join(\", \")})`;\n\t\t}\n\t}\n\n\tvar cssProperties = {};\n\tfor (var k in colors) {\n\t\tcssProperties[`--${k}`] = colors[k];\n\t}\n\n\tcssProperties = Object.assign(renderThemeGraphics(cssProperties), cssProperties);\n\n\treturn cssProperties;\n}\n\nfunction applyCSSProperties(cssProperties, options = {}) {\n\t// @TODO: clean up deprecated argument handling\n\tlet element, recurseIntoIframes;\n\tif (\"tagName\" in options) {\n\t\tconsole.warn(\"deprecated: use options argument to applyCSSProperties, e.g. applyCSSProperties(cssProperties, { element: document.documentElement, recurseIntoIframes: true })\");\n\t\telement = options;\n\t\trecurseIntoIframes = false;\n\t} else {\n\t\t({ element = document.documentElement, recurseIntoIframes = false } = options);\n\t}\n\n\tvar getProp = (propName) => cssProperties.getPropertyValue ? cssProperties.getPropertyValue(propName) : cssProperties[propName];\n\tfor (var k in cssProperties) {\n\t\telement.style.setProperty(k, getProp(k));\n\t}\n\t// iframe theme propagation\n\tif (recurseIntoIframes) {\n\t\tvar iframes = element.querySelectorAll(\"iframe\");\n\t\tfor (var i = 0; i < iframes.length; i++) {\n\t\t\ttry {\n\t\t\t\tapplyCSSProperties(cssProperties, { element: iframes[i].contentDocument.documentElement, recurseIntoIframes: true });\n\t\t\t} catch (error) {\n\t\t\t\t// ignore\n\t\t\t\t// @TODO: share warning with $Window's iframe handling\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction makeThemeCSSFile(cssProperties) {\n\tvar css = `\n/* This is a generated file. */\n:root {\n`;\n\tfor (var k in cssProperties) {\n\t\tcss += `\\t${k}: ${cssProperties[k]};\\n`;\n\t}\n\tcss += `}\n`;\n\treturn css;\n}\n\n// @TODO: should this be part of theme graphics generation?\n// I want to figure out a better way to do dynamic theme features,\n// where it works with the CSS cascade as much as possible\nfunction makeBlackToInsetFilter() {\n\tif (document.getElementById(\"os-gui-black-to-inset-filter\")) {\n\t\treturn;\n\t}\n\tconst svg_xml = `\n\t\t<svg style=\"position: absolute; pointer-events: none; bottom: 100%;\">\n\t\t\t<defs>\n\t\t\t\t<filter id=\"os-gui-black-to-inset-filter\" x=\"0\" y=\"0\" width=\"1px\" height=\"1px\">\n\t\t\t\t\t<feColorMatrix\n\t\t\t\t\t\tin=\"SourceGraphic\"\n\t\t\t\t\t\ttype=\"matrix\"\n\t\t\t\t\t\tvalues=\"\n\t\t\t\t\t\t\t1 0 0 0 0\n\t\t\t\t\t\t\t0 1 0 0 0\n\t\t\t\t\t\t\t0 0 1 0 0\n\t\t\t\t\t\t\t-1000 -1000 -1000 1 0\n\t\t\t\t\t\t\"\n\t\t\t\t\t\tresult=\"black-parts-isolated\"\n\t\t\t\t\t/>\n\t\t\t\t\t<feFlood result=\"shadow-color\" flood-color=\"var(--ButtonShadow)\"/>\n\t\t\t\t\t<feFlood result=\"hilight-color\" flood-color=\"var(--ButtonHilight)\"/>\n\t\t\t\t\t<feOffset in=\"black-parts-isolated\" dx=\"1\" dy=\"1\" result=\"offset\"/>\n\t\t\t\t\t<feComposite in=\"hilight-color\" in2=\"offset\" operator=\"in\" result=\"hilight-colored-offset\"/>\n\t\t\t\t\t<feComposite in=\"shadow-color\" in2=\"black-parts-isolated\" operator=\"in\" result=\"shadow-colored\"/>\n\t\t\t\t\t<feMerge>\n\t\t\t\t\t\t<feMergeNode in=\"hilight-colored-offset\"/>\n\t\t\t\t\t\t<feMergeNode in=\"shadow-colored\"/>\n\t\t\t\t\t</feMerge>\n\t\t\t\t</filter>\n\t\t\t</defs>\n\t\t</svg>\n\t`;\n\tconst $svg = $(svg_xml);\n\t$svg.appendTo(\"body\");\n}\n"]}