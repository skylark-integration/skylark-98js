{"version":3,"sources":["iframe-windows.js"],"names":["define","$","win98js","$Window","programs_being_loaded","$G","window","enhance_iframe","iframe","$iframe","addClass","on","removeClass","console","assert","contentWindow","document","contentDocument","e","warn","src","themeCSSProperties","applyTheme","documentElement","addEventListener","event","delegate_pointerup","jQuery","trigger","MouseEvent","button","dispatchEvent","event2","clean_up_delegation","off","removeEventListener","proxy_keyboard_events","querySelector","message","createElement","style","position","left","right","top","bottom","background","color","padding","body","appendChild","innerHTML","href","replace","$contentWindow","$window","focus","hide","css","close","showMessageBox","options","title","defaultMessageBoxTitle","minWidth","minHeight","flex","border","event_type","proxied_event","KeyboardEvent","target","view","ownerDocument","defaultView","bubbles","cancelable","key","keyCode","which","code","shiftKey","ctrlKey","metaKey","altKey","repeat","preventDefault","type","activeElement","tagName","match","make_iframe_window","undefined","resizable","$win","attr","$content","append","show","display","flexDirection","center"],"mappings":"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","file":"../iframe-windows.js","sourcesContent":["define([\n\t\"skylark-jquery\",\n\t\"./win98\",\n\t\"./os-gui/$Window\"\n],function($,win98js,$Window){\n\tvar programs_being_loaded = 0;\n\n\tvar $G = $(window);\n\t\n\tfunction enhance_iframe(iframe) {\n\t\tvar $iframe = $(iframe);\n\n\t\t$(\"body\").addClass(\"loading-program\");\n\t\tprograms_being_loaded += 1;\n\n\t\t$iframe.on(\"load\", function () {\n\n\t\t\tif (--programs_being_loaded <= 0) {\n\t\t\t\t$(\"body\").removeClass(\"loading-program\");\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconsole.assert(iframe.contentWindow.document === iframe.contentDocument); // just something that won't get optimized away if we were to ever use a minifier (or by the JIT compiler??)\n\t\t\t} catch (e) {\n\t\t\t\tconsole.warn(`[enhance_iframe] iframe integration is not available for '${iframe.src}'`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (window.themeCSSProperties) {\n\t\t\t\tapplyTheme(themeCSSProperties, iframe.contentDocument.documentElement);\n\t\t\t}\n\n\t\t\t// Let the iframe to handle mouseup events outside itself\n\t\t\t// (without using setPointerCapture)\n\t\t\tiframe.contentDocument.addEventListener(\"mousedown\", (event) => {\n\t\t\t\tvar delegate_pointerup = function () {\n\t\t\t\t\tif (iframe.contentWindow && iframe.contentWindow.jQuery) {\n\t\t\t\t\t\tiframe.contentWindow.jQuery(\"body\").trigger(\"pointerup\");\n\t\t\t\t\t}\n\t\t\t\t\tif (iframe.contentWindow) {\n\t\t\t\t\t\tconst event = new iframe.contentWindow.MouseEvent(\"mouseup\", { button: 0 });\n\t\t\t\t\t\tiframe.contentWindow.dispatchEvent(event);\n\t\t\t\t\t\tconst event2 = new iframe.contentWindow.MouseEvent(\"mouseup\", { button: 2 });\n\t\t\t\t\t\tiframe.contentWindow.dispatchEvent(event2);\n\t\t\t\t\t}\n\t\t\t\t\tclean_up_delegation();\n\t\t\t\t};\n\t\t\t\t// @TODO: delegate pointermove events too?\n\t\t\t\t// @TODO: do delegation in os-gui.js library instead\n\t\t\t\t// is it delegation? I think I mean proxying (but I'm really tired and don't have internet right now so I can't say for sure haha)\n\n\t\t\t\t$G.on(\"mouseup blur\", delegate_pointerup);\n\t\t\t\tiframe.contentDocument.addEventListener(\"mouseup\", clean_up_delegation);\n\t\t\t\tfunction clean_up_delegation() {\n\t\t\t\t\t$G.off(\"mouseup blur\", delegate_pointerup);\n\t\t\t\t\tiframe.contentDocument.removeEventListener(\"mouseup\", clean_up_delegation);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Let the containing page handle keyboard events, with an opportunity to cancel them\n\t\t\tproxy_keyboard_events(iframe);\n\n\t\t\t// on Wayback Machine, and iframe's url not saved yet\n\t\t\tif (iframe.contentDocument.querySelector(\"#error #livewebInfo.available\")) {\n\t\t\t\tvar message = document.createElement(\"div\");\n\t\t\t\tmessage.style.position = \"absolute\";\n\t\t\t\tmessage.style.left = \"0\";\n\t\t\t\tmessage.style.right = \"0\";\n\t\t\t\tmessage.style.top = \"0\";\n\t\t\t\tmessage.style.bottom = \"0\";\n\t\t\t\tmessage.style.background = \"#c0c0c0\";\n\t\t\t\tmessage.style.color = \"#000\";\n\t\t\t\tmessage.style.padding = \"50px\";\n\t\t\t\tiframe.contentDocument.body.appendChild(message);\n\t\t\t\tmessage.innerHTML = `<a target=\"_blank\">Save this url in the Wayback Machine</a>`;\n\t\t\t\tmessage.querySelector(\"a\").href =\n\t\t\t\t\t\"https://web.archive.org/save/https://98.js.org/\" +\n\t\t\t\t\tiframe.src.replace(/.*https:\\/\\/98.js.org\\/?/, \"\");\n\t\t\t\tmessage.querySelector(\"a\").style.color = \"blue\";\n\t\t\t}\n\n\t\t\tvar $contentWindow = $(iframe.contentWindow);\n\t\t\t$contentWindow.on(\"pointerdown click\", function (e) {\n\t\t\t\tiframe.$window && iframe.$window.focus();\n\n\t\t\t\t// from close_menus in $MenuBar\n\t\t\t\t$(\".menu-button\").trigger(\"release\");\n\t\t\t\t// Close any rogue floating submenus\n\t\t\t\t$(\".menu-popup\").hide();\n\t\t\t});\n\t\t\t// We want to disable pointer events for other iframes, but not this one\n\t\t\t$contentWindow.on(\"pointerdown\", function (e) {\n\t\t\t\t$iframe.css(\"pointer-events\", \"all\");\n\t\t\t\t$(\"body\").addClass(\"drag\");\n\t\t\t});\n\t\t\t$contentWindow.on(\"pointerup\", function (e) {\n\t\t\t\t$(\"body\").removeClass(\"drag\");\n\t\t\t\t$iframe.css(\"pointer-events\", \"\");\n\t\t\t});\n\t\t\t// $(\"iframe\").css(\"pointer-events\", \"\"); is called elsewhere.\n\t\t\t// Otherwise iframes would get stuck in this interaction mode\n\n\t\t\tiframe.contentWindow.close = function () {\n\t\t\t\tiframe.$window && iframe.$window.close();\n\t\t\t};\n\t\t\t// TODO: hook into saveAs (a la FileSaver.js) and another function for opening files\n\t\t\t// iframe.contentWindow.saveAs = function(){\n\t\t\t// \tsaveAsDialog();\n\t\t\t// };\n\n\t\t\t// Don't override alert (except within the specific pages)\n\t\t\t// but override the underlying message box function that\n\t\t\t// the alert override uses, so that the message boxes can\n\t\t\t// go outside the window.\n\t\t\tiframe.contentWindow.showMessageBox = (options) => {\n\t\t\t\treturn showMessageBox({\n\t\t\t\t\ttitle: options.title /*??*/ ||  iframe.contentWindow.defaultMessageBoxTitle,\n\t\t\t\t\t...options,\n\t\t\t\t});\n\t\t\t};\n\t\t});\n\t\t$iframe.css({\n\t\t\tminWidth: 0,\n\t\t\tminHeight: 0, // overrides user agent styling apparently, fixes Sound Recorder\n\t\t\tflex: 1,\n\t\t\tborder: 0, // overrides user agent styling\n\t\t});\n\t}\n\n\t// Let the containing page handle keyboard events, with an opportunity to cancel them\n\tfunction proxy_keyboard_events(iframe) {\n\t\t// Note: iframe must be same-origin, or this will fail.\n\t\tfor (const event_type of [\"keyup\", \"keydown\", \"keypress\"]) {\n\t\t\tiframe.contentWindow.addEventListener(event_type, (event) => {\n\t\t\t\tconst proxied_event = new KeyboardEvent(event_type, {\n\t\t\t\t\ttarget: iframe,\n\t\t\t\t\tview: iframe.ownerDocument.defaultView,\n\t\t\t\t\tbubbles: true,\n\t\t\t\t\tcancelable: true,\n\t\t\t\t\tkey: event.key,\n\t\t\t\t\tkeyCode: event.keyCode,\n\t\t\t\t\twhich: event.which,\n\t\t\t\t\tcode: event.code,\n\t\t\t\t\tshiftKey: event.shiftKey,\n\t\t\t\t\tctrlKey: event.ctrlKey,\n\t\t\t\t\tmetaKey: event.metaKey,\n\t\t\t\t\taltKey: event.altKey,\n\t\t\t\t\trepeat: event.repeat,\n\t\t\t\t\t//...@TODO: should it copy ALL properties?\n\t\t\t\t});\n\t\t\t\tconst result = iframe.dispatchEvent(proxied_event);\n\t\t\t\t// console.log(\"proxied\", event, \"as\", proxied_event, \"result\", result);\n\t\t\t\tif (!result) {\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t}\n\t\t\t}, true);\n\t\t}\n\t}\n\n\tfunction make_iframe_window(options) {\n\t\t///options.resizable ??= true;\n\t\tif (options.resizable == undefined) {\n\t\t\toptions.resizable = true;\n\t\t}\n\t\tvar $win = new $Window(options);\n\n\t\tvar $iframe = $win.$iframe = $(\"<iframe>\").attr({ src: options.src });\n\t\tenhance_iframe($iframe[0]);\n\t\t$win.$content.append($iframe);\n\t\tvar iframe = $win.iframe = $iframe[0];\n\t\t// TODO: should I instead of having iframe.$window, have a get$Window type of dealio?\n\t\t// where all is $window needed?\n\t\t// I know it's used from within the iframe contents as frameElement.$window\n\t\tiframe.$window = $win;\n\n\t\t$iframe.on(\"load\", function () {\n\t\t\t$win.show();\n\t\t\t$win.focus();\n\t\t});\n\n\t\t$win.$content.css({\n\t\t\tdisplay: \"flex\",\n\t\t\tflexDirection: \"column\",\n\t\t});\n\n\t\t// TODO: cascade windows\n\t\t$win.center();\n\t\t$win.hide();\n\n\t\treturn $win;\n\t}\n\n\t// Fix dragging things (i.e. windows) over iframes (i.e. other windows)\n\t// (when combined with a bit of css, .drag iframe { pointer-events: none; })\n\t// (and a similar thing in make_iframe_window)\n\t$(window).on(\"pointerdown\", function (e) {\n\t\t//console.log(e.type);\n\t\t$(\"body\").addClass(\"drag\");\n\t});\n\t$(window).on(\"pointerup dragend blur\", function (e) {\n\t\t//console.log(e.type);\n\t\tif (e.type === \"blur\") {\n\t\t\tif (document.activeElement.tagName.match(/iframe/i)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\t$(\"body\").removeClass(\"drag\");\n\t\t$(\"iframe\").css(\"pointer-events\", \"\");\n\t});\n\n\treturn {\n\t\tenhance_iframe,\n\t\tproxy_keyboard_events,\n\t\tmake_iframe_window\n\t}\n\n});"]}